import{e as $r,f as Hr,h as Ce,m as u_,n as Yr,o as Jr,p as Xr,q as Zr}from"./chunk-XPPDT5O2.js";import{$ as Vc,A as i_,B as s_,C as yt,D as Tn,E as Va,F as Ps,G as Nc,H as o_,K as a_,M as Q,N as at,O as Me,P as Dc,Q as l_,R as xs,T as ne,U as Mt,V as Oa,W as kc,X as vt,Y as Wr,_ as Fa,a as O,b as zr,ba as Ma,c as Xg,d as Zg,da as Oc,f as e_,fa as Qr,ga as Lt,h as Rc,j as et,k as Da,l as Rs,m as Pc,p as t_,r as Ft,s as xc,t as n_,w as r_,y as ka,z as Ne}from"./chunk-QPWJ32ZV.js";import{u as Yg,z as Jg}from"./chunk-OYTWBHQG.js";import{a as Na}from"./chunk-KGMONOZY.js";import{W as Hg}from"./chunk-4SNHCYBM.js";import{d as Qg,s as $g,t as xa}from"./chunk-LR4WFUS2.js";import{A as bs,Fa as In,H as ba,J as jg,M as Ra,N as ir,O as Gg,P as Cc,Q as Kg,R as Pa,S as sn,T as bc,W as zg,Z as _t,aa as Ze,c as rr,ca as K,da as Wg,f as qg,g as rn,i as Aa,l as As,m as Ca,n as ct,o as Ot,s as he,z as Cs,za as Kr}from"./chunk-BEVEPN7V.js";import{a as Vt,b as Ss,n as Ac,o as D}from"./chunk-EMXRSGQS.js";var Ds=new Ze("angularfire2.auth.use-emulator"),ks=new Ze("angularfire2.auth.settings"),Vs=new Ze("angularfire2.auth.tenant-id"),Os=new Ze("angularfire2.auth.langugage-code"),Fs=new Ze("angularfire2.auth.use-device-language"),Ms=new Ze("angularfire.auth.persistence"),Ls=(n,e,t,r,i,s,o,a)=>Zr(`${n.name}.auth`,"AngularFireAuth",n.name,()=>{let u=e.runOutsideAngular(()=>n.auth());if(t&&u.useEmulator(...t),r&&(u.tenantId=r),u.languageCode=i,s&&u.useDeviceLanguage(),o)for(let[c,d]of Object.entries(o))u.settings[c]=d;return a&&u.setPersistence(a),u},[t,r,i,s,o,a]),ei=(()=>{class n{authState;idToken;user;idTokenResult;credential;constructor(t,r,i,s,o,a,u,c,d,m,p,y){let A=new qg,x=Ot(void 0).pipe(As(o.outsideAngular),sn(()=>s.runOutsideAngular(()=>import("./chunk-LJTM6TDY.js"))),he(()=>Xr(t,s,r)),he(N=>Ls(N,s,a,c,d,m,u,p)),Cc({bufferSize:1,refCount:!1}));if(xa(i))this.authState=this.user=this.idToken=this.idTokenResult=this.credential=Ot(null);else{x.pipe(jg()).subscribe();let N=x.pipe(sn(F=>F.getRedirectResult().then(W=>W,()=>null)),Ce,Cc({bufferSize:1,refCount:!1})),q=x.pipe(sn(F=>new rr(W=>({unsubscribe:s.runOutsideAngular(()=>F.onAuthStateChanged(H=>W.next(H),H=>W.error(H),()=>W.complete()))})))),j=x.pipe(sn(F=>new rr(W=>({unsubscribe:s.runOutsideAngular(()=>F.onIdTokenChanged(H=>W.next(H),H=>W.error(H),()=>W.complete()))}))));this.authState=N.pipe(bc(q),Ca(o.outsideAngular),As(o.insideAngular)),this.user=N.pipe(bc(j),Ca(o.outsideAngular),As(o.insideAngular)),this.idToken=this.user.pipe(sn(F=>F?ct(F.getIdToken()):Ot(null))),this.idTokenResult=this.user.pipe(sn(F=>F?ct(F.getIdTokenResult()):Ot(null))),this.credential=Cs(N,A,this.authState.pipe(bs(F=>!F))).pipe(he(F=>F?.user?F:null),Ca(o.outsideAngular),As(o.insideAngular))}return u_(this,x,s,{spy:{apply:(N,q,j)=>{(N.startsWith("signIn")||N.startsWith("createUser"))&&j.then(F=>A.next(F))}}})}static \u0275fac=function(r){return new(r||n)(K(Yr),K(Jr,8),K(In),K(Kr),K(Hr),K(Ds,8),K(ks,8),K(Vs,8),K(Os,8),K(Fs,8),K(Ms,8),K($r,8))};static \u0275prov=_t({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})();var p_="@firebase/database",g_="1.0.7";var $h="";function Hh(n){$h=n}var Kc=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),Ne(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:ka(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var zc=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return yt(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var Q_=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){let e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Kc(e)}}catch{}return new zc},or=Q_("localStorage"),Wc=Q_("sessionStorage");var ii=new Wr("@firebase/database"),$_=function(){let n=1;return function(){return n++}}(),H_=function(n){let e=l_(n),t=new a_;t.update(e);let r=t.digest();return Xg.encodeByteArray(r)},lo=function(...n){let e="";for(let t=0;t<n.length;t++){let r=n[t];Array.isArray(r)||r&&typeof r=="object"&&typeof r.length=="number"?e+=lo.apply(null,r):typeof r=="object"?e+=Ne(r):e+=r,e+=" "}return e},ar=null,__=!0,Y_=function(n,e){O(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(ii.logLevel=vt.VERBOSE,ar=ii.log.bind(ii),e&&Wc.set("logging_enabled",!0)):typeof n=="function"?ar=n:(ar=null,Wc.remove("logging_enabled"))},Be=function(...n){if(__===!0&&(__=!1,ar===null&&Wc.get("logging_enabled")===!0&&Y_(!0)),ar){let e=lo.apply(null,n);ar(e)}},uo=function(n){return function(...e){Be(n,...e)}},Qc=function(...n){let e="FIREBASE INTERNAL ERROR: "+lo(...n);ii.error(e)},qt=function(...n){let e=`FIREBASE FATAL ERROR: ${lo(...n)}`;throw ii.error(e),new Error(e)},$e=function(...n){let e="FIREBASE WARNING: "+lo(...n);ii.warn(e)},eS=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&$e("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},hl=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},tS=function(n){if(Ft()||document.readyState==="complete")n();else{let e=!1,t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},bn="[MIN_NAME]",on="[MAX_NAME]",ur=function(n,e){if(n===e)return 0;if(n===bn||e===on)return-1;if(e===bn||n===on)return 1;{let t=y_(n),r=y_(e);return t!==null?r!==null?t-r===0?n.length-e.length:t-r:-1:r!==null?1:n<e?-1:1}},nS=function(n,e){return n===e?0:n<e?-1:1},Us=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+Ne(e))},Yh=function(n){if(typeof n!="object"||n===null)return Ne(n);let e=[];for(let r in n)e.push(r);e.sort();let t="{";for(let r=0;r<e.length;r++)r!==0&&(t+=","),t+=Ne(e[r]),t+=":",t+=Yh(n[e[r]]);return t+="}",t},J_=function(n,e){let t=n.length;if(t<=e)return[n];let r=[];for(let i=0;i<t;i+=e)i+e>t?r.push(n.substring(i,t)):r.push(n.substring(i,i+e));return r};function qe(n,e){for(let t in n)n.hasOwnProperty(t)&&e(t,n[t])}var X_=function(n){O(!hl(n),"Invalid JSON number");let e=11,t=52,r=(1<<e-1)-1,i,s,o,a,u;n===0?(s=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-r)?(a=Math.min(Math.floor(Math.log(n)/Math.LN2),r),s=a+r,o=Math.round(n*Math.pow(2,t-a)-Math.pow(2,t))):(s=0,o=Math.round(n/Math.pow(2,1-r-t))));let c=[];for(u=t;u;u-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(u=e;u;u-=1)c.push(s%2?1:0),s=Math.floor(s/2);c.push(i?1:0),c.reverse();let d=c.join(""),m="";for(u=0;u<64;u+=8){let p=parseInt(d.substr(u,8),2).toString(16);p.length===1&&(p="0"+p),m=m+p}return m.toLowerCase()},rS=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},iS=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function sS(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");let r=new Error(n+" at "+e._path.toString()+": "+t);return r.code=n.toUpperCase(),r}var oS=new RegExp("^-?(0*)\\d{1,10}$"),aS=-2147483648,lS=2147483647,y_=function(n){if(oS.test(n)){let e=Number(n);if(e>=aS&&e<=lS)return e}return null},fi=function(n){try{n()}catch(e){setTimeout(()=>{let t=e.stack||"";throw $e("Exception was thrown by user callback.",t),e},Math.floor(0))}},uS=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},Gs=function(n,e){let t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};var $c=class{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(r=>this.appCheck=r)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,r)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(r=>r.addTokenListener(e))}notifyForInvalidToken(){$e(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}};var Hc=class{constructor(e,t,r){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=r,this.auth_=null,this.auth_=r.getImmediate({optional:!0}),this.auth_||r.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(Be("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,r)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',$e(e)}},Ks=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}n.OWNER="owner";return n})(),Ua="5",Z_="v",ey="s",ty="r",ny="f",ry=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,iy="ls",sy="p",Yc="ac",oy="websocket",ay="long_polling";var Ba=class{constructor(e,t,r,i,s=!1,o="",a=!1,u=!1){this.secure=t,this.namespace=r,this.webSocketOnly=i,this.nodeAdmin=s,this.persistenceKey=o,this.includeNamespaceInQueryParams=a,this.isUsingEmulator=u,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=or.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&or.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}};function cS(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function ly(n,e,t){O(typeof e=="string","typeof type must == string"),O(typeof t=="object","typeof params must == object");let r;if(e===oy)r=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===ay)r=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);cS(n)&&(t.ns=n.namespace);let i=[];return qe(t,(s,o)=>{i.push(s+"="+o)}),r+i.join("&")}var Jc=class{constructor(){this.counters_={}}incrementCounter(e,t=1){yt(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return e_(this.counters_)}};var Mc={},Lc={};function Jh(n){let e=n.toString();return Mc[e]||(Mc[e]=new Jc),Mc[e]}function hS(n,e){let t=n.toString();return Lc[t]||(Lc[t]=e()),Lc[t]}var Xc=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let r=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<r.length;++i)r[i]&&fi(()=>{this.onMessage_(r[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var v_="start",dS="close",fS="pLPCommand",mS="pRTLPCB",uy="id",cy="pw",hy="ser",pS="cb",gS="seg",_S="ts",yS="d",vS="dframe",dy=1870,fy=30,wS=dy-fy,ES=25e3,IS=3e4,$s=class n{constructor(e,t,r,i,s,o,a){this.connId=e,this.repoInfo=t,this.applicationId=r,this.appCheckToken=i,this.authToken=s,this.transportSessionId=o,this.lastSessionId=a,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=uo(e),this.stats_=Jh(t),this.urlFn=u=>(this.appCheckToken&&(u[Yc]=this.appCheckToken),ly(t,ay,u))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new Xc(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(IS)),tS(()=>{if(this.isClosed_)return;this.scriptTagHolder=new Zc((...s)=>{let[o,a,u,c,d]=s;if(this.incrementIncomingBytes_(s),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===v_)this.id=a,this.password=u;else if(o===dS)a?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(a,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...s)=>{let[o,a]=s;this.incrementIncomingBytes_(s),this.myPacketOrderer.handleResponse(o,a)},()=>{this.onClosed_()},this.urlFn);let r={};r[v_]="t",r[hy]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(r[pS]=this.scriptTagHolder.uniqueCallbackIdentifier),r[Z_]=Ua,this.transportSessionId&&(r[ey]=this.transportSessionId),this.lastSessionId&&(r[iy]=this.lastSessionId),this.applicationId&&(r[sy]=this.applicationId),this.appCheckToken&&(r[Yc]=this.appCheckToken),typeof location<"u"&&location.hostname&&ry.test(location.hostname)&&(r[ty]=ny);let i=this.urlFn(r);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){n.forceAllow_=!0}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){return Ft()?!1:n.forceAllow_?!0:!n.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!rS()&&!iS()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let t=Ne(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);let r=Zg(t),i=J_(r,wS);for(let s=0;s<i.length;s++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[s]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(Ft())return;this.myDisconnFrame=document.createElement("iframe");let r={};r[vS]="t",r[uy]=e,r[cy]=t,this.myDisconnFrame.src=this.urlFn(r),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=Ne(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}},Zc=class n{constructor(e,t,r,i){if(this.onDisconnect=r,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,Ft())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=$_(),window[fS+this.uniqueCallbackIdentifier]=e,window[mS+this.uniqueCallbackIdentifier]=t,this.myIFrame=n.createIFrame_();let s="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(s='<script>document.domain="'+document.domain+'";<\/script>');let o="<html><body>"+s+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(a){Be("frame writing exception"),a.stack&&Be(a.stack),Be(a)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||Be("No IE domain setting required")}catch{let r=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+r+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[uy]=this.myID,e[cy]=this.myPW,e[hy]=this.currentSerial;let t=this.urlFn(e),r="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+fy+r.length<=dy;){let o=this.pendingSegs.shift();r=r+"&"+gS+i+"="+o.seg+"&"+_S+i+"="+o.ts+"&"+yS+i+"="+o.d,i++}return t=t+r,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,r){this.pendingSegs.push({seg:e,ts:t,d:r}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let r=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(r,Math.floor(ES)),s=()=>{clearTimeout(i),r()};this.addTag(e,s)}addTag(e,t){Ft()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let r=this.myIFrame.doc.createElement("script");r.type="text/javascript",r.async=!0,r.src=e,r.onload=r.onreadystatechange=function(){let i=r.readyState;(!i||i==="loaded"||i==="complete")&&(r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),t())},r.onerror=()=>{Be("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(r)}catch{}},Math.floor(1))}};var TS=16384,SS=45e3,qa=null;typeof MozWebSocket<"u"?qa=MozWebSocket:typeof WebSocket<"u"&&(qa=WebSocket);var ni=(()=>{class n{constructor(t,r,i,s,o,a,u){this.connId=t,this.applicationId=i,this.appCheckToken=s,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=uo(this.connId),this.stats_=Jh(r),this.connURL=n.connectionURL_(r,a,u,s,i),this.nodeAdmin=r.nodeAdmin}static connectionURL_(t,r,i,s,o){let a={};return a[Z_]=Ua,!Ft()&&typeof location<"u"&&location.hostname&&ry.test(location.hostname)&&(a[ty]=ny),r&&(a[ey]=r),i&&(a[iy]=i),s&&(a[Yc]=s),o&&(a[sy]=o),ly(t,oy,a)}open(t,r){this.onDisconnect=r,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,or.set("previous_websocket_failure",!0);try{let i;if(Ft()){let s=this.nodeAdmin?"AdminNode":"Node";i={headers:{"User-Agent":`Firebase/${Ua}/${$h}/${process.platform}/${s}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,a=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;a&&(i.proxy={origin:a})}this.mySock=new qa(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){let r=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(r);i&&i.length>1&&parseFloat(i[1])<4.4&&(t=!0)}return!t&&qa!==null&&!n.forceDisallow_}static previouslyFailed(){return or.isInMemoryStorage||or.get("previous_websocket_failure")===!0}markConnectionHealthy(){or.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){let r=this.frames.join("");this.frames=null;let i=ka(r);this.onMessage(i)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(O(this.frames===null,"We already have a frame buffer"),t.length<=6){let r=Number(t);if(!isNaN(r))return this.handleNewFrameCount_(r),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;let r=t.data;if(this.bytesReceived+=r.length,this.stats_.incrementCounter("bytes_received",r.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(r);else{let i=this.extractFrameCount_(r);i!==null&&this.appendFrame_(i)}}send(t){this.resetKeepAlive();let r=Ne(t);this.bytesSent+=r.length,this.stats_.incrementCounter("bytes_sent",r.length);let i=J_(r,TS);i.length>1&&this.sendString_(String(i.length));for(let s=0;s<i.length;s++)this.sendString_(i[s])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(SS))}sendString_(t){try{this.mySock.send(t)}catch(r){this.log_("Exception thrown from WebSocket.send():",r.message||r.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4;return n})(),my=(()=>{class n{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[$s,ni]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){let r=ni&&ni.isAvailable(),i=r&&!ni.previouslyFailed();if(t.webSocketOnly&&(r||$e("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[ni];else{let s=this.transports_=[];for(let o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&s.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}n.globalTransportInitialized_=!1;return n})(),AS=6e4,CS=5e3,bS=10*1024,RS=100*1024,Uc="t",w_="d",PS="s",E_="r",xS="e",I_="o",T_="a",S_="n",A_="p",NS="h",eh=class{constructor(e,t,r,i,s,o,a,u,c,d){this.id=e,this.repoInfo_=t,this.applicationId_=r,this.appCheckToken_=i,this.authToken_=s,this.onMessage_=o,this.onReady_=a,this.onDisconnect_=u,this.onKill_=c,this.lastSessionId=d,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=uo("c:"+this.id+":"),this.transportManager_=new my(t),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),r=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,r)},Math.floor(0));let i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=Gs(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>RS?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>bS?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){let t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(Uc in e){let t=e[Uc];t===T_?this.upgradeIfSecondaryHealthy_():t===E_?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===I_&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=Us("t",e),r=Us("d",e);if(t==="c")this.onSecondaryControl_(r);else if(t==="d")this.pendingDataMessages.push(r);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:A_,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:T_,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:S_,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=Us("t",e),r=Us("d",e);t==="c"?this.onControl_(r):t==="d"&&this.onDataMessage_(r)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=Us(Uc,e);if(w_ in e){let r=e[w_];if(t===NS){let i=Object.assign({},r);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===S_){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===PS?this.onConnectionShutdown_(r):t===E_?this.onReset_(r):t===xS?Qc("Server Error: "+r):t===I_?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Qc("Unknown control packet command: "+t)}}onHandshake_(e){let t=e.ts,r=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Ua!==r&&$e("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),r=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,r),Gs(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(AS))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):Gs(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(CS))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:A_,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(or.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var ja=class{put(e,t,r,i){}merge(e,t,r,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,r){}onDisconnectMerge(e,t,r){}onDisconnectCancel(e,t){}reportStats(e){}};var Ga=class{constructor(e){this.allowedEvents_=e,this.listeners_={},O(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let r=[...this.listeners_[e]];for(let i=0;i<r.length;i++)r[i].callback.apply(r[i].context,t)}}on(e,t,r){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:r});let i=this.getInitialEvent(e);i&&t.apply(r,i)}off(e,t,r){this.validateEventType_(e);let i=this.listeners_[e]||[];for(let s=0;s<i.length;s++)if(i[s].callback===t&&(!r||r===i[s].context)){i.splice(s,1);return}}validateEventType_(e){O(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}};var Ka=class n extends Ga{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!Pc()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new n}getInitialEvent(e){return O(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var C_=32,b_=768,ue=class{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let r=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[r]=this.pieces_[i],r++);this.pieces_.length=r,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}};function le(){return new ue("")}function Z(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function Rn(n){return n.pieces_.length-n.pieceNum_}function fe(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new ue(n.pieces_,e)}function Xh(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function DS(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function Hs(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function py(n){if(n.pieceNum_>=n.pieces_.length)return null;let e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new ue(e,0)}function ve(n,e){let t=[];for(let r=n.pieceNum_;r<n.pieces_.length;r++)t.push(n.pieces_[r]);if(e instanceof ue)for(let r=e.pieceNum_;r<e.pieces_.length;r++)t.push(e.pieces_[r]);else{let r=e.split("/");for(let i=0;i<r.length;i++)r[i].length>0&&t.push(r[i])}return new ue(t,0)}function ee(n){return n.pieceNum_>=n.pieces_.length}function tt(n,e){let t=Z(n),r=Z(e);if(t===null)return e;if(t===r)return tt(fe(n),fe(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function kS(n,e){let t=Hs(n,0),r=Hs(e,0);for(let i=0;i<t.length&&i<r.length;i++){let s=ur(t[i],r[i]);if(s!==0)return s}return t.length===r.length?0:t.length<r.length?-1:1}function Zh(n,e){if(Rn(n)!==Rn(e))return!1;for(let t=n.pieceNum_,r=e.pieceNum_;t<=n.pieces_.length;t++,r++)if(n.pieces_[t]!==e.pieces_[r])return!1;return!0}function wt(n,e){let t=n.pieceNum_,r=e.pieceNum_;if(Rn(n)>Rn(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[r])return!1;++t,++r}return!0}var th=class{constructor(e,t){this.errorPrefix_=t,this.parts_=Hs(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let r=0;r<this.parts_.length;r++)this.byteLength_+=xs(this.parts_[r]);gy(this)}};function VS(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=xs(e),gy(n)}function OS(n){let e=n.parts_.pop();n.byteLength_-=xs(e),n.parts_.length>0&&(n.byteLength_-=1)}function gy(n){if(n.byteLength_>b_)throw new Error(n.errorPrefix_+"has a key path longer than "+b_+" bytes ("+n.byteLength_+").");if(n.parts_.length>C_)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+C_+") or object contains a cycle "+sr(n))}function sr(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}var nh=class n extends Ga{constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{let r=!document[e];r!==this.visible_&&(this.visible_=r,this.trigger("visible",r))},!1)}static getInstance(){return new n}getInitialEvent(e){return O(e==="visible","Unknown event type: "+e),[this.visible_]}};var Bs=1e3,FS=60*5*1e3,R_=30*1e3,MS=1.3,LS=3e4,US="server_kill",P_=3,ed=(()=>{class n extends ja{constructor(t,r,i,s,o,a,u,c){if(super(),this.repoInfo_=t,this.applicationId_=r,this.onDataUpdate_=i,this.onConnectStatus_=s,this.onServerInfoUpdate_=o,this.authTokenProvider_=a,this.appCheckTokenProvider_=u,this.authOverride_=c,this.id=n.nextPersistentConnectionId_++,this.log_=uo("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Bs,this.maxReconnectDelay_=FS,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!Ft())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");nh.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&Ka.getInstance().on("online",this.onOnline_,this)}sendRequest(t,r,i){let s=++this.requestNumber_,o={r:s,a:t,b:r};this.log_(Ne(o)),O(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[s]=i)}get(t){this.initConnection_();let r=new et,s={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:a=>{let u=a.d;a.s==="ok"?r.resolve(u):r.reject(u)}};this.outstandingGets_.push(s),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),r.promise}listen(t,r,i,s){this.initConnection_();let o=t._queryIdentifier,a=t._path.toString();this.log_("Listen called for "+a+" "+o),this.listens.has(a)||this.listens.set(a,new Map),O(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),O(!this.listens.get(a).has(o),"listen() called twice for same path/queryId.");let u={onComplete:s,hashFn:r,query:t,tag:i};this.listens.get(a).set(o,u),this.connected_&&this.sendListen_(u)}sendGet_(t){let r=this.outstandingGets_[t];this.sendRequest("g",r.request,i=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),r.onComplete&&r.onComplete(i)})}sendListen_(t){let r=t.query,i=r._path.toString(),s=r._queryIdentifier;this.log_("Listen on "+i+" for "+s);let o={p:i},a="q";t.tag&&(o.q=r._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest(a,o,u=>{let c=u.d,d=u.s;n.warnOnListenWarnings_(c,r),(this.listens.get(i)&&this.listens.get(i).get(s))===t&&(this.log_("listen response",u),d!=="ok"&&this.removeListen_(i,s),t.onComplete&&t.onComplete(d,c))})}static warnOnListenWarnings_(t,r){if(t&&typeof t=="object"&&yt(t,"w")){let i=Tn(t,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){let s='".indexOn": "'+r._queryParams.getIndex().toString()+'"',o=r._path.toString();$e(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${s} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||s_(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=R_)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let t=this.authToken_,r=i_(t)?"auth":"gauth",i={cred:t};this.authOverride_===null?i.noauth=!0:typeof this.authOverride_=="object"&&(i.authvar=this.authOverride_),this.sendRequest(r,i,s=>{let o=s.s,a=s.d||"error";this.authToken_===t&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,a))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{let r=t.s,i=t.d||"error";r==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(r,i)})}unlisten(t,r){let i=t._path.toString(),s=t._queryIdentifier;this.log_("Unlisten called for "+i+" "+s),O(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,s)&&this.connected_&&this.sendUnlisten_(i,s,t._queryObject,r)}sendUnlisten_(t,r,i,s){this.log_("Unlisten on "+t+" for "+r);let o={p:t},a="n";s&&(o.q=i,o.t=s),this.sendRequest(a,o)}onDisconnectPut(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:r,onComplete:i})}onDisconnectMerge(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:r,onComplete:i})}onDisconnectCancel(t,r){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,r):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:r})}sendOnDisconnect_(t,r,i,s){let o={p:r,d:i};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,a=>{s&&setTimeout(()=>{s(a.s,a.d)},Math.floor(0))})}put(t,r,i,s){this.putInternal("p",t,r,i,s)}merge(t,r,i,s){this.putInternal("m",t,r,i,s)}putInternal(t,r,i,s,o){this.initConnection_();let a={p:r,d:i};o!==void 0&&(a.h=o),this.outstandingPuts_.push({action:t,request:a,onComplete:s}),this.outstandingPutCount_++;let u=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(u):this.log_("Buffering put: "+r)}sendPut_(t){let r=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,s=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(r,i,o=>{this.log_(r+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),s&&s(o.s,o.d)})}reportStats(t){if(this.connected_){let r={c:t};this.log_("reportStats",r),this.sendRequest("s",r,i=>{if(i.s!=="ok"){let o=i.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+Ne(t));let r=t.r,i=this.requestCBHash_[r];i&&(delete this.requestCBHash_[r],i(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,r){this.log_("handleServerMessage",t,r),t==="d"?this.onDataUpdate_(r.p,r.d,!1,r.t):t==="m"?this.onDataUpdate_(r.p,r.d,!0,r.t):t==="c"?this.onListenRevoked_(r.p,r.q):t==="ac"?this.onAuthRevoked_(r.s,r.d):t==="apc"?this.onAppCheckRevoked_(r.s,r.d):t==="sd"?this.onSecurityDebugPacket_(r):Qc("Unrecognized action received from server: "+Ne(t)+`
Are you using the latest client?`)}onReady_(t,r){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=r,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){O(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Bs,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=Bs,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>LS&&(this.reconnectDelay_=Bs),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let t=new Date().getTime()-this.lastConnectionAttemptTime_,r=Math.max(0,this.reconnectDelay_-t);r=Math.random()*r,this.log_("Trying to reconnect in "+r+"ms"),this.scheduleConnect_(r),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*MS)}this.onConnectStatus_(!1)}establishConnection_(){return D(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),r=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),s=this.id+":"+n.nextConnectionId_++,o=this.lastSessionId,a=!1,u=null,c=function(){u?u.close():(a=!0,i())},d=function(p){O(u,"sendRequest call when we're not connected not allowed."),u.sendRequest(p)};this.realtime_={close:c,sendRequest:d};let m=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[p,y]=yield Promise.all([this.authTokenProvider_.getToken(m),this.appCheckTokenProvider_.getToken(m)]);a?Be("getToken() completed but was canceled"):(Be("getToken() completed. Creating connection."),this.authToken_=p&&p.accessToken,this.appCheckToken_=y&&y.token,u=new eh(s,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,r,i,A=>{$e(A+" ("+this.repoInfo_.toString()+")"),this.interrupt(US)},o))}catch(p){this.log_("Failed to get token: "+p),a||(this.repoInfo_.nodeAdmin&&$e(p),c())}}})}interrupt(t){Be("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){Be("Resuming connection for reason: "+t),delete this.interruptReasons_[t],Va(this.interruptReasons_)&&(this.reconnectDelay_=Bs,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){let r=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:r})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){let r=this.outstandingPuts_[t];r&&"h"in r.request&&r.queued&&(r.onComplete&&r.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,r){let i;r?i=r.map(o=>Yh(o)).join("$"):i="default";let s=this.removeListen_(t,i);s&&s.onComplete&&s.onComplete("permission_denied")}removeListen_(t,r){let i=new ue(t).toString(),s;if(this.listens.has(i)){let o=this.listens.get(i);s=o.get(r),o.delete(r),o.size===0&&this.listens.delete(i)}else s=void 0;return s}onAuthRevoked_(t,r){Be("Auth token revoked: "+t+"/"+r),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=P_&&(this.reconnectDelay_=R_,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,r){Be("App check token revoked: "+t+"/"+r),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=P_&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let t of this.listens.values())for(let r of t.values())this.sendListen_(r);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){let t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){let t={},r="js";Ft()&&(this.repoInfo_.nodeAdmin?r="admin_node":r="node"),t["sdk."+r+"."+$h.replace(/\./g,"-")]=1,Pc()?t["framework.cordova"]=1:t_()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){let t=Ka.getInstance().currentlyOnline();return Va(this.interruptReasons_)&&t}}n.nextPersistentConnectionId_=0,n.nextConnectionId_=0;return n})(),te=class n{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new n(e,t)}};var si=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let r=new te(bn,e),i=new te(bn,t);return this.compare(r,i)!==0}minPost(){return te.MIN}};var La,za=class extends si{static get __EMPTY_NODE(){return La}static set __EMPTY_NODE(e){La=e}compare(e,t){return ur(e.name,t.name)}isDefinedOn(e){throw zr("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return te.MIN}maxPost(){return new te(on,La)}makePost(e,t){return O(typeof e=="string","KeyIndex indexValue must always be a string."),new te(e,La)}toString(){return".key"}},Bt=new za;var ri=class{constructor(e,t,r,i,s=null){this.isReverse_=i,this.resultGenerator_=s,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?r(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},Rt=(()=>{class n{constructor(t,r,i,s,o){this.key=t,this.value=r,this.color=i??n.RED,this.left=s??Et.EMPTY_NODE,this.right=o??Et.EMPTY_NODE}copy(t,r,i,s,o){return new n(t??this.key,r??this.value,i??this.color,s??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,r,i){let s=this,o=i(t,s.key);return o<0?s=s.copy(null,null,null,s.left.insert(t,r,i),null):o===0?s=s.copy(null,r,null,null,null):s=s.copy(null,null,null,null,s.right.insert(t,r,i)),s.fixUp_()}removeMin_(){if(this.left.isEmpty())return Et.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,r){let i,s;if(i=this,r(t,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(t,r),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),r(t,i.key)===0){if(i.right.isEmpty())return Et.EMPTY_NODE;s=i.right.min_(),i=i.copy(s.key,s.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(t,r))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let t=this.left.copy(null,null,!this.left.color,null,null),r=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,r)}checkMaxDepth_(){let t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})(),rh=class{copy(e,t,r,i,s){return this}insert(e,t,r){return new Rt(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},Et=class n{constructor(e,t=n.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new n(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,Rt.BLACK,null,null))}remove(e){return new n(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,Rt.BLACK,null,null))}get(e){let t,r=this.root_;for(;!r.isEmpty();){if(t=this.comparator_(e,r.key),t===0)return r.value;t<0?r=r.left:t>0&&(r=r.right)}return null}getPredecessorKey(e){let t,r=this.root_,i=null;for(;!r.isEmpty();)if(t=this.comparator_(e,r.key),t===0){if(r.left.isEmpty())return i?i.key:null;for(r=r.left;!r.right.isEmpty();)r=r.right;return r.key}else t<0?r=r.left:t>0&&(i=r,r=r.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new ri(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new ri(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new ri(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new ri(this.root_,null,this.comparator_,!0,e)}};Et.EMPTY_NODE=new rh;function BS(n,e){return ur(n.name,e.name)}function td(n,e){return ur(n,e)}var ih;function qS(n){ih=n}var _y=function(n){return typeof n=="number"?"number:"+X_(n):"string:"+n},yy=function(n){if(n.isLeafNode()){let e=n.val();O(typeof e=="string"||typeof e=="number"||typeof e=="object"&&yt(e,".sv"),"Priority must be a string or number.")}else O(n===ih||n.isEmpty(),"priority of unexpected type.");O(n===ih||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var x_,oi=(()=>{class n{constructor(t,r=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=r,this.lazyHash_=null,O(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),yy(this.priorityNode_)}static set __childrenNodeConstructor(t){x_=t}static get __childrenNodeConstructor(){return x_}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return ee(t)?this:Z(t)===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,r){return null}updateImmediateChild(t,r){return t===".priority"?this.updatePriority(r):r.isEmpty()&&t!==".priority"?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,r).updatePriority(this.priorityNode_)}updateChild(t,r){let i=Z(t);return i===null?r:r.isEmpty()&&i!==".priority"?this:(O(i!==".priority"||Rn(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(i,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(fe(t),r)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,r){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+_y(this.priorityNode_.val())+":");let r=typeof this.value_;t+=r+":",r==="number"?t+=X_(this.value_):t+=this.value_,this.lazyHash_=H_(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:(O(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){let r=typeof t.value_,i=typeof this.value_,s=n.VALUE_TYPE_ORDER.indexOf(r),o=n.VALUE_TYPE_ORDER.indexOf(i);return O(s>=0,"Unknown leaf type: "+r),O(o>=0,"Unknown leaf type: "+i),s===o?i==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-s}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){let r=t;return this.value_===r.value_&&this.priorityNode_.equals(r.priorityNode_)}else return!1}}n.VALUE_TYPE_ORDER=["object","boolean","number","string"];return n})(),vy,wy;function jS(n){vy=n}function GS(n){wy=n}var sh=class extends si{compare(e,t){let r=e.node.getPriority(),i=t.node.getPriority(),s=r.compareTo(i);return s===0?ur(e.name,t.name):s}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return te.MIN}maxPost(){return new te(on,new oi("[PRIORITY-POST]",wy))}makePost(e,t){let r=vy(e);return new te(t,new oi("[PRIORITY-POST]",r))}toString(){return".priority"}},pe=new sh;var KS=Math.log(2),oh=class{constructor(e){let t=s=>parseInt(Math.log(s)/KS,10),r=s=>parseInt(Array(s+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;let i=r(this.count);this.bits_=e+1&i}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},Wa=function(n,e,t,r){n.sort(e);let i=function(u,c){let d=c-u,m,p;if(d===0)return null;if(d===1)return m=n[u],p=t?t(m):m,new Rt(p,m.node,Rt.BLACK,null,null);{let y=parseInt(d/2,10)+u,A=i(u,y),x=i(y+1,c);return m=n[y],p=t?t(m):m,new Rt(p,m.node,Rt.BLACK,A,x)}},s=function(u){let c=null,d=null,m=n.length,p=function(A,x){let N=m-A,q=m;m-=A;let j=i(N+1,q),F=n[N],W=t?t(F):F;y(new Rt(W,F.node,x,null,j))},y=function(A){c?(c.left=A,c=A):(d=A,c=A)};for(let A=0;A<u.count;++A){let x=u.nextBitIsOne(),N=Math.pow(2,u.count-(A+1));x?p(N,Rt.BLACK):(p(N,Rt.BLACK),p(N,Rt.RED))}return d},o=new oh(n.length),a=s(o);return new Et(r||e,a)};var Bc,ti={},ai=class n{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return O(ti&&pe,"ChildrenNode.ts has not been loaded"),Bc=Bc||new n({".priority":ti},{".priority":pe}),Bc}get(e){let t=Tn(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof Et?t:null}hasIndex(e){return yt(this.indexSet_,e.toString())}addIndex(e,t){O(e!==Bt,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let r=[],i=!1,s=t.getIterator(te.Wrap),o=s.getNext();for(;o;)i=i||e.isDefinedOn(o.node),r.push(o),o=s.getNext();let a;i?a=Wa(r,e.getCompare()):a=ti;let u=e.toString(),c=Object.assign({},this.indexSet_);c[u]=e;let d=Object.assign({},this.indexes_);return d[u]=a,new n(d,c)}addToIndexes(e,t){let r=Ps(this.indexes_,(i,s)=>{let o=Tn(this.indexSet_,s);if(O(o,"Missing index implementation for "+s),i===ti)if(o.isDefinedOn(e.node)){let a=[],u=t.getIterator(te.Wrap),c=u.getNext();for(;c;)c.name!==e.name&&a.push(c),c=u.getNext();return a.push(e),Wa(a,o.getCompare())}else return ti;else{let a=t.get(e.name),u=i;return a&&(u=u.remove(new te(e.name,a))),u.insert(e,e.node)}});return new n(r,this.indexSet_)}removeFromIndexes(e,t){let r=Ps(this.indexes_,i=>{if(i===ti)return i;{let s=t.get(e.name);return s?i.remove(new te(e.name,s)):i}});return new n(r,this.indexSet_)}};var qs,J=(()=>{class n{constructor(t,r,i){this.children_=t,this.priorityNode_=r,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&yy(this.priorityNode_),this.children_.isEmpty()&&O(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return qs||(qs=new n(new Et(td),null,ai.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||qs}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{let r=this.children_.get(t);return r===null?qs:r}}getChild(t){let r=Z(t);return r===null?this:this.getImmediateChild(r).getChild(fe(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,r){if(O(r,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(r);{let i=new te(t,r),s,o;r.isEmpty()?(s=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(i,this.children_)):(s=this.children_.insert(t,r),o=this.indexMap_.addToIndexes(i,this.children_));let a=s.isEmpty()?qs:this.priorityNode_;return new n(s,a,o)}}updateChild(t,r){let i=Z(t);if(i===null)return r;{O(Z(t)!==".priority"||Rn(t)===1,".priority must be the last token in a path");let s=this.getImmediateChild(i).updateChild(fe(t),r);return this.updateImmediateChild(i,s)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let r={},i=0,s=0,o=!0;if(this.forEachChild(pe,(a,u)=>{r[a]=u.val(t),i++,o&&n.INTEGER_REGEXP_.test(a)?s=Math.max(s,Number(a)):o=!1}),!t&&o&&s<2*i){let a=[];for(let u in r)a[u]=r[u];return a}else return t&&!this.getPriority().isEmpty()&&(r[".priority"]=this.getPriority().val()),r}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+_y(this.getPriority().val())+":"),this.forEachChild(pe,(r,i)=>{let s=i.hash();s!==""&&(t+=":"+r+":"+s)}),this.lazyHash_=t===""?"":H_(t)}return this.lazyHash_}getPredecessorChildName(t,r,i){let s=this.resolveIndex_(i);if(s){let o=s.getPredecessorKey(new te(t,r));return o?o.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.minKey();return i&&i.name}else return this.children_.minKey()}getFirstChild(t){let r=this.getFirstChildName(t);return r?new te(r,this.children_.get(r)):null}getLastChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.maxKey();return i&&i.name}else return this.children_.maxKey()}getLastChild(t){let r=this.getLastChildName(t);return r?new te(r,this.children_.get(r)):null}forEachChild(t,r){let i=this.resolveIndex_(t);return i?i.inorderTraversal(s=>r(s.name,s.node)):this.children_.inorderTraversal(r)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getIteratorFrom(t,s=>s);{let s=this.children_.getIteratorFrom(t.name,te.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)<0;)s.getNext(),o=s.peek();return s}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getReverseIteratorFrom(t,s=>s);{let s=this.children_.getReverseIteratorFrom(t.name,te.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)>0;)s.getNext(),o=s.peek();return s}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===co?-1:0}withIndex(t){if(t===Bt||this.indexMap_.hasIndex(t))return this;{let r=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,r)}}isIndexed(t){return t===Bt||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{let r=t;if(this.getPriority().equals(r.getPriority()))if(this.children_.count()===r.children_.count()){let i=this.getIterator(pe),s=r.getIterator(pe),o=i.getNext(),a=s.getNext();for(;o&&a;){if(o.name!==a.name||!o.node.equals(a.node))return!1;o=i.getNext(),a=s.getNext()}return o===null&&a===null}else return!1;else return!1}}resolveIndex_(t){return t===Bt?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})(),ah=class extends J{constructor(){super(new Et(td),J.EMPTY_NODE,ai.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return J.EMPTY_NODE}isEmpty(){return!1}},co=new ah;Object.defineProperties(te,{MIN:{value:new te(bn,J.EMPTY_NODE)},MAX:{value:new te(on,co)}});za.__EMPTY_NODE=J.EMPTY_NODE;oi.__childrenNodeConstructor=J;qS(co);GS(co);var zS=!0;function Ie(n,e=null){if(n===null)return J.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),O(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){let t=n;return new oi(t,Ie(e))}if(!(n instanceof Array)&&zS){let t=[],r=!1;if(qe(n,(o,a)=>{if(o.substring(0,1)!=="."){let u=Ie(a);u.isEmpty()||(r=r||!u.getPriority().isEmpty(),t.push(new te(o,u)))}}),t.length===0)return J.EMPTY_NODE;let s=Wa(t,BS,o=>o.name,td);if(r){let o=Wa(t,pe.getCompare());return new J(s,Ie(e),new ai({".priority":o},{".priority":pe}))}else return new J(s,Ie(e),ai.Default)}else{let t=J.EMPTY_NODE;return qe(n,(r,i)=>{if(yt(n,r)&&r.substring(0,1)!=="."){let s=Ie(i);(s.isLeafNode()||!s.isEmpty())&&(t=t.updateImmediateChild(r,s))}}),t.updatePriority(Ie(e))}}jS(Ie);var Ys=class extends si{constructor(e){super(),this.indexPath_=e,O(!ee(e)&&Z(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let r=this.extractChild(e.node),i=this.extractChild(t.node),s=r.compareTo(i);return s===0?ur(e.name,t.name):s}makePost(e,t){let r=Ie(e),i=J.EMPTY_NODE.updateChild(this.indexPath_,r);return new te(t,i)}maxPost(){let e=J.EMPTY_NODE.updateChild(this.indexPath_,co);return new te(on,e)}toString(){return Hs(this.indexPath_,0).join("/")}};var lh=class extends si{compare(e,t){let r=e.node.compareTo(t.node);return r===0?ur(e.name,t.name):r}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return te.MIN}maxPost(){return te.MAX}makePost(e,t){let r=Ie(e);return new te(t,r)}toString(){return".value"}},nd=new lh;function Ey(n){return{type:"value",snapshotNode:n}}function li(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function Js(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Xs(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function WS(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}var Zs=class{constructor(e){this.index_=e}updateChild(e,t,r,i,s,o){O(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let a=e.getImmediateChild(t);return a.getChild(i).equals(r.getChild(i))&&a.isEmpty()===r.isEmpty()||(o!=null&&(r.isEmpty()?e.hasChild(t)?o.trackChildChange(Js(t,a)):O(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(li(t,r)):o.trackChildChange(Xs(t,r,a))),e.isLeafNode()&&r.isEmpty())?e:e.updateImmediateChild(t,r).withIndex(this.index_)}updateFullNode(e,t,r){return r!=null&&(e.isLeafNode()||e.forEachChild(pe,(i,s)=>{t.hasChild(i)||r.trackChildChange(Js(i,s))}),t.isLeafNode()||t.forEachChild(pe,(i,s)=>{if(e.hasChild(i)){let o=e.getImmediateChild(i);o.equals(s)||r.trackChildChange(Xs(i,s,o))}else r.trackChildChange(li(i,s))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?J.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var Qa=class n{constructor(e){this.indexedFilter_=new Zs(e.getIndex()),this.index_=e.getIndex(),this.startPost_=n.getStartPost_(e),this.endPost_=n.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,r=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&r}updateChild(e,t,r,i,s,o){return this.matches(new te(t,r))||(r=J.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,r,i,s,o)}updateFullNode(e,t,r){t.isLeafNode()&&(t=J.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(J.EMPTY_NODE);let s=this;return t.forEachChild(pe,(o,a)=>{s.matches(new te(o,a))||(i=i.updateImmediateChild(o,J.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}};var uh=class{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{let r=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?r<=0:r<0},this.withinEndPost=t=>{let r=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?r<=0:r<0},this.rangedFilter_=new Qa(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,r,i,s,o){return this.rangedFilter_.matches(new te(t,r))||(r=J.EMPTY_NODE),e.getImmediateChild(t).equals(r)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,r,i,s,o):this.fullLimitUpdateChild_(e,t,r,s,o)}updateFullNode(e,t,r){let i;if(t.isLeafNode()||t.isEmpty())i=J.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=J.EMPTY_NODE.withIndex(this.index_);let s;this.reverse_?s=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):s=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;s.hasNext()&&o<this.limit_;){let a=s.getNext();if(this.withinDirectionalStart(a))if(this.withinDirectionalEnd(a))i=i.updateImmediateChild(a.name,a.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority(J.EMPTY_NODE);let s;this.reverse_?s=i.getReverseIterator(this.index_):s=i.getIterator(this.index_);let o=0;for(;s.hasNext();){let a=s.getNext();o<this.limit_&&this.withinDirectionalStart(a)&&this.withinDirectionalEnd(a)?o++:i=i.updateImmediateChild(a.name,J.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,r,i,s){let o;if(this.reverse_){let m=this.index_.getCompare();o=(p,y)=>m(y,p)}else o=this.index_.getCompare();let a=e;O(a.numChildren()===this.limit_,"");let u=new te(t,r),c=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),d=this.rangedFilter_.matches(u);if(a.hasChild(t)){let m=a.getImmediateChild(t),p=i.getChildAfterChild(this.index_,c,this.reverse_);for(;p!=null&&(p.name===t||a.hasChild(p.name));)p=i.getChildAfterChild(this.index_,p,this.reverse_);let y=p==null?1:o(p,u);if(d&&!r.isEmpty()&&y>=0)return s?.trackChildChange(Xs(t,r,m)),a.updateImmediateChild(t,r);{s?.trackChildChange(Js(t,m));let x=a.updateImmediateChild(t,J.EMPTY_NODE);return p!=null&&this.rangedFilter_.matches(p)?(s?.trackChildChange(li(p.name,p.node)),x.updateImmediateChild(p.name,p.node)):x}}else return r.isEmpty()?e:d&&o(c,u)>=0?(s!=null&&(s.trackChildChange(Js(c.name,c.node)),s.trackChildChange(li(t,r))),a.updateImmediateChild(t,r).updateImmediateChild(c.name,J.EMPTY_NODE)):e}};var eo=class n{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=pe}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return O(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return O(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:bn}hasEnd(){return this.endSet_}getIndexEndValue(){return O(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return O(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:on}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return O(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===pe}copy(){let e=new n;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function QS(n){return n.loadsAllData()?new Zs(n.getIndex()):n.hasLimit()?new uh(n):new Qa(n)}function $S(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}function HS(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}function ch(n,e,t){let r=n.copy();return r.startSet_=!0,e===void 0&&(e=null),r.indexStartValue_=e,t!=null?(r.startNameSet_=!0,r.indexStartName_=t):(r.startNameSet_=!1,r.indexStartName_=""),r}function YS(n,e,t){let r;return n.index_===Bt||t?r=ch(n,e,t):r=ch(n,e,on),r.startAfterSet_=!0,r}function hh(n,e,t){let r=n.copy();return r.endSet_=!0,e===void 0&&(e=null),r.indexEndValue_=e,t!==void 0?(r.endNameSet_=!0,r.indexEndName_=t):(r.endNameSet_=!1,r.indexEndName_=""),r}function JS(n,e,t){let r;return n.index_===Bt||t?r=hh(n,e,t):r=hh(n,e,bn),r.endBeforeSet_=!0,r}function dl(n,e){let t=n.copy();return t.index_=e,t}function N_(n){let e={};if(n.isDefault())return e;let t;if(n.index_===pe?t="$priority":n.index_===nd?t="$value":n.index_===Bt?t="$key":(O(n.index_ instanceof Ys,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=Ne(t),n.startSet_){let r=n.startAfterSet_?"startAfter":"startAt";e[r]=Ne(n.indexStartValue_),n.startNameSet_&&(e[r]+=","+Ne(n.indexStartName_))}if(n.endSet_){let r=n.endBeforeSet_?"endBefore":"endAt";e[r]=Ne(n.indexEndValue_),n.endNameSet_&&(e[r]+=","+Ne(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function D_(n){let e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==pe&&(e.i=n.index_.toString()),e}var dh=class n extends ja{constructor(e,t,r,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=r,this.appCheckTokenProvider_=i,this.log_=uo("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(O(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,r,i){let s=e._path.toString();this.log_("Listen called for "+s+" "+e._queryIdentifier);let o=n.getListenId_(e,r),a={};this.listens_[o]=a;let u=N_(e._queryParams);this.restRequest_(s+".json",u,(c,d)=>{let m=d;if(c===404&&(m=null,c=null),c===null&&this.onDataUpdate_(s,m,!1,r),Tn(this.listens_,o)===a){let p;c?c===401?p="permission_denied":p="rest_error:"+c:p="ok",i(p,null)}})}unlisten(e,t){let r=n.getListenId_(e,t);delete this.listens_[r]}get(e){let t=N_(e._queryParams),r=e._path.toString(),i=new et;return this.restRequest_(r+".json",t,(s,o)=>{let a=o;s===404&&(a=null,s=null),s===null?(this.onDataUpdate_(r,a,!1,null),i.resolve(a)):i.reject(new Error(a))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},r){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,s])=>{i&&i.accessToken&&(t.auth=i.accessToken),s&&s.token&&(t.ac=s.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+o_(t);this.log_("Sending REST request for "+o);let a=new XMLHttpRequest;a.onreadystatechange=()=>{if(r&&a.readyState===4){this.log_("REST Response for "+o+" received. status:",a.status,"response:",a.responseText);let u=null;if(a.status>=200&&a.status<300){try{u=ka(a.responseText)}catch{$e("Failed to parse JSON response for "+o+": "+a.responseText)}r(null,u)}else a.status!==401&&a.status!==404&&$e("Got unsuccessful REST response for "+o+" Status: "+a.status),r(a.status);r=null}},a.open("GET",o,!0),a.send()})}};var fh=class{constructor(){this.rootNode_=J.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function $a(){return{value:null,children:new Map}}function mi(n,e,t){if(ee(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{let r=Z(e);n.children.has(r)||n.children.set(r,$a());let i=n.children.get(r);e=fe(e),mi(i,e,t)}}function mh(n,e){if(ee(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{let t=n.value;return n.value=null,t.forEachChild(pe,(r,i)=>{mi(n,new ue(r),i)}),mh(n,e)}}else if(n.children.size>0){let t=Z(e);return e=fe(e),n.children.has(t)&&mh(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function ph(n,e,t){n.value!==null?t(e,n.value):XS(n,(r,i)=>{let s=new ue(e.toString()+"/"+r);ph(i,s,t)})}function XS(n,e){n.children.forEach((t,r)=>{e(r,t)})}var gh=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t=Object.assign({},e);return this.last_&&qe(this.last_,(r,i)=>{t[r]=t[r]-i}),this.last_=e,t}};var k_=10*1e3,ZS=30*1e3,eA=5*60*1e3,_h=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new gh(e);let r=k_+(ZS-k_)*Math.random();Gs(this.reportStats_.bind(this),Math.floor(r))}reportStats_(){let e=this.statsListener_.get(),t={},r=!1;qe(e,(i,s)=>{s>0&&yt(this.statsToReport_,i)&&(t[i]=s,r=!0)}),r&&this.server_.reportStats(t),Gs(this.reportStats_.bind(this),Math.floor(Math.random()*2*eA))}};var Ut=function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n}(Ut||{});function rd(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function id(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function sd(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}var yh=class n{constructor(e,t,r){this.path=e,this.affectedTree=t,this.revert=r,this.type=Ut.ACK_USER_WRITE,this.source=rd()}operationForChild(e){if(ee(this.path)){if(this.affectedTree.value!=null)return O(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let t=this.affectedTree.subtree(new ue(e));return new n(le(),t,this.revert)}}else return O(Z(this.path)===e,"operationForChild called for unrelated child."),new n(fe(this.path),this.affectedTree,this.revert)}};var Ha=class n{constructor(e,t){this.source=e,this.path=t,this.type=Ut.LISTEN_COMPLETE}operationForChild(e){return ee(this.path)?new n(this.source,le()):new n(this.source,fe(this.path))}};var ui=class n{constructor(e,t,r){this.source=e,this.path=t,this.snap=r,this.type=Ut.OVERWRITE}operationForChild(e){return ee(this.path)?new n(this.source,le(),this.snap.getImmediateChild(e)):new n(this.source,fe(this.path),this.snap)}};var to=class n{constructor(e,t,r){this.source=e,this.path=t,this.children=r,this.type=Ut.MERGE}operationForChild(e){if(ee(this.path)){let t=this.children.subtree(new ue(e));return t.isEmpty()?null:t.value?new ui(this.source,le(),t.value):new n(this.source,le(),t)}else return O(Z(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new n(this.source,fe(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var jt=class{constructor(e,t,r){this.node_=e,this.fullyInitialized_=t,this.filtered_=r}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(ee(e))return this.isFullyInitialized()&&!this.filtered_;let t=Z(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var vh=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function tA(n,e,t,r){let i=[],s=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&s.push(WS(o.childName,o.snapshotNode))}),js(n,i,"child_removed",e,r,t),js(n,i,"child_added",e,r,t),js(n,i,"child_moved",s,r,t),js(n,i,"child_changed",e,r,t),js(n,i,"value",e,r,t),i}function js(n,e,t,r,i,s){let o=r.filter(a=>a.type===t);o.sort((a,u)=>rA(n,a,u)),o.forEach(a=>{let u=nA(n,a,s);i.forEach(c=>{c.respondsTo(a.type)&&e.push(c.createEvent(u,n.query_))})})}function nA(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function rA(n,e,t){if(e.childName==null||t.childName==null)throw zr("Should only compare child_ events.");let r=new te(e.childName,e.snapshotNode),i=new te(t.childName,t.snapshotNode);return n.index_.compare(r,i)}function fl(n,e){return{eventCache:n,serverCache:e}}function zs(n,e,t,r){return fl(new jt(e,t,r),n.serverCache)}function Iy(n,e,t,r){return fl(n.eventCache,new jt(e,t,r))}function Ya(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function lr(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}var qc,iA=()=>(qc||(qc=new Et(nS)),qc),nt=class n{constructor(e,t=iA()){this.value=e,this.children=t}static fromObject(e){let t=new n(null);return qe(e,(r,i)=>{t=t.set(new ue(r),i)}),t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:le(),value:this.value};if(ee(e))return null;{let r=Z(e),i=this.children.get(r);if(i!==null){let s=i.findRootMostMatchingPathAndValue(fe(e),t);return s!=null?{path:ve(new ue(r),s.path),value:s.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(ee(e))return this;{let t=Z(e),r=this.children.get(t);return r!==null?r.subtree(fe(e)):new n(null)}}set(e,t){if(ee(e))return new n(t,this.children);{let r=Z(e),s=(this.children.get(r)||new n(null)).set(fe(e),t),o=this.children.insert(r,s);return new n(this.value,o)}}remove(e){if(ee(e))return this.children.isEmpty()?new n(null):new n(null,this.children);{let t=Z(e),r=this.children.get(t);if(r){let i=r.remove(fe(e)),s;return i.isEmpty()?s=this.children.remove(t):s=this.children.insert(t,i),this.value===null&&s.isEmpty()?new n(null):new n(this.value,s)}else return this}}get(e){if(ee(e))return this.value;{let t=Z(e),r=this.children.get(t);return r?r.get(fe(e)):null}}setTree(e,t){if(ee(e))return t;{let r=Z(e),s=(this.children.get(r)||new n(null)).setTree(fe(e),t),o;return s.isEmpty()?o=this.children.remove(r):o=this.children.insert(r,s),new n(this.value,o)}}fold(e){return this.fold_(le(),e)}fold_(e,t){let r={};return this.children.inorderTraversal((i,s)=>{r[i]=s.fold_(ve(e,i),t)}),t(e,this.value,r)}findOnPath(e,t){return this.findOnPath_(e,le(),t)}findOnPath_(e,t,r){let i=this.value?r(t,this.value):!1;if(i)return i;if(ee(e))return null;{let s=Z(e),o=this.children.get(s);return o?o.findOnPath_(fe(e),ve(t,s),r):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,le(),t)}foreachOnPath_(e,t,r){if(ee(e))return this;{this.value&&r(t,this.value);let i=Z(e),s=this.children.get(i);return s?s.foreachOnPath_(fe(e),ve(t,i),r):new n(null)}}foreach(e){this.foreach_(le(),e)}foreach_(e,t){this.children.inorderTraversal((r,i)=>{i.foreach_(ve(e,r),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,r)=>{r.value&&e(t,r.value)})}};var Pt=class n{constructor(e){this.writeTree_=e}static empty(){return new n(new nt(null))}};function Ws(n,e,t){if(ee(e))return new Pt(new nt(t));{let r=n.writeTree_.findRootMostValueAndPath(e);if(r!=null){let i=r.path,s=r.value,o=tt(i,e);return s=s.updateChild(o,t),new Pt(n.writeTree_.set(i,s))}else{let i=new nt(t),s=n.writeTree_.setTree(e,i);return new Pt(s)}}}function wh(n,e,t){let r=n;return qe(t,(i,s)=>{r=Ws(r,ve(e,i),s)}),r}function V_(n,e){if(ee(e))return Pt.empty();{let t=n.writeTree_.setTree(e,new nt(null));return new Pt(t)}}function Eh(n,e){return cr(n,e)!=null}function cr(n,e){let t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(tt(t.path,e)):null}function O_(n){let e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(pe,(r,i)=>{e.push(new te(r,i))}):n.writeTree_.children.inorderTraversal((r,i)=>{i.value!=null&&e.push(new te(r,i.value))}),e}function An(n,e){if(ee(e))return n;{let t=cr(n,e);return t!=null?new Pt(new nt(t)):new Pt(n.writeTree_.subtree(e))}}function Ih(n){return n.writeTree_.isEmpty()}function ci(n,e){return Ty(le(),n.writeTree_,e)}function Ty(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let r=null;return e.children.inorderTraversal((i,s)=>{i===".priority"?(O(s.value!==null,"Priority writes must always be leaf nodes"),r=s.value):t=Ty(ve(n,i),s,t)}),!t.getChild(n).isEmpty()&&r!==null&&(t=t.updateChild(ve(n,".priority"),r)),t}}function ml(n,e){return by(e,n)}function sA(n,e,t,r,i){O(r>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:r,visible:i}),i&&(n.visibleWrites=Ws(n.visibleWrites,e,t)),n.lastWriteId=r}function oA(n,e,t,r){O(r>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:r,visible:!0}),n.visibleWrites=wh(n.visibleWrites,e,t),n.lastWriteId=r}function aA(n,e){for(let t=0;t<n.allWrites.length;t++){let r=n.allWrites[t];if(r.writeId===e)return r}return null}function lA(n,e){let t=n.allWrites.findIndex(a=>a.writeId===e);O(t>=0,"removeWrite called with nonexistent writeId.");let r=n.allWrites[t];n.allWrites.splice(t,1);let i=r.visible,s=!1,o=n.allWrites.length-1;for(;i&&o>=0;){let a=n.allWrites[o];a.visible&&(o>=t&&uA(a,r.path)?i=!1:wt(r.path,a.path)&&(s=!0)),o--}if(i){if(s)return cA(n),!0;if(r.snap)n.visibleWrites=V_(n.visibleWrites,r.path);else{let a=r.children;qe(a,u=>{n.visibleWrites=V_(n.visibleWrites,ve(r.path,u))})}return!0}else return!1}function uA(n,e){if(n.snap)return wt(n.path,e);for(let t in n.children)if(n.children.hasOwnProperty(t)&&wt(ve(n.path,t),e))return!0;return!1}function cA(n){n.visibleWrites=Sy(n.allWrites,hA,le()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function hA(n){return n.visible}function Sy(n,e,t){let r=Pt.empty();for(let i=0;i<n.length;++i){let s=n[i];if(e(s)){let o=s.path,a;if(s.snap)wt(t,o)?(a=tt(t,o),r=Ws(r,a,s.snap)):wt(o,t)&&(a=tt(o,t),r=Ws(r,le(),s.snap.getChild(a)));else if(s.children){if(wt(t,o))a=tt(t,o),r=wh(r,a,s.children);else if(wt(o,t))if(a=tt(o,t),ee(a))r=wh(r,le(),s.children);else{let u=Tn(s.children,Z(a));if(u){let c=u.getChild(fe(a));r=Ws(r,le(),c)}}}else throw zr("WriteRecord should have .snap or .children")}}return r}function Ay(n,e,t,r,i){if(!r&&!i){let s=cr(n.visibleWrites,e);if(s!=null)return s;{let o=An(n.visibleWrites,e);if(Ih(o))return t;if(t==null&&!Eh(o,le()))return null;{let a=t||J.EMPTY_NODE;return ci(o,a)}}}else{let s=An(n.visibleWrites,e);if(!i&&Ih(s))return t;if(!i&&t==null&&!Eh(s,le()))return null;{let o=function(c){return(c.visible||i)&&(!r||!~r.indexOf(c.writeId))&&(wt(c.path,e)||wt(e,c.path))},a=Sy(n.allWrites,o,e),u=t||J.EMPTY_NODE;return ci(a,u)}}}function dA(n,e,t){let r=J.EMPTY_NODE,i=cr(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(pe,(s,o)=>{r=r.updateImmediateChild(s,o)}),r;if(t){let s=An(n.visibleWrites,e);return t.forEachChild(pe,(o,a)=>{let u=ci(An(s,new ue(o)),a);r=r.updateImmediateChild(o,u)}),O_(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}else{let s=An(n.visibleWrites,e);return O_(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}}function fA(n,e,t,r,i){O(r||i,"Either existingEventSnap or existingServerSnap must exist");let s=ve(e,t);if(Eh(n.visibleWrites,s))return null;{let o=An(n.visibleWrites,s);return Ih(o)?i.getChild(t):ci(o,i.getChild(t))}}function mA(n,e,t,r){let i=ve(e,t),s=cr(n.visibleWrites,i);if(s!=null)return s;if(r.isCompleteForChild(t)){let o=An(n.visibleWrites,i);return ci(o,r.getNode().getImmediateChild(t))}else return null}function pA(n,e){return cr(n.visibleWrites,e)}function gA(n,e,t,r,i,s,o){let a,u=An(n.visibleWrites,e),c=cr(u,le());if(c!=null)a=c;else if(t!=null)a=ci(u,t);else return[];if(a=a.withIndex(o),!a.isEmpty()&&!a.isLeafNode()){let d=[],m=o.getCompare(),p=s?a.getReverseIteratorFrom(r,o):a.getIteratorFrom(r,o),y=p.getNext();for(;y&&d.length<i;)m(y,r)!==0&&d.push(y),y=p.getNext();return d}else return[]}function _A(){return{visibleWrites:Pt.empty(),allWrites:[],lastWriteId:-1}}function Ja(n,e,t,r){return Ay(n.writeTree,n.treePath,e,t,r)}function od(n,e){return dA(n.writeTree,n.treePath,e)}function F_(n,e,t,r){return fA(n.writeTree,n.treePath,e,t,r)}function Xa(n,e){return pA(n.writeTree,ve(n.treePath,e))}function yA(n,e,t,r,i,s){return gA(n.writeTree,n.treePath,e,t,r,i,s)}function ad(n,e,t){return mA(n.writeTree,n.treePath,e,t)}function Cy(n,e){return by(ve(n.treePath,e),n.writeTree)}function by(n,e){return{treePath:n,writeTree:e}}var Th=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,r=e.childName;O(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),O(r!==".priority","Only non-priority child changes can be tracked.");let i=this.changeMap.get(r);if(i){let s=i.type;if(t==="child_added"&&s==="child_removed")this.changeMap.set(r,Xs(r,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&s==="child_added")this.changeMap.delete(r);else if(t==="child_removed"&&s==="child_changed")this.changeMap.set(r,Js(r,i.oldSnap));else if(t==="child_changed"&&s==="child_added")this.changeMap.set(r,li(r,e.snapshotNode));else if(t==="child_changed"&&s==="child_changed")this.changeMap.set(r,Xs(r,e.snapshotNode,i.oldSnap));else throw zr("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(r,e)}getChanges(){return Array.from(this.changeMap.values())}};var Sh=class{getCompleteChild(e){return null}getChildAfterChild(e,t,r){return null}},Ry=new Sh,no=class{constructor(e,t,r=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=r}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let r=this.optCompleteServerCache_!=null?new jt(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return ad(this.writes_,e,r)}}getChildAfterChild(e,t,r){let i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:lr(this.viewCache_),s=yA(this.writes_,i,t,1,r,e);return s.length===0?null:s[0]}};function vA(n){return{filter:n}}function wA(n,e){O(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),O(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function EA(n,e,t,r,i){let s=new Th,o,a;if(t.type===Ut.OVERWRITE){let c=t;c.source.fromUser?o=Ah(n,e,c.path,c.snap,r,i,s):(O(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered()&&!ee(c.path),o=Za(n,e,c.path,c.snap,r,i,a,s))}else if(t.type===Ut.MERGE){let c=t;c.source.fromUser?o=TA(n,e,c.path,c.children,r,i,s):(O(c.source.fromServer,"Unknown source."),a=c.source.tagged||e.serverCache.isFiltered(),o=Ch(n,e,c.path,c.children,r,i,a,s))}else if(t.type===Ut.ACK_USER_WRITE){let c=t;c.revert?o=CA(n,e,c.path,r,i,s):o=SA(n,e,c.path,c.affectedTree,r,i,s)}else if(t.type===Ut.LISTEN_COMPLETE)o=AA(n,e,t.path,r,s);else throw zr("Unknown operation type: "+t.type);let u=s.getChanges();return IA(e,o,u),{viewCache:o,changes:u}}function IA(n,e,t){let r=e.eventCache;if(r.isFullyInitialized()){let i=r.getNode().isLeafNode()||r.getNode().isEmpty(),s=Ya(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!r.getNode().equals(s)||!r.getNode().getPriority().equals(s.getPriority()))&&t.push(Ey(Ya(e)))}}function Py(n,e,t,r,i,s){let o=e.eventCache;if(Xa(r,t)!=null)return e;{let a,u;if(ee(t))if(O(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let c=lr(e),d=c instanceof J?c:J.EMPTY_NODE,m=od(r,d);a=n.filter.updateFullNode(e.eventCache.getNode(),m,s)}else{let c=Ja(r,lr(e));a=n.filter.updateFullNode(e.eventCache.getNode(),c,s)}else{let c=Z(t);if(c===".priority"){O(Rn(t)===1,"Can't have a priority with additional path components");let d=o.getNode();u=e.serverCache.getNode();let m=F_(r,t,d,u);m!=null?a=n.filter.updatePriority(d,m):a=o.getNode()}else{let d=fe(t),m;if(o.isCompleteForChild(c)){u=e.serverCache.getNode();let p=F_(r,t,o.getNode(),u);p!=null?m=o.getNode().getImmediateChild(c).updateChild(d,p):m=o.getNode().getImmediateChild(c)}else m=ad(r,c,e.serverCache);m!=null?a=n.filter.updateChild(o.getNode(),c,m,d,i,s):a=o.getNode()}}return zs(e,a,o.isFullyInitialized()||ee(t),n.filter.filtersNodes())}}function Za(n,e,t,r,i,s,o,a){let u=e.serverCache,c,d=o?n.filter:n.filter.getIndexedFilter();if(ee(t))c=d.updateFullNode(u.getNode(),r,null);else if(d.filtersNodes()&&!u.isFiltered()){let y=u.getNode().updateChild(t,r);c=d.updateFullNode(u.getNode(),y,null)}else{let y=Z(t);if(!u.isCompleteForPath(t)&&Rn(t)>1)return e;let A=fe(t),N=u.getNode().getImmediateChild(y).updateChild(A,r);y===".priority"?c=d.updatePriority(u.getNode(),N):c=d.updateChild(u.getNode(),y,N,A,Ry,null)}let m=Iy(e,c,u.isFullyInitialized()||ee(t),d.filtersNodes()),p=new no(i,m,s);return Py(n,m,t,i,p,a)}function Ah(n,e,t,r,i,s,o){let a=e.eventCache,u,c,d=new no(i,e,s);if(ee(t))c=n.filter.updateFullNode(e.eventCache.getNode(),r,o),u=zs(e,c,!0,n.filter.filtersNodes());else{let m=Z(t);if(m===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),r),u=zs(e,c,a.isFullyInitialized(),a.isFiltered());else{let p=fe(t),y=a.getNode().getImmediateChild(m),A;if(ee(p))A=r;else{let x=d.getCompleteChild(m);x!=null?Xh(p)===".priority"&&x.getChild(py(p)).isEmpty()?A=x:A=x.updateChild(p,r):A=J.EMPTY_NODE}if(y.equals(A))u=e;else{let x=n.filter.updateChild(a.getNode(),m,A,p,d,o);u=zs(e,x,a.isFullyInitialized(),n.filter.filtersNodes())}}}return u}function M_(n,e){return n.eventCache.isCompleteForChild(e)}function TA(n,e,t,r,i,s,o){let a=e;return r.foreach((u,c)=>{let d=ve(t,u);M_(e,Z(d))&&(a=Ah(n,a,d,c,i,s,o))}),r.foreach((u,c)=>{let d=ve(t,u);M_(e,Z(d))||(a=Ah(n,a,d,c,i,s,o))}),a}function L_(n,e,t){return t.foreach((r,i)=>{e=e.updateChild(r,i)}),e}function Ch(n,e,t,r,i,s,o,a){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let u=e,c;ee(t)?c=r:c=new nt(null).setTree(t,r);let d=e.serverCache.getNode();return c.children.inorderTraversal((m,p)=>{if(d.hasChild(m)){let y=e.serverCache.getNode().getImmediateChild(m),A=L_(n,y,p);u=Za(n,u,new ue(m),A,i,s,o,a)}}),c.children.inorderTraversal((m,p)=>{let y=!e.serverCache.isCompleteForChild(m)&&p.value===null;if(!d.hasChild(m)&&!y){let A=e.serverCache.getNode().getImmediateChild(m),x=L_(n,A,p);u=Za(n,u,new ue(m),x,i,s,o,a)}}),u}function SA(n,e,t,r,i,s,o){if(Xa(i,t)!=null)return e;let a=e.serverCache.isFiltered(),u=e.serverCache;if(r.value!=null){if(ee(t)&&u.isFullyInitialized()||u.isCompleteForPath(t))return Za(n,e,t,u.getNode().getChild(t),i,s,a,o);if(ee(t)){let c=new nt(null);return u.getNode().forEachChild(Bt,(d,m)=>{c=c.set(new ue(d),m)}),Ch(n,e,t,c,i,s,a,o)}else return e}else{let c=new nt(null);return r.foreach((d,m)=>{let p=ve(t,d);u.isCompleteForPath(p)&&(c=c.set(d,u.getNode().getChild(p)))}),Ch(n,e,t,c,i,s,a,o)}}function AA(n,e,t,r,i){let s=e.serverCache,o=Iy(e,s.getNode(),s.isFullyInitialized()||ee(t),s.isFiltered());return Py(n,o,t,r,Ry,i)}function CA(n,e,t,r,i,s){let o;if(Xa(r,t)!=null)return e;{let a=new no(r,e,i),u=e.eventCache.getNode(),c;if(ee(t)||Z(t)===".priority"){let d;if(e.serverCache.isFullyInitialized())d=Ja(r,lr(e));else{let m=e.serverCache.getNode();O(m instanceof J,"serverChildren would be complete if leaf node"),d=od(r,m)}d=d,c=n.filter.updateFullNode(u,d,s)}else{let d=Z(t),m=ad(r,d,e.serverCache);m==null&&e.serverCache.isCompleteForChild(d)&&(m=u.getImmediateChild(d)),m!=null?c=n.filter.updateChild(u,d,m,fe(t),a,s):e.eventCache.getNode().hasChild(d)?c=n.filter.updateChild(u,d,J.EMPTY_NODE,fe(t),a,s):c=u,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=Ja(r,lr(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,s)))}return o=e.serverCache.isFullyInitialized()||Xa(r,le())!=null,zs(e,c,o,n.filter.filtersNodes())}}var bh=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let r=this.query_._queryParams,i=new Zs(r.getIndex()),s=QS(r);this.processor_=vA(s);let o=t.serverCache,a=t.eventCache,u=i.updateFullNode(J.EMPTY_NODE,o.getNode(),null),c=s.updateFullNode(J.EMPTY_NODE,a.getNode(),null),d=new jt(u,o.isFullyInitialized(),i.filtersNodes()),m=new jt(c,a.isFullyInitialized(),s.filtersNodes());this.viewCache_=fl(m,d),this.eventGenerator_=new vh(this.query_)}get query(){return this.query_}};function bA(n){return n.viewCache_.serverCache.getNode()}function RA(n){return Ya(n.viewCache_)}function PA(n,e){let t=lr(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!ee(e)&&!t.getImmediateChild(Z(e)).isEmpty())?t.getChild(e):null}function U_(n){return n.eventRegistrations_.length===0}function xA(n,e){n.eventRegistrations_.push(e)}function B_(n,e,t){let r=[];if(t){O(e==null,"A cancel should cancel all event registrations.");let i=n.query._path;n.eventRegistrations_.forEach(s=>{let o=s.createCancelEvent(t,i);o&&r.push(o)})}if(e){let i=[];for(let s=0;s<n.eventRegistrations_.length;++s){let o=n.eventRegistrations_[s];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(s+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return r}function q_(n,e,t,r){e.type===Ut.MERGE&&e.source.queryId!==null&&(O(lr(n.viewCache_),"We should always have a full cache before handling merges"),O(Ya(n.viewCache_),"Missing event cache, even though we have a server cache"));let i=n.viewCache_,s=EA(n.processor_,i,e,t,r);return wA(n.processor_,s.viewCache),O(s.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=s.viewCache,xy(n,s.changes,s.viewCache.eventCache.getNode(),null)}function NA(n,e){let t=n.viewCache_.eventCache,r=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(pe,(s,o)=>{r.push(li(s,o))}),t.isFullyInitialized()&&r.push(Ey(t.getNode())),xy(n,r,t.getNode(),e)}function xy(n,e,t,r){let i=r?[r]:n.eventRegistrations_;return tA(n.eventGenerator_,e,t,i)}var el,tl=class{constructor(){this.views=new Map}};function DA(n){O(!el,"__referenceConstructor has already been defined"),el=n}function kA(){return O(el,"Reference.ts has not been loaded"),el}function VA(n){return n.views.size===0}function ld(n,e,t,r){let i=e.source.queryId;if(i!==null){let s=n.views.get(i);return O(s!=null,"SyncTree gave us an op for an invalid query."),q_(s,e,t,r)}else{let s=[];for(let o of n.views.values())s=s.concat(q_(o,e,t,r));return s}}function Ny(n,e,t,r,i){let s=e._queryIdentifier,o=n.views.get(s);if(!o){let a=Ja(t,i?r:null),u=!1;a?u=!0:r instanceof J?(a=od(t,r),u=!1):(a=J.EMPTY_NODE,u=!1);let c=fl(new jt(a,u,!1),new jt(r,i,!1));return new bh(e,c)}return o}function OA(n,e,t,r,i,s){let o=Ny(n,e,r,i,s);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),xA(o,t),NA(o,t)}function FA(n,e,t,r){let i=e._queryIdentifier,s=[],o=[],a=Pn(n);if(i==="default")for(let[u,c]of n.views.entries())o=o.concat(B_(c,t,r)),U_(c)&&(n.views.delete(u),c.query._queryParams.loadsAllData()||s.push(c.query));else{let u=n.views.get(i);u&&(o=o.concat(B_(u,t,r)),U_(u)&&(n.views.delete(i),u.query._queryParams.loadsAllData()||s.push(u.query)))}return a&&!Pn(n)&&s.push(new(kA())(e._repo,e._path)),{removed:s,events:o}}function Dy(n){let e=[];for(let t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function Cn(n,e){let t=null;for(let r of n.views.values())t=t||PA(r,e);return t}function ky(n,e){if(e._queryParams.loadsAllData())return pl(n);{let r=e._queryIdentifier;return n.views.get(r)}}function Vy(n,e){return ky(n,e)!=null}function Pn(n){return pl(n)!=null}function pl(n){for(let e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var nl;function MA(n){O(!nl,"__referenceConstructor has already been defined"),nl=n}function LA(){return O(nl,"Reference.ts has not been loaded"),nl}var UA=1,rl=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new nt(null),this.pendingWriteTree_=_A(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function ud(n,e,t,r,i){return sA(n.pendingWriteTree_,e,t,r,i),i?pi(n,new ui(rd(),e,t)):[]}function BA(n,e,t,r){oA(n.pendingWriteTree_,e,t,r);let i=nt.fromObject(t);return pi(n,new to(rd(),e,i))}function Sn(n,e,t=!1){let r=aA(n.pendingWriteTree_,e);if(lA(n.pendingWriteTree_,e)){let s=new nt(null);return r.snap!=null?s=s.set(le(),!0):qe(r.children,o=>{s=s.set(new ue(o),!0)}),pi(n,new yh(r.path,s,t))}else return[]}function ho(n,e,t){return pi(n,new ui(id(),e,t))}function qA(n,e,t){let r=nt.fromObject(t);return pi(n,new to(id(),e,r))}function jA(n,e){return pi(n,new Ha(id(),e))}function GA(n,e,t){let r=cd(n,t);if(r){let i=hd(r),s=i.path,o=i.queryId,a=tt(s,e),u=new Ha(sd(o),a);return dd(n,s,u)}else return[]}function il(n,e,t,r,i=!1){let s=e._path,o=n.syncPointTree_.get(s),a=[];if(o&&(e._queryIdentifier==="default"||Vy(o,e))){let u=FA(o,e,t,r);VA(o)&&(n.syncPointTree_=n.syncPointTree_.remove(s));let c=u.removed;if(a=u.events,!i){let d=c.findIndex(p=>p._queryParams.loadsAllData())!==-1,m=n.syncPointTree_.findOnPath(s,(p,y)=>Pn(y));if(d&&!m){let p=n.syncPointTree_.subtree(s);if(!p.isEmpty()){let y=WA(p);for(let A=0;A<y.length;++A){let x=y[A],N=x.query,q=Ly(n,x);n.listenProvider_.startListening(Qs(N),ro(n,N),q.hashFn,q.onComplete)}}}!m&&c.length>0&&!r&&(d?n.listenProvider_.stopListening(Qs(e),null):c.forEach(p=>{let y=n.queryToTagMap.get(_l(p));n.listenProvider_.stopListening(Qs(p),y)}))}QA(n,c)}return a}function Oy(n,e,t,r){let i=cd(n,r);if(i!=null){let s=hd(i),o=s.path,a=s.queryId,u=tt(o,e),c=new ui(sd(a),u,t);return dd(n,o,c)}else return[]}function KA(n,e,t,r){let i=cd(n,r);if(i){let s=hd(i),o=s.path,a=s.queryId,u=tt(o,e),c=nt.fromObject(t),d=new to(sd(a),u,c);return dd(n,o,d)}else return[]}function Rh(n,e,t,r=!1){let i=e._path,s=null,o=!1;n.syncPointTree_.foreachOnPath(i,(p,y)=>{let A=tt(p,i);s=s||Cn(y,A),o=o||Pn(y)});let a=n.syncPointTree_.get(i);a?(o=o||Pn(a),s=s||Cn(a,le())):(a=new tl,n.syncPointTree_=n.syncPointTree_.set(i,a));let u;s!=null?u=!0:(u=!1,s=J.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((y,A)=>{let x=Cn(A,le());x&&(s=s.updateImmediateChild(y,x))}));let c=Vy(a,e);if(!c&&!e._queryParams.loadsAllData()){let p=_l(e);O(!n.queryToTagMap.has(p),"View does not exist, but we have a tag");let y=$A();n.queryToTagMap.set(p,y),n.tagToQueryMap.set(y,p)}let d=ml(n.pendingWriteTree_,i),m=OA(a,e,t,d,s,u);if(!c&&!o&&!r){let p=ky(a,e);m=m.concat(HA(n,e,p))}return m}function gl(n,e,t){let i=n.pendingWriteTree_,s=n.syncPointTree_.findOnPath(e,(o,a)=>{let u=tt(o,e),c=Cn(a,u);if(c)return c});return Ay(i,e,s,t,!0)}function zA(n,e){let t=e._path,r=null;n.syncPointTree_.foreachOnPath(t,(c,d)=>{let m=tt(c,t);r=r||Cn(d,m)});let i=n.syncPointTree_.get(t);i?r=r||Cn(i,le()):(i=new tl,n.syncPointTree_=n.syncPointTree_.set(t,i));let s=r!=null,o=s?new jt(r,!0,!1):null,a=ml(n.pendingWriteTree_,e._path),u=Ny(i,e,a,s?o.getNode():J.EMPTY_NODE,s);return RA(u)}function pi(n,e){return Fy(e,n.syncPointTree_,null,ml(n.pendingWriteTree_,le()))}function Fy(n,e,t,r){if(ee(n.path))return My(n,e,t,r);{let i=e.get(le());t==null&&i!=null&&(t=Cn(i,le()));let s=[],o=Z(n.path),a=n.operationForChild(o),u=e.children.get(o);if(u&&a){let c=t?t.getImmediateChild(o):null,d=Cy(r,o);s=s.concat(Fy(a,u,c,d))}return i&&(s=s.concat(ld(i,n,r,t))),s}}function My(n,e,t,r){let i=e.get(le());t==null&&i!=null&&(t=Cn(i,le()));let s=[];return e.children.inorderTraversal((o,a)=>{let u=t?t.getImmediateChild(o):null,c=Cy(r,o),d=n.operationForChild(o);d&&(s=s.concat(My(d,a,u,c)))}),i&&(s=s.concat(ld(i,n,r,t))),s}function Ly(n,e){let t=e.query,r=ro(n,t);return{hashFn:()=>(bA(e)||J.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return r?GA(n,t._path,r):jA(n,t._path);{let s=sS(i,t);return il(n,t,null,s)}}}}function ro(n,e){let t=_l(e);return n.queryToTagMap.get(t)}function _l(n){return n._path.toString()+"$"+n._queryIdentifier}function cd(n,e){return n.tagToQueryMap.get(e)}function hd(n){let e=n.indexOf("$");return O(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new ue(n.substr(0,e))}}function dd(n,e,t){let r=n.syncPointTree_.get(e);O(r,"Missing sync point for query tag that we're tracking");let i=ml(n.pendingWriteTree_,e);return ld(r,t,i,null)}function WA(n){return n.fold((e,t,r)=>{if(t&&Pn(t))return[pl(t)];{let i=[];return t&&(i=Dy(t)),qe(r,(s,o)=>{i=i.concat(o)}),i}})}function Qs(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(LA())(n._repo,n._path):n}function QA(n,e){for(let t=0;t<e.length;++t){let r=e[t];if(!r._queryParams.loadsAllData()){let i=_l(r),s=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(s)}}}function $A(){return UA++}function HA(n,e,t){let r=e._path,i=ro(n,e),s=Ly(n,t),o=n.listenProvider_.startListening(Qs(e),i,s.hashFn,s.onComplete),a=n.syncPointTree_.subtree(r);if(i)O(!Pn(a.value),"If we're adding a query, it shouldn't be shadowed");else{let u=a.fold((c,d,m)=>{if(!ee(c)&&d&&Pn(d))return[pl(d).query];{let p=[];return d&&(p=p.concat(Dy(d).map(y=>y.query))),qe(m,(y,A)=>{p=p.concat(A)}),p}});for(let c=0;c<u.length;++c){let d=u[c];n.listenProvider_.stopListening(Qs(d),ro(n,d))}}return o}var Ph=class n{constructor(e){this.node_=e}getImmediateChild(e){let t=this.node_.getImmediateChild(e);return new n(t)}node(){return this.node_}},xh=class n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){let t=ve(this.path_,e);return new n(this.syncTree_,t)}node(){return gl(this.syncTree_,this.path_)}},YA=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},j_=function(n,e,t){if(!n||typeof n!="object")return n;if(O(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return JA(n[".sv"],e,t);if(typeof n[".sv"]=="object")return XA(n[".sv"],e);O(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},JA=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:O(!1,"Unexpected server value: "+n)}},XA=function(n,e,t){n.hasOwnProperty("increment")||O(!1,"Unexpected server value: "+JSON.stringify(n,null,2));let r=n.increment;typeof r!="number"&&O(!1,"Unexpected increment value: "+r);let i=e.node();if(O(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return r;let o=i.getValue();return typeof o!="number"?r:o+r},Uy=function(n,e,t,r){return md(e,new xh(t,n),r)},fd=function(n,e,t){return md(n,new Ph(e),t)};function md(n,e,t){let r=n.getPriority().val(),i=j_(r,e.getImmediateChild(".priority"),t),s;if(n.isLeafNode()){let o=n,a=j_(o.getValue(),e,t);return a!==o.getValue()||i!==o.getPriority().val()?new oi(a,Ie(i)):n}else{let o=n;return s=o,i!==o.getPriority().val()&&(s=s.updatePriority(new oi(i))),o.forEachChild(pe,(a,u)=>{let c=md(u,e.getImmediateChild(a),t);c!==u&&(s=s.updateImmediateChild(a,c))}),s}}var io=class{constructor(e="",t=null,r={children:{},childCount:0}){this.name=e,this.parent=t,this.node=r}};function yl(n,e){let t=e instanceof ue?e:new ue(e),r=n,i=Z(t);for(;i!==null;){let s=Tn(r.node.children,i)||{children:{},childCount:0};r=new io(i,r,s),t=fe(t),i=Z(t)}return r}function hr(n){return n.node.value}function pd(n,e){n.node.value=e,Nh(n)}function By(n){return n.node.childCount>0}function ZA(n){return hr(n)===void 0&&!By(n)}function vl(n,e){qe(n.node.children,(t,r)=>{e(new io(t,n,r))})}function qy(n,e,t,r){t&&!r&&e(n),vl(n,i=>{qy(i,e,!0,r)}),t&&r&&e(n)}function e0(n,e,t){let r=t?n:n.parent;for(;r!==null;){if(e(r))return!0;r=r.parent}return!1}function fo(n){return new ue(n.parent===null?n.name:fo(n.parent)+"/"+n.name)}function Nh(n){n.parent!==null&&t0(n.parent,n.name,n)}function t0(n,e,t){let r=ZA(t),i=yt(n.node.children,e);r&&i?(delete n.node.children[e],n.node.childCount--,Nh(n)):!r&&!i&&(n.node.children[e]=t.node,n.node.childCount++,Nh(n))}var n0=/[\[\].#$\/\u0000-\u001F\u007F]/,r0=/[\[\].#$\u0000-\u001F\u007F]/,jc=10*1024*1024,wl=function(n){return typeof n=="string"&&n.length!==0&&!n0.test(n)},jy=function(n){return typeof n=="string"&&n.length!==0&&!r0.test(n)},i0=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),jy(n)},so=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!hl(n)||n&&typeof n=="object"&&yt(n,".sv")},Gt=function(n,e,t,r){r&&e===void 0||mo(at(n,"value"),e,t)},mo=function(n,e,t){let r=t instanceof ue?new th(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+sr(r));if(typeof e=="function")throw new Error(n+"contains a function "+sr(r)+" with contents = "+e.toString());if(hl(e))throw new Error(n+"contains "+e.toString()+" "+sr(r));if(typeof e=="string"&&e.length>jc/3&&xs(e)>jc)throw new Error(n+"contains a string greater than "+jc+" utf8 bytes "+sr(r)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,s=!1;if(qe(e,(o,a)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(s=!0,!wl(o)))throw new Error(n+" contains an invalid key ("+o+") "+sr(r)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);VS(r,o),mo(n,a,r),OS(r)}),i&&s)throw new Error(n+' contains ".value" child '+sr(r)+" in addition to actual children.")}},s0=function(n,e){let t,r;for(t=0;t<e.length;t++){r=e[t];let s=Hs(r);for(let o=0;o<s.length;o++)if(!(s[o]===".priority"&&o===s.length-1)){if(!wl(s[o]))throw new Error(n+"contains an invalid key ("+s[o]+") in path "+r.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(kS);let i=null;for(t=0;t<e.length;t++){if(r=e[t],i!==null&&wt(i,r))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+r.toString());i=r}},Gy=function(n,e,t,r){if(r&&e===void 0)return;let i=at(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");let s=[];qe(e,(o,a)=>{let u=new ue(o);if(mo(i,a,ve(t,u)),Xh(u)===".priority"&&!so(a))throw new Error(i+"contains an invalid value for '"+u.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");s.push(u)}),s0(i,s)},gd=function(n,e,t){if(!(t&&e===void 0)){if(hl(e))throw new Error(at(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!so(e))throw new Error(at(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},po=function(n,e,t,r){if(!(r&&t===void 0)&&!wl(t))throw new Error(at(n,e)+'was an invalid key = "'+t+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},gi=function(n,e,t,r){if(!(r&&t===void 0)&&!jy(t))throw new Error(at(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},o0=function(n,e,t,r){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),gi(n,e,t,r)},ht=function(n,e){if(Z(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},Ky=function(n,e){let t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!wl(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!i0(t))throw new Error(at(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var Dh=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function El(n,e){let t=null;for(let r=0;r<e.length;r++){let i=e[r],s=i.getPath();t!==null&&!Zh(s,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:s}),t.events.push(i)}t&&n.eventLists_.push(t)}function zy(n,e,t){El(n,t),Wy(n,r=>Zh(r,e))}function dt(n,e,t){El(n,t),Wy(n,r=>wt(r,e)||wt(e,r))}function Wy(n,e){n.recursionDepth_++;let t=!0;for(let r=0;r<n.eventLists_.length;r++){let i=n.eventLists_[r];if(i){let s=i.path;e(s)?(a0(n.eventLists_[r]),n.eventLists_[r]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function a0(n){for(let e=0;e<n.events.length;e++){let t=n.events[e];if(t!==null){n.events[e]=null;let r=t.getEventRunner();ar&&Be("event: "+t.toString()),fi(r)}}}var Qy="repo_interrupt",l0=25,kh=class{constructor(e,t,r,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=r,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Dh,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=$a(),this.transactionQueueTree_=new io,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function u0(n,e,t){if(n.stats_=Jh(n.repoInfo_),n.forceRestClient_||uS())n.server_=new dh(n.repoInfo_,(r,i,s,o)=>{G_(n,r,i,s,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>K_(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{Ne(t)}catch(r){throw new Error("Invalid authOverride provided: "+r)}}n.persistentConnection_=new ed(n.repoInfo_,e,(r,i,s,o)=>{G_(n,r,i,s,o)},r=>{K_(n,r)},r=>{c0(n,r)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(r=>{n.server_.refreshAuthToken(r)}),n.appCheckProvider_.addTokenChangeListener(r=>{n.server_.refreshAppCheckToken(r.token)}),n.statsReporter_=hS(n.repoInfo_,()=>new _h(n.stats_,n.server_)),n.infoData_=new fh,n.infoSyncTree_=new rl({startListening:(r,i,s,o)=>{let a=[],u=n.infoData_.getNode(r._path);return u.isEmpty()||(a=ho(n.infoSyncTree_,r._path,u),setTimeout(()=>{o("ok")},0)),a},stopListening:()=>{}}),_d(n,"connected",!1),n.serverSyncTree_=new rl({startListening:(r,i,s,o)=>(n.server_.listen(r,s,i,(a,u)=>{let c=o(a,u);dt(n.eventQueue_,r._path,c)}),[]),stopListening:(r,i)=>{n.server_.unlisten(r,i)}})}function $y(n){let t=n.infoData_.getNode(new ue(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function go(n){return YA({timestamp:$y(n)})}function G_(n,e,t,r,i){n.dataUpdateCount++;let s=new ue(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(r){let u=Ps(t,c=>Ie(c));o=KA(n.serverSyncTree_,s,u,i)}else{let u=Ie(t);o=Oy(n.serverSyncTree_,s,u,i)}else if(r){let u=Ps(t,c=>Ie(c));o=qA(n.serverSyncTree_,s,u)}else{let u=Ie(t);o=ho(n.serverSyncTree_,s,u)}let a=s;o.length>0&&(a=hi(n,s)),dt(n.eventQueue_,a,o)}function K_(n,e){_d(n,"connected",e),e===!1&&f0(n)}function c0(n,e){qe(e,(t,r)=>{_d(n,t,r)})}function _d(n,e,t){let r=new ue("/.info/"+e),i=Ie(t);n.infoData_.updateSnapshot(r,i);let s=ho(n.infoSyncTree_,r,i);dt(n.eventQueue_,r,s)}function Il(n){return n.nextWriteId_++}function h0(n,e,t){let r=zA(n.serverSyncTree_,e);return r!=null?Promise.resolve(r):n.server_.get(e).then(i=>{let s=Ie(i).withIndex(e._queryParams.getIndex());Rh(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=ho(n.serverSyncTree_,e._path,s);else{let a=ro(n.serverSyncTree_,e);o=Oy(n.serverSyncTree_,e._path,s,a)}return dt(n.eventQueue_,e._path,o),il(n.serverSyncTree_,e,t,null,!0),s},i=>(_i(n,"get for query "+Ne(e)+" failed: "+i),Promise.reject(new Error(i))))}function yd(n,e,t,r,i){_i(n,"set",{path:e.toString(),value:t,priority:r});let s=go(n),o=Ie(t,r),a=gl(n.serverSyncTree_,e),u=fd(o,a,s),c=Il(n),d=ud(n.serverSyncTree_,e,u,c,!0);El(n.eventQueue_,d),n.server_.put(e.toString(),o.val(!0),(p,y)=>{let A=p==="ok";A||$e("set at "+e+" failed: "+p);let x=Sn(n.serverSyncTree_,c,!A);dt(n.eventQueue_,e,x),xn(n,i,p,y)});let m=wd(n,e);hi(n,m),dt(n.eventQueue_,m,[])}function d0(n,e,t,r){_i(n,"update",{path:e.toString(),value:t});let i=!0,s=go(n),o={};if(qe(t,(a,u)=>{i=!1,o[a]=Uy(ve(e,a),Ie(u),n.serverSyncTree_,s)}),i)Be("update() called with empty data.  Don't do anything."),xn(n,r,"ok",void 0);else{let a=Il(n),u=BA(n.serverSyncTree_,e,o,a);El(n.eventQueue_,u),n.server_.merge(e.toString(),t,(c,d)=>{let m=c==="ok";m||$e("update at "+e+" failed: "+c);let p=Sn(n.serverSyncTree_,a,!m),y=p.length>0?hi(n,e):e;dt(n.eventQueue_,y,p),xn(n,r,c,d)}),qe(t,c=>{let d=wd(n,ve(e,c));hi(n,d)}),dt(n.eventQueue_,e,[])}}function f0(n){_i(n,"onDisconnectEvents");let e=go(n),t=$a();ph(n.onDisconnect_,le(),(i,s)=>{let o=Uy(i,s,n.serverSyncTree_,e);mi(t,i,o)});let r=[];ph(t,le(),(i,s)=>{r=r.concat(ho(n.serverSyncTree_,i,s));let o=wd(n,i);hi(n,o)}),n.onDisconnect_=$a(),dt(n.eventQueue_,le(),r)}function m0(n,e,t){n.server_.onDisconnectCancel(e.toString(),(r,i)=>{r==="ok"&&mh(n.onDisconnect_,e),xn(n,t,r,i)})}function z_(n,e,t,r){let i=Ie(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(s,o)=>{s==="ok"&&mi(n.onDisconnect_,e,i),xn(n,r,s,o)})}function p0(n,e,t,r,i){let s=Ie(t,r);n.server_.onDisconnectPut(e.toString(),s.val(!0),(o,a)=>{o==="ok"&&mi(n.onDisconnect_,e,s),xn(n,i,o,a)})}function g0(n,e,t,r){if(Va(t)){Be("onDisconnect().update() called with empty data.  Don't do anything."),xn(n,r,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,s)=>{i==="ok"&&qe(t,(o,a)=>{let u=Ie(a);mi(n.onDisconnect_,ve(e,o),u)}),xn(n,r,i,s)})}function _0(n,e,t){let r;Z(e._path)===".info"?r=Rh(n.infoSyncTree_,e,t):r=Rh(n.serverSyncTree_,e,t),zy(n.eventQueue_,e._path,r)}function Vh(n,e,t){let r;Z(e._path)===".info"?r=il(n.infoSyncTree_,e,t):r=il(n.serverSyncTree_,e,t),zy(n.eventQueue_,e._path,r)}function Hy(n){n.persistentConnection_&&n.persistentConnection_.interrupt(Qy)}function y0(n){n.persistentConnection_&&n.persistentConnection_.resume(Qy)}function _i(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),Be(t,...e)}function xn(n,e,t,r){e&&fi(()=>{if(t==="ok")e(null);else{let i=(t||"error").toUpperCase(),s=i;r&&(s+=": "+r);let o=new Error(s);o.code=i,e(o)}})}function v0(n,e,t,r,i,s){_i(n,"transaction on "+e);let o={path:e,update:t,onComplete:r,status:null,order:$_(),applyLocally:s,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},a=vd(n,e,void 0);o.currentInputSnapshot=a;let u=o.update(a.val());if(u===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{mo("transaction failed: Data returned ",u,o.path),o.status=0;let c=yl(n.transactionQueueTree_,e),d=hr(c)||[];d.push(o),pd(c,d);let m;typeof u=="object"&&u!==null&&yt(u,".priority")?(m=Tn(u,".priority"),O(so(m),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):m=(gl(n.serverSyncTree_,e)||J.EMPTY_NODE).getPriority().val();let p=go(n),y=Ie(u,m),A=fd(y,a,p);o.currentOutputSnapshotRaw=y,o.currentOutputSnapshotResolved=A,o.currentWriteId=Il(n);let x=ud(n.serverSyncTree_,e,A,o.currentWriteId,o.applyLocally);dt(n.eventQueue_,e,x),Tl(n,n.transactionQueueTree_)}}function vd(n,e,t){return gl(n.serverSyncTree_,e,t)||J.EMPTY_NODE}function Tl(n,e=n.transactionQueueTree_){if(e||Sl(n,e),hr(e)){let t=Jy(n,e);O(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&w0(n,fo(e),t)}else By(e)&&vl(e,t=>{Tl(n,t)})}function w0(n,e,t){let r=t.map(c=>c.currentWriteId),i=vd(n,e,r),s=i,o=i.hash();for(let c=0;c<t.length;c++){let d=t[c];O(d.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),d.status=1,d.retryCount++;let m=tt(e,d.path);s=s.updateChild(m,d.currentOutputSnapshotRaw)}let a=s.val(!0),u=e;n.server_.put(u.toString(),a,c=>{_i(n,"transaction put response",{path:u.toString(),status:c});let d=[];if(c==="ok"){let m=[];for(let p=0;p<t.length;p++)t[p].status=2,d=d.concat(Sn(n.serverSyncTree_,t[p].currentWriteId)),t[p].onComplete&&m.push(()=>t[p].onComplete(null,!0,t[p].currentOutputSnapshotResolved)),t[p].unwatcher();Sl(n,yl(n.transactionQueueTree_,e)),Tl(n,n.transactionQueueTree_),dt(n.eventQueue_,e,d);for(let p=0;p<m.length;p++)fi(m[p])}else{if(c==="datastale")for(let m=0;m<t.length;m++)t[m].status===3?t[m].status=4:t[m].status=0;else{$e("transaction at "+u.toString()+" failed: "+c);for(let m=0;m<t.length;m++)t[m].status=4,t[m].abortReason=c}hi(n,e)}},o)}function hi(n,e){let t=Yy(n,e),r=fo(t),i=Jy(n,t);return E0(n,i,r),r}function E0(n,e,t){if(e.length===0)return;let r=[],i=[],o=e.filter(a=>a.status===0).map(a=>a.currentWriteId);for(let a=0;a<e.length;a++){let u=e[a],c=tt(t,u.path),d=!1,m;if(O(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),u.status===4)d=!0,m=u.abortReason,i=i.concat(Sn(n.serverSyncTree_,u.currentWriteId,!0));else if(u.status===0)if(u.retryCount>=l0)d=!0,m="maxretry",i=i.concat(Sn(n.serverSyncTree_,u.currentWriteId,!0));else{let p=vd(n,u.path,o);u.currentInputSnapshot=p;let y=e[a].update(p.val());if(y!==void 0){mo("transaction failed: Data returned ",y,u.path);let A=Ie(y);typeof y=="object"&&y!=null&&yt(y,".priority")||(A=A.updatePriority(p.getPriority()));let N=u.currentWriteId,q=go(n),j=fd(A,p,q);u.currentOutputSnapshotRaw=A,u.currentOutputSnapshotResolved=j,u.currentWriteId=Il(n),o.splice(o.indexOf(N),1),i=i.concat(ud(n.serverSyncTree_,u.path,j,u.currentWriteId,u.applyLocally)),i=i.concat(Sn(n.serverSyncTree_,N,!0))}else d=!0,m="nodata",i=i.concat(Sn(n.serverSyncTree_,u.currentWriteId,!0))}dt(n.eventQueue_,t,i),i=[],d&&(e[a].status=2,function(p){setTimeout(p,Math.floor(0))}(e[a].unwatcher),e[a].onComplete&&(m==="nodata"?r.push(()=>e[a].onComplete(null,!1,e[a].currentInputSnapshot)):r.push(()=>e[a].onComplete(new Error(m),!1,null))))}Sl(n,n.transactionQueueTree_);for(let a=0;a<r.length;a++)fi(r[a]);Tl(n,n.transactionQueueTree_)}function Yy(n,e){let t,r=n.transactionQueueTree_;for(t=Z(e);t!==null&&hr(r)===void 0;)r=yl(r,t),e=fe(e),t=Z(e);return r}function Jy(n,e){let t=[];return Xy(n,e,t),t.sort((r,i)=>r.order-i.order),t}function Xy(n,e,t){let r=hr(e);if(r)for(let i=0;i<r.length;i++)t.push(r[i]);vl(e,i=>{Xy(n,i,t)})}function Sl(n,e){let t=hr(e);if(t){let r=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[r]=t[i],r++);t.length=r,pd(e,t.length>0?t:void 0)}vl(e,r=>{Sl(n,r)})}function wd(n,e){let t=fo(Yy(n,e)),r=yl(n.transactionQueueTree_,e);return e0(r,i=>{Gc(n,i)}),Gc(n,r),qy(r,i=>{Gc(n,i)}),t}function Gc(n,e){let t=hr(e);if(t){let r=[],i=[],s=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(O(s===o-1,"All SENT items should be at beginning of queue."),s=o,t[o].status=3,t[o].abortReason="set"):(O(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(Sn(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&r.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));s===-1?pd(e,void 0):t.length=s+1,dt(n.eventQueue_,fo(e),i);for(let o=0;o<r.length;o++)fi(r[o])}}function I0(n){let e="",t=n.split("/");for(let r=0;r<t.length;r++)if(t[r].length>0){let i=t[r];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function T0(n){let e={};n.charAt(0)==="?"&&(n=n.substring(1));for(let t of n.split("&")){if(t.length===0)continue;let r=t.split("=");r.length===2?e[decodeURIComponent(r[0])]=decodeURIComponent(r[1]):$e(`Invalid query segment '${t}' in query '${n}'`)}return e}var Oh=function(n,e){let t=S0(n),r=t.namespace;t.domain==="firebase.com"&&qt(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!r||r==="undefined")&&t.domain!=="localhost"&&qt("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||eS();let i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new Ba(t.host,t.secure,r,i,e,"",r!==t.subdomain),path:new ue(t.pathString)}},S0=function(n){let e="",t="",r="",i="",s="",o=!0,a="https",u=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(a=n.substring(0,c-1),n=n.substring(c+2));let d=n.indexOf("/");d===-1&&(d=n.length);let m=n.indexOf("?");m===-1&&(m=n.length),e=n.substring(0,Math.min(d,m)),d<m&&(i=I0(n.substring(d,m)));let p=T0(n.substring(Math.min(n.length,m)));c=e.indexOf(":"),c>=0?(o=a==="https"||a==="wss",u=parseInt(e.substring(c+1),10)):c=e.length;let y=e.slice(0,c);if(y.toLowerCase()==="localhost")t="localhost";else if(y.split(".").length<=2)t=y;else{let A=e.indexOf(".");r=e.substring(0,A).toLowerCase(),t=e.substring(A+1),s=r}"ns"in p&&(s=p.ns)}return{host:e,port:u,domain:t,subdomain:r,secure:o,scheme:a,pathString:i,namespace:s}};var W_="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",A0=function(){let n=0,e=[];return function(t){let r=t===n;n=t;let i,s=new Array(8);for(i=7;i>=0;i--)s[i]=W_.charAt(t%64),t=Math.floor(t/64);O(t===0,"Cannot push at time == 0");let o=s.join("");if(r){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=W_.charAt(e[i]);return O(o.length===20,"nextPushId: Length should be 20."),o}}();var sl=class{constructor(e,t,r,i){this.eventType=e,this.eventRegistration=t,this.snapshot=r,this.prevName=i}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+Ne(this.snapshot.exportVal())}},ol=class{constructor(e,t,r){this.eventRegistration=e,this.error=t,this.path=r}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var oo=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return O(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var al=class{constructor(e,t){this._repo=e,this._path=t}cancel(){let e=new et;return m0(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){ht("OnDisconnect.remove",this._path);let e=new et;return z_(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){ht("OnDisconnect.set",this._path),Gt("OnDisconnect.set",e,this._path,!1);let t=new et;return z_(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){ht("OnDisconnect.setWithPriority",this._path),Gt("OnDisconnect.setWithPriority",e,this._path,!1),gd("OnDisconnect.setWithPriority",t,!1);let r=new et;return p0(this._repo,this._path,e,t,r.wrapCallback(()=>{})),r.promise}update(e){ht("OnDisconnect.update",this._path),Gy("OnDisconnect.update",e,this._path,!1);let t=new et;return g0(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}};var rt=class n{constructor(e,t,r,i){this._repo=e,this._path=t,this._queryParams=r,this._orderByCalled=i}get key(){return ee(this._path)?null:Xh(this._path)}get ref(){return new ft(this._repo,this._path)}get _queryIdentifier(){let e=D_(this._queryParams),t=Yh(e);return t==="{}"?"default":t}get _queryObject(){return D_(this._queryParams)}isEqual(e){if(e=ne(e),!(e instanceof n))return!1;let t=this._repo===e._repo,r=Zh(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&r&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+DS(this._path)}};function Al(n,e){if(n._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function Dn(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===Bt){let r="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==bn)throw new Error(r);if(typeof e!="string")throw new Error(i)}if(n.hasEnd()){if(n.getIndexEndName()!==on)throw new Error(r);if(typeof t!="string")throw new Error(i)}}else if(n.getIndex()===pe){if(e!=null&&!so(e)||t!=null&&!so(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(O(n.getIndex()instanceof Ys||n.getIndex()===nd,"unknown index type."),e!=null&&typeof e=="object"||t!=null&&typeof t=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function Cl(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var ft=class n extends rt{constructor(e,t){super(e,t,new eo,!1)}get parent(){let e=py(this._path);return e===null?null:new n(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},di=class n{constructor(e,t,r){this._node=e,this.ref=t,this._index=r}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let t=new ue(e),r=Nn(this.ref,e);return new n(this._node.getChild(t),r,pe)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(r,i)=>e(new n(i,Nn(this.ref,r),pe)))}hasChild(e){let t=new ue(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function Ed(n,e){return n=ne(n),n._checkNotDeleted("ref"),e!==void 0?Nn(n._root,e):n._root}function Id(n,e){n=ne(n),n._checkNotDeleted("refFromURL");let t=Oh(e,n._repo.repoInfo_.nodeAdmin);Ky("refFromURL",t);let r=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&r.host!==n._repo.repoInfo_.host&&qt("refFromURL: Host name does not match the current database: (found "+r.host+" but expected "+n._repo.repoInfo_.host+")"),Ed(n,t.path.toString())}function Nn(n,e){return n=ne(n),Z(n._path)===null?o0("child","path",e,!1):gi("child","path",e,!1),new ft(n._repo,ve(n._path,e))}function Zy(n,e){n=ne(n),ht("push",n._path),Gt("push",e,n._path,!0);let t=$y(n._repo),r=A0(t),i=Nn(n,r),s=Nn(n,r),o;return e!=null?o=bl(s,e).then(()=>s):o=Promise.resolve(s),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function ev(n){return ht("remove",n._path),bl(n,null)}function bl(n,e){n=ne(n),ht("set",n._path),Gt("set",e,n._path,!1);let t=new et;return yd(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function tv(n,e){n=ne(n),ht("setPriority",n._path),gd("setPriority",e,!1);let t=new et;return yd(n._repo,ve(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}function nv(n,e,t){if(ht("setWithPriority",n._path),Gt("setWithPriority",e,n._path,!1),gd("setWithPriority",t,!1),n.key===".length"||n.key===".keys")throw"setWithPriority failed: "+n.key+" is a read-only object.";let r=new et;return yd(n._repo,n._path,e,t,r.wrapCallback(()=>{})),r.promise}function rv(n,e){Gy("update",e,n._path,!1);let t=new et;return d0(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function iv(n){n=ne(n);let e=new oo(()=>{}),t=new ao(e);return h0(n._repo,n,t).then(r=>new di(r,new ft(n._repo,n._path),n._queryParams.getIndex()))}var ao=class n{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){let r=t._queryParams.getIndex();return new sl("value",this,new di(e.snapshotNode,new ft(t._repo,t._path),r))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new ol(this,e,t):null}matches(e){return e instanceof n?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},ll=class n{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e==="children_added"?"child_added":e;return t=t==="children_removed"?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new ol(this,e,t):null}createEvent(e,t){O(e.childName!=null,"Child events should have a childName.");let r=Nn(new ft(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new sl(e.type,this,new di(e.snapshotNode,r,i),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof n?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function _o(n,e,t,r,i){let s;if(typeof r=="object"&&(s=void 0,i=r),typeof r=="function"&&(s=r),i&&i.onlyOnce){let u=t,c=(d,m)=>{Vh(n._repo,n,a),u(d,m)};c.userCallback=t.userCallback,c.context=t.context,t=c}let o=new oo(t,s||void 0),a=e==="value"?new ao(o):new ll(e,o);return _0(n._repo,n,a),()=>Vh(n._repo,n,a)}function Rl(n,e,t,r){return _o(n,"value",e,t,r)}function Td(n,e,t,r){return _o(n,"child_added",e,t,r)}function Sd(n,e,t,r){return _o(n,"child_changed",e,t,r)}function Ad(n,e,t,r){return _o(n,"child_moved",e,t,r)}function Cd(n,e,t,r){return _o(n,"child_removed",e,t,r)}function bd(n,e,t){let r=null,i=t?new oo(t):null;e==="value"?r=new ao(i):e&&(r=new ll(e,i)),Vh(n._repo,n,r)}var mt=class{},ul=class extends mt{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){Gt("endAt",this._value,e._path,!0);let t=hh(e._queryParams,this._value,this._key);if(Cl(t),Dn(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new rt(e._repo,e._path,t,e._orderByCalled)}};function sv(n,e){return po("endAt","key",e,!0),new ul(n,e)}var Fh=class extends mt{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){Gt("endBefore",this._value,e._path,!1);let t=JS(e._queryParams,this._value,this._key);if(Cl(t),Dn(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new rt(e._repo,e._path,t,e._orderByCalled)}};function ov(n,e){return po("endBefore","key",e,!0),new Fh(n,e)}var cl=class extends mt{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){Gt("startAt",this._value,e._path,!0);let t=ch(e._queryParams,this._value,this._key);if(Cl(t),Dn(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new rt(e._repo,e._path,t,e._orderByCalled)}};function av(n=null,e){return po("startAt","key",e,!0),new cl(n,e)}var Mh=class extends mt{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){Gt("startAfter",this._value,e._path,!1);let t=YS(e._queryParams,this._value,this._key);if(Cl(t),Dn(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new rt(e._repo,e._path,t,e._orderByCalled)}};function lv(n,e){return po("startAfter","key",e,!0),new Mh(n,e)}var Lh=class extends mt{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new rt(e._repo,e._path,$S(e._queryParams,this._limit),e._orderByCalled)}};function uv(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new Lh(n)}var Uh=class extends mt{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new rt(e._repo,e._path,HS(e._queryParams,this._limit),e._orderByCalled)}};function cv(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new Uh(n)}var Bh=class extends mt{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){Al(e,"orderByChild");let t=new ue(this._path);if(ee(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let r=new Ys(t),i=dl(e._queryParams,r);return Dn(i),new rt(e._repo,e._path,i,!0)}};function hv(n){if(n==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(n==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(n==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return gi("orderByChild","path",n,!1),new Bh(n)}var qh=class extends mt{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){Al(e,"orderByKey");let t=dl(e._queryParams,Bt);return Dn(t),new rt(e._repo,e._path,t,!0)}};function dv(){return new qh}var jh=class extends mt{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){Al(e,"orderByPriority");let t=dl(e._queryParams,pe);return Dn(t),new rt(e._repo,e._path,t,!0)}};function fv(){return new jh}var Gh=class extends mt{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){Al(e,"orderByValue");let t=dl(e._queryParams,nd);return Dn(t),new rt(e._repo,e._path,t,!0)}};function mv(){return new Gh}var Kh=class extends mt{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(Gt("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new ul(this._value,this._key)._apply(new cl(this._value,this._key)._apply(e))}};function pv(n,e){return po("equalTo","key",e,!0),new Kh(n,e)}function It(n,...e){let t=ne(n);for(let r of e)t=r._apply(t);return t}DA(ft);MA(ft);var C0="FIREBASE_DATABASE_EMULATOR_HOST",zh={},b0=!1;function R0(n,e,t,r){n.repoInfo_=new Ba(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),r&&(n.authTokenProvider_=r)}function Rd(n,e,t,r,i){let s=r||n.options.databaseURL;s===void 0&&(n.options.projectId||qt("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),Be("Using default host for project ",n.options.projectId),s=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=Oh(s,i),a=o.repoInfo,u,c;typeof process<"u"&&process.env&&(c=process.env[C0]),c?(u=!0,s=`http://${c}?ns=${a.namespace}`,o=Oh(s,i),a=o.repoInfo):u=!o.repoInfo.secure;let d=i&&u?new Ks(Ks.OWNER):new Hc(n.name,n.options,e);Ky("Invalid Firebase Database URL",o),ee(o.path)||qt("Database URL must point to the root of a Firebase Database (not including a child path).");let m=x0(a,n,d,new $c(n.name,t));return new Wh(m,n)}function P0(n,e){let t=zh[e];(!t||t[n.key]!==n)&&qt(`Database ${e}(${n.repoInfo_}) has already been deleted.`),Hy(n),delete t[n.key]}function x0(n,e,t,r){let i=zh[e.name];i||(i={},zh[e.name]=i);let s=i[n.toURLString()];return s&&qt("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),s=new kh(n,b0,t,r),i[n.toURLString()]=s,s}var Wh=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(u0(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new ft(this._repo,le())),this._rootInternal}_delete(){return this._rootInternal!==null&&(P0(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&qt("Cannot call "+e+" on a deleted database.")}};function gv(){my.IS_TRANSPORT_INITIALIZED&&$e("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function _v(){gv(),$s.forceDisallow()}function yv(){gv(),ni.forceDisallow(),$s.forceAllow()}function vv(n,e,t,r={}){n=ne(n),n._checkNotDeleted("useEmulator"),n._instanceStarted&&qt("Cannot call useEmulator() after instance has already been initialized.");let i=n._repoInternal,s;if(i.repoInfo_.nodeAdmin)r.mockUserToken&&qt('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),s=new Ks(Ks.OWNER);else if(r.mockUserToken){let o=typeof r.mockUserToken=="string"?r.mockUserToken:Da(r.mockUserToken,n.app.options.projectId);s=new Ks(o)}R0(i,e,t,s)}function wv(n){n=ne(n),n._checkNotDeleted("goOffline"),Hy(n._repo)}function Ev(n){n=ne(n),n._checkNotDeleted("goOnline"),y0(n._repo)}function Iv(n,e){Y_(n,e)}function N0(n){Hh(Ma),Fa(new Mt("database",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),s=e.getProvider("app-check-internal");return Rd(r,i,s,t)},"PUBLIC").setMultipleInstances(!0)),Qr(p_,g_,n),Qr(p_,g_,"esm2017")}var D0={".sv":"timestamp"};function Tv(){return D0}function Sv(n){return{".sv":{increment:n}}}var Qh=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function Av(n,e,t){var r;if(n=ne(n),ht("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";let i=(r=t?.applyLocally)!==null&&r!==void 0?r:!0,s=new et,o=(u,c,d)=>{let m=null;u?s.reject(u):(m=new di(d,new ft(n._repo,n._path),pe),s.resolve(new Qh(c,m)))},a=Rl(n,()=>{});return v0(n._repo,n._path,e,o,a,i),s.promise}ed.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};ed.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};N0();var k0="@firebase/database-compat",V0="1.0.7";var O0=new Wr("@firebase/database-compat"),Cv=function(n){let e="FIREBASE WARNING: "+n;O0.warn(e)};var F0=function(n,e,t,r){if(!(r&&t===void 0)&&typeof t!="boolean")throw new Error(at(n,e)+"must be a boolean.")},M0=function(n,e,t){if(!(t&&e===void 0))switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(at(n,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}};var Pd=class{constructor(e){this._delegate=e}cancel(e){Q("OnDisconnect.cancel",0,1,arguments.length),Me("OnDisconnect.cancel","onComplete",e,!0);let t=this._delegate.cancel();return e&&t.then(()=>e(null),r=>e(r)),t}remove(e){Q("OnDisconnect.remove",0,1,arguments.length),Me("OnDisconnect.remove","onComplete",e,!0);let t=this._delegate.remove();return e&&t.then(()=>e(null),r=>e(r)),t}set(e,t){Q("OnDisconnect.set",1,2,arguments.length),Me("OnDisconnect.set","onComplete",t,!0);let r=this._delegate.set(e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){Q("OnDisconnect.setWithPriority",2,3,arguments.length),Me("OnDisconnect.setWithPriority","onComplete",r,!0);let i=this._delegate.setWithPriority(e,t);return r&&i.then(()=>r(null),s=>r(s)),i}update(e,t){if(Q("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,Cv("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}Me("OnDisconnect.update","onComplete",t,!0);let r=this._delegate.update(e);return t&&r.then(()=>t(null),i=>t(i)),r}};var xd=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return Q("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}};var dr=class n{constructor(e,t){this._database=e,this._delegate=t}val(){return Q("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return Q("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return Q("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return Q("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return Q("DataSnapshot.child",0,1,arguments.length),e=String(e),gi("DataSnapshot.child","path",e,!1),new n(this._database,this._delegate.child(e))}hasChild(e){return Q("DataSnapshot.hasChild",1,1,arguments.length),gi("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return Q("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return Q("DataSnapshot.forEach",1,1,arguments.length),Me("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new n(this._database,t)))}hasChildren(){return Q("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return Q("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return Q("DataSnapshot.ref",0,0,arguments.length),new an(this._database,this._delegate.ref)}get ref(){return this.getRef()}},Pl=class n{constructor(e,t){this.database=e,this._delegate=t}on(e,t,r,i){var s;Q("Query.on",2,4,arguments.length),Me("Query.on","callback",t,!1);let o=n.getCancelAndContextArgs_("Query.on",r,i),a=(c,d)=>{t.call(o.context,new dr(this.database,c),d)};a.userCallback=t,a.context=o.context;let u=(s=o.cancel)===null||s===void 0?void 0:s.bind(o.context);switch(e){case"value":return Rl(this._delegate,a,u),t;case"child_added":return Td(this._delegate,a,u),t;case"child_removed":return Cd(this._delegate,a,u),t;case"child_changed":return Sd(this._delegate,a,u),t;case"child_moved":return Ad(this._delegate,a,u),t;default:throw new Error(at("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,r){if(Q("Query.off",0,3,arguments.length),M0("Query.off",e,!0),Me("Query.off","callback",t,!0),Dc("Query.off","context",r,!0),t){let i=()=>{};i.userCallback=t,i.context=r,bd(this._delegate,e,i)}else bd(this._delegate,e)}get(){return iv(this._delegate).then(e=>new dr(this.database,e))}once(e,t,r,i){Q("Query.once",1,4,arguments.length),Me("Query.once","callback",t,!0);let s=n.getCancelAndContextArgs_("Query.once",r,i),o=new et,a=(c,d)=>{let m=new dr(this.database,c);t&&t.call(s.context,m,d),o.resolve(m)};a.userCallback=t,a.context=s.context;let u=c=>{s.cancel&&s.cancel.call(s.context,c),o.reject(c)};switch(e){case"value":Rl(this._delegate,a,u,{onlyOnce:!0});break;case"child_added":Td(this._delegate,a,u,{onlyOnce:!0});break;case"child_removed":Cd(this._delegate,a,u,{onlyOnce:!0});break;case"child_changed":Sd(this._delegate,a,u,{onlyOnce:!0});break;case"child_moved":Ad(this._delegate,a,u,{onlyOnce:!0});break;default:throw new Error(at("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return Q("Query.limitToFirst",1,1,arguments.length),new n(this.database,It(this._delegate,uv(e)))}limitToLast(e){return Q("Query.limitToLast",1,1,arguments.length),new n(this.database,It(this._delegate,cv(e)))}orderByChild(e){return Q("Query.orderByChild",1,1,arguments.length),new n(this.database,It(this._delegate,hv(e)))}orderByKey(){return Q("Query.orderByKey",0,0,arguments.length),new n(this.database,It(this._delegate,dv()))}orderByPriority(){return Q("Query.orderByPriority",0,0,arguments.length),new n(this.database,It(this._delegate,fv()))}orderByValue(){return Q("Query.orderByValue",0,0,arguments.length),new n(this.database,It(this._delegate,mv()))}startAt(e=null,t){return Q("Query.startAt",0,2,arguments.length),new n(this.database,It(this._delegate,av(e,t)))}startAfter(e=null,t){return Q("Query.startAfter",0,2,arguments.length),new n(this.database,It(this._delegate,lv(e,t)))}endAt(e=null,t){return Q("Query.endAt",0,2,arguments.length),new n(this.database,It(this._delegate,sv(e,t)))}endBefore(e=null,t){return Q("Query.endBefore",0,2,arguments.length),new n(this.database,It(this._delegate,ov(e,t)))}equalTo(e,t){return Q("Query.equalTo",1,2,arguments.length),new n(this.database,It(this._delegate,pv(e,t)))}toString(){return Q("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return Q("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if(Q("Query.isEqual",1,1,arguments.length),!(e instanceof n)){let t="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(t)}return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,r){let i={cancel:void 0,context:void 0};if(t&&r)i.cancel=t,Me(e,"cancel",i.cancel,!0),i.context=r,Dc(e,"context",i.context,!0);else if(t)if(typeof t=="object"&&t!==null)i.context=t;else if(typeof t=="function")i.cancel=t;else throw new Error(at(e,"cancelOrContext")+" must either be a cancel callback or a context object.");return i}get ref(){return new an(this.database,new ft(this._delegate._repo,this._delegate._path))}},an=class n extends Pl{constructor(e,t){super(e,new rt(t._repo,t._path,new eo,!1)),this.database=e,this._delegate=t}getKey(){return Q("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return Q("Reference.child",1,1,arguments.length),typeof e=="number"&&(e=String(e)),new n(this.database,Nn(this._delegate,e))}getParent(){Q("Reference.parent",0,0,arguments.length);let e=this._delegate.parent;return e?new n(this.database,e):null}getRoot(){return Q("Reference.root",0,0,arguments.length),new n(this.database,this._delegate.root)}set(e,t){Q("Reference.set",1,2,arguments.length),Me("Reference.set","onComplete",t,!0);let r=bl(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}update(e,t){if(Q("Reference.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,Cv("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}ht("Reference.update",this._delegate._path),Me("Reference.update","onComplete",t,!0);let r=rv(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){Q("Reference.setWithPriority",2,3,arguments.length),Me("Reference.setWithPriority","onComplete",r,!0);let i=nv(this._delegate,e,t);return r&&i.then(()=>r(null),s=>r(s)),i}remove(e){Q("Reference.remove",0,1,arguments.length),Me("Reference.remove","onComplete",e,!0);let t=ev(this._delegate);return e&&t.then(()=>e(null),r=>e(r)),t}transaction(e,t,r){Q("Reference.transaction",1,3,arguments.length),Me("Reference.transaction","transactionUpdate",e,!1),Me("Reference.transaction","onComplete",t,!0),F0("Reference.transaction","applyLocally",r,!0);let i=Av(this._delegate,e,{applyLocally:r}).then(s=>new xd(s.committed,new dr(this.database,s.snapshot)));return t&&i.then(s=>t(null,s.committed,s.snapshot),s=>t(s,!1,null)),i}setPriority(e,t){Q("Reference.setPriority",1,2,arguments.length),Me("Reference.setPriority","onComplete",t,!0);let r=tv(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}push(e,t){Q("Reference.push",0,2,arguments.length),Me("Reference.push","onComplete",t,!0);let r=Zy(this._delegate,e),i=r.then(o=>new n(this.database,o));t&&i.then(()=>t(null),o=>t(o));let s=new n(this.database,r);return s.then=i.then.bind(i),s.catch=i.catch.bind(i,void 0),s}onDisconnect(){return ht("Reference.onDisconnect",this._delegate._path),new Pd(new al(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}};var fr=class{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:_v,forceLongPolling:yv}}useEmulator(e,t,r={}){vv(this._delegate,e,t,r)}ref(e){if(Q("database.ref",0,1,arguments.length),e instanceof an){let t=Id(this._delegate,e.toString());return new an(this,t)}else{let t=Ed(this._delegate,e);return new an(this,t)}}refFromURL(e){Q("database.refFromURL",1,1,arguments.length);let r=Id(this._delegate,e);return new an(this,r)}goOffline(){return Q("database.goOffline",0,0,arguments.length),wv(this._delegate)}goOnline(){return Q("database.goOnline",0,0,arguments.length),Ev(this._delegate)}};fr.ServerValue={TIMESTAMP:Tv(),increment:n=>Sv(n)};function L0({app:n,url:e,version:t,customAuthImpl:r,customAppCheckImpl:i,namespace:s,nodeAdmin:o=!1}){Hh(t);let a=new kc("database-standalone"),u=new Oa("auth-internal",a);u.setComponent(new Mt("auth-internal",()=>r,"PRIVATE"));let c;return i&&(c=new Oa("app-check-internal",a),c.setComponent(new Mt("app-check-internal",()=>i,"PRIVATE"))),{instance:new fr(Rd(n,u,c,e,o),n),namespace:s}}var U0=Object.freeze({__proto__:null,initStandalone:L0});var B0=fr.ServerValue;function q0(n){n.INTERNAL.registerComponent(new Mt("database-compat",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app-compat").getImmediate(),i=e.getProvider("database").getImmediate({identifier:t});return new fr(i,r)},"PUBLIC").setServiceProps({Reference:an,Query:Pl,Database:fr,DataSnapshot:dr,enableLogging:Iv,INTERNAL:U0,ServerValue:B0}).setMultipleInstances(!0)),n.registerVersion(k0,V0)}q0(Lt);function yo(n,e,t="on",r=Aa){return new rr(i=>{let s=null;return s=n[t](e,(o,a)=>{r.schedule(()=>{i.next({snapshot:o,prevKey:a})}),t==="once"&&r.schedule(()=>i.complete())},o=>{r.schedule(()=>i.error(o))}),t==="on"?{unsubscribe(){s!=null&&n.off(e,s)}}:{unsubscribe(){}}}).pipe(he(i=>{let{snapshot:s,prevKey:o}=i,a=null;return s.exists()&&(a=s.key),{type:e,payload:s,prevKey:o,key:a}}),Gg())}function j0(n){return typeof n=="string"}function G0(n){return typeof n.exportVal=="function"}function Nv(n){return n==null}function Dv(n){return typeof n.set=="function"}function bv(n,e){return Dv(e)?e:n.ref(e)}function kv(n,e){if(j0(n))return e.stringCase();if(Dv(n))return e.firebaseCase();if(G0(n))return e.snapshotCase();throw new Error(`Expects a string, snapshot, or reference. Got: ${typeof n}`)}function Vv(n){return(Nv(n)||n.length===0)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function Ov(n,e,t){e=Vv(e);let r=e.map(i=>yo(n,i,"on",t));return Cs(...r)}function K0(n,e,t){let r=Ov(n,e).pipe(ir((i,s)=>[...i,s],[]));return W0(n,r,t)}function z0(n,e){return yo(n,"value","on",e).pipe(he(t=>{let r;return t.payload.forEach(i=>(r=i.key,!1)),{data:t,lastKeyToLoad:r}}))}function W0(n,e,t){return z0(n,t).pipe(zg(e),he(([i,s])=>{let o=i.lastKeyToLoad,a=s.map(u=>u.key);return{actions:s,lastKeyToLoad:o,loadedKeys:a}}),Kg(i=>i.loadedKeys.indexOf(i.lastKeyToLoad)===-1),he(i=>i.actions))}function Rv(n,e){return function(r,i){return kv(r,{stringCase:()=>n.child(r)[e](i),firebaseCase:()=>r[e](i),snapshotCase:()=>r.ref[e](i)})}}function Q0(n){return function(t){return t?kv(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function $0(n,e,t){return yo(n,"value","once",t).pipe(sn(r=>{let i=[Ot(r)];return e.forEach(s=>i.push(yo(n,s,"on",t))),Cs(...i).pipe(ir(Y0,[]))}),ba())}function Fv(n,e){let t=n.length;for(let r=0;r<t;r++)if(n[r].payload.key===e)return r;return-1}function H0(n,e){if(Nv(e))return 0;{let t=Fv(n,e);return t===-1?n.length:t+1}}function Y0(n,e){let{payload:t,prevKey:r,key:i}=e,s=Fv(n,i),o=H0(n,r);switch(e.type){case"value":if(e.payload?.exists()){let a=null;e.payload.forEach(u=>{let c={payload:u,type:"value",prevKey:a,key:u.key};return a=u.key,n=[...n,c],!1})}return n;case"child_added":if(s>-1)(n[s-1]?.key||null)!==r&&(n=n.filter(u=>u.payload.key!==t.key),n.splice(o,0,e));else{if(r==null)return[e,...n];n=n.slice(),n.splice(o,0,e)}return n;case"child_removed":return n.filter(a=>a.payload.key!==t.key);case"child_changed":return n.map(a=>a.payload.key===i?e:a);case"child_moved":if(s>-1){let a=n.splice(s,1)[0];return n=n.slice(),n.splice(o,0,a),n}return n;default:return n}}function Pv(n,e,t){return e=Vv(e),$0(n,e,t)}function J0(n,e){let t=e.schedulers.outsideAngular,r=e.schedulers.ngZone.run(()=>n.ref);return{query:n,update:Rv(r,"update"),set:Rv(r,"set"),push:i=>r.push(i),remove:Q0(r),snapshotChanges(i){return Pv(n,i,t).pipe(Ce)},stateChanges(i){return Ov(n,i,t).pipe(Ce)},auditTrail(i){return K0(n,i,t).pipe(Ce)},valueChanges(i,s){return Pv(n,i,t).pipe(he(a=>a.map(u=>s&&s.idField?Ss(Vt({},u.payload.val()),{[s.idField]:u.key}):u.payload.val())),Ce)}}}function xv(n,e){return function(){return yo(n,"value","on",e)}}function X0(n,e){return{query:n,snapshotChanges(){return xv(n,e.schedulers.outsideAngular)().pipe(Ce)},update(t){return n.ref.update(t)},set(t){return n.ref.set(t)},remove(){return n.ref.remove()},valueChanges(){return xv(n,e.schedulers.outsideAngular)().pipe(Ce,he(r=>r.payload.exists()?r.payload.val():null))}}}var Z0=new Ze("angularfire2.realtimeDatabaseURL"),eC=new Ze("angularfire2.database.use-emulator"),Mv=(()=>{class n{schedulers;database;constructor(t,r,i,s,o,a,u,c,d,m,p,y,A,x,N){this.schedulers=a;let q=u,j=Xr(t,o,r);c&&Ls(j,o,d,p,y,A,m,x),this.database=Zr(`${j.name}.database.${i}`,"AngularFireDatabase",j.name,()=>{let F=o.runOutsideAngular(()=>j.database(i||void 0));return q&&F.useEmulator(...q),F},[q])}list(t,r){let i=this.schedulers.ngZone.runOutsideAngular(()=>bv(this.database,t)),s=i;return r&&(s=r(i)),J0(s,this)}object(t){let r=this.schedulers.ngZone.runOutsideAngular(()=>bv(this.database,t));return X0(r,this)}createPushId(){return this.schedulers.ngZone.runOutsideAngular(()=>this.database.ref()).push().key}static \u0275fac=function(r){return new(r||n)(K(Yr),K(Jr,8),K(Z0,8),K(In),K(Kr),K(Hr),K(eC,8),K(ei,8),K(Ds,8),K(ks,8),K(Vs,8),K(Os,8),K(Fs,8),K(Ms,8),K($r,8))};static \u0275prov=_t({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})();var Lv=(()=>{let e=class e{get loadingSnapshot(){return this.loadingSubject.getValue()}set loading(r){this.loadingSubject.next(r)}get totalRowsSnapshot(){return this.totalRowsSubject.getValue()}set totalRows(r){this.totalRowsSubject.next(r)}constructor(r){this.db=r,this.loadingSubject=new rn(!0),this.loading$=this.loadingSubject.asObservable(),this.modeSubject=new rn("addMode"),this.mode$=this.modeSubject.asObservable(),this.formValueSubject=new rn({}),this.formValue$=this.formValueSubject.asObservable(),this.totalRowsSubject=new rn(0),this.totalRows$=this.totalRowsSubject.asObservable()}getItemsRef(r){return this.db.list(r)}getItemRef(r,i){return this.db.object(`${r}/${i}`)}createItem(r,i){return this.getItemsRef(r).push(i)}getItemsList(r){return this.loading=!0,this.getItemsRef(r).snapshotChanges().pipe(he(s=>{let o=s.map(a=>Vt({id:a.payload.key},a.payload.val()));return this.totalRows=o.length,this.loading=!1,o}))}getItem(r,i){return this.getItemRef(r,i).valueChanges()}getItemBy_(r,i,s){return this.db.list(s,o=>o.orderByChild(i).equalTo(r)).snapshotChanges().pipe(he(o=>o.map(a=>Vt({key:a.payload.key},a.payload.val()))))}updateItem(r,i,s){return this.getItemsRef(r).update(i,s)}deleteItem(r,i){return this.getItemsRef(r).remove(i)}deleteAll(r){return this.getItemsRef(r).remove()}getItemsByDateRange(r,i,s,o){return this.db.list(o,a=>a.orderByChild(r).startAt(i.toISOString()).endAt(s.toISOString())).snapshotChanges().pipe(he(a=>a.map(u=>Vt({key:u.payload.key},u.payload.val()))))}};e.\u0275fac=function(i){return new(i||e)(K(Mv))},e.\u0275prov=_t({token:e,factory:e.\u0275fac,providedIn:"root"});let n=e;return n})();var Uv=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Bv={};var kn,Nd;(function(){var n;function e(E,_){function w(){}w.prototype=_.prototype,E.D=_.prototype,E.prototype=new w,E.prototype.constructor=E,E.C=function(I,T,C){for(var v=Array(arguments.length-2),en=2;en<arguments.length;en++)v[en-2]=arguments[en];return _.prototype[T].apply(I,v)}}function t(){this.blockSize=-1}function r(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}e(r,t),r.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(E,_,w){w||(w=0);var I=Array(16);if(typeof _=="string")for(var T=0;16>T;++T)I[T]=_.charCodeAt(w++)|_.charCodeAt(w++)<<8|_.charCodeAt(w++)<<16|_.charCodeAt(w++)<<24;else for(T=0;16>T;++T)I[T]=_[w++]|_[w++]<<8|_[w++]<<16|_[w++]<<24;_=E.g[0],w=E.g[1],T=E.g[2];var C=E.g[3],v=_+(C^w&(T^C))+I[0]+3614090360&4294967295;_=w+(v<<7&4294967295|v>>>25),v=C+(T^_&(w^T))+I[1]+3905402710&4294967295,C=_+(v<<12&4294967295|v>>>20),v=T+(w^C&(_^w))+I[2]+606105819&4294967295,T=C+(v<<17&4294967295|v>>>15),v=w+(_^T&(C^_))+I[3]+3250441966&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(C^w&(T^C))+I[4]+4118548399&4294967295,_=w+(v<<7&4294967295|v>>>25),v=C+(T^_&(w^T))+I[5]+1200080426&4294967295,C=_+(v<<12&4294967295|v>>>20),v=T+(w^C&(_^w))+I[6]+2821735955&4294967295,T=C+(v<<17&4294967295|v>>>15),v=w+(_^T&(C^_))+I[7]+4249261313&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(C^w&(T^C))+I[8]+1770035416&4294967295,_=w+(v<<7&4294967295|v>>>25),v=C+(T^_&(w^T))+I[9]+2336552879&4294967295,C=_+(v<<12&4294967295|v>>>20),v=T+(w^C&(_^w))+I[10]+4294925233&4294967295,T=C+(v<<17&4294967295|v>>>15),v=w+(_^T&(C^_))+I[11]+2304563134&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(C^w&(T^C))+I[12]+1804603682&4294967295,_=w+(v<<7&4294967295|v>>>25),v=C+(T^_&(w^T))+I[13]+4254626195&4294967295,C=_+(v<<12&4294967295|v>>>20),v=T+(w^C&(_^w))+I[14]+2792965006&4294967295,T=C+(v<<17&4294967295|v>>>15),v=w+(_^T&(C^_))+I[15]+1236535329&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(T^C&(w^T))+I[1]+4129170786&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^T&(_^w))+I[6]+3225465664&4294967295,C=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(C^_))+I[11]+643717713&4294967295,T=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(T^C))+I[0]+3921069994&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(T^C&(w^T))+I[5]+3593408605&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^T&(_^w))+I[10]+38016083&4294967295,C=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(C^_))+I[15]+3634488961&4294967295,T=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(T^C))+I[4]+3889429448&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(T^C&(w^T))+I[9]+568446438&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^T&(_^w))+I[14]+3275163606&4294967295,C=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(C^_))+I[3]+4107603335&4294967295,T=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(T^C))+I[8]+1163531501&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(T^C&(w^T))+I[13]+2850285829&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^T&(_^w))+I[2]+4243563512&4294967295,C=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(C^_))+I[7]+1735328473&4294967295,T=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(T^C))+I[12]+2368359562&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(w^T^C)+I[5]+4294588738&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^T)+I[8]+2272392833&4294967295,C=_+(v<<11&4294967295|v>>>21),v=T+(C^_^w)+I[11]+1839030562&4294967295,T=C+(v<<16&4294967295|v>>>16),v=w+(T^C^_)+I[14]+4259657740&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(w^T^C)+I[1]+2763975236&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^T)+I[4]+1272893353&4294967295,C=_+(v<<11&4294967295|v>>>21),v=T+(C^_^w)+I[7]+4139469664&4294967295,T=C+(v<<16&4294967295|v>>>16),v=w+(T^C^_)+I[10]+3200236656&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(w^T^C)+I[13]+681279174&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^T)+I[0]+3936430074&4294967295,C=_+(v<<11&4294967295|v>>>21),v=T+(C^_^w)+I[3]+3572445317&4294967295,T=C+(v<<16&4294967295|v>>>16),v=w+(T^C^_)+I[6]+76029189&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(w^T^C)+I[9]+3654602809&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^T)+I[12]+3873151461&4294967295,C=_+(v<<11&4294967295|v>>>21),v=T+(C^_^w)+I[15]+530742520&4294967295,T=C+(v<<16&4294967295|v>>>16),v=w+(T^C^_)+I[2]+3299628645&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(T^(w|~C))+I[0]+4096336452&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~T))+I[7]+1126891415&4294967295,C=_+(v<<10&4294967295|v>>>22),v=T+(_^(C|~w))+I[14]+2878612391&4294967295,T=C+(v<<15&4294967295|v>>>17),v=w+(C^(T|~_))+I[5]+4237533241&4294967295,w=T+(v<<21&4294967295|v>>>11),v=_+(T^(w|~C))+I[12]+1700485571&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~T))+I[3]+2399980690&4294967295,C=_+(v<<10&4294967295|v>>>22),v=T+(_^(C|~w))+I[10]+4293915773&4294967295,T=C+(v<<15&4294967295|v>>>17),v=w+(C^(T|~_))+I[1]+2240044497&4294967295,w=T+(v<<21&4294967295|v>>>11),v=_+(T^(w|~C))+I[8]+1873313359&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~T))+I[15]+4264355552&4294967295,C=_+(v<<10&4294967295|v>>>22),v=T+(_^(C|~w))+I[6]+2734768916&4294967295,T=C+(v<<15&4294967295|v>>>17),v=w+(C^(T|~_))+I[13]+1309151649&4294967295,w=T+(v<<21&4294967295|v>>>11),v=_+(T^(w|~C))+I[4]+4149444226&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~T))+I[11]+3174756917&4294967295,C=_+(v<<10&4294967295|v>>>22),v=T+(_^(C|~w))+I[2]+718787259&4294967295,T=C+(v<<15&4294967295|v>>>17),v=w+(C^(T|~_))+I[9]+3951481745&4294967295,E.g[0]=E.g[0]+_&4294967295,E.g[1]=E.g[1]+(T+(v<<21&4294967295|v>>>11))&4294967295,E.g[2]=E.g[2]+T&4294967295,E.g[3]=E.g[3]+C&4294967295}r.prototype.u=function(E,_){_===void 0&&(_=E.length);for(var w=_-this.blockSize,I=this.B,T=this.h,C=0;C<_;){if(T==0)for(;C<=w;)i(this,E,C),C+=this.blockSize;if(typeof E=="string"){for(;C<_;)if(I[T++]=E.charCodeAt(C++),T==this.blockSize){i(this,I),T=0;break}}else for(;C<_;)if(I[T++]=E[C++],T==this.blockSize){i(this,I),T=0;break}}this.h=T,this.o+=_},r.prototype.v=function(){var E=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);E[0]=128;for(var _=1;_<E.length-8;++_)E[_]=0;var w=8*this.o;for(_=E.length-8;_<E.length;++_)E[_]=w&255,w/=256;for(this.u(E),E=Array(16),_=w=0;4>_;++_)for(var I=0;32>I;I+=8)E[w++]=this.g[_]>>>I&255;return E};function s(E,_){var w=a;return Object.prototype.hasOwnProperty.call(w,E)?w[E]:w[E]=_(E)}function o(E,_){this.h=_;for(var w=[],I=!0,T=E.length-1;0<=T;T--){var C=E[T]|0;I&&C==_||(w[T]=C,I=!1)}this.g=w}var a={};function u(E){return-128<=E&&128>E?s(E,function(_){return new o([_|0],0>_?-1:0)}):new o([E|0],0>E?-1:0)}function c(E){if(isNaN(E)||!isFinite(E))return m;if(0>E)return N(c(-E));for(var _=[],w=1,I=0;E>=w;I++)_[I]=E/w|0,w*=4294967296;return new o(_,0)}function d(E,_){if(E.length==0)throw Error("number format error: empty string");if(_=_||10,2>_||36<_)throw Error("radix out of range: "+_);if(E.charAt(0)=="-")return N(d(E.substring(1),_));if(0<=E.indexOf("-"))throw Error('number format error: interior "-" character');for(var w=c(Math.pow(_,8)),I=m,T=0;T<E.length;T+=8){var C=Math.min(8,E.length-T),v=parseInt(E.substring(T,T+C),_);8>C?(C=c(Math.pow(_,C)),I=I.j(C).add(c(v))):(I=I.j(w),I=I.add(c(v)))}return I}var m=u(0),p=u(1),y=u(16777216);n=o.prototype,n.m=function(){if(x(this))return-N(this).m();for(var E=0,_=1,w=0;w<this.g.length;w++){var I=this.i(w);E+=(0<=I?I:4294967296+I)*_,_*=4294967296}return E},n.toString=function(E){if(E=E||10,2>E||36<E)throw Error("radix out of range: "+E);if(A(this))return"0";if(x(this))return"-"+N(this).toString(E);for(var _=c(Math.pow(E,6)),w=this,I="";;){var T=W(w,_).g;w=q(w,T.j(_));var C=((0<w.g.length?w.g[0]:w.h)>>>0).toString(E);if(w=T,A(w))return C+I;for(;6>C.length;)C="0"+C;I=C+I}},n.i=function(E){return 0>E?0:E<this.g.length?this.g[E]:this.h};function A(E){if(E.h!=0)return!1;for(var _=0;_<E.g.length;_++)if(E.g[_]!=0)return!1;return!0}function x(E){return E.h==-1}n.l=function(E){return E=q(this,E),x(E)?-1:A(E)?0:1};function N(E){for(var _=E.g.length,w=[],I=0;I<_;I++)w[I]=~E.g[I];return new o(w,~E.h).add(p)}n.abs=function(){return x(this)?N(this):this},n.add=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0,T=0;T<=_;T++){var C=I+(this.i(T)&65535)+(E.i(T)&65535),v=(C>>>16)+(this.i(T)>>>16)+(E.i(T)>>>16);I=v>>>16,C&=65535,v&=65535,w[T]=v<<16|C}return new o(w,w[w.length-1]&-2147483648?-1:0)};function q(E,_){return E.add(N(_))}n.j=function(E){if(A(this)||A(E))return m;if(x(this))return x(E)?N(this).j(N(E)):N(N(this).j(E));if(x(E))return N(this.j(N(E)));if(0>this.l(y)&&0>E.l(y))return c(this.m()*E.m());for(var _=this.g.length+E.g.length,w=[],I=0;I<2*_;I++)w[I]=0;for(I=0;I<this.g.length;I++)for(var T=0;T<E.g.length;T++){var C=this.i(I)>>>16,v=this.i(I)&65535,en=E.i(T)>>>16,ss=E.i(T)&65535;w[2*I+2*T]+=v*ss,j(w,2*I+2*T),w[2*I+2*T+1]+=C*ss,j(w,2*I+2*T+1),w[2*I+2*T+1]+=v*en,j(w,2*I+2*T+1),w[2*I+2*T+2]+=C*en,j(w,2*I+2*T+2)}for(I=0;I<_;I++)w[I]=w[2*I+1]<<16|w[2*I];for(I=_;I<2*_;I++)w[I]=0;return new o(w,0)};function j(E,_){for(;(E[_]&65535)!=E[_];)E[_+1]+=E[_]>>>16,E[_]&=65535,_++}function F(E,_){this.g=E,this.h=_}function W(E,_){if(A(_))throw Error("division by zero");if(A(E))return new F(m,m);if(x(E))return _=W(N(E),_),new F(N(_.g),N(_.h));if(x(_))return _=W(E,N(_)),new F(N(_.g),_.h);if(30<E.g.length){if(x(E)||x(_))throw Error("slowDivide_ only works with positive integers.");for(var w=p,I=_;0>=I.l(E);)w=H(w),I=H(I);var T=Y(w,1),C=Y(I,1);for(I=Y(I,2),w=Y(w,2);!A(I);){var v=C.add(I);0>=v.l(E)&&(T=T.add(w),C=v),I=Y(I,1),w=Y(w,1)}return _=q(E,T.j(_)),new F(T,_)}for(T=m;0<=E.l(_);){for(w=Math.max(1,Math.floor(E.m()/_.m())),I=Math.ceil(Math.log(w)/Math.LN2),I=48>=I?1:Math.pow(2,I-48),C=c(w),v=C.j(_);x(v)||0<v.l(E);)w-=I,C=c(w),v=C.j(_);A(C)&&(C=p),T=T.add(C),E=q(E,v)}return new F(T,E)}n.A=function(E){return W(this,E).h},n.and=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)&E.i(I);return new o(w,this.h&E.h)},n.or=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)|E.i(I);return new o(w,this.h|E.h)},n.xor=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)^E.i(I);return new o(w,this.h^E.h)};function H(E){for(var _=E.g.length+1,w=[],I=0;I<_;I++)w[I]=E.i(I)<<1|E.i(I-1)>>>31;return new o(w,E.h)}function Y(E,_){var w=_>>5;_%=32;for(var I=E.g.length-w,T=[],C=0;C<I;C++)T[C]=0<_?E.i(C+w)>>>_|E.i(C+w+1)<<32-_:E.i(C+w);return new o(T,E.h)}r.prototype.digest=r.prototype.v,r.prototype.reset=r.prototype.s,r.prototype.update=r.prototype.u,Nd=Bv.Md5=r,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=c,o.fromString=d,kn=Bv.Integer=o}).apply(typeof Uv<"u"?Uv:typeof self<"u"?self:typeof window<"u"?window:{});var xl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},ln={};var Dd,kd,yi,Vd,vo,Nl,Od,Fd,Md;(function(){var n,e=typeof Object.defineProperties=="function"?Object.defineProperty:function(l,h,f){return l==Array.prototype||l==Object.prototype||(l[h]=f.value),l};function t(l){l=[typeof globalThis=="object"&&globalThis,l,typeof window=="object"&&window,typeof self=="object"&&self,typeof xl=="object"&&xl];for(var h=0;h<l.length;++h){var f=l[h];if(f&&f.Math==Math)return f}throw Error("Cannot find global object")}var r=t(this);function i(l,h){if(h)e:{var f=r;l=l.split(".");for(var g=0;g<l.length-1;g++){var S=l[g];if(!(S in f))break e;f=f[S]}l=l[l.length-1],g=f[l],h=h(g),h!=g&&h!=null&&e(f,l,{configurable:!0,writable:!0,value:h})}}function s(l,h){l instanceof String&&(l+="");var f=0,g=!1,S={next:function(){if(!g&&f<l.length){var P=f++;return{value:h(P,l[P]),done:!1}}return g=!0,{done:!0,value:void 0}}};return S[Symbol.iterator]=function(){return S},S}i("Array.prototype.values",function(l){return l||function(){return s(this,function(h,f){return f})}});var o=o||{},a=this||self;function u(l){var h=typeof l;return h=h!="object"?h:l?Array.isArray(l)?"array":h:"null",h=="array"||h=="object"&&typeof l.length=="number"}function c(l){var h=typeof l;return h=="object"&&l!=null||h=="function"}function d(l,h,f){return l.call.apply(l.bind,arguments)}function m(l,h,f){if(!l)throw Error();if(2<arguments.length){var g=Array.prototype.slice.call(arguments,2);return function(){var S=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(S,g),l.apply(h,S)}}return function(){return l.apply(h,arguments)}}function p(l,h,f){return p=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?d:m,p.apply(null,arguments)}function y(l,h){var f=Array.prototype.slice.call(arguments,1);return function(){var g=f.slice();return g.push.apply(g,arguments),l.apply(this,g)}}function A(l,h){function f(){}f.prototype=h.prototype,l.aa=h.prototype,l.prototype=new f,l.prototype.constructor=l,l.Qb=function(g,S,P){for(var M=Array(arguments.length-2),de=2;de<arguments.length;de++)M[de-2]=arguments[de];return h.prototype[S].apply(g,M)}}function x(l){let h=l.length;if(0<h){let f=Array(h);for(let g=0;g<h;g++)f[g]=l[g];return f}return[]}function N(l,h){for(let f=1;f<arguments.length;f++){let g=arguments[f];if(u(g)){let S=l.length||0,P=g.length||0;l.length=S+P;for(let M=0;M<P;M++)l[S+M]=g[M]}else l.push(g)}}class q{constructor(h,f){this.i=h,this.j=f,this.h=0,this.g=null}get(){let h;return 0<this.h?(this.h--,h=this.g,this.g=h.next,h.next=null):h=this.i(),h}}function j(l){return/^[\s\xa0]*$/.test(l)}function F(){var l=a.navigator;return l&&(l=l.userAgent)?l:""}function W(l){return W[" "](l),l}W[" "]=function(){};var H=F().indexOf("Gecko")!=-1&&!(F().toLowerCase().indexOf("webkit")!=-1&&F().indexOf("Edge")==-1)&&!(F().indexOf("Trident")!=-1||F().indexOf("MSIE")!=-1)&&F().indexOf("Edge")==-1;function Y(l,h,f){for(let g in l)h.call(f,l[g],g,l)}function E(l,h){for(let f in l)h.call(void 0,l[f],f,l)}function _(l){let h={};for(let f in l)h[f]=l[f];return h}let w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function I(l,h){let f,g;for(let S=1;S<arguments.length;S++){g=arguments[S];for(f in g)l[f]=g[f];for(let P=0;P<w.length;P++)f=w[P],Object.prototype.hasOwnProperty.call(g,f)&&(l[f]=g[f])}}function T(l){var h=1;l=l.split(":");let f=[];for(;0<h&&l.length;)f.push(l.shift()),h--;return l.length&&f.push(l.join(":")),f}function C(l){a.setTimeout(()=>{throw l},0)}function v(){var l=ec;let h=null;return l.g&&(h=l.g,l.g=l.g.next,l.g||(l.h=null),h.next=null),h}class en{constructor(){this.h=this.g=null}add(h,f){let g=ss.get();g.set(h,f),this.h?this.h.next=g:this.g=g,this.h=g}}var ss=new q(()=>new wT,l=>l.reset());class wT{constructor(){this.next=this.g=this.h=null}set(h,f){this.h=h,this.g=f,this.next=null}reset(){this.next=this.g=this.h=null}}let os,as=!1,ec=new en,Bp=()=>{let l=a.Promise.resolve(void 0);os=()=>{l.then(ET)}};var ET=()=>{for(var l;l=v();){try{l.h.call(l.g)}catch(f){C(f)}var h=ss;h.j(l),100>h.h&&(h.h++,l.next=h.g,h.g=l)}as=!1};function yn(){this.s=this.s,this.C=this.C}yn.prototype.s=!1,yn.prototype.ma=function(){this.s||(this.s=!0,this.N())},yn.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function Ke(l,h){this.type=l,this.g=this.target=h,this.defaultPrevented=!1}Ke.prototype.h=function(){this.defaultPrevented=!0};var IT=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var l=!1,h=Object.defineProperty({},"passive",{get:function(){l=!0}});try{let f=()=>{};a.addEventListener("test",f,h),a.removeEventListener("test",f,h)}catch{}return l}();function ls(l,h){if(Ke.call(this,l?l.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,l){var f=this.type=l.type,g=l.changedTouches&&l.changedTouches.length?l.changedTouches[0]:null;if(this.target=l.target||l.srcElement,this.g=h,h=l.relatedTarget){if(H){e:{try{W(h.nodeName);var S=!0;break e}catch{}S=!1}S||(h=null)}}else f=="mouseover"?h=l.fromElement:f=="mouseout"&&(h=l.toElement);this.relatedTarget=h,g?(this.clientX=g.clientX!==void 0?g.clientX:g.pageX,this.clientY=g.clientY!==void 0?g.clientY:g.pageY,this.screenX=g.screenX||0,this.screenY=g.screenY||0):(this.clientX=l.clientX!==void 0?l.clientX:l.pageX,this.clientY=l.clientY!==void 0?l.clientY:l.pageY,this.screenX=l.screenX||0,this.screenY=l.screenY||0),this.button=l.button,this.key=l.key||"",this.ctrlKey=l.ctrlKey,this.altKey=l.altKey,this.shiftKey=l.shiftKey,this.metaKey=l.metaKey,this.pointerId=l.pointerId||0,this.pointerType=typeof l.pointerType=="string"?l.pointerType:TT[l.pointerType]||"",this.state=l.state,this.i=l,l.defaultPrevented&&ls.aa.h.call(this)}}A(ls,Ke);var TT={2:"touch",3:"pen",4:"mouse"};ls.prototype.h=function(){ls.aa.h.call(this);var l=this.i;l.preventDefault?l.preventDefault():l.returnValue=!1};var us="closure_listenable_"+(1e6*Math.random()|0),ST=0;function AT(l,h,f,g,S){this.listener=l,this.proxy=null,this.src=h,this.type=f,this.capture=!!g,this.ha=S,this.key=++ST,this.da=this.fa=!1}function la(l){l.da=!0,l.listener=null,l.proxy=null,l.src=null,l.ha=null}function ua(l){this.src=l,this.g={},this.h=0}ua.prototype.add=function(l,h,f,g,S){var P=l.toString();l=this.g[P],l||(l=this.g[P]=[],this.h++);var M=nc(l,h,g,S);return-1<M?(h=l[M],f||(h.fa=!1)):(h=new AT(h,this.src,P,!!g,S),h.fa=f,l.push(h)),h};function tc(l,h){var f=h.type;if(f in l.g){var g=l.g[f],S=Array.prototype.indexOf.call(g,h,void 0),P;(P=0<=S)&&Array.prototype.splice.call(g,S,1),P&&(la(h),l.g[f].length==0&&(delete l.g[f],l.h--))}}function nc(l,h,f,g){for(var S=0;S<l.length;++S){var P=l[S];if(!P.da&&P.listener==h&&P.capture==!!f&&P.ha==g)return S}return-1}var rc="closure_lm_"+(1e6*Math.random()|0),ic={};function qp(l,h,f,g,S){if(g&&g.once)return Gp(l,h,f,g,S);if(Array.isArray(h)){for(var P=0;P<h.length;P++)qp(l,h[P],f,g,S);return null}return f=lc(f),l&&l[us]?l.K(h,f,c(g)?!!g.capture:!!g,S):jp(l,h,f,!1,g,S)}function jp(l,h,f,g,S,P){if(!h)throw Error("Invalid event type");var M=c(S)?!!S.capture:!!S,de=oc(l);if(de||(l[rc]=de=new ua(l)),f=de.add(h,f,g,M,P),f.proxy)return f;if(g=CT(),f.proxy=g,g.src=l,g.listener=f,l.addEventListener)IT||(S=M),S===void 0&&(S=!1),l.addEventListener(h.toString(),g,S);else if(l.attachEvent)l.attachEvent(zp(h.toString()),g);else if(l.addListener&&l.removeListener)l.addListener(g);else throw Error("addEventListener and attachEvent are unavailable.");return f}function CT(){function l(f){return h.call(l.src,l.listener,f)}let h=bT;return l}function Gp(l,h,f,g,S){if(Array.isArray(h)){for(var P=0;P<h.length;P++)Gp(l,h[P],f,g,S);return null}return f=lc(f),l&&l[us]?l.L(h,f,c(g)?!!g.capture:!!g,S):jp(l,h,f,!0,g,S)}function Kp(l,h,f,g,S){if(Array.isArray(h))for(var P=0;P<h.length;P++)Kp(l,h[P],f,g,S);else g=c(g)?!!g.capture:!!g,f=lc(f),l&&l[us]?(l=l.i,h=String(h).toString(),h in l.g&&(P=l.g[h],f=nc(P,f,g,S),-1<f&&(la(P[f]),Array.prototype.splice.call(P,f,1),P.length==0&&(delete l.g[h],l.h--)))):l&&(l=oc(l))&&(h=l.g[h.toString()],l=-1,h&&(l=nc(h,f,g,S)),(f=-1<l?h[l]:null)&&sc(f))}function sc(l){if(typeof l!="number"&&l&&!l.da){var h=l.src;if(h&&h[us])tc(h.i,l);else{var f=l.type,g=l.proxy;h.removeEventListener?h.removeEventListener(f,g,l.capture):h.detachEvent?h.detachEvent(zp(f),g):h.addListener&&h.removeListener&&h.removeListener(g),(f=oc(h))?(tc(f,l),f.h==0&&(f.src=null,h[rc]=null)):la(l)}}}function zp(l){return l in ic?ic[l]:ic[l]="on"+l}function bT(l,h){if(l.da)l=!0;else{h=new ls(h,this);var f=l.listener,g=l.ha||l.src;l.fa&&sc(l),l=f.call(g,h)}return l}function oc(l){return l=l[rc],l instanceof ua?l:null}var ac="__closure_events_fn_"+(1e9*Math.random()>>>0);function lc(l){return typeof l=="function"?l:(l[ac]||(l[ac]=function(h){return l.handleEvent(h)}),l[ac])}function ze(){yn.call(this),this.i=new ua(this),this.M=this,this.F=null}A(ze,yn),ze.prototype[us]=!0,ze.prototype.removeEventListener=function(l,h,f,g){Kp(this,l,h,f,g)};function Je(l,h){var f,g=l.F;if(g)for(f=[];g;g=g.F)f.push(g);if(l=l.M,g=h.type||h,typeof h=="string")h=new Ke(h,l);else if(h instanceof Ke)h.target=h.target||l;else{var S=h;h=new Ke(g,l),I(h,S)}if(S=!0,f)for(var P=f.length-1;0<=P;P--){var M=h.g=f[P];S=ca(M,g,!0,h)&&S}if(M=h.g=l,S=ca(M,g,!0,h)&&S,S=ca(M,g,!1,h)&&S,f)for(P=0;P<f.length;P++)M=h.g=f[P],S=ca(M,g,!1,h)&&S}ze.prototype.N=function(){if(ze.aa.N.call(this),this.i){var l=this.i,h;for(h in l.g){for(var f=l.g[h],g=0;g<f.length;g++)la(f[g]);delete l.g[h],l.h--}}this.F=null},ze.prototype.K=function(l,h,f,g){return this.i.add(String(l),h,!1,f,g)},ze.prototype.L=function(l,h,f,g){return this.i.add(String(l),h,!0,f,g)};function ca(l,h,f,g){if(h=l.i.g[String(h)],!h)return!0;h=h.concat();for(var S=!0,P=0;P<h.length;++P){var M=h[P];if(M&&!M.da&&M.capture==f){var de=M.listener,je=M.ha||M.src;M.fa&&tc(l.i,M),S=de.call(je,g)!==!1&&S}}return S&&!g.defaultPrevented}function Wp(l,h,f){if(typeof l=="function")f&&(l=p(l,f));else if(l&&typeof l.handleEvent=="function")l=p(l.handleEvent,l);else throw Error("Invalid listener argument");return 2147483647<Number(h)?-1:a.setTimeout(l,h||0)}function Qp(l){l.g=Wp(()=>{l.g=null,l.i&&(l.i=!1,Qp(l))},l.l);let h=l.h;l.h=null,l.m.apply(null,h)}class RT extends yn{constructor(h,f){super(),this.m=h,this.l=f,this.h=null,this.i=!1,this.g=null}j(h){this.h=arguments,this.g?this.i=!0:Qp(this)}N(){super.N(),this.g&&(a.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function cs(l){yn.call(this),this.h=l,this.g={}}A(cs,yn);var $p=[];function Hp(l){Y(l.g,function(h,f){this.g.hasOwnProperty(f)&&sc(h)},l),l.g={}}cs.prototype.N=function(){cs.aa.N.call(this),Hp(this)},cs.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var uc=a.JSON.stringify,PT=a.JSON.parse,xT=class{stringify(l){return a.JSON.stringify(l,void 0)}parse(l){return a.JSON.parse(l,void 0)}};function cc(){}cc.prototype.h=null;function Yp(l){return l.h||(l.h=l.i())}function Jp(){}var hs={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function hc(){Ke.call(this,"d")}A(hc,Ke);function dc(){Ke.call(this,"c")}A(dc,Ke);var Zn={},Xp=null;function ha(){return Xp=Xp||new ze}Zn.La="serverreachability";function Zp(l){Ke.call(this,Zn.La,l)}A(Zp,Ke);function ds(l){let h=ha();Je(h,new Zp(h))}Zn.STAT_EVENT="statevent";function eg(l,h){Ke.call(this,Zn.STAT_EVENT,l),this.stat=h}A(eg,Ke);function Xe(l){let h=ha();Je(h,new eg(h,l))}Zn.Ma="timingevent";function tg(l,h){Ke.call(this,Zn.Ma,l),this.size=h}A(tg,Ke);function fs(l,h){if(typeof l!="function")throw Error("Fn must not be null and must be a function");return a.setTimeout(function(){l()},h)}function ms(){this.g=!0}ms.prototype.xa=function(){this.g=!1};function NT(l,h,f,g,S,P){l.info(function(){if(l.g)if(P)for(var M="",de=P.split("&"),je=0;je<de.length;je++){var ae=de[je].split("=");if(1<ae.length){var We=ae[0];ae=ae[1];var Qe=We.split("_");M=2<=Qe.length&&Qe[1]=="type"?M+(We+"="+ae+"&"):M+(We+"=redacted&")}}else M=null;else M=P;return"XMLHTTP REQ ("+g+") [attempt "+S+"]: "+h+`
`+f+`
`+M})}function DT(l,h,f,g,S,P,M){l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+S+"]: "+h+`
`+f+`
`+P+" "+M})}function Br(l,h,f,g){l.info(function(){return"XMLHTTP TEXT ("+h+"): "+VT(l,f)+(g?" "+g:"")})}function kT(l,h){l.info(function(){return"TIMEOUT: "+h})}ms.prototype.info=function(){};function VT(l,h){if(!l.g)return h;if(!h)return null;try{var f=JSON.parse(h);if(f){for(l=0;l<f.length;l++)if(Array.isArray(f[l])){var g=f[l];if(!(2>g.length)){var S=g[1];if(Array.isArray(S)&&!(1>S.length)){var P=S[0];if(P!="noop"&&P!="stop"&&P!="close")for(var M=1;M<S.length;M++)S[M]=""}}}}return uc(f)}catch{return h}}var da={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},ng={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},fc;function fa(){}A(fa,cc),fa.prototype.g=function(){return new XMLHttpRequest},fa.prototype.i=function(){return{}},fc=new fa;function vn(l,h,f,g){this.j=l,this.i=h,this.l=f,this.R=g||1,this.U=new cs(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new rg}function rg(){this.i=null,this.g="",this.h=!1}var ig={},mc={};function pc(l,h,f){l.L=1,l.v=_a(tn(h)),l.m=f,l.P=!0,sg(l,null)}function sg(l,h){l.F=Date.now(),ma(l),l.A=tn(l.v);var f=l.A,g=l.R;Array.isArray(g)||(g=[String(g)]),vg(f.i,"t",g),l.C=0,f=l.j.J,l.h=new rg,l.g=Mg(l.j,f?h:null,!l.m),0<l.O&&(l.M=new RT(p(l.Y,l,l.g),l.O)),h=l.U,f=l.g,g=l.ca;var S="readystatechange";Array.isArray(S)||(S&&($p[0]=S.toString()),S=$p);for(var P=0;P<S.length;P++){var M=qp(f,S[P],g||h.handleEvent,!1,h.h||h);if(!M)break;h.g[M.key]=M}h=l.H?_(l.H):{},l.m?(l.u||(l.u="POST"),h["Content-Type"]="application/x-www-form-urlencoded",l.g.ea(l.A,l.u,l.m,h)):(l.u="GET",l.g.ea(l.A,l.u,null,h)),ds(),NT(l.i,l.u,l.A,l.l,l.R,l.m)}vn.prototype.ca=function(l){l=l.target;let h=this.M;h&&nn(l)==3?h.j():this.Y(l)},vn.prototype.Y=function(l){try{if(l==this.g)e:{let Qe=nn(this.g);var h=this.g.Ba();let Gr=this.g.Z();if(!(3>Qe)&&(Qe!=3||this.g&&(this.h.h||this.g.oa()||Cg(this.g)))){this.J||Qe!=4||h==7||(h==8||0>=Gr?ds(3):ds(2)),gc(this);var f=this.g.Z();this.X=f;t:if(og(this)){var g=Cg(this.g);l="";var S=g.length,P=nn(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){er(this),ps(this);var M="";break t}this.h.i=new a.TextDecoder}for(h=0;h<S;h++)this.h.h=!0,l+=this.h.i.decode(g[h],{stream:!(P&&h==S-1)});g.length=0,this.h.g+=l,this.C=0,M=this.h.g}else M=this.g.oa();if(this.o=f==200,DT(this.i,this.u,this.A,this.l,this.R,Qe,f),this.o){if(this.T&&!this.K){t:{if(this.g){var de,je=this.g;if((de=je.g?je.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!j(de)){var ae=de;break t}}ae=null}if(f=ae)Br(this.i,this.l,f,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,_c(this,f);else{this.o=!1,this.s=3,Xe(12),er(this),ps(this);break e}}if(this.P){f=!0;let bt;for(;!this.J&&this.C<M.length;)if(bt=OT(this,M),bt==mc){Qe==4&&(this.s=4,Xe(14),f=!1),Br(this.i,this.l,null,"[Incomplete Response]");break}else if(bt==ig){this.s=4,Xe(15),Br(this.i,this.l,M,"[Invalid Chunk]"),f=!1;break}else Br(this.i,this.l,bt,null),_c(this,bt);if(og(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Qe!=4||M.length!=0||this.h.h||(this.s=1,Xe(16),f=!1),this.o=this.o&&f,!f)Br(this.i,this.l,M,"[Invalid Chunked Response]"),er(this),ps(this);else if(0<M.length&&!this.W){this.W=!0;var We=this.j;We.g==this&&We.ba&&!We.M&&(We.j.info("Great, no buffering proxy detected. Bytes received: "+M.length),Tc(We),We.M=!0,Xe(11))}}else Br(this.i,this.l,M,null),_c(this,M);Qe==4&&er(this),this.o&&!this.J&&(Qe==4?kg(this.j,this):(this.o=!1,ma(this)))}else XT(this.g),f==400&&0<M.indexOf("Unknown SID")?(this.s=3,Xe(12)):(this.s=0,Xe(13)),er(this),ps(this)}}}catch{}finally{}};function og(l){return l.g?l.u=="GET"&&l.L!=2&&l.j.Ca:!1}function OT(l,h){var f=l.C,g=h.indexOf(`
`,f);return g==-1?mc:(f=Number(h.substring(f,g)),isNaN(f)?ig:(g+=1,g+f>h.length?mc:(h=h.slice(g,g+f),l.C=g+f,h)))}vn.prototype.cancel=function(){this.J=!0,er(this)};function ma(l){l.S=Date.now()+l.I,ag(l,l.I)}function ag(l,h){if(l.B!=null)throw Error("WatchDog timer not null");l.B=fs(p(l.ba,l),h)}function gc(l){l.B&&(a.clearTimeout(l.B),l.B=null)}vn.prototype.ba=function(){this.B=null;let l=Date.now();0<=l-this.S?(kT(this.i,this.A),this.L!=2&&(ds(),Xe(17)),er(this),this.s=2,ps(this)):ag(this,this.S-l)};function ps(l){l.j.G==0||l.J||kg(l.j,l)}function er(l){gc(l);var h=l.M;h&&typeof h.ma=="function"&&h.ma(),l.M=null,Hp(l.U),l.g&&(h=l.g,l.g=null,h.abort(),h.ma())}function _c(l,h){try{var f=l.j;if(f.G!=0&&(f.g==l||yc(f.h,l))){if(!l.K&&yc(f.h,l)&&f.G==3){try{var g=f.Da.g.parse(h)}catch{g=null}if(Array.isArray(g)&&g.length==3){var S=g;if(S[0]==0){e:if(!f.u){if(f.g)if(f.g.F+3e3<l.F)Ia(f),wa(f);else break e;Ic(f),Xe(18)}}else f.za=S[1],0<f.za-f.T&&37500>S[2]&&f.F&&f.v==0&&!f.C&&(f.C=fs(p(f.Za,f),6e3));if(1>=cg(f.h)&&f.ca){try{f.ca()}catch{}f.ca=void 0}}else nr(f,11)}else if((l.K||f.g==l)&&Ia(f),!j(h))for(S=f.Da.g.parse(h),h=0;h<S.length;h++){let ae=S[h];if(f.T=ae[0],ae=ae[1],f.G==2)if(ae[0]=="c"){f.K=ae[1],f.ia=ae[2];let We=ae[3];We!=null&&(f.la=We,f.j.info("VER="+f.la));let Qe=ae[4];Qe!=null&&(f.Aa=Qe,f.j.info("SVER="+f.Aa));let Gr=ae[5];Gr!=null&&typeof Gr=="number"&&0<Gr&&(g=1.5*Gr,f.L=g,f.j.info("backChannelRequestTimeoutMs_="+g)),g=f;let bt=l.g;if(bt){let Sa=bt.g?bt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Sa){var P=g.h;P.g||Sa.indexOf("spdy")==-1&&Sa.indexOf("quic")==-1&&Sa.indexOf("h2")==-1||(P.j=P.l,P.g=new Set,P.h&&(vc(P,P.h),P.h=null))}if(g.D){let Sc=bt.g?bt.g.getResponseHeader("X-HTTP-Session-Id"):null;Sc&&(g.ya=Sc,_e(g.I,g.D,Sc))}}f.G=3,f.l&&f.l.ua(),f.ba&&(f.R=Date.now()-l.F,f.j.info("Handshake RTT: "+f.R+"ms")),g=f;var M=l;if(g.qa=Fg(g,g.J?g.ia:null,g.W),M.K){hg(g.h,M);var de=M,je=g.L;je&&(de.I=je),de.B&&(gc(de),ma(de)),g.g=M}else Ng(g);0<f.i.length&&Ea(f)}else ae[0]!="stop"&&ae[0]!="close"||nr(f,7);else f.G==3&&(ae[0]=="stop"||ae[0]=="close"?ae[0]=="stop"?nr(f,7):Ec(f):ae[0]!="noop"&&f.l&&f.l.ta(ae),f.v=0)}}ds(4)}catch{}}var FT=class{constructor(l,h){this.g=l,this.map=h}};function lg(l){this.l=l||10,a.PerformanceNavigationTiming?(l=a.performance.getEntriesByType("navigation"),l=0<l.length&&(l[0].nextHopProtocol=="hq"||l[0].nextHopProtocol=="h2")):l=!!(a.chrome&&a.chrome.loadTimes&&a.chrome.loadTimes()&&a.chrome.loadTimes().wasFetchedViaSpdy),this.j=l?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function ug(l){return l.h?!0:l.g?l.g.size>=l.j:!1}function cg(l){return l.h?1:l.g?l.g.size:0}function yc(l,h){return l.h?l.h==h:l.g?l.g.has(h):!1}function vc(l,h){l.g?l.g.add(h):l.h=h}function hg(l,h){l.h&&l.h==h?l.h=null:l.g&&l.g.has(h)&&l.g.delete(h)}lg.prototype.cancel=function(){if(this.i=dg(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let l of this.g.values())l.cancel();this.g.clear()}};function dg(l){if(l.h!=null)return l.i.concat(l.h.D);if(l.g!=null&&l.g.size!==0){let h=l.i;for(let f of l.g.values())h=h.concat(f.D);return h}return x(l.i)}function MT(l){if(l.V&&typeof l.V=="function")return l.V();if(typeof Map<"u"&&l instanceof Map||typeof Set<"u"&&l instanceof Set)return Array.from(l.values());if(typeof l=="string")return l.split("");if(u(l)){for(var h=[],f=l.length,g=0;g<f;g++)h.push(l[g]);return h}h=[],f=0;for(g in l)h[f++]=l[g];return h}function LT(l){if(l.na&&typeof l.na=="function")return l.na();if(!l.V||typeof l.V!="function"){if(typeof Map<"u"&&l instanceof Map)return Array.from(l.keys());if(!(typeof Set<"u"&&l instanceof Set)){if(u(l)||typeof l=="string"){var h=[];l=l.length;for(var f=0;f<l;f++)h.push(f);return h}h=[],f=0;for(let g in l)h[f++]=g;return h}}}function fg(l,h){if(l.forEach&&typeof l.forEach=="function")l.forEach(h,void 0);else if(u(l)||typeof l=="string")Array.prototype.forEach.call(l,h,void 0);else for(var f=LT(l),g=MT(l),S=g.length,P=0;P<S;P++)h.call(void 0,g[P],f&&f[P],l)}var mg=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function UT(l,h){if(l){l=l.split("&");for(var f=0;f<l.length;f++){var g=l[f].indexOf("="),S=null;if(0<=g){var P=l[f].substring(0,g);S=l[f].substring(g+1)}else P=l[f];h(P,S?decodeURIComponent(S.replace(/\+/g," ")):"")}}}function tr(l){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,l instanceof tr){this.h=l.h,pa(this,l.j),this.o=l.o,this.g=l.g,ga(this,l.s),this.l=l.l;var h=l.i,f=new ys;f.i=h.i,h.g&&(f.g=new Map(h.g),f.h=h.h),pg(this,f),this.m=l.m}else l&&(h=String(l).match(mg))?(this.h=!1,pa(this,h[1]||"",!0),this.o=gs(h[2]||""),this.g=gs(h[3]||"",!0),ga(this,h[4]),this.l=gs(h[5]||"",!0),pg(this,h[6]||"",!0),this.m=gs(h[7]||"")):(this.h=!1,this.i=new ys(null,this.h))}tr.prototype.toString=function(){var l=[],h=this.j;h&&l.push(_s(h,gg,!0),":");var f=this.g;return(f||h=="file")&&(l.push("//"),(h=this.o)&&l.push(_s(h,gg,!0),"@"),l.push(encodeURIComponent(String(f)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),f=this.s,f!=null&&l.push(":",String(f))),(f=this.l)&&(this.g&&f.charAt(0)!="/"&&l.push("/"),l.push(_s(f,f.charAt(0)=="/"?jT:qT,!0))),(f=this.i.toString())&&l.push("?",f),(f=this.m)&&l.push("#",_s(f,KT)),l.join("")};function tn(l){return new tr(l)}function pa(l,h,f){l.j=f?gs(h,!0):h,l.j&&(l.j=l.j.replace(/:$/,""))}function ga(l,h){if(h){if(h=Number(h),isNaN(h)||0>h)throw Error("Bad port number "+h);l.s=h}else l.s=null}function pg(l,h,f){h instanceof ys?(l.i=h,zT(l.i,l.h)):(f||(h=_s(h,GT)),l.i=new ys(h,l.h))}function _e(l,h,f){l.i.set(h,f)}function _a(l){return _e(l,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),l}function gs(l,h){return l?h?decodeURI(l.replace(/%25/g,"%2525")):decodeURIComponent(l):""}function _s(l,h,f){return typeof l=="string"?(l=encodeURI(l).replace(h,BT),f&&(l=l.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),l):null}function BT(l){return l=l.charCodeAt(0),"%"+(l>>4&15).toString(16)+(l&15).toString(16)}var gg=/[#\/\?@]/g,qT=/[#\?:]/g,jT=/[#\?]/g,GT=/[#\?@]/g,KT=/#/g;function ys(l,h){this.h=this.g=null,this.i=l||null,this.j=!!h}function wn(l){l.g||(l.g=new Map,l.h=0,l.i&&UT(l.i,function(h,f){l.add(decodeURIComponent(h.replace(/\+/g," ")),f)}))}n=ys.prototype,n.add=function(l,h){wn(this),this.i=null,l=qr(this,l);var f=this.g.get(l);return f||this.g.set(l,f=[]),f.push(h),this.h+=1,this};function _g(l,h){wn(l),h=qr(l,h),l.g.has(h)&&(l.i=null,l.h-=l.g.get(h).length,l.g.delete(h))}function yg(l,h){return wn(l),h=qr(l,h),l.g.has(h)}n.forEach=function(l,h){wn(this),this.g.forEach(function(f,g){f.forEach(function(S){l.call(h,S,g,this)},this)},this)},n.na=function(){wn(this);let l=Array.from(this.g.values()),h=Array.from(this.g.keys()),f=[];for(let g=0;g<h.length;g++){let S=l[g];for(let P=0;P<S.length;P++)f.push(h[g])}return f},n.V=function(l){wn(this);let h=[];if(typeof l=="string")yg(this,l)&&(h=h.concat(this.g.get(qr(this,l))));else{l=Array.from(this.g.values());for(let f=0;f<l.length;f++)h=h.concat(l[f])}return h},n.set=function(l,h){return wn(this),this.i=null,l=qr(this,l),yg(this,l)&&(this.h-=this.g.get(l).length),this.g.set(l,[h]),this.h+=1,this},n.get=function(l,h){return l?(l=this.V(l),0<l.length?String(l[0]):h):h};function vg(l,h,f){_g(l,h),0<f.length&&(l.i=null,l.g.set(qr(l,h),x(f)),l.h+=f.length)}n.toString=function(){if(this.i)return this.i;if(!this.g)return"";let l=[],h=Array.from(this.g.keys());for(var f=0;f<h.length;f++){var g=h[f];let P=encodeURIComponent(String(g)),M=this.V(g);for(g=0;g<M.length;g++){var S=P;M[g]!==""&&(S+="="+encodeURIComponent(String(M[g]))),l.push(S)}}return this.i=l.join("&")};function qr(l,h){return h=String(h),l.j&&(h=h.toLowerCase()),h}function zT(l,h){h&&!l.j&&(wn(l),l.i=null,l.g.forEach(function(f,g){var S=g.toLowerCase();g!=S&&(_g(this,g),vg(this,S,f))},l)),l.j=h}function WT(l,h){let f=new ms;if(a.Image){let g=new Image;g.onload=y(En,f,"TestLoadImage: loaded",!0,h,g),g.onerror=y(En,f,"TestLoadImage: error",!1,h,g),g.onabort=y(En,f,"TestLoadImage: abort",!1,h,g),g.ontimeout=y(En,f,"TestLoadImage: timeout",!1,h,g),a.setTimeout(function(){g.ontimeout&&g.ontimeout()},1e4),g.src=l}else h(!1)}function QT(l,h){let f=new ms,g=new AbortController,S=setTimeout(()=>{g.abort(),En(f,"TestPingServer: timeout",!1,h)},1e4);fetch(l,{signal:g.signal}).then(P=>{clearTimeout(S),P.ok?En(f,"TestPingServer: ok",!0,h):En(f,"TestPingServer: server error",!1,h)}).catch(()=>{clearTimeout(S),En(f,"TestPingServer: error",!1,h)})}function En(l,h,f,g,S){try{S&&(S.onload=null,S.onerror=null,S.onabort=null,S.ontimeout=null),g(f)}catch{}}function $T(){this.g=new xT}function HT(l,h,f){let g=f||"";try{fg(l,function(S,P){let M=S;c(S)&&(M=uc(S)),h.push(g+P+"="+encodeURIComponent(M))})}catch(S){throw h.push(g+"type="+encodeURIComponent("_badmap")),S}}function vs(l){this.l=l.Ub||null,this.j=l.eb||!1}A(vs,cc),vs.prototype.g=function(){return new ya(this.l,this.j)},vs.prototype.i=function(l){return function(){return l}}({});function ya(l,h){ze.call(this),this.D=l,this.o=h,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}A(ya,ze),n=ya.prototype,n.open=function(l,h){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=l,this.A=h,this.readyState=1,Es(this)},n.send=function(l){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let h={headers:this.u,method:this.B,credentials:this.m,cache:void 0};l&&(h.body=l),(this.D||a).fetch(new Request(this.A,h)).then(this.Sa.bind(this),this.ga.bind(this))},n.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,ws(this)),this.readyState=0},n.Sa=function(l){if(this.g&&(this.l=l,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=l.headers,this.readyState=2,Es(this)),this.g&&(this.readyState=3,Es(this),this.g)))if(this.responseType==="arraybuffer")l.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof a.ReadableStream<"u"&&"body"in l){if(this.j=l.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;wg(this)}else l.text().then(this.Ra.bind(this),this.ga.bind(this))};function wg(l){l.j.read().then(l.Pa.bind(l)).catch(l.ga.bind(l))}n.Pa=function(l){if(this.g){if(this.o&&l.value)this.response.push(l.value);else if(!this.o){var h=l.value?l.value:new Uint8Array(0);(h=this.v.decode(h,{stream:!l.done}))&&(this.response=this.responseText+=h)}l.done?ws(this):Es(this),this.readyState==3&&wg(this)}},n.Ra=function(l){this.g&&(this.response=this.responseText=l,ws(this))},n.Qa=function(l){this.g&&(this.response=l,ws(this))},n.ga=function(){this.g&&ws(this)};function ws(l){l.readyState=4,l.l=null,l.j=null,l.v=null,Es(l)}n.setRequestHeader=function(l,h){this.u.append(l,h)},n.getResponseHeader=function(l){return this.h&&this.h.get(l.toLowerCase())||""},n.getAllResponseHeaders=function(){if(!this.h)return"";let l=[],h=this.h.entries();for(var f=h.next();!f.done;)f=f.value,l.push(f[0]+": "+f[1]),f=h.next();return l.join(`\r
`)};function Es(l){l.onreadystatechange&&l.onreadystatechange.call(l)}Object.defineProperty(ya.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(l){this.m=l?"include":"same-origin"}});function Eg(l){let h="";return Y(l,function(f,g){h+=g,h+=":",h+=f,h+=`\r
`}),h}function wc(l,h,f){e:{for(g in f){var g=!1;break e}g=!0}g||(f=Eg(f),typeof l=="string"?f!=null&&encodeURIComponent(String(f)):_e(l,h,f))}function Se(l){ze.call(this),this.headers=new Map,this.o=l||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}A(Se,ze);var YT=/^https?$/i,JT=["POST","PUT"];n=Se.prototype,n.Ha=function(l){this.J=l},n.ea=function(l,h,f,g){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+l);h=h?h.toUpperCase():"GET",this.D=l,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():fc.g(),this.v=this.o?Yp(this.o):Yp(fc),this.g.onreadystatechange=p(this.Ea,this);try{this.B=!0,this.g.open(h,String(l),!0),this.B=!1}catch(P){Ig(this,P);return}if(l=f||"",f=new Map(this.headers),g)if(Object.getPrototypeOf(g)===Object.prototype)for(var S in g)f.set(S,g[S]);else if(typeof g.keys=="function"&&typeof g.get=="function")for(let P of g.keys())f.set(P,g.get(P));else throw Error("Unknown input type for opt_headers: "+String(g));g=Array.from(f.keys()).find(P=>P.toLowerCase()=="content-type"),S=a.FormData&&l instanceof a.FormData,!(0<=Array.prototype.indexOf.call(JT,h,void 0))||g||S||f.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[P,M]of f)this.g.setRequestHeader(P,M);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Ag(this),this.u=!0,this.g.send(l),this.u=!1}catch(P){Ig(this,P)}};function Ig(l,h){l.h=!1,l.g&&(l.j=!0,l.g.abort(),l.j=!1),l.l=h,l.m=5,Tg(l),va(l)}function Tg(l){l.A||(l.A=!0,Je(l,"complete"),Je(l,"error"))}n.abort=function(l){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=l||7,Je(this,"complete"),Je(this,"abort"),va(this))},n.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),va(this,!0)),Se.aa.N.call(this)},n.Ea=function(){this.s||(this.B||this.u||this.j?Sg(this):this.bb())},n.bb=function(){Sg(this)};function Sg(l){if(l.h&&typeof o<"u"&&(!l.v[1]||nn(l)!=4||l.Z()!=2)){if(l.u&&nn(l)==4)Wp(l.Ea,0,l);else if(Je(l,"readystatechange"),nn(l)==4){l.h=!1;try{let M=l.Z();e:switch(M){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var h=!0;break e;default:h=!1}var f;if(!(f=h)){var g;if(g=M===0){var S=String(l.D).match(mg)[1]||null;!S&&a.self&&a.self.location&&(S=a.self.location.protocol.slice(0,-1)),g=!YT.test(S?S.toLowerCase():"")}f=g}if(f)Je(l,"complete"),Je(l,"success");else{l.m=6;try{var P=2<nn(l)?l.g.statusText:""}catch{P=""}l.l=P+" ["+l.Z()+"]",Tg(l)}}finally{va(l)}}}}function va(l,h){if(l.g){Ag(l);let f=l.g,g=l.v[0]?()=>{}:null;l.g=null,l.v=null,h||Je(l,"ready");try{f.onreadystatechange=g}catch{}}}function Ag(l){l.I&&(a.clearTimeout(l.I),l.I=null)}n.isActive=function(){return!!this.g};function nn(l){return l.g?l.g.readyState:0}n.Z=function(){try{return 2<nn(this)?this.g.status:-1}catch{return-1}},n.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},n.Oa=function(l){if(this.g){var h=this.g.responseText;return l&&h.indexOf(l)==0&&(h=h.substring(l.length)),PT(h)}};function Cg(l){try{if(!l.g)return null;if("response"in l.g)return l.g.response;switch(l.H){case"":case"text":return l.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in l.g)return l.g.mozResponseArrayBuffer}return null}catch{return null}}function XT(l){let h={};l=(l.g&&2<=nn(l)&&l.g.getAllResponseHeaders()||"").split(`\r
`);for(let g=0;g<l.length;g++){if(j(l[g]))continue;var f=T(l[g]);let S=f[0];if(f=f[1],typeof f!="string")continue;f=f.trim();let P=h[S]||[];h[S]=P,P.push(f)}E(h,function(g){return g.join(", ")})}n.Ba=function(){return this.m},n.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function Is(l,h,f){return f&&f.internalChannelParams&&f.internalChannelParams[l]||h}function bg(l){this.Aa=0,this.i=[],this.j=new ms,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Is("failFast",!1,l),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Is("baseRetryDelayMs",5e3,l),this.cb=Is("retryDelaySeedMs",1e4,l),this.Wa=Is("forwardChannelMaxRetries",2,l),this.wa=Is("forwardChannelRequestTimeoutMs",2e4,l),this.pa=l&&l.xmlHttpFactory||void 0,this.Xa=l&&l.Tb||void 0,this.Ca=l&&l.useFetchStreams||!1,this.L=void 0,this.J=l&&l.supportsCrossDomainXhr||!1,this.K="",this.h=new lg(l&&l.concurrentRequestLimit),this.Da=new $T,this.P=l&&l.fastHandshake||!1,this.O=l&&l.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=l&&l.Rb||!1,l&&l.xa&&this.j.xa(),l&&l.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&l&&l.detectBufferingProxy||!1,this.ja=void 0,l&&l.longPollingTimeout&&0<l.longPollingTimeout&&(this.ja=l.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}n=bg.prototype,n.la=8,n.G=1,n.connect=function(l,h,f,g){Xe(0),this.W=l,this.H=h||{},f&&g!==void 0&&(this.H.OSID=f,this.H.OAID=g),this.F=this.X,this.I=Fg(this,null,this.W),Ea(this)};function Ec(l){if(Rg(l),l.G==3){var h=l.U++,f=tn(l.I);if(_e(f,"SID",l.K),_e(f,"RID",h),_e(f,"TYPE","terminate"),Ts(l,f),h=new vn(l,l.j,h),h.L=2,h.v=_a(tn(f)),f=!1,a.navigator&&a.navigator.sendBeacon)try{f=a.navigator.sendBeacon(h.v.toString(),"")}catch{}!f&&a.Image&&(new Image().src=h.v,f=!0),f||(h.g=Mg(h.j,null),h.g.ea(h.v)),h.F=Date.now(),ma(h)}Og(l)}function wa(l){l.g&&(Tc(l),l.g.cancel(),l.g=null)}function Rg(l){wa(l),l.u&&(a.clearTimeout(l.u),l.u=null),Ia(l),l.h.cancel(),l.s&&(typeof l.s=="number"&&a.clearTimeout(l.s),l.s=null)}function Ea(l){if(!ug(l.h)&&!l.s){l.s=!0;var h=l.Ga;os||Bp(),as||(os(),as=!0),ec.add(h,l),l.B=0}}function ZT(l,h){return cg(l.h)>=l.h.j-(l.s?1:0)?!1:l.s?(l.i=h.D.concat(l.i),!0):l.G==1||l.G==2||l.B>=(l.Va?0:l.Wa)?!1:(l.s=fs(p(l.Ga,l,h),Vg(l,l.B)),l.B++,!0)}n.Ga=function(l){if(this.s)if(this.s=null,this.G==1){if(!l){this.U=Math.floor(1e5*Math.random()),l=this.U++;let S=new vn(this,this.j,l),P=this.o;if(this.S&&(P?(P=_(P),I(P,this.S)):P=this.S),this.m!==null||this.O||(S.H=P,P=null),this.P)e:{for(var h=0,f=0;f<this.i.length;f++){t:{var g=this.i[f];if("__data__"in g.map&&(g=g.map.__data__,typeof g=="string")){g=g.length;break t}g=void 0}if(g===void 0)break;if(h+=g,4096<h){h=f;break e}if(h===4096||f===this.i.length-1){h=f+1;break e}}h=1e3}else h=1e3;h=xg(this,S,h),f=tn(this.I),_e(f,"RID",l),_e(f,"CVER",22),this.D&&_e(f,"X-HTTP-Session-Id",this.D),Ts(this,f),P&&(this.O?h="headers="+encodeURIComponent(String(Eg(P)))+"&"+h:this.m&&wc(f,this.m,P)),vc(this.h,S),this.Ua&&_e(f,"TYPE","init"),this.P?(_e(f,"$req",h),_e(f,"SID","null"),S.T=!0,pc(S,f,null)):pc(S,f,h),this.G=2}}else this.G==3&&(l?Pg(this,l):this.i.length==0||ug(this.h)||Pg(this))};function Pg(l,h){var f;h?f=h.l:f=l.U++;let g=tn(l.I);_e(g,"SID",l.K),_e(g,"RID",f),_e(g,"AID",l.T),Ts(l,g),l.m&&l.o&&wc(g,l.m,l.o),f=new vn(l,l.j,f,l.B+1),l.m===null&&(f.H=l.o),h&&(l.i=h.D.concat(l.i)),h=xg(l,f,1e3),f.I=Math.round(.5*l.wa)+Math.round(.5*l.wa*Math.random()),vc(l.h,f),pc(f,g,h)}function Ts(l,h){l.H&&Y(l.H,function(f,g){_e(h,g,f)}),l.l&&fg({},function(f,g){_e(h,g,f)})}function xg(l,h,f){f=Math.min(l.i.length,f);var g=l.l?p(l.l.Na,l.l,l):null;e:{var S=l.i;let P=-1;for(;;){let M=["count="+f];P==-1?0<f?(P=S[0].g,M.push("ofs="+P)):P=0:M.push("ofs="+P);let de=!0;for(let je=0;je<f;je++){let ae=S[je].g,We=S[je].map;if(ae-=P,0>ae)P=Math.max(0,S[je].g-100),de=!1;else try{HT(We,M,"req"+ae+"_")}catch{g&&g(We)}}if(de){g=M.join("&");break e}}}return l=l.i.splice(0,f),h.D=l,g}function Ng(l){if(!l.g&&!l.u){l.Y=1;var h=l.Fa;os||Bp(),as||(os(),as=!0),ec.add(h,l),l.v=0}}function Ic(l){return l.g||l.u||3<=l.v?!1:(l.Y++,l.u=fs(p(l.Fa,l),Vg(l,l.v)),l.v++,!0)}n.Fa=function(){if(this.u=null,Dg(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var l=2*this.R;this.j.info("BP detection timer enabled: "+l),this.A=fs(p(this.ab,this),l)}},n.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Xe(10),wa(this),Dg(this))};function Tc(l){l.A!=null&&(a.clearTimeout(l.A),l.A=null)}function Dg(l){l.g=new vn(l,l.j,"rpc",l.Y),l.m===null&&(l.g.H=l.o),l.g.O=0;var h=tn(l.qa);_e(h,"RID","rpc"),_e(h,"SID",l.K),_e(h,"AID",l.T),_e(h,"CI",l.F?"0":"1"),!l.F&&l.ja&&_e(h,"TO",l.ja),_e(h,"TYPE","xmlhttp"),Ts(l,h),l.m&&l.o&&wc(h,l.m,l.o),l.L&&(l.g.I=l.L);var f=l.g;l=l.ia,f.L=1,f.v=_a(tn(h)),f.m=null,f.P=!0,sg(f,l)}n.Za=function(){this.C!=null&&(this.C=null,wa(this),Ic(this),Xe(19))};function Ia(l){l.C!=null&&(a.clearTimeout(l.C),l.C=null)}function kg(l,h){var f=null;if(l.g==h){Ia(l),Tc(l),l.g=null;var g=2}else if(yc(l.h,h))f=h.D,hg(l.h,h),g=1;else return;if(l.G!=0){if(h.o)if(g==1){f=h.m?h.m.length:0,h=Date.now()-h.F;var S=l.B;g=ha(),Je(g,new tg(g,f)),Ea(l)}else Ng(l);else if(S=h.s,S==3||S==0&&0<h.X||!(g==1&&ZT(l,h)||g==2&&Ic(l)))switch(f&&0<f.length&&(h=l.h,h.i=h.i.concat(f)),S){case 1:nr(l,5);break;case 4:nr(l,10);break;case 3:nr(l,6);break;default:nr(l,2)}}}function Vg(l,h){let f=l.Ta+Math.floor(Math.random()*l.cb);return l.isActive()||(f*=2),f*h}function nr(l,h){if(l.j.info("Error code "+h),h==2){var f=p(l.fb,l),g=l.Xa;let S=!g;g=new tr(g||"//www.google.com/images/cleardot.gif"),a.location&&a.location.protocol=="http"||pa(g,"https"),_a(g),S?WT(g.toString(),f):QT(g.toString(),f)}else Xe(2);l.G=0,l.l&&l.l.sa(h),Og(l),Rg(l)}n.fb=function(l){l?(this.j.info("Successfully pinged google.com"),Xe(2)):(this.j.info("Failed to ping google.com"),Xe(1))};function Og(l){if(l.G=0,l.ka=[],l.l){let h=dg(l.h);(h.length!=0||l.i.length!=0)&&(N(l.ka,h),N(l.ka,l.i),l.h.i.length=0,x(l.i),l.i.length=0),l.l.ra()}}function Fg(l,h,f){var g=f instanceof tr?tn(f):new tr(f);if(g.g!="")h&&(g.g=h+"."+g.g),ga(g,g.s);else{var S=a.location;g=S.protocol,h=h?h+"."+S.hostname:S.hostname,S=+S.port;var P=new tr(null);g&&pa(P,g),h&&(P.g=h),S&&ga(P,S),f&&(P.l=f),g=P}return f=l.D,h=l.ya,f&&h&&_e(g,f,h),_e(g,"VER",l.la),Ts(l,g),g}function Mg(l,h,f){if(h&&!l.J)throw Error("Can't create secondary domain capable XhrIo object.");return h=l.Ca&&!l.pa?new Se(new vs({eb:f})):new Se(l.pa),h.Ha(l.J),h}n.isActive=function(){return!!this.l&&this.l.isActive(this)};function Lg(){}n=Lg.prototype,n.ua=function(){},n.ta=function(){},n.sa=function(){},n.ra=function(){},n.isActive=function(){return!0},n.Na=function(){};function Ta(){}Ta.prototype.g=function(l,h){return new ut(l,h)};function ut(l,h){ze.call(this),this.g=new bg(h),this.l=l,this.h=h&&h.messageUrlParams||null,l=h&&h.messageHeaders||null,h&&h.clientProtocolHeaderRequired&&(l?l["X-Client-Protocol"]="webchannel":l={"X-Client-Protocol":"webchannel"}),this.g.o=l,l=h&&h.initMessageHeaders||null,h&&h.messageContentType&&(l?l["X-WebChannel-Content-Type"]=h.messageContentType:l={"X-WebChannel-Content-Type":h.messageContentType}),h&&h.va&&(l?l["X-WebChannel-Client-Profile"]=h.va:l={"X-WebChannel-Client-Profile":h.va}),this.g.S=l,(l=h&&h.Sb)&&!j(l)&&(this.g.m=l),this.v=h&&h.supportsCrossDomainXhr||!1,this.u=h&&h.sendRawJson||!1,(h=h&&h.httpSessionIdParam)&&!j(h)&&(this.g.D=h,l=this.h,l!==null&&h in l&&(l=this.h,h in l&&delete l[h])),this.j=new jr(this)}A(ut,ze),ut.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},ut.prototype.close=function(){Ec(this.g)},ut.prototype.o=function(l){var h=this.g;if(typeof l=="string"){var f={};f.__data__=l,l=f}else this.u&&(f={},f.__data__=uc(l),l=f);h.i.push(new FT(h.Ya++,l)),h.G==3&&Ea(h)},ut.prototype.N=function(){this.g.l=null,delete this.j,Ec(this.g),delete this.g,ut.aa.N.call(this)};function Ug(l){hc.call(this),l.__headers__&&(this.headers=l.__headers__,this.statusCode=l.__status__,delete l.__headers__,delete l.__status__);var h=l.__sm__;if(h){e:{for(let f in h){l=f;break e}l=void 0}(this.i=l)&&(l=this.i,h=h!==null&&l in h?h[l]:void 0),this.data=h}else this.data=l}A(Ug,hc);function Bg(){dc.call(this),this.status=1}A(Bg,dc);function jr(l){this.g=l}A(jr,Lg),jr.prototype.ua=function(){Je(this.g,"a")},jr.prototype.ta=function(l){Je(this.g,new Ug(l))},jr.prototype.sa=function(l){Je(this.g,new Bg)},jr.prototype.ra=function(){Je(this.g,"b")},Ta.prototype.createWebChannel=Ta.prototype.g,ut.prototype.send=ut.prototype.o,ut.prototype.open=ut.prototype.m,ut.prototype.close=ut.prototype.close,Md=ln.createWebChannelTransport=function(){return new Ta},Fd=ln.getStatEventTarget=function(){return ha()},Od=ln.Event=Zn,Nl=ln.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},da.NO_ERROR=0,da.TIMEOUT=8,da.HTTP_ERROR=6,vo=ln.ErrorCode=da,ng.COMPLETE="complete",Vd=ln.EventType=ng,Jp.EventType=hs,hs.OPEN="a",hs.CLOSE="b",hs.ERROR="c",hs.MESSAGE="d",ze.prototype.listen=ze.prototype.K,yi=ln.WebChannel=Jp,kd=ln.FetchXmlHttpFactory=vs,Se.prototype.listenOnce=Se.prototype.L,Se.prototype.getLastError=Se.prototype.Ka,Se.prototype.getLastErrorCode=Se.prototype.Ba,Se.prototype.getStatus=Se.prototype.Z,Se.prototype.getResponseJson=Se.prototype.Oa,Se.prototype.getResponseText=Se.prototype.oa,Se.prototype.send=Se.prototype.ea,Se.prototype.setWithCredentials=Se.prototype.Ha,Dd=ln.XhrIo=Se}).apply(typeof xl<"u"?xl:typeof self<"u"?self:typeof window<"u"?window:{});var qv="@firebase/firestore";var Ve=class{constructor(e){this.uid=e}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}};Ve.UNAUTHENTICATED=new Ve(null),Ve.GOOGLE_CREDENTIALS=new Ve("google-credentials-uid"),Ve.FIRST_PARTY=new Ve("first-party-uid"),Ve.MOCK_USER=new Ve("mock-user");var Hi="10.13.0";var Bn=new Wr("@firebase/firestore");function Ti(){return Bn.logLevel}function Gw(n){Bn.setLogLevel(n)}function V(n,...e){if(Bn.logLevel<=vt.DEBUG){let t=e.map(Gm);Bn.debug(`Firestore (${Hi}): ${n}`,...t)}}function be(n,...e){if(Bn.logLevel<=vt.ERROR){let t=e.map(Gm);Bn.error(`Firestore (${Hi}): ${n}`,...t)}}function St(n,...e){if(Bn.logLevel<=vt.WARN){let t=e.map(Gm);Bn.warn(`Firestore (${Hi}): ${n}`,...t)}}function Gm(n){if(typeof n=="string")return n;try{return function(t){return JSON.stringify(t)}(n)}catch{return n}}function B(n="Unexpected state"){let e=`FIRESTORE (${Hi}) INTERNAL ASSERTION FAILED: `+n;throw be(e),new Error(e)}function G(n,e){n||B()}function Kw(n,e){n||B()}function L(n,e){return n}var R={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},k=class extends r_{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var Oe=class{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}};var jl=class{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}},jd=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Ve.UNAUTHENTICATED))}shutdown(){}},Gd=class{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}},Kd=class{constructor(e){this.t=e,this.currentUser=Ve.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let r=this.i,i=u=>this.i!==r?(r=this.i,t(u)):Promise.resolve(),s=new Oe;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Oe,e.enqueueRetryable(()=>i(this.currentUser))};let o=()=>{let u=s;e.enqueueRetryable(()=>D(this,null,function*(){yield u.promise,yield i(this.currentUser)}))},a=u=>{V("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=u,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(u=>a(u)),setTimeout(()=>{if(!this.auth){let u=this.t.getImmediate({optional:!0});u?a(u):(V("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Oe)}},0),o()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(r=>this.i!==e?(V("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):r?(G(typeof r.accessToken=="string"),new jl(r.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){let e=this.auth&&this.auth.getUid();return G(e===null||typeof e=="string"),new Ve(e)}},zd=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r,this.type="FirstParty",this.user=Ve.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},Wd=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r}getToken(){return Promise.resolve(new zd(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(Ve.FIRST_PARTY))}shutdown(){}invalidateToken(){}},Qd=class{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},$d=class{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){let r=s=>{s.error!=null&&V("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let o=s.token!==this.R;return this.R=s.token,V("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?t(s.token):Promise.resolve()};this.o=s=>{e.enqueueRetryable(()=>r(s))};let i=s=>{V("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):V("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(G(typeof t.token=="string"),this.R=t.token,new Qd(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}};function rC(n){let e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(n);if(e&&typeof e.getRandomValues=="function")e.getRandomValues(t);else for(let r=0;r<n;r++)t[r]=Math.floor(256*Math.random());return t}var Gl=class{static newId(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length,r="";for(;r.length<20;){let i=rC(40);for(let s=0;s<i.length;++s)r.length<20&&i[s]<t&&(r+=e.charAt(i[s]%e.length))}return r}};function $(n,e){return n<e?-1:n>e?1:0}function Di(n,e,t){return n.length===e.length&&n.every((r,i)=>t(r,e[i]))}function zw(n){return n+"\0"}var Te=class n{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new k(R.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new k(R.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new k(R.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new k(R.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return n.fromMillis(Date.now())}static fromDate(e){return n.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),r=Math.floor(1e6*(e-1e3*t));return new n(t,r)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?$(this.nanoseconds,e.nanoseconds):$(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var z=class n{constructor(e){this.timestamp=e}static fromTimestamp(e){return new n(e)}static min(){return new n(new Te(0,0))}static max(){return new n(new Te(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var Kl=class n{constructor(e,t,r){t===void 0?t=0:t>e.length&&B(),r===void 0?r=e.length-t:r>e.length-t&&B(),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return n.comparator(this,e)===0}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof n?e.forEach(r=>{t.push(r)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=e===void 0?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return this.length===0}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let r=Math.min(e.length,t.length);for(let i=0;i<r;i++){let s=e.get(i),o=t.get(i);if(s<o)return-1;if(s>o)return 1}return e.length<t.length?-1:e.length>t.length?1:0}},se=class n extends Kl{construct(e,t,r){return new n(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let r of e){if(r.indexOf("//")>=0)throw new k(R.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(i=>i.length>0))}return new n(t)}static emptyPath(){return new n([])}},iC=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Re=class n extends Kl{construct(e,t,r){return new n(e,t,r)}static isValidIdentifier(e){return iC.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new n(["__name__"])}static fromServerFormat(e){let t=[],r="",i=0,s=()=>{if(r.length===0)throw new k(R.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""},o=!1;for(;i<e.length;){let a=e[i];if(a==="\\"){if(i+1===e.length)throw new k(R.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let u=e[i+1];if(u!=="\\"&&u!=="."&&u!=="`")throw new k(R.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=u,i+=2}else a==="`"?(o=!o,i++):a!=="."||o?(r+=a,i++):(s(),i++)}if(s(),o)throw new k(R.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new n(t)}static emptyPath(){return new n([])}};var U=class n{constructor(e){this.path=e}static fromPath(e){return new n(se.fromString(e))}static fromName(e){return new n(se.fromString(e).popFirst(5))}static empty(){return new n(se.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return e!==null&&se.comparator(this.path,e.path)===0}toString(){return this.path.toString()}static comparator(e,t){return se.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new n(new se(e.slice()))}};var ki=class{constructor(e,t,r,i){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=i}};function Hd(n){return n.fields.find(e=>e.kind===2)}function pr(n){return n.fields.filter(e=>e.kind!==2)}ki.UNKNOWN_ID=-1;var Pi=class{constructor(e,t){this.fieldPath=e,this.kind=t}};var No=class n{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new n(0,At.min())}};function Ww(n,e){let t=n.toTimestamp().seconds,r=n.toTimestamp().nanoseconds+1,i=z.fromTimestamp(r===1e9?new Te(t+1,0):new Te(t,r));return new At(i,U.empty(),e)}function Qw(n){return new At(n.readTime,n.key,-1)}var At=class n{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new n(z.min(),U.empty(),-1)}static max(){return new n(z.max(),U.empty(),-1)}};function Km(n,e){let t=n.readTime.compareTo(e.readTime);return t!==0?t:(t=U.comparator(n.documentKey,e.documentKey),t!==0?t:$(n.largestBatchId,e.largestBatchId))}var $w="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",zl=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}};function Yn(n){return D(this,null,function*(){if(n.code!==R.FAILED_PRECONDITION||n.message!==$w)throw n;V("LocalStore","Unexpectedly lost primary lease")})}var b=class n{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&B(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new n((r,i)=>{this.nextCallback=s=>{this.wrapSuccess(e,s).next(r,i)},this.catchCallback=s=>{this.wrapFailure(t,s).next(r,i)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof n?t:n.resolve(t)}catch(t){return n.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):n.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):n.reject(t)}static resolve(e){return new n((t,r)=>{t(e)})}static reject(e){return new n((t,r)=>{r(e)})}static waitFor(e){return new n((t,r)=>{let i=0,s=0,o=!1;e.forEach(a=>{++i,a.next(()=>{++s,o&&s===i&&t()},u=>r(u))}),o=!0,s===i&&t()})}static or(e){let t=n.resolve(!1);for(let r of e)t=t.next(i=>i?n.resolve(i):r());return t}static forEach(e,t){let r=[];return e.forEach((i,s)=>{r.push(t.call(this,i,s))}),this.waitFor(r)}static mapArray(e,t){return new n((r,i)=>{let s=e.length,o=new Array(s),a=0;for(let u=0;u<s;u++){let c=u;t(e[c]).next(d=>{o[c]=d,++a,a===s&&r(o)},d=>i(d))}})}static doWhile(e,t){return new n((r,i)=>{let s=()=>{e()===!0?t().next(()=>{s()},i):r()};s()})}};var Wl=class n{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new Oe,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new Er(e,t.error)):this.V.resolve()},this.transaction.onerror=r=>{let i=zm(r.target.error);this.V.reject(new Er(e,i))}}static open(e,t,r,i){try{return new n(t,e.transaction(i,r))}catch(s){throw new Er(t,s)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(V("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let e=this.transaction;this.aborted||typeof e.commit!="function"||e.commit()}store(e){let t=this.transaction.objectStore(e);return new Jd(t)}},qn=class n{constructor(e,t,r){this.name=e,this.version=t,this.p=r,n.S(Rs())===12.2&&be("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return V("SimpleDb","Removing database:",e),gr(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!n_())return!1;if(n.v())return!0;let e=Rs(),t=n.S(e),r=0<t&&t<10,i=Hw(e),s=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||s)}static v(){var e;return typeof process<"u"&&((e=process.__PRIVATE_env)===null||e===void 0?void 0:e.C)==="YES"}static F(e,t){return e.store(t)}static S(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),r=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(r)}M(e){return D(this,null,function*(){return this.db||(V("SimpleDb","Opening database:",this.name),this.db=yield new Promise((t,r)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let o=s.target.result;t(o)},i.onblocked=()=>{r(new Er(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let o=s.target.error;o.name==="VersionError"?r(new k(R.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o.name==="InvalidStateError"?r(new k(R.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+o)):r(new Er(e,o))},i.onupgradeneeded=s=>{V("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let o=s.target.result;this.p.O(o,i.transaction,s.oldVersion,this.version).next(()=>{V("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=t=>this.N(t)),this.db})}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}runTransaction(e,t,r,i){return D(this,null,function*(){let s=t==="readonly",o=0;for(;;){++o;try{this.db=yield this.M(e);let a=Wl.open(this.db,e,s?"readonly":"readwrite",r),u=i(a).next(c=>(a.g(),c)).catch(c=>(a.abort(c),b.reject(c))).toPromise();return u.catch(()=>{}),yield a.m,u}catch(a){let u=a,c=u.name!=="FirebaseError"&&o<3;if(V("SimpleDb","Transaction failed with error:",u.message,"Retrying:",c),this.close(),!c)return Promise.reject(u)}}})}close(){this.db&&this.db.close(),this.db=void 0}};function Hw(n){let e=n.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}var Yd=class{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return gr(this.B.delete())}},Er=class extends k{constructor(e,t){super(R.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}};function Jn(n){return n.name==="IndexedDbTransactionError"}var Jd=class{constructor(e){this.store=e}put(e,t){let r;return t!==void 0?(V("SimpleDb","PUT",this.store.name,e,t),r=this.store.put(t,e)):(V("SimpleDb","PUT",this.store.name,"<auto-key>",e),r=this.store.put(e)),gr(r)}add(e){return V("SimpleDb","ADD",this.store.name,e,e),gr(this.store.add(e))}get(e){return gr(this.store.get(e)).next(t=>(t===void 0&&(t=null),V("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return V("SimpleDb","DELETE",this.store.name,e),gr(this.store.delete(e))}count(){return V("SimpleDb","COUNT",this.store.name),gr(this.store.count())}U(e,t){let r=this.options(e,t),i=r.index?this.store.index(r.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(r.range);return new b((o,a)=>{s.onerror=u=>{a(u.target.error)},s.onsuccess=u=>{o(u.target.result)}})}{let s=this.cursor(r),o=[];return this.W(s,(a,u)=>{o.push(u)}).next(()=>o)}}G(e,t){let r=this.store.getAll(e,t===null?void 0:t);return new b((i,s)=>{r.onerror=o=>{s(o.target.error)},r.onsuccess=o=>{i(o.target.result)}})}j(e,t){V("SimpleDb","DELETE ALL",this.store.name);let r=this.options(e,t);r.H=!1;let i=this.cursor(r);return this.W(i,(s,o,a)=>a.delete())}J(e,t){let r;t?r=e:(r={},t=e);let i=this.cursor(r);return this.W(i,t)}Y(e){let t=this.cursor({});return new b((r,i)=>{t.onerror=s=>{let o=zm(s.target.error);i(o)},t.onsuccess=s=>{let o=s.target.result;o?e(o.primaryKey,o.value).next(a=>{a?o.continue():r()}):r()}})}W(e,t){let r=[];return new b((i,s)=>{e.onerror=o=>{s(o.target.error)},e.onsuccess=o=>{let a=o.target.result;if(!a)return void i();let u=new Yd(a),c=t(a.primaryKey,a.value,u);if(c instanceof b){let d=c.catch(m=>(u.done(),b.reject(m)));r.push(d)}u.isDone?i():u.K===null?a.continue():a.continue(u.K)}}).next(()=>b.waitFor(r))}options(e,t){let r;return e!==void 0&&(typeof e=="string"?r=e:t=e),{index:r,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let r=this.store.index(e.index);return e.H?r.openKeyCursor(e.range,t):r.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}};function gr(n){return new b((e,t)=>{n.onsuccess=r=>{let i=r.target.result;e(i)},n.onerror=r=>{let i=zm(r.target.error);t(i)}})}var jv=!1;function zm(n){let e=qn.S(Rs());if(e>=12.2&&e<13){let t="An internal error was encountered in the Indexed Database server";if(n.message.indexOf(t)>=0){let r=new k("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return jv||(jv=!0,setTimeout(()=>{throw r},0)),r}}return n}var Xd=class{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}X(e){V("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,()=>D(this,null,function*(){this.task=null;try{V("IndexBackfiller",`Documents written: ${yield this.Z.ee()}`)}catch(t){Jn(t)?V("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",t):yield Yn(t)}yield this.X(6e4)}))}},Zd=class{constructor(e,t){this.localStore=e,this.persistence=t}ee(e=50){return D(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.te(t,e))})}te(e,t){let r=new Set,i=t,s=!0;return b.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(o=>{if(o!==null&&!r.has(o))return V("IndexBackfiller",`Processing collection: ${o}`),this.ne(e,o,i).next(a=>{i-=a,r.add(o)});s=!1})).next(()=>t-i)}ne(e,t,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(i=>this.localStore.localDocuments.getNextDocuments(e,t,i,r).next(s=>{let o=s.changes;return this.localStore.indexManager.updateIndexEntries(e,o).next(()=>this.re(i,s)).next(a=>(V("IndexBackfiller",`Updating offset: ${a}`),this.localStore.indexManager.updateCollectionGroup(e,t,a))).next(()=>o.size)}))}re(e,t){let r=e;return t.changes.forEach((i,s)=>{let o=Qw(s);Km(o,r)>0&&(r=o)}),new At(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}};var pt=(()=>{class n{constructor(t,r){this.previousValue=t,r&&(r.sequenceNumberHandler=i=>this.ie(i),this.se=i=>r.writeSequenceNumber(i))}ie(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){let t=++this.previousValue;return this.se&&this.se(t),t}}return n.oe=-1,n})();function ea(n){return n==null}function Do(n){return n===0&&1/n==-1/0}function Yw(n){return typeof n=="number"&&Number.isInteger(n)&&!Do(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}function it(n){let e="";for(let t=0;t<n.length;t++)e.length>0&&(e=Gv(e)),e=sC(n.get(t),e);return Gv(e)}function sC(n,e){let t=e,r=n.length;for(let i=0;i<r;i++){let s=n.charAt(i);switch(s){case"\0":t+="";break;case"":t+="";break;default:t+=s}}return t}function Gv(n){return n+""}function Kt(n){let e=n.length;if(G(e>=2),e===2)return G(n.charAt(0)===""&&n.charAt(1)===""),se.emptyPath();let t=e-2,r=[],i="";for(let s=0;s<e;){let o=n.indexOf("",s);switch((o<0||o>t)&&B(),n.charAt(o+1)){case"":let a=n.substring(s,o),u;i.length===0?u=a:(i+=a,u=i,i=""),r.push(u);break;case"":i+=n.substring(s,o),i+="\0";break;case"":i+=n.substring(s,o+1);break;default:B()}s=o+2}return new se(r)}var Kv=["userId","batchId"];function Fl(n,e){return[n,it(e)]}function Jw(n,e,t){return[n,it(e),t]}var oC={},aC=["prefixPath","collectionGroup","readTime","documentId"],lC=["prefixPath","collectionGroup","documentId"],uC=["collectionGroup","readTime","prefixPath","documentId"],cC=["canonicalId","targetId"],hC=["targetId","path"],dC=["path","targetId"],fC=["collectionId","parent"],mC=["indexId","uid"],pC=["uid","sequenceNumber"],gC=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],_C=["indexId","uid","orderedDocumentKey"],yC=["userId","collectionPath","documentId"],vC=["userId","collectionPath","largestBatchId"],wC=["userId","collectionGroup","largestBatchId"],Xw=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],EC=[...Xw,"documentOverlays"],Zw=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],eE=Zw,Wm=[...eE,"indexConfiguration","indexState","indexEntries"],IC=Wm,TC=[...Wm,"globals"];var ko=class extends zl{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}};function Le(n,e){let t=L(n);return qn.F(t._e,e)}function zv(n){let e=0;for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e++;return e}function kr(n,e){for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e(t,n[t])}function tE(n){for(let e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}var ye=class n{constructor(e,t){this.comparator=e,this.root=t||Wt.EMPTY}insert(e,t){return new n(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Wt.BLACK,null,null))}remove(e){return new n(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Wt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let r=this.comparator(e,t.key);if(r===0)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){let i=this.comparator(e,r.key);if(i===0)return t+r.left.size;i<0?r=r.left:(t+=r.left.size+1,r=r.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){let e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Ri(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Ri(this.root,e,this.comparator,!1)}getReverseIterator(){return new Ri(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Ri(this.root,e,this.comparator,!0)}},Ri=class{constructor(e,t,r,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?r(e.key,t):1,t&&i&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(s===0){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}},Wt=class n{constructor(e,t,r,i,s){this.key=e,this.value=t,this.color=r??n.RED,this.left=i??n.EMPTY,this.right=s??n.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,i,s){return new n(e??this.key,t??this.value,r??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let i=this,s=r(e,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(e,t,r),null):s===0?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,r)),i.fixUp()}removeMin(){if(this.left.isEmpty())return n.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let r,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),t(e,i.key)===0){if(i.right.isEmpty())return n.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){let e=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){let e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw B();let e=this.left.check();if(e!==this.right.check())throw B();return e+(this.isRed()?0:1)}};Wt.EMPTY=null,Wt.RED=!0,Wt.BLACK=!1;Wt.EMPTY=new class{constructor(){this.size=0}get key(){throw B()}get value(){throw B()}get color(){throw B()}get left(){throw B()}get right(){throw B()}copy(e,t,r,i,s){return this}insert(e,t,r){return new Wt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var me=class n{constructor(e){this.comparator=e,this.data=new ye(this.comparator)}has(e){return this.data.get(e)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){let r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){let i=r.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let r;for(r=t!==void 0?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Ql(this.data.getIterator())}getIteratorFrom(e){return new Ql(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(r=>{t=t.add(r)}),t}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new n(this.comparator);return t.data=e,t}},Ql=class{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function vi(n){return n.hasNext()?n.getNext():void 0}var gt=class n{constructor(e){this.fields=e,e.sort(Re.comparator)}static empty(){return new n([])}unionWith(e){let t=new me(Re.comparator);for(let r of this.fields)t=t.add(r);for(let r of e)t=t.add(r);return new n(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Di(this.fields,e.fields,(t,r)=>t.isEqual(r))}};var $l=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function nE(){return typeof atob<"u"}var xe=class n{constructor(e){this.binaryString=e}static fromBase64String(e){let t=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new $l("Invalid base64 string: "+s):s}}(e);return new n(t)}static fromUint8Array(e){let t=function(i){let s="";for(let o=0;o<i.length;++o)s+=String.fromCharCode(i[o]);return s}(e);return new n(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(t){return btoa(t)}(this.binaryString)}toUint8Array(){return function(t){let r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return $(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}};xe.EMPTY_BYTE_STRING=new xe("");var SC=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function hn(n){if(G(!!n),typeof n=="string"){let e=0,t=SC.exec(n);if(G(!!t),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}let r=new Date(n);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:we(n.seconds),nanos:we(n.nanos)}}function we(n){return typeof n=="number"?n:typeof n=="string"?Number(n):0}function jn(n){return typeof n=="string"?xe.fromBase64String(n):xe.fromUint8Array(n)}function Lu(n){var e,t;return((t=(((e=n?.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="server_timestamp"}function Qm(n){let e=n.mapValue.fields.__previous_value__;return Lu(e)?Qm(e):e}function Vo(n){let e=hn(n.mapValue.fields.__local_write_time__.timestampValue);return new Te(e.seconds,e.nanos)}var ef=class{constructor(e,t,r,i,s,o,a,u,c){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=i,this.ssl=s,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=u,this.useFetchStreams=c}},Gn=class n{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new n("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(e){return e instanceof n&&e.projectId===this.projectId&&e.database===this.database}};var Ln={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ml={nullValue:"NULL_VALUE"};function Ir(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?Lu(n)?4:rE(n)?9007199254740991:Uu(n)?10:11:B()}function Ht(n,e){if(n===e)return!0;let t=Ir(n);if(t!==Ir(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===e.booleanValue;case 4:return Vo(n).isEqual(Vo(e));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let o=hn(i.timestampValue),a=hn(s.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(n,e);case 5:return n.stringValue===e.stringValue;case 6:return function(i,s){return jn(i.bytesValue).isEqual(jn(s.bytesValue))}(n,e);case 7:return n.referenceValue===e.referenceValue;case 8:return function(i,s){return we(i.geoPointValue.latitude)===we(s.geoPointValue.latitude)&&we(i.geoPointValue.longitude)===we(s.geoPointValue.longitude)}(n,e);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return we(i.integerValue)===we(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let o=we(i.doubleValue),a=we(s.doubleValue);return o===a?Do(o)===Do(a):isNaN(o)&&isNaN(a)}return!1}(n,e);case 9:return Di(n.arrayValue.values||[],e.arrayValue.values||[],Ht);case 10:case 11:return function(i,s){let o=i.mapValue.fields||{},a=s.mapValue.fields||{};if(zv(o)!==zv(a))return!1;for(let u in o)if(o.hasOwnProperty(u)&&(a[u]===void 0||!Ht(o[u],a[u])))return!1;return!0}(n,e);default:return B()}}function Oo(n,e){return(n.values||[]).find(t=>Ht(t,e))!==void 0}function Kn(n,e){if(n===e)return 0;let t=Ir(n),r=Ir(e);if(t!==r)return $(t,r);switch(t){case 0:case 9007199254740991:return 0;case 1:return $(n.booleanValue,e.booleanValue);case 2:return function(s,o){let a=we(s.integerValue||s.doubleValue),u=we(o.integerValue||o.doubleValue);return a<u?-1:a>u?1:a===u?0:isNaN(a)?isNaN(u)?0:-1:1}(n,e);case 3:return Wv(n.timestampValue,e.timestampValue);case 4:return Wv(Vo(n),Vo(e));case 5:return $(n.stringValue,e.stringValue);case 6:return function(s,o){let a=jn(s),u=jn(o);return a.compareTo(u)}(n.bytesValue,e.bytesValue);case 7:return function(s,o){let a=s.split("/"),u=o.split("/");for(let c=0;c<a.length&&c<u.length;c++){let d=$(a[c],u[c]);if(d!==0)return d}return $(a.length,u.length)}(n.referenceValue,e.referenceValue);case 8:return function(s,o){let a=$(we(s.latitude),we(o.latitude));return a!==0?a:$(we(s.longitude),we(o.longitude))}(n.geoPointValue,e.geoPointValue);case 9:return Qv(n.arrayValue,e.arrayValue);case 10:return function(s,o){var a,u,c,d;let m=s.fields||{},p=o.fields||{},y=(a=m.value)===null||a===void 0?void 0:a.arrayValue,A=(u=p.value)===null||u===void 0?void 0:u.arrayValue,x=$(((c=y?.values)===null||c===void 0?void 0:c.length)||0,((d=A?.values)===null||d===void 0?void 0:d.length)||0);return x!==0?x:Qv(y,A)}(n.mapValue,e.mapValue);case 11:return function(s,o){if(s===Ln.mapValue&&o===Ln.mapValue)return 0;if(s===Ln.mapValue)return 1;if(o===Ln.mapValue)return-1;let a=s.fields||{},u=Object.keys(a),c=o.fields||{},d=Object.keys(c);u.sort(),d.sort();for(let m=0;m<u.length&&m<d.length;++m){let p=$(u[m],d[m]);if(p!==0)return p;let y=Kn(a[u[m]],c[d[m]]);if(y!==0)return y}return $(u.length,d.length)}(n.mapValue,e.mapValue);default:throw B()}}function Wv(n,e){if(typeof n=="string"&&typeof e=="string"&&n.length===e.length)return $(n,e);let t=hn(n),r=hn(e),i=$(t.seconds,r.seconds);return i!==0?i:$(t.nanos,r.nanos)}function Qv(n,e){let t=n.values||[],r=e.values||[];for(let i=0;i<t.length&&i<r.length;++i){let s=Kn(t[i],r[i]);if(s)return s}return $(t.length,r.length)}function Vi(n){return tf(n)}function tf(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?function(t){let r=hn(t);return`time(${r.seconds},${r.nanos})`}(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?function(t){return jn(t).toBase64()}(n.bytesValue):"referenceValue"in n?function(t){return U.fromName(t).toString()}(n.referenceValue):"geoPointValue"in n?function(t){return`geo(${t.latitude},${t.longitude})`}(n.geoPointValue):"arrayValue"in n?function(t){let r="[",i=!0;for(let s of t.values||[])i?i=!1:r+=",",r+=tf(s);return r+"]"}(n.arrayValue):"mapValue"in n?function(t){let r=Object.keys(t.fields||{}).sort(),i="{",s=!0;for(let o of r)s?s=!1:i+=",",i+=`${o}:${tf(t.fields[o])}`;return i+"}"}(n.mapValue):B()}function Tr(n,e){return{referenceValue:`projects/${n.projectId}/databases/${n.database}/documents/${e.path.canonicalString()}`}}function nf(n){return!!n&&"integerValue"in n}function Fo(n){return!!n&&"arrayValue"in n}function $v(n){return!!n&&"nullValue"in n}function Hv(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function Ll(n){return!!n&&"mapValue"in n}function Uu(n){var e,t;return((t=(((e=n?.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="__vector__"}function Co(n){if(n.geoPointValue)return{geoPointValue:Object.assign({},n.geoPointValue)};if(n.timestampValue&&typeof n.timestampValue=="object")return{timestampValue:Object.assign({},n.timestampValue)};if(n.mapValue){let e={mapValue:{fields:{}}};return kr(n.mapValue.fields,(t,r)=>e.mapValue.fields[t]=Co(r)),e}if(n.arrayValue){let e={arrayValue:{values:[]}};for(let t=0;t<(n.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=Co(n.arrayValue.values[t]);return e}return Object.assign({},n)}function rE(n){return(((n.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}var iE={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function AC(n){return"nullValue"in n?Ml:"booleanValue"in n?{booleanValue:!1}:"integerValue"in n||"doubleValue"in n?{doubleValue:NaN}:"timestampValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in n?{stringValue:""}:"bytesValue"in n?{bytesValue:""}:"referenceValue"in n?Tr(Gn.empty(),U.empty()):"geoPointValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in n?{arrayValue:{}}:"mapValue"in n?Uu(n)?iE:{mapValue:{}}:B()}function CC(n){return"nullValue"in n?{booleanValue:!1}:"booleanValue"in n?{doubleValue:NaN}:"integerValue"in n||"doubleValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in n?{stringValue:""}:"stringValue"in n?{bytesValue:""}:"bytesValue"in n?Tr(Gn.empty(),U.empty()):"referenceValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in n?{arrayValue:{}}:"arrayValue"in n?iE:"mapValue"in n?Uu(n)?{mapValue:{}}:Ln:B()}function Yv(n,e){let t=Kn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?-1:!n.inclusive&&e.inclusive?1:0}function Jv(n,e){let t=Kn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?1:!n.inclusive&&e.inclusive?-1:0}var Ye=class n{constructor(e){this.value=e}static empty(){return new n({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(t=(t.mapValue.fields||{})[e.get(r)],!Ll(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Co(t)}setAll(e){let t=Re.emptyPath(),r={},i=[];e.forEach((o,a)=>{if(!t.isImmediateParentOf(a)){let u=this.getFieldsMap(t);this.applyChanges(u,r,i),r={},i=[],t=a.popLast()}o?r[a.lastSegment()]=Co(o):i.push(a.lastSegment())});let s=this.getFieldsMap(t);this.applyChanges(s,r,i)}delete(e){let t=this.field(e.popLast());Ll(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Ht(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let i=t.mapValue.fields[e.get(r)];Ll(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,r){kr(t,(i,s)=>e[i]=s);for(let i of r)delete e[i]}clone(){return new n(Co(this.value))}};function sE(n){let e=[];return kr(n.fields,(t,r)=>{let i=new Re([t]);if(Ll(r)){let s=sE(r.mapValue).fields;if(s.length===0)e.push(i);else for(let o of s)e.push(i.child(o))}else e.push(i)}),new gt(e)}var Fe=class n{constructor(e,t,r,i,s,o,a){this.key=e,this.documentType=t,this.version=r,this.readTime=i,this.createTime=s,this.data=o,this.documentState=a}static newInvalidDocument(e){return new n(e,0,z.min(),z.min(),z.min(),Ye.empty(),0)}static newFoundDocument(e,t,r,i){return new n(e,1,t,z.min(),r,i,0)}static newNoDocument(e,t){return new n(e,2,t,z.min(),z.min(),Ye.empty(),0)}static newUnknownDocument(e,t){return new n(e,3,t,z.min(),z.min(),Ye.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(z.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ye.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ye.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=z.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(e){return e instanceof n&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new n(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var Yt=class{constructor(e,t){this.position=e,this.inclusive=t}};function Xv(n,e,t){let r=0;for(let i=0;i<n.position.length;i++){let s=e[i],o=n.position[i];if(s.field.isKeyField()?r=U.comparator(U.fromName(o.referenceValue),t.key):r=Kn(o,t.data.field(s.field)),s.dir==="desc"&&(r*=-1),r!==0)break}return r}function Zv(n,e){if(n===null)return e===null;if(e===null||n.inclusive!==e.inclusive||n.position.length!==e.position.length)return!1;for(let t=0;t<n.position.length;t++)if(!Ht(n.position[t],e.position[t]))return!1;return!0}var Sr=class{constructor(e,t="asc"){this.field=e,this.dir=t}};function bC(n,e){return n.dir===e.dir&&n.field.isEqual(e.field)}var Hl=class{},re=class n extends Hl{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?t==="in"||t==="not-in"?this.createKeyFieldInFilter(e,t,r):new of(e,t,r):t==="array-contains"?new uf(e,r):t==="in"?new Yl(e,r):t==="not-in"?new cf(e,r):t==="array-contains-any"?new hf(e,r):new n(e,t,r)}static createKeyFieldInFilter(e,t,r){return t==="in"?new af(e,r):new lf(e,r)}matches(e){let t=e.data.field(this.field);return this.op==="!="?t!==null&&this.matchesComparison(Kn(t,this.value)):t!==null&&Ir(this.value)===Ir(t)&&this.matchesComparison(Kn(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return e===0;case"!=":return e!==0;case">":return e>0;case">=":return e>=0;default:return B()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},ce=class n extends Hl{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new n(e,t)}matches(e){return Oi(this)?this.filters.find(t=>!t.matches(e))===void 0:this.filters.find(t=>t.matches(e))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}};function Oi(n){return n.op==="and"}function rf(n){return n.op==="or"}function $m(n){return oE(n)&&Oi(n)}function oE(n){for(let e of n.filters)if(e instanceof ce)return!1;return!0}function sf(n){if(n instanceof re)return n.field.canonicalString()+n.op.toString()+Vi(n.value);if($m(n))return n.filters.map(e=>sf(e)).join(",");{let e=n.filters.map(t=>sf(t)).join(",");return`${n.op}(${e})`}}function aE(n,e){return n instanceof re?function(r,i){return i instanceof re&&r.op===i.op&&r.field.isEqual(i.field)&&Ht(r.value,i.value)}(n,e):n instanceof ce?function(r,i){return i instanceof ce&&r.op===i.op&&r.filters.length===i.filters.length?r.filters.reduce((s,o,a)=>s&&aE(o,i.filters[a]),!0):!1}(n,e):void B()}function lE(n,e){let t=n.filters.concat(e);return ce.create(t,n.op)}function uE(n){return n instanceof re?function(t){return`${t.field.canonicalString()} ${t.op} ${Vi(t.value)}`}(n):n instanceof ce?function(t){return t.op.toString()+" {"+t.getFilters().map(uE).join(" ,")+"}"}(n):"Filter"}var of=class extends re{constructor(e,t,r){super(e,t,r),this.key=U.fromName(r.referenceValue)}matches(e){let t=U.comparator(e.key,this.key);return this.matchesComparison(t)}},af=class extends re{constructor(e,t){super(e,"in",t),this.keys=cE("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}},lf=class extends re{constructor(e,t){super(e,"not-in",t),this.keys=cE("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}};function cE(n,e){var t;return(((t=e.arrayValue)===null||t===void 0?void 0:t.values)||[]).map(r=>U.fromName(r.referenceValue))}var uf=class extends re{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return Fo(t)&&Oo(t.arrayValue,this.value)}},Yl=class extends re{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return t!==null&&Oo(this.value.arrayValue,t)}},cf=class extends re{constructor(e,t){super(e,"not-in",t)}matches(e){if(Oo(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return t!==null&&!Oo(this.value.arrayValue,t)}},hf=class extends re{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!Fo(t)||!t.arrayValue.values)&&t.arrayValue.values.some(r=>Oo(this.value.arrayValue,r))}};var df=class{constructor(e,t=null,r=[],i=[],s=null,o=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=i,this.limit=s,this.startAt=o,this.endAt=a,this.ue=null}};function ff(n,e=null,t=[],r=[],i=null,s=null,o=null){return new df(n,e,t,r,i,s,o)}function Ar(n){let e=L(n);if(e.ue===null){let t=e.path.canonicalString();e.collectionGroup!==null&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(r=>sf(r)).join(","),t+="|ob:",t+=e.orderBy.map(r=>function(s){return s.field.canonicalString()+s.dir}(r)).join(","),ea(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(r=>Vi(r)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(r=>Vi(r)).join(",")),e.ue=t}return e.ue}function ta(n,e){if(n.limit!==e.limit||n.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<n.orderBy.length;t++)if(!bC(n.orderBy[t],e.orderBy[t]))return!1;if(n.filters.length!==e.filters.length)return!1;for(let t=0;t<n.filters.length;t++)if(!aE(n.filters[t],e.filters[t]))return!1;return n.collectionGroup===e.collectionGroup&&!!n.path.isEqual(e.path)&&!!Zv(n.startAt,e.startAt)&&Zv(n.endAt,e.endAt)}function Jl(n){return U.isDocumentKey(n.path)&&n.collectionGroup===null&&n.filters.length===0}function Xl(n,e){return n.filters.filter(t=>t instanceof re&&t.field.isEqual(e))}function ew(n,e,t){let r=Ml,i=!0;for(let s of Xl(n,e)){let o=Ml,a=!0;switch(s.op){case"<":case"<=":o=AC(s.value);break;case"==":case"in":case">=":o=s.value;break;case">":o=s.value,a=!1;break;case"!=":case"not-in":o=Ml}Yv({value:r,inclusive:i},{value:o,inclusive:a})<0&&(r=o,i=a)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];Yv({value:r,inclusive:i},{value:o,inclusive:t.inclusive})<0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}function tw(n,e,t){let r=Ln,i=!0;for(let s of Xl(n,e)){let o=Ln,a=!0;switch(s.op){case">=":case">":o=CC(s.value),a=!1;break;case"==":case"in":case"<=":o=s.value;break;case"<":o=s.value,a=!1;break;case"!=":case"not-in":o=Ln}Jv({value:r,inclusive:i},{value:o,inclusive:a})>0&&(r=o,i=a)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];Jv({value:r,inclusive:i},{value:o,inclusive:t.inclusive})>0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}var xt=class{constructor(e,t=null,r=[],i=[],s=null,o="F",a=null,u=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=i,this.limit=s,this.limitType=o,this.startAt=a,this.endAt=u,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}};function hE(n,e,t,r,i,s,o,a){return new xt(n,e,t,r,i,s,o,a)}function Yi(n){return new xt(n)}function nw(n){return n.filters.length===0&&n.limit===null&&n.startAt==null&&n.endAt==null&&(n.explicitOrderBy.length===0||n.explicitOrderBy.length===1&&n.explicitOrderBy[0].field.isKeyField())}function Hm(n){return n.collectionGroup!==null}function xi(n){let e=L(n);if(e.ce===null){e.ce=[];let t=new Set;for(let s of e.explicitOrderBy)e.ce.push(s),t.add(s.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new me(Re.comparator);return o.filters.forEach(u=>{u.getFlattenedFilters().forEach(c=>{c.isInequality()&&(a=a.add(c.field))})}),a})(e).forEach(s=>{t.has(s.canonicalString())||s.isKeyField()||e.ce.push(new Sr(s,r))}),t.has(Re.keyField().canonicalString())||e.ce.push(new Sr(Re.keyField(),r))}return e.ce}function st(n){let e=L(n);return e.le||(e.le=RC(e,xi(n))),e.le}function RC(n,e){if(n.limitType==="F")return ff(n.path,n.collectionGroup,e,n.filters,n.limit,n.startAt,n.endAt);{e=e.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new Sr(i.field,s)});let t=n.endAt?new Yt(n.endAt.position,n.endAt.inclusive):null,r=n.startAt?new Yt(n.startAt.position,n.startAt.inclusive):null;return ff(n.path,n.collectionGroup,e,n.filters,n.limit,t,r)}}function mf(n,e){let t=n.filters.concat([e]);return new xt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),t,n.limit,n.limitType,n.startAt,n.endAt)}function Zl(n,e,t){return new xt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),e,t,n.startAt,n.endAt)}function na(n,e){return ta(st(n),st(e))&&n.limitType===e.limitType}function dE(n){return`${Ar(st(n))}|lt:${n.limitType}`}function Si(n){return`Query(target=${function(t){let r=t.path.canonicalString();return t.collectionGroup!==null&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(i=>uE(i)).join(", ")}]`),ea(t.limit)||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(i=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(i)).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(i=>Vi(i)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(i=>Vi(i)).join(",")),`Target(${r})`}(st(n))}; limitType=${n.limitType})`}function ra(n,e){return e.isFoundDocument()&&function(r,i){let s=i.key.path;return r.collectionGroup!==null?i.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(s):U.isDocumentKey(r.path)?r.path.isEqual(s):r.path.isImmediateParentOf(s)}(n,e)&&function(r,i){for(let s of xi(r))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(n,e)&&function(r,i){for(let s of r.filters)if(!s.matches(i))return!1;return!0}(n,e)&&function(r,i){return!(r.startAt&&!function(o,a,u){let c=Xv(o,a,u);return o.inclusive?c<=0:c<0}(r.startAt,xi(r),i)||r.endAt&&!function(o,a,u){let c=Xv(o,a,u);return o.inclusive?c>=0:c>0}(r.endAt,xi(r),i))}(n,e)}function fE(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function mE(n){return(e,t)=>{let r=!1;for(let i of xi(n)){let s=PC(i,e,t);if(s!==0)return s;r=r||i.field.isKeyField()}return 0}}function PC(n,e,t){let r=n.field.isKeyField()?U.comparator(e.key,t.key):function(s,o,a){let u=o.data.field(s),c=a.data.field(s);return u!==null&&c!==null?Kn(u,c):B()}(n.field,e,t);switch(n.dir){case"asc":return r;case"desc":return-1*r;default:return B()}}var Jt=class{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r!==void 0){for(let[i,s]of r)if(this.equalsFn(i,e))return s}}has(e){return this.get(e)!==void 0}set(e,t){let r=this.mapKeyFn(e),i=this.inner[r];if(i===void 0)return this.inner[r]=[[e,t]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],e))return void(i[s]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r===void 0)return!1;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return r.length===1?delete this.inner[t]:r.splice(i,1),this.innerSize--,!0;return!1}forEach(e){kr(this.inner,(t,r)=>{for(let[i,s]of r)e(i,s)})}isEmpty(){return tE(this.inner)}size(){return this.innerSize}};var xC=new ye(U.comparator);function lt(){return xC}var pE=new ye(U.comparator);function So(...n){let e=pE;for(let t of n)e=e.insert(t.key,t);return e}function gE(n){let e=pE;return n.forEach((t,r)=>e=e.insert(t,r.overlayedDocument)),e}function zt(){return bo()}function _E(){return bo()}function bo(){return new Jt(n=>n.toString(),(n,e)=>n.isEqual(e))}var NC=new ye(U.comparator),DC=new me(U.comparator);function X(...n){let e=DC;for(let t of n)e=e.add(t);return e}var kC=new me($);function Ym(){return kC}function Jm(n,e){if(n.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Do(e)?"-0":e}}function yE(n){return{integerValue:""+n}}function vE(n,e){return Yw(e)?yE(e):Jm(n,e)}var Fi=class{constructor(){this._=void 0}};function VC(n,e,t){return n instanceof zn?function(i,s){let o={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&Lu(s)&&(s=Qm(s)),s&&(o.fields.__previous_value__=s),{mapValue:o}}(t,e):n instanceof dn?EE(n,e):n instanceof fn?IE(n,e):function(i,s){let o=wE(i,s),a=rw(o)+rw(i.Pe);return nf(o)&&nf(i.Pe)?yE(a):Jm(i.serializer,a)}(n,e)}function OC(n,e,t){return n instanceof dn?EE(n,e):n instanceof fn?IE(n,e):t}function wE(n,e){return n instanceof Wn?function(r){return nf(r)||function(s){return!!s&&"doubleValue"in s}(r)}(e)?e:{integerValue:0}:null}var zn=class extends Fi{},dn=class extends Fi{constructor(e){super(),this.elements=e}};function EE(n,e){let t=TE(e);for(let r of n.elements)t.some(i=>Ht(i,r))||t.push(r);return{arrayValue:{values:t}}}var fn=class extends Fi{constructor(e){super(),this.elements=e}};function IE(n,e){let t=TE(e);for(let r of n.elements)t=t.filter(i=>!Ht(i,r));return{arrayValue:{values:t}}}var Wn=class extends Fi{constructor(e,t){super(),this.serializer=e,this.Pe=t}};function rw(n){return we(n.integerValue||n.doubleValue)}function TE(n){return Fo(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}var Cr=class{constructor(e,t){this.field=e,this.transform=t}};function FC(n,e){return n.field.isEqual(e.field)&&function(r,i){return r instanceof dn&&i instanceof dn||r instanceof fn&&i instanceof fn?Di(r.elements,i.elements,Ht):r instanceof Wn&&i instanceof Wn?Ht(r.Pe,i.Pe):r instanceof zn&&i instanceof zn}(n.transform,e.transform)}var pf=class{constructor(e,t){this.version=e,this.transformResults=t}},Ae=class n{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new n}static exists(e){return new n(void 0,e)}static updateTime(e){return new n(e)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}};function Ul(n,e){return n.updateTime!==void 0?e.isFoundDocument()&&e.version.isEqual(n.updateTime):n.exists===void 0||n.exists===e.isFoundDocument()}var Mi=class{};function SE(n,e){if(!n.hasLocalMutations||e&&e.fields.length===0)return null;if(e===null)return n.isNoDocument()?new $n(n.key,Ae.none()):new Qn(n.key,n.data,Ae.none());{let t=n.data,r=Ye.empty(),i=new me(Re.comparator);for(let s of e.fields)if(!i.has(s)){let o=t.field(s);o===null&&s.length>1&&(s=s.popLast(),o=t.field(s)),o===null?r.delete(s):r.set(s,o),i=i.add(s)}return new Nt(n.key,r,new gt(i.toArray()),Ae.none())}}function MC(n,e,t){n instanceof Qn?function(i,s,o){let a=i.value.clone(),u=sw(i.fieldTransforms,s,o.transformResults);a.setAll(u),s.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(n,e,t):n instanceof Nt?function(i,s,o){if(!Ul(i.precondition,s))return void s.convertToUnknownDocument(o.version);let a=sw(i.fieldTransforms,s,o.transformResults),u=s.data;u.setAll(AE(i)),u.setAll(a),s.convertToFoundDocument(o.version,u).setHasCommittedMutations()}(n,e,t):function(i,s,o){s.convertToNoDocument(o.version).setHasCommittedMutations()}(0,e,t)}function Ro(n,e,t,r){return n instanceof Qn?function(s,o,a,u){if(!Ul(s.precondition,o))return a;let c=s.value.clone(),d=ow(s.fieldTransforms,u,o);return c.setAll(d),o.convertToFoundDocument(o.version,c).setHasLocalMutations(),null}(n,e,t,r):n instanceof Nt?function(s,o,a,u){if(!Ul(s.precondition,o))return a;let c=ow(s.fieldTransforms,u,o),d=o.data;return d.setAll(AE(s)),d.setAll(c),o.convertToFoundDocument(o.version,d).setHasLocalMutations(),a===null?null:a.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(m=>m.field))}(n,e,t,r):function(s,o,a){return Ul(s.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(n,e,t)}function LC(n,e){let t=null;for(let r of n.fieldTransforms){let i=e.data.field(r.field),s=wE(r.transform,i||null);s!=null&&(t===null&&(t=Ye.empty()),t.set(r.field,s))}return t||null}function iw(n,e){return n.type===e.type&&!!n.key.isEqual(e.key)&&!!n.precondition.isEqual(e.precondition)&&!!function(r,i){return r===void 0&&i===void 0||!(!r||!i)&&Di(r,i,(s,o)=>FC(s,o))}(n.fieldTransforms,e.fieldTransforms)&&(n.type===0?n.value.isEqual(e.value):n.type!==1||n.data.isEqual(e.data)&&n.fieldMask.isEqual(e.fieldMask))}var Qn=class extends Mi{constructor(e,t,r,i=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},Nt=class extends Mi{constructor(e,t,r,i,s=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function AE(n){let e=new Map;return n.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){let r=n.data.field(t);e.set(t,r)}}),e}function sw(n,e,t){let r=new Map;G(n.length===t.length);for(let i=0;i<t.length;i++){let s=n[i],o=s.transform,a=e.data.field(s.field);r.set(s.field,OC(o,a,t[i]))}return r}function ow(n,e,t){let r=new Map;for(let i of n){let s=i.transform,o=t.data.field(i.field);r.set(i.field,VC(s,o,e))}return r}var $n=class extends Mi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},Mo=class extends Mi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var Lo=class{constructor(e,t,r,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=i}applyToRemoteDocument(e,t){let r=t.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(e.key)&&MC(s,e,r[i])}}applyToLocalView(e,t){for(let r of this.baseMutations)r.key.isEqual(e.key)&&(t=Ro(r,e,t,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(e.key)&&(t=Ro(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let r=_E();return this.mutations.forEach(i=>{let s=e.get(i.key),o=s.overlayedDocument,a=this.applyToLocalView(o,s.mutatedFields);a=t.has(i.key)?null:a;let u=SE(o,a);u!==null&&r.set(i.key,u),o.isValidDocument()||o.convertToNoDocument(z.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),X())}isEqual(e){return this.batchId===e.batchId&&Di(this.mutations,e.mutations,(t,r)=>iw(t,r))&&Di(this.baseMutations,e.baseMutations,(t,r)=>iw(t,r))}},gf=class n{constructor(e,t,r,i){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=i}static from(e,t,r){G(e.mutations.length===r.length);let i=function(){return NC}(),s=e.mutations;for(let o=0;o<s.length;o++)i=i.insert(s[o].key,r[o].version);return new n(e,t,r,i)}};var Uo=class{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return e!==null&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var _f=class{constructor(e,t){this.count=e,this.unchangedNames=t}};var De,ie;function CE(n){switch(n){default:return B();case R.CANCELLED:case R.UNKNOWN:case R.DEADLINE_EXCEEDED:case R.RESOURCE_EXHAUSTED:case R.INTERNAL:case R.UNAVAILABLE:case R.UNAUTHENTICATED:return!1;case R.INVALID_ARGUMENT:case R.NOT_FOUND:case R.ALREADY_EXISTS:case R.PERMISSION_DENIED:case R.FAILED_PRECONDITION:case R.ABORTED:case R.OUT_OF_RANGE:case R.UNIMPLEMENTED:case R.DATA_LOSS:return!0}}function bE(n){if(n===void 0)return be("GRPC error has no .code"),R.UNKNOWN;switch(n){case De.OK:return R.OK;case De.CANCELLED:return R.CANCELLED;case De.UNKNOWN:return R.UNKNOWN;case De.DEADLINE_EXCEEDED:return R.DEADLINE_EXCEEDED;case De.RESOURCE_EXHAUSTED:return R.RESOURCE_EXHAUSTED;case De.INTERNAL:return R.INTERNAL;case De.UNAVAILABLE:return R.UNAVAILABLE;case De.UNAUTHENTICATED:return R.UNAUTHENTICATED;case De.INVALID_ARGUMENT:return R.INVALID_ARGUMENT;case De.NOT_FOUND:return R.NOT_FOUND;case De.ALREADY_EXISTS:return R.ALREADY_EXISTS;case De.PERMISSION_DENIED:return R.PERMISSION_DENIED;case De.FAILED_PRECONDITION:return R.FAILED_PRECONDITION;case De.ABORTED:return R.ABORTED;case De.OUT_OF_RANGE:return R.OUT_OF_RANGE;case De.UNIMPLEMENTED:return R.UNIMPLEMENTED;case De.DATA_LOSS:return R.DATA_LOSS;default:return B()}}(ie=De||(De={}))[ie.OK=0]="OK",ie[ie.CANCELLED=1]="CANCELLED",ie[ie.UNKNOWN=2]="UNKNOWN",ie[ie.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",ie[ie.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",ie[ie.NOT_FOUND=5]="NOT_FOUND",ie[ie.ALREADY_EXISTS=6]="ALREADY_EXISTS",ie[ie.PERMISSION_DENIED=7]="PERMISSION_DENIED",ie[ie.UNAUTHENTICATED=16]="UNAUTHENTICATED",ie[ie.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",ie[ie.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",ie[ie.ABORTED=10]="ABORTED",ie[ie.OUT_OF_RANGE=11]="OUT_OF_RANGE",ie[ie.UNIMPLEMENTED=12]="UNIMPLEMENTED",ie[ie.INTERNAL=13]="INTERNAL",ie[ie.UNAVAILABLE=14]="UNAVAILABLE",ie[ie.DATA_LOSS=15]="DATA_LOSS";var aw=null;function RE(){return new TextEncoder}var UC=new kn([4294967295,4294967295],0);function lw(n){let e=RE().encode(n),t=new Nd;return t.update(e),new Uint8Array(t.digest())}function uw(n){let e=new DataView(n.buffer),t=e.getUint32(0,!0),r=e.getUint32(4,!0),i=e.getUint32(8,!0),s=e.getUint32(12,!0);return[new kn([t,r],0),new kn([i,s],0)]}var yf=class n{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new wr(`Invalid padding: ${t}`);if(r<0)throw new wr(`Invalid hash count: ${r}`);if(e.length>0&&this.hashCount===0)throw new wr(`Invalid hash count: ${r}`);if(e.length===0&&t!==0)throw new wr(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=kn.fromNumber(this.Ie)}Ee(e,t,r){let i=e.add(t.multiply(kn.fromNumber(r)));return i.compare(UC)===1&&(i=new kn([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(e){return(this.bitmap[Math.floor(e/8)]&1<<e%8)!=0}mightContain(e){if(this.Ie===0)return!1;let t=lw(e),[r,i]=uw(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);if(!this.de(o))return!1}return!0}static create(e,t,r){let i=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),o=new n(s,i,t);return r.forEach(a=>o.insert(a)),o}insert(e){if(this.Ie===0)return;let t=lw(e),[r,i]=uw(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);this.Ae(o)}}Ae(e){let t=Math.floor(e/8),r=e%8;this.bitmap[t]|=1<<r}},wr=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var Bo=class n{constructor(e,t,r,i,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,r){let i=new Map;return i.set(e,qo.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new n(z.min(),i,new ye($),lt(),X())}},qo=class n{constructor(e,t,r,i,s){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new n(r,t,X(),X(),X())}};var Ni=class{constructor(e,t,r,i){this.Re=e,this.removedTargetIds=t,this.key=r,this.Ve=i}},eu=class{constructor(e,t){this.targetId=e,this.me=t}},tu=class{constructor(e,t,r=xe.EMPTY_BYTE_STRING,i=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=i}},nu=class{constructor(){this.fe=0,this.ge=hw(),this.pe=xe.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=X(),t=X(),r=X();return this.ge.forEach((i,s)=>{switch(s){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:r=r.add(i);break;default:B()}}),new qo(this.pe,this.ye,e,t,r)}Ce(){this.we=!1,this.ge=hw()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,G(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}},vf=class{constructor(e){this.Le=e,this.Be=new Map,this.ke=lt(),this.qe=cw(),this.Qe=new ye($)}Ke(e){for(let t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(let t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{let r=this.Ge(t);switch(e.state){case 0:this.ze(t)&&r.De(e.resumeToken);break;case 1:r.Oe(),r.Se||r.Ce(),r.De(e.resumeToken);break;case 2:r.Oe(),r.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(r.Ne(),r.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),r.De(e.resumeToken));break;default:B()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((r,i)=>{this.ze(i)&&t(i)})}He(e){let t=e.targetId,r=e.me.count,i=this.Je(t);if(i){let s=i.target;if(Jl(s))if(r===0){let o=new U(s.path);this.Ue(t,o,Fe.newNoDocument(o,z.min()))}else G(r===1);else{let o=this.Ye(t);if(o!==r){let a=this.Ze(e),u=a?this.Xe(a,e,o):1;if(u!==0){this.je(t);let c=u===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,c)}aw?.et(function(d,m,p,y,A){var x,N,q,j,F,W;let H={localCacheCount:d,existenceFilterCount:m.count,databaseId:p.database,projectId:p.projectId},Y=m.unchangedNames;return Y&&(H.bloomFilter={applied:A===0,hashCount:(x=Y?.hashCount)!==null&&x!==void 0?x:0,bitmapLength:(j=(q=(N=Y?.bits)===null||N===void 0?void 0:N.bitmap)===null||q===void 0?void 0:q.length)!==null&&j!==void 0?j:0,padding:(W=(F=Y?.bits)===null||F===void 0?void 0:F.padding)!==null&&W!==void 0?W:0,mightContain:E=>{var _;return(_=y?.mightContain(E))!==null&&_!==void 0&&_}}),H}(o,e.me,this.Le.tt(),a,u))}}}}Ze(e){let t=e.me.unchangedNames;if(!t||!t.bits)return null;let{bits:{bitmap:r="",padding:i=0},hashCount:s=0}=t,o,a;try{o=jn(r).toUint8Array()}catch(u){if(u instanceof $l)return St("Decoding the base64 bloom filter in existence filter failed ("+u.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw u}try{a=new yf(o,i,s)}catch(u){return St(u instanceof wr?"BloomFilter error: ":"Applying bloom filter failed: ",u),null}return a.Ie===0?null:a}Xe(e,t,r){return t.me.count===r-this.nt(e,t.targetId)?0:2}nt(e,t){let r=this.Le.getRemoteKeysForTarget(t),i=0;return r.forEach(s=>{let o=this.Le.tt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${s.path.canonicalString()}`;e.mightContain(a)||(this.Ue(t,s,null),i++)}),i}rt(e){let t=new Map;this.Be.forEach((s,o)=>{let a=this.Je(o);if(a){if(s.current&&Jl(a.target)){let u=new U(a.target.path);this.ke.get(u)!==null||this.it(o,u)||this.Ue(o,u,Fe.newNoDocument(u,e))}s.be&&(t.set(o,s.ve()),s.Ce())}});let r=X();this.qe.forEach((s,o)=>{let a=!0;o.forEachWhile(u=>{let c=this.Je(u);return!c||c.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(r=r.add(s))}),this.ke.forEach((s,o)=>o.setReadTime(e));let i=new Bo(e,t,this.Qe,this.ke,r);return this.ke=lt(),this.qe=cw(),this.Qe=new ye($),i}$e(e,t){if(!this.ze(e))return;let r=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,r),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,r){if(!this.ze(e))return;let i=this.Ge(e);this.it(e,t)?i.Fe(t,1):i.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),r&&(this.ke=this.ke.insert(t,r))}removeTarget(e){this.Be.delete(e)}Ye(e){let t=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new nu,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new me($),this.qe=this.qe.insert(e,t)),t}ze(e){let t=this.Je(e)!==null;return t||V("WatchChangeAggregator","Detected inactive target",e),t}Je(e){let t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new nu),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}};function cw(){return new ye(U.comparator)}function hw(){return new ye(U.comparator)}var BC={asc:"ASCENDING",desc:"DESCENDING"},qC={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},jC={and:"AND",or:"OR"},wf=class{constructor(e,t){this.databaseId=e,this.useProto3Json=t}};function Ef(n,e){return n.useProto3Json||ea(e)?e:{value:e}}function Li(n,e){return n.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function PE(n,e){return n.useProto3Json?e.toBase64():e.toUint8Array()}function GC(n,e){return Li(n,e.toTimestamp())}function Pe(n){return G(!!n),z.fromTimestamp(function(t){let r=hn(t);return new Te(r.seconds,r.nanos)}(n))}function Xm(n,e){return If(n,e).canonicalString()}function If(n,e){let t=function(i){return new se(["projects",i.projectId,"databases",i.database])}(n).child("documents");return e===void 0?t:t.child(e)}function xE(n){let e=se.fromString(n);return G(BE(e)),e}function jo(n,e){return Xm(n.databaseId,e.path)}function Qt(n,e){let t=xE(e);if(t.get(1)!==n.databaseId.projectId)throw new k(R.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+n.databaseId.projectId);if(t.get(3)!==n.databaseId.database)throw new k(R.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+n.databaseId.database);return new U(kE(t))}function NE(n,e){return Xm(n.databaseId,e)}function DE(n){let e=xE(n);return e.length===4?se.emptyPath():kE(e)}function Tf(n){return new se(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function kE(n){return G(n.length>4&&n.get(4)==="documents"),n.popFirst(5)}function dw(n,e,t){return{name:jo(n,e),fields:t.value.mapValue.fields}}function VE(n,e,t){let r=Qt(n,e.name),i=Pe(e.updateTime),s=e.createTime?Pe(e.createTime):z.min(),o=new Ye({mapValue:{fields:e.fields}}),a=Fe.newFoundDocument(r,i,s,o);return t&&a.setHasCommittedMutations(),t?a.setHasCommittedMutations():a}function KC(n,e){return"found"in e?function(r,i){G(!!i.found),i.found.name,i.found.updateTime;let s=Qt(r,i.found.name),o=Pe(i.found.updateTime),a=i.found.createTime?Pe(i.found.createTime):z.min(),u=new Ye({mapValue:{fields:i.found.fields}});return Fe.newFoundDocument(s,o,a,u)}(n,e):"missing"in e?function(r,i){G(!!i.missing),G(!!i.readTime);let s=Qt(r,i.missing),o=Pe(i.readTime);return Fe.newNoDocument(s,o)}(n,e):B()}function zC(n,e){let t;if("targetChange"in e){e.targetChange;let r=function(c){return c==="NO_CHANGE"?0:c==="ADD"?1:c==="REMOVE"?2:c==="CURRENT"?3:c==="RESET"?4:B()}(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],s=function(c,d){return c.useProto3Json?(G(d===void 0||typeof d=="string"),xe.fromBase64String(d||"")):(G(d===void 0||d instanceof Buffer||d instanceof Uint8Array),xe.fromUint8Array(d||new Uint8Array))}(n,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(c){let d=c.code===void 0?R.UNKNOWN:bE(c.code);return new k(d,c.message||"")}(o);t=new tu(r,i,s,a||null)}else if("documentChange"in e){e.documentChange;let r=e.documentChange;r.document,r.document.name,r.document.updateTime;let i=Qt(n,r.document.name),s=Pe(r.document.updateTime),o=r.document.createTime?Pe(r.document.createTime):z.min(),a=new Ye({mapValue:{fields:r.document.fields}}),u=Fe.newFoundDocument(i,s,o,a),c=r.targetIds||[],d=r.removedTargetIds||[];t=new Ni(c,d,u.key,u)}else if("documentDelete"in e){e.documentDelete;let r=e.documentDelete;r.document;let i=Qt(n,r.document),s=r.readTime?Pe(r.readTime):z.min(),o=Fe.newNoDocument(i,s),a=r.removedTargetIds||[];t=new Ni([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;let r=e.documentRemove;r.document;let i=Qt(n,r.document),s=r.removedTargetIds||[];t=new Ni([],s,i,null)}else{if(!("filter"in e))return B();{e.filter;let r=e.filter;r.targetId;let{count:i=0,unchangedNames:s}=r,o=new _f(i,s),a=r.targetId;t=new eu(a,o)}}return t}function Go(n,e){let t;if(e instanceof Qn)t={update:dw(n,e.key,e.value)};else if(e instanceof $n)t={delete:jo(n,e.key)};else if(e instanceof Nt)t={update:dw(n,e.key,e.data),updateMask:JC(e.fieldMask)};else{if(!(e instanceof Mo))return B();t={verify:jo(n,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(r=>function(s,o){let a=o.transform;if(a instanceof zn)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof dn)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof fn)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof Wn)return{fieldPath:o.field.canonicalString(),increment:a.Pe};throw B()}(0,r))),e.precondition.isNone||(t.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:GC(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:B()}(n,e.precondition)),t}function Sf(n,e){let t=e.currentDocument?function(s){return s.updateTime!==void 0?Ae.updateTime(Pe(s.updateTime)):s.exists!==void 0?Ae.exists(s.exists):Ae.none()}(e.currentDocument):Ae.none(),r=e.updateTransforms?e.updateTransforms.map(i=>function(o,a){let u=null;if("setToServerValue"in a)G(a.setToServerValue==="REQUEST_TIME"),u=new zn;else if("appendMissingElements"in a){let d=a.appendMissingElements.values||[];u=new dn(d)}else if("removeAllFromArray"in a){let d=a.removeAllFromArray.values||[];u=new fn(d)}else"increment"in a?u=new Wn(o,a.increment):B();let c=Re.fromServerFormat(a.fieldPath);return new Cr(c,u)}(n,i)):[];if(e.update){e.update.name;let i=Qt(n,e.update.name),s=new Ye({mapValue:{fields:e.update.fields}});if(e.updateMask){let o=function(u){let c=u.fieldPaths||[];return new gt(c.map(d=>Re.fromServerFormat(d)))}(e.updateMask);return new Nt(i,s,o,t,r)}return new Qn(i,s,t,r)}if(e.delete){let i=Qt(n,e.delete);return new $n(i,t)}if(e.verify){let i=Qt(n,e.verify);return new Mo(i,t)}return B()}function WC(n,e){return n&&n.length>0?(G(e!==void 0),n.map(t=>function(i,s){let o=i.updateTime?Pe(i.updateTime):Pe(s);return o.isEqual(z.min())&&(o=Pe(s)),new pf(o,i.transformResults||[])}(t,e))):[]}function OE(n,e){return{documents:[NE(n,e.path)]}}function FE(n,e){let t={structuredQuery:{}},r=e.path,i;e.collectionGroup!==null?(i=r,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=r.popLast(),t.structuredQuery.from=[{collectionId:r.lastSegment()}]),t.parent=NE(n,i);let s=function(c){if(c.length!==0)return UE(ce.create(c,"and"))}(e.filters);s&&(t.structuredQuery.where=s);let o=function(c){if(c.length!==0)return c.map(d=>function(p){return{field:Ai(p.field),direction:$C(p.dir)}}(d))}(e.orderBy);o&&(t.structuredQuery.orderBy=o);let a=Ef(n,e.limit);return a!==null&&(t.structuredQuery.limit=a),e.startAt&&(t.structuredQuery.startAt=function(c){return{before:c.inclusive,values:c.position}}(e.startAt)),e.endAt&&(t.structuredQuery.endAt=function(c){return{before:!c.inclusive,values:c.position}}(e.endAt)),{_t:t,parent:i}}function ME(n){let e=DE(n.parent),t=n.structuredQuery,r=t.from?t.from.length:0,i=null;if(r>0){G(r===1);let d=t.from[0];d.allDescendants?i=d.collectionId:e=e.child(d.collectionId)}let s=[];t.where&&(s=function(m){let p=LE(m);return p instanceof ce&&$m(p)?p.getFilters():[p]}(t.where));let o=[];t.orderBy&&(o=function(m){return m.map(p=>function(A){return new Sr(Ci(A.field),function(N){switch(N){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(A.direction))}(p))}(t.orderBy));let a=null;t.limit&&(a=function(m){let p;return p=typeof m=="object"?m.value:m,ea(p)?null:p}(t.limit));let u=null;t.startAt&&(u=function(m){let p=!!m.before,y=m.values||[];return new Yt(y,p)}(t.startAt));let c=null;return t.endAt&&(c=function(m){let p=!m.before,y=m.values||[];return new Yt(y,p)}(t.endAt)),hE(e,i,o,s,a,"F",u,c)}function QC(n,e){let t=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return B()}}(e.purpose);return t==null?null:{"goog-listen-tags":t}}function LE(n){return n.unaryFilter!==void 0?function(t){switch(t.unaryFilter.op){case"IS_NAN":let r=Ci(t.unaryFilter.field);return re.create(r,"==",{doubleValue:NaN});case"IS_NULL":let i=Ci(t.unaryFilter.field);return re.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=Ci(t.unaryFilter.field);return re.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let o=Ci(t.unaryFilter.field);return re.create(o,"!=",{nullValue:"NULL_VALUE"});default:return B()}}(n):n.fieldFilter!==void 0?function(t){return re.create(Ci(t.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return B()}}(t.fieldFilter.op),t.fieldFilter.value)}(n):n.compositeFilter!==void 0?function(t){return ce.create(t.compositeFilter.filters.map(r=>LE(r)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return B()}}(t.compositeFilter.op))}(n):B()}function $C(n){return BC[n]}function HC(n){return qC[n]}function YC(n){return jC[n]}function Ai(n){return{fieldPath:n.canonicalString()}}function Ci(n){return Re.fromServerFormat(n.fieldPath)}function UE(n){return n instanceof re?function(t){if(t.op==="=="){if(Hv(t.value))return{unaryFilter:{field:Ai(t.field),op:"IS_NAN"}};if($v(t.value))return{unaryFilter:{field:Ai(t.field),op:"IS_NULL"}}}else if(t.op==="!="){if(Hv(t.value))return{unaryFilter:{field:Ai(t.field),op:"IS_NOT_NAN"}};if($v(t.value))return{unaryFilter:{field:Ai(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ai(t.field),op:HC(t.op),value:t.value}}}(n):n instanceof ce?function(t){let r=t.getFilters().map(i=>UE(i));return r.length===1?r[0]:{compositeFilter:{op:YC(t.op),filters:r}}}(n):B()}function JC(n){let e=[];return n.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function BE(n){return n.length>=4&&n.get(0)==="projects"&&n.get(2)==="databases"}var Ui=class n{constructor(e,t,r,i,s=z.min(),o=z.min(),a=xe.EMPTY_BYTE_STRING,u=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=u}withSequenceNumber(e){return new n(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}};var ru=class{constructor(e){this.ct=e}};function XC(n,e){let t;if(e.document)t=VE(n.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){let r=U.fromSegments(e.noDocument.path),i=Rr(e.noDocument.readTime);t=Fe.newNoDocument(r,i),e.hasCommittedMutations&&t.setHasCommittedMutations()}else{if(!e.unknownDocument)return B();{let r=U.fromSegments(e.unknownDocument.path),i=Rr(e.unknownDocument.version);t=Fe.newUnknownDocument(r,i)}}return e.readTime&&t.setReadTime(function(i){let s=new Te(i[0],i[1]);return z.fromTimestamp(s)}(e.readTime)),t}function fw(n,e){let t=e.key,r={prefixPath:t.getCollectionPath().popLast().toArray(),collectionGroup:t.collectionGroup,documentId:t.path.lastSegment(),readTime:iu(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(s,o){return{name:jo(s,o.key),fields:o.data.value.mapValue.fields,updateTime:Li(s,o.version.toTimestamp()),createTime:Li(s,o.createTime.toTimestamp())}}(n.ct,e);else if(e.isNoDocument())r.noDocument={path:t.path.toArray(),readTime:br(e.version)};else{if(!e.isUnknownDocument())return B();r.unknownDocument={path:t.path.toArray(),version:br(e.version)}}return r}function iu(n){let e=n.toTimestamp();return[e.seconds,e.nanoseconds]}function br(n){let e=n.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Rr(n){let e=new Te(n.seconds,n.nanoseconds);return z.fromTimestamp(e)}function _r(n,e){let t=(e.baseMutations||[]).map(s=>Sf(n.ct,s));for(let s=0;s<e.mutations.length-1;++s){let o=e.mutations[s];if(s+1<e.mutations.length&&e.mutations[s+1].transform!==void 0){let a=e.mutations[s+1];o.updateTransforms=a.transform.fieldTransforms,e.mutations.splice(s+1,1),++s}}let r=e.mutations.map(s=>Sf(n.ct,s)),i=Te.fromMillis(e.localWriteTimeMs);return new Lo(e.batchId,i,t,r)}function Ao(n){let e=Rr(n.readTime),t=n.lastLimboFreeSnapshotVersion!==void 0?Rr(n.lastLimboFreeSnapshotVersion):z.min(),r;return r=function(s){return s.documents!==void 0}(n.query)?function(s){return G(s.documents.length===1),st(Yi(DE(s.documents[0])))}(n.query):function(s){return st(ME(s))}(n.query),new Ui(r,n.targetId,"TargetPurposeListen",n.lastListenSequenceNumber,e,t,xe.fromBase64String(n.resumeToken))}function qE(n,e){let t=br(e.snapshotVersion),r=br(e.lastLimboFreeSnapshotVersion),i;i=Jl(e.target)?OE(n.ct,e.target):FE(n.ct,e.target)._t;let s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Ar(e.target),readTime:t,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Zm(n){let e=ME({parent:n.parent,structuredQuery:n.structuredQuery});return n.limitType==="LAST"?Zl(e,e.limit,"L"):e}function Ld(n,e){return new Uo(e.largestBatchId,Sf(n.ct,e.overlayMutation))}function mw(n,e){let t=e.path.lastSegment();return[n,it(e.path.popLast()),t]}function pw(n,e,t,r){return{indexId:n,uid:e,sequenceNumber:t,readTime:br(r.readTime),documentKey:it(r.documentKey.path),largestBatchId:r.largestBatchId}}var Af=class{getBundleMetadata(e,t){return gw(e).get(t).next(r=>{if(r)return function(s){return{id:s.bundleId,createTime:Rr(s.createTime),version:s.version}}(r)})}saveBundleMetadata(e,t){return gw(e).put(function(i){return{bundleId:i.id,createTime:br(Pe(i.createTime)),version:i.version}}(t))}getNamedQuery(e,t){return _w(e).get(t).next(r=>{if(r)return function(s){return{name:s.name,query:Zm(s.bundledQuery),readTime:Rr(s.readTime)}}(r)})}saveNamedQuery(e,t){return _w(e).put(function(i){return{name:i.name,readTime:br(Pe(i.readTime)),bundledQuery:i.bundledQuery}}(t))}};function gw(n){return Le(n,"bundles")}function _w(n){return Le(n,"namedQueries")}var su=class n{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){let r=t.uid||"";return new n(e,r)}getOverlay(e,t){return wo(e).get(mw(this.userId,t)).next(r=>r?Ld(this.serializer,r):null)}getOverlays(e,t){let r=zt();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){let i=[];return r.forEach((s,o)=>{let a=new Uo(t,o);i.push(this.ht(e,a))}),b.waitFor(i)}removeOverlaysForBatchId(e,t,r){let i=new Set;t.forEach(o=>i.add(it(o.getCollectionPath())));let s=[];return i.forEach(o=>{let a=IDBKeyRange.bound([this.userId,o,r],[this.userId,o,r+1],!1,!0);s.push(wo(e).j("collectionPathOverlayIndex",a))}),b.waitFor(s)}getOverlaysForCollection(e,t,r){let i=zt(),s=it(t),o=IDBKeyRange.bound([this.userId,s,r],[this.userId,s,Number.POSITIVE_INFINITY],!0);return wo(e).U("collectionPathOverlayIndex",o).next(a=>{for(let u of a){let c=Ld(this.serializer,u);i.set(c.getKey(),c)}return i})}getOverlaysForCollectionGroup(e,t,r,i){let s=zt(),o,a=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,Number.POSITIVE_INFINITY],!0);return wo(e).J({index:"collectionGroupOverlayIndex",range:a},(u,c,d)=>{let m=Ld(this.serializer,c);s.size()<i||m.largestBatchId===o?(s.set(m.getKey(),m),o=m.largestBatchId):d.done()}).next(()=>s)}ht(e,t){return wo(e).put(function(i,s,o){let[a,u,c]=mw(s,o.mutation.key);return{userId:s,collectionPath:u,documentId:c,collectionGroup:o.mutation.key.getCollectionGroup(),largestBatchId:o.largestBatchId,overlayMutation:Go(i.ct,o.mutation)}}(this.serializer,this.userId,t))}};function wo(n){return Le(n,"documentOverlays")}var Cf=class{Pt(e){return Le(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next(t=>{let r=t?.value;return r?xe.fromUint8Array(r):xe.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}};var un=class{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(e.booleanValue?1:0);else if("integerValue"in e)this.dt(t,15),t.At(we(e.integerValue));else if("doubleValue"in e){let r=we(e.doubleValue);isNaN(r)?this.dt(t,13):(this.dt(t,15),Do(r)?t.At(0):t.At(r))}else if("timestampValue"in e){let r=e.timestampValue;this.dt(t,20),typeof r=="string"&&(r=hn(r)),t.Rt(`${r.seconds||""}`),t.At(r.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(jn(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){let r=e.geoPointValue;this.dt(t,45),t.At(r.latitude||0),t.At(r.longitude||0)}else"mapValue"in e?rE(e)?this.dt(t,Number.MAX_SAFE_INTEGER):Uu(e)?this.wt(e.mapValue,t):(this.St(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.ft(t)):B()}Vt(e,t){this.dt(t,25),this.Dt(e,t)}Dt(e,t){t.Rt(e)}St(e,t){let r=e.fields||{};this.dt(t,55);for(let i of Object.keys(r))this.Vt(i,t),this.Tt(r[i],t)}wt(e,t){var r,i;let s=e.fields||{};this.dt(t,53);let o="value",a=((i=(r=s[o].arrayValue)===null||r===void 0?void 0:r.values)===null||i===void 0?void 0:i.length)||0;this.dt(t,15),t.At(we(a)),this.Vt(o,t),this.Tt(s[o],t)}bt(e,t){let r=e.values||[];this.dt(t,50);for(let i of r)this.Tt(i,t)}yt(e,t){this.dt(t,37),U.fromName(e).path.forEach(r=>{this.dt(t,60),this.Dt(r,t)})}dt(e,t){e.At(t)}ft(e){e.At(2)}};un.vt=new un;function ZC(n){if(n===0)return 8;let e=0;return!(n>>4)&&(e+=4,n<<=4),!(n>>6)&&(e+=2,n<<=2),!(n>>7)&&(e+=1),e}function yw(n){let e=64-function(r){let i=0;for(let s=0;s<8;++s){let o=ZC(255&r[s]);if(i+=o,o!==8)break}return i}(n);return Math.ceil(e/8)}var bf=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Ft(r.value),r=t.next();this.Mt()}xt(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Ot(r.value),r=t.next();this.Nt()}Lt(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.Ft(r);else if(r<2048)this.Ft(960|r>>>6),this.Ft(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.Ft(480|r>>>12),this.Ft(128|63&r>>>6),this.Ft(128|63&r);else{let i=t.codePointAt(0);this.Ft(240|i>>>18),this.Ft(128|63&i>>>12),this.Ft(128|63&i>>>6),this.Ft(128|63&i)}}this.Mt()}Bt(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.Ot(r);else if(r<2048)this.Ot(960|r>>>6),this.Ot(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.Ot(480|r>>>12),this.Ot(128|63&r>>>6),this.Ot(128|63&r);else{let i=t.codePointAt(0);this.Ot(240|i>>>18),this.Ot(128|63&i>>>12),this.Ot(128|63&i>>>6),this.Ot(128|63&i)}}this.Nt()}kt(e){let t=this.qt(e),r=yw(t);this.Qt(1+r),this.buffer[this.position++]=255&r;for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=255&t[i]}Kt(e){let t=this.qt(e),r=yw(t);this.Qt(1+r),this.buffer[this.position++]=~(255&r);for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=~(255&t[i])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){let t=function(s){let o=new DataView(new ArrayBuffer(8));return o.setFloat64(0,s,!1),new Uint8Array(o.buffer)}(e),r=(128&t[0])!=0;t[0]^=r?255:128;for(let i=1;i<t.length;++i)t[i]^=r?255:0;return t}Ft(e){let t=255&e;t===0?(this.Ut(0),this.Ut(255)):t===255?(this.Ut(255),this.Ut(0)):this.Ut(t)}Ot(e){let t=255&e;t===0?(this.Gt(0),this.Gt(255)):t===255?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(e){let t=e+this.position;if(t<=this.buffer.length)return;let r=2*this.buffer.length;r<t&&(r=t);let i=new Uint8Array(r);i.set(this.buffer),this.buffer=i}},Rf=class{constructor(e){this.jt=e}gt(e){this.jt.Ct(e)}Rt(e){this.jt.Lt(e)}At(e){this.jt.kt(e)}Et(){this.jt.$t()}},Pf=class{constructor(e){this.jt=e}gt(e){this.jt.xt(e)}Rt(e){this.jt.Bt(e)}At(e){this.jt.Kt(e)}Et(){this.jt.Wt()}},yr=class{constructor(){this.jt=new bf,this.Ht=new Rf(this.jt),this.Jt=new Pf(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return e===0?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}};var vr=class n{constructor(e,t,r,i){this.indexId=e,this.documentKey=t,this.arrayValue=r,this.directionalValue=i}Zt(){let e=this.directionalValue.length,t=e===0||this.directionalValue[e-1]===255?e+1:e,r=new Uint8Array(t);return r.set(this.directionalValue,0),t!==e?r.set([0],this.directionalValue.length):++r[r.length-1],new n(this.indexId,this.documentKey,this.arrayValue,r)}};function Vn(n,e){let t=n.indexId-e.indexId;return t!==0?t:(t=vw(n.arrayValue,e.arrayValue),t!==0?t:(t=vw(n.directionalValue,e.directionalValue),t!==0?t:U.comparator(n.documentKey,e.documentKey)))}function vw(n,e){for(let t=0;t<n.length&&t<e.length;++t){let r=n[t]-e[t];if(r!==0)return r}return n.length-e.length}var ou=class{constructor(e){this.Xt=new me((t,r)=>Re.comparator(t.field,r.field)),this.collectionId=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment(),this.en=e.orderBy,this.tn=[];for(let t of e.filters){let r=t;r.isInequality()?this.Xt=this.Xt.add(r):this.tn.push(r)}}get nn(){return this.Xt.size>1}rn(e){if(G(e.collectionGroup===this.collectionId),this.nn)return!1;let t=Hd(e);if(t!==void 0&&!this.sn(t))return!1;let r=pr(e),i=new Set,s=0,o=0;for(;s<r.length&&this.sn(r[s]);++s)i=i.add(r[s].fieldPath.canonicalString());if(s===r.length)return!0;if(this.Xt.size>0){let a=this.Xt.getIterator().getNext();if(!i.has(a.field.canonicalString())){let u=r[s];if(!this.on(a,u)||!this._n(this.en[o++],u))return!1}++s}for(;s<r.length;++s){let a=r[s];if(o>=this.en.length||!this._n(this.en[o++],a))return!1}return!0}an(){if(this.nn)return null;let e=new me(Re.comparator),t=[];for(let r of this.tn)if(!r.field.isKeyField())if(r.op==="array-contains"||r.op==="array-contains-any")t.push(new Pi(r.field,2));else{if(e.has(r.field))continue;e=e.add(r.field),t.push(new Pi(r.field,0))}for(let r of this.en)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new Pi(r.field,r.dir==="asc"?0:1)));return new ki(ki.UNKNOWN_ID,this.collectionId,t,No.empty())}sn(e){for(let t of this.tn)if(this.on(t,e))return!0;return!1}on(e,t){if(e===void 0||!e.field.isEqual(t.fieldPath))return!1;let r=e.op==="array-contains"||e.op==="array-contains-any";return t.kind===2===r}_n(e,t){return!!e.field.isEqual(t.fieldPath)&&(t.kind===0&&e.dir==="asc"||t.kind===1&&e.dir==="desc")}};function jE(n){var e,t;if(G(n instanceof re||n instanceof ce),n instanceof re){if(n instanceof Yl){let i=((t=(e=n.value.arrayValue)===null||e===void 0?void 0:e.values)===null||t===void 0?void 0:t.map(s=>re.create(n.field,"==",s)))||[];return ce.create(i,"or")}return n}let r=n.filters.map(i=>jE(i));return ce.create(r,n.op)}function eb(n){if(n.getFilters().length===0)return[];let e=Df(jE(n));return G(GE(e)),xf(e)||Nf(e)?[e]:e.getFilters()}function xf(n){return n instanceof re}function Nf(n){return n instanceof ce&&$m(n)}function GE(n){return xf(n)||Nf(n)||function(t){if(t instanceof ce&&rf(t)){for(let r of t.getFilters())if(!xf(r)&&!Nf(r))return!1;return!0}return!1}(n)}function Df(n){if(G(n instanceof re||n instanceof ce),n instanceof re)return n;if(n.filters.length===1)return Df(n.filters[0]);let e=n.filters.map(r=>Df(r)),t=ce.create(e,n.op);return t=au(t),GE(t)?t:(G(t instanceof ce),G(Oi(t)),G(t.filters.length>1),t.filters.reduce((r,i)=>ep(r,i)))}function ep(n,e){let t;return G(n instanceof re||n instanceof ce),G(e instanceof re||e instanceof ce),t=n instanceof re?e instanceof re?function(i,s){return ce.create([i,s],"and")}(n,e):ww(n,e):e instanceof re?ww(e,n):function(i,s){if(G(i.filters.length>0&&s.filters.length>0),Oi(i)&&Oi(s))return lE(i,s.getFilters());let o=rf(i)?i:s,a=rf(i)?s:i,u=o.filters.map(c=>ep(c,a));return ce.create(u,"or")}(n,e),au(t)}function ww(n,e){if(Oi(e))return lE(e,n.getFilters());{let t=e.filters.map(r=>ep(n,r));return ce.create(t,"or")}}function au(n){if(G(n instanceof re||n instanceof ce),n instanceof re)return n;let e=n.getFilters();if(e.length===1)return au(e[0]);if(oE(n))return n;let t=e.map(i=>au(i)),r=[];return t.forEach(i=>{i instanceof re?r.push(i):i instanceof ce&&(i.op===n.op?r.push(...i.filters):r.push(i))}),r.length===1?r[0]:ce.create(r,n.op)}var kf=class{constructor(){this.un=new Ko}addToCollectionParentIndex(e,t){return this.un.add(t),b.resolve()}getCollectionParents(e,t){return b.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return b.resolve()}deleteFieldIndex(e,t){return b.resolve()}deleteAllFieldIndexes(e){return b.resolve()}createTargetIndexes(e,t){return b.resolve()}getDocumentsMatchingTarget(e,t){return b.resolve(null)}getIndexType(e,t){return b.resolve(0)}getFieldIndexes(e,t){return b.resolve([])}getNextCollectionGroupToUpdate(e){return b.resolve(null)}getMinOffset(e,t){return b.resolve(At.min())}getMinOffsetFromCollectionGroup(e,t){return b.resolve(At.min())}updateCollectionGroup(e,t,r){return b.resolve()}updateIndexEntries(e,t){return b.resolve()}},Ko=class{constructor(){this.index={}}add(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t]||new me(se.comparator),s=!i.has(r);return this.index[t]=i.add(r),s}has(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t];return i&&i.has(r)}getEntries(e){return(this.index[e]||new me(se.comparator)).toArray()}};var Dl=new Uint8Array(0),Vf=class{constructor(e,t){this.databaseId=t,this.cn=new Ko,this.ln=new Jt(r=>Ar(r),(r,i)=>ta(r,i)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.cn.has(t)){let r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener(()=>{this.cn.add(t)});let s={collectionId:r,parent:it(i)};return Ew(e).put(s)}return b.resolve()}getCollectionParents(e,t){let r=[],i=IDBKeyRange.bound([t,""],[zw(t),""],!1,!0);return Ew(e).U(i).next(s=>{for(let o of s){if(o.collectionId!==t)break;r.push(Kt(o.parent))}return r})}addFieldIndex(e,t){let r=Eo(e),i=function(a){return{indexId:a.indexId,collectionGroup:a.collectionGroup,fields:a.fields.map(u=>[u.fieldPath.canonicalString(),u.kind])}}(t);delete i.indexId;let s=r.add(i);if(t.indexState){let o=Ei(e);return s.next(a=>{o.put(pw(a,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){let r=Eo(e),i=Ei(e),s=wi(e);return r.delete(t.indexId).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=Eo(e),r=wi(e),i=Ei(e);return t.j().next(()=>r.j()).next(()=>i.j())}createTargetIndexes(e,t){return b.forEach(this.hn(t),r=>this.getIndexType(e,r).next(i=>{if(i===0||i===1){let s=new ou(r).an();if(s!=null)return this.addFieldIndex(e,s)}}))}getDocumentsMatchingTarget(e,t){let r=wi(e),i=!0,s=new Map;return b.forEach(this.hn(t),o=>this.Pn(e,o).next(a=>{i&&(i=!!a),s.set(o,a)})).next(()=>{if(i){let o=X(),a=[];return b.forEach(s,(u,c)=>{V("IndexedDbIndexManager",`Using index ${function(F){return`id=${F.indexId}|cg=${F.collectionGroup}|f=${F.fields.map(W=>`${W.fieldPath}:${W.kind}`).join(",")}`}(u)} to execute ${Ar(t)}`);let d=function(F,W){let H=Hd(W);if(H===void 0)return null;for(let Y of Xl(F,H.fieldPath))switch(Y.op){case"array-contains-any":return Y.value.arrayValue.values||[];case"array-contains":return[Y.value]}return null}(c,u),m=function(F,W){let H=new Map;for(let Y of pr(W))for(let E of Xl(F,Y.fieldPath))switch(E.op){case"==":case"in":H.set(Y.fieldPath.canonicalString(),E.value);break;case"not-in":case"!=":return H.set(Y.fieldPath.canonicalString(),E.value),Array.from(H.values())}return null}(c,u),p=function(F,W){let H=[],Y=!0;for(let E of pr(W)){let _=E.kind===0?ew(F,E.fieldPath,F.startAt):tw(F,E.fieldPath,F.startAt);H.push(_.value),Y&&(Y=_.inclusive)}return new Yt(H,Y)}(c,u),y=function(F,W){let H=[],Y=!0;for(let E of pr(W)){let _=E.kind===0?tw(F,E.fieldPath,F.endAt):ew(F,E.fieldPath,F.endAt);H.push(_.value),Y&&(Y=_.inclusive)}return new Yt(H,Y)}(c,u),A=this.In(u,c,p),x=this.In(u,c,y),N=this.Tn(u,c,m),q=this.En(u.indexId,d,A,p.inclusive,x,y.inclusive,N);return b.forEach(q,j=>r.G(j,t.limit).next(F=>{F.forEach(W=>{let H=U.fromSegments(W.documentKey);o.has(H)||(o=o.add(H),a.push(H))})}))}).next(()=>a)}return b.resolve(null)})}hn(e){let t=this.ln.get(e);return t||(e.filters.length===0?t=[e]:t=eb(ce.create(e.filters,"and")).map(r=>ff(e.path,e.collectionGroup,e.orderBy,r.getFilters(),e.limit,e.startAt,e.endAt)),this.ln.set(e,t),t)}En(e,t,r,i,s,o,a){let u=(t!=null?t.length:1)*Math.max(r.length,s.length),c=u/(t!=null?t.length:1),d=[];for(let m=0;m<u;++m){let p=t?this.dn(t[m/c]):Dl,y=this.An(e,p,r[m%c],i),A=this.Rn(e,p,s[m%c],o),x=a.map(N=>this.An(e,p,N,!0));d.push(...this.createRange(y,A,x))}return d}An(e,t,r,i){let s=new vr(e,U.empty(),t,r);return i?s:s.Zt()}Rn(e,t,r,i){let s=new vr(e,U.empty(),t,r);return i?s.Zt():s}Pn(e,t){let r=new ou(t),i=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,i).next(s=>{let o=null;for(let a of s)r.rn(a)&&(!o||a.fields.length>o.fields.length)&&(o=a);return o})}getIndexType(e,t){let r=2,i=this.hn(t);return b.forEach(i,s=>this.Pn(e,s).next(o=>{o?r!==0&&o.fields.length<function(u){let c=new me(Re.comparator),d=!1;for(let m of u.filters)for(let p of m.getFlattenedFilters())p.field.isKeyField()||(p.op==="array-contains"||p.op==="array-contains-any"?d=!0:c=c.add(p.field));for(let m of u.orderBy)m.field.isKeyField()||(c=c.add(m.field));return c.size+(d?1:0)}(s)&&(r=1):r=0})).next(()=>function(o){return o.limit!==null}(t)&&i.length>1&&r===2?1:r)}Vn(e,t){let r=new yr;for(let i of pr(e)){let s=t.data.field(i.fieldPath);if(s==null)return null;let o=r.Yt(i.kind);un.vt.It(s,o)}return r.zt()}dn(e){let t=new yr;return un.vt.It(e,t.Yt(0)),t.zt()}mn(e,t){let r=new yr;return un.vt.It(Tr(this.databaseId,t),r.Yt(function(s){let o=pr(s);return o.length===0?0:o[o.length-1].kind}(e))),r.zt()}Tn(e,t,r){if(r===null)return[];let i=[];i.push(new yr);let s=0;for(let o of pr(e)){let a=r[s++];for(let u of i)if(this.fn(t,o.fieldPath)&&Fo(a))i=this.gn(i,o,a);else{let c=u.Yt(o.kind);un.vt.It(a,c)}}return this.pn(i)}In(e,t,r){return this.Tn(e,t,r.position)}pn(e){let t=[];for(let r=0;r<e.length;++r)t[r]=e[r].zt();return t}gn(e,t,r){let i=[...e],s=[];for(let o of r.arrayValue.values||[])for(let a of i){let u=new yr;u.seed(a.zt()),un.vt.It(o,u.Yt(t.kind)),s.push(u)}return s}fn(e,t){return!!e.filters.find(r=>r instanceof re&&r.field.isEqual(t)&&(r.op==="in"||r.op==="not-in"))}getFieldIndexes(e,t){let r=Eo(e),i=Ei(e);return(t?r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):r.U()).next(s=>{let o=[];return b.forEach(s,a=>i.get([a.indexId,this.uid]).next(u=>{o.push(function(d,m){let p=m?new No(m.sequenceNumber,new At(Rr(m.readTime),new U(Kt(m.documentKey)),m.largestBatchId)):No.empty(),y=d.fields.map(([A,x])=>new Pi(Re.fromServerFormat(A),x));return new ki(d.indexId,d.collectionGroup,y,p)}(a,u))})).next(()=>o)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(t=>t.length===0?null:(t.sort((r,i)=>{let s=r.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:$(r.collectionGroup,i.collectionGroup)}),t[0].collectionGroup))}updateCollectionGroup(e,t,r){let i=Eo(e),s=Ei(e);return this.yn(e).next(o=>i.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(a=>b.forEach(a,u=>s.put(pw(u.indexId,this.uid,o,r)))))}updateIndexEntries(e,t){let r=new Map;return b.forEach(t,(i,s)=>{let o=r.get(i.collectionGroup);return(o?b.resolve(o):this.getFieldIndexes(e,i.collectionGroup)).next(a=>(r.set(i.collectionGroup,a),b.forEach(a,u=>this.wn(e,i,u).next(c=>{let d=this.Sn(s,u);return c.isEqual(d)?b.resolve():this.bn(e,s,u,c,d)}))))})}Dn(e,t,r,i){return wi(e).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.mn(r,t.key),documentKey:t.key.path.toArray()})}vn(e,t,r,i){return wi(e).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.mn(r,t.key),t.key.path.toArray()])}wn(e,t,r){let i=wi(e),s=new me(Vn);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.mn(r,t)])},(o,a)=>{s=s.add(new vr(r.indexId,t,a.arrayValue,a.directionalValue))}).next(()=>s)}Sn(e,t){let r=new me(Vn),i=this.Vn(t,e);if(i==null)return r;let s=Hd(t);if(s!=null){let o=e.data.field(s.fieldPath);if(Fo(o))for(let a of o.arrayValue.values||[])r=r.add(new vr(t.indexId,e.key,this.dn(a),i))}else r=r.add(new vr(t.indexId,e.key,Dl,i));return r}bn(e,t,r,i,s){V("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);let o=[];return function(u,c,d,m,p){let y=u.getIterator(),A=c.getIterator(),x=vi(y),N=vi(A);for(;x||N;){let q=!1,j=!1;if(x&&N){let F=d(x,N);F<0?j=!0:F>0&&(q=!0)}else x!=null?j=!0:q=!0;q?(m(N),N=vi(A)):j?(p(x),x=vi(y)):(x=vi(y),N=vi(A))}}(i,s,Vn,a=>{o.push(this.Dn(e,t,r,a))},a=>{o.push(this.vn(e,t,r,a))}),b.waitFor(o)}yn(e){let t=1;return Ei(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(r,i,s)=>{s.done(),t=i.sequenceNumber+1}).next(()=>t)}createRange(e,t,r){r=r.sort((o,a)=>Vn(o,a)).filter((o,a,u)=>!a||Vn(o,u[a-1])!==0);let i=[];i.push(e);for(let o of r){let a=Vn(o,e),u=Vn(o,t);if(a===0)i[0]=e.Zt();else if(a>0&&u<0)i.push(o),i.push(o.Zt());else if(u>0)break}i.push(t);let s=[];for(let o=0;o<i.length;o+=2){if(this.Cn(i[o],i[o+1]))return[];let a=[i[o].indexId,this.uid,i[o].arrayValue,i[o].directionalValue,Dl,[]],u=[i[o+1].indexId,this.uid,i[o+1].arrayValue,i[o+1].directionalValue,Dl,[]];s.push(IDBKeyRange.bound(a,u))}return s}Cn(e,t){return Vn(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Iw)}getMinOffset(e,t){return b.mapArray(this.hn(t),r=>this.Pn(e,r).next(i=>i||B())).next(Iw)}};function Ew(n){return Le(n,"collectionParents")}function wi(n){return Le(n,"indexEntries")}function Eo(n){return Le(n,"indexConfiguration")}function Ei(n){return Le(n,"indexState")}function Iw(n){G(n.length!==0);let e=n[0].indexState.offset,t=e.largestBatchId;for(let r=1;r<n.length;r++){let i=n[r].indexState.offset;Km(i,e)<0&&(e=i),t<i.largestBatchId&&(t=i.largestBatchId)}return new At(e.readTime,e.documentKey,t)}var Tw={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Tt=class n{constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}static withCacheSize(e){return new n(e,n.DEFAULT_COLLECTION_PERCENTILE,n.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function KE(n,e,t){let r=n.store("mutations"),i=n.store("documentMutations"),s=[],o=IDBKeyRange.only(t.batchId),a=0,u=r.J({range:o},(d,m,p)=>(a++,p.delete()));s.push(u.next(()=>{G(a===1)}));let c=[];for(let d of t.mutations){let m=Jw(e,d.key.path,t.batchId);s.push(i.delete(m)),c.push(d.key)}return b.waitFor(s).next(()=>c)}function lu(n){if(!n)return 0;let e;if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw B();e=n.noDocument}return JSON.stringify(e).length}Tt.DEFAULT_COLLECTION_PERCENTILE=10,Tt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Tt.DEFAULT=new Tt(41943040,Tt.DEFAULT_COLLECTION_PERCENTILE,Tt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Tt.DISABLED=new Tt(-1,0,0);var uu=class n{constructor(e,t,r,i){this.userId=e,this.serializer=t,this.indexManager=r,this.referenceDelegate=i,this.Fn={}}static lt(e,t,r,i){G(e.uid!=="");let s=e.isAuthenticated()?e.uid:"";return new n(s,t,r,i)}checkEmpty(e){let t=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return On(e).J({index:"userMutationsIndex",range:r},(i,s,o)=>{t=!1,o.done()}).next(()=>t)}addMutationBatch(e,t,r,i){let s=bi(e),o=On(e);return o.add({}).next(a=>{G(typeof a=="number");let u=new Lo(a,t,r,i),c=function(y,A,x){let N=x.baseMutations.map(j=>Go(y.ct,j)),q=x.mutations.map(j=>Go(y.ct,j));return{userId:A,batchId:x.batchId,localWriteTimeMs:x.localWriteTime.toMillis(),baseMutations:N,mutations:q}}(this.serializer,this.userId,u),d=[],m=new me((p,y)=>$(p.canonicalString(),y.canonicalString()));for(let p of i){let y=Jw(this.userId,p.key.path,a);m=m.add(p.key.path.popLast()),d.push(o.put(c)),d.push(s.put(y,oC))}return m.forEach(p=>{d.push(this.indexManager.addToCollectionParentIndex(e,p))}),e.addOnCommittedListener(()=>{this.Fn[a]=u.keys()}),b.waitFor(d).next(()=>u)})}lookupMutationBatch(e,t){return On(e).get(t).next(r=>r?(G(r.userId===this.userId),_r(this.serializer,r)):null)}Mn(e,t){return this.Fn[t]?b.resolve(this.Fn[t]):this.lookupMutationBatch(e,t).next(r=>{if(r){let i=r.keys();return this.Fn[t]=i,i}return null})}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=IDBKeyRange.lowerBound([this.userId,r]),s=null;return On(e).J({index:"userMutationsIndex",range:i},(o,a,u)=>{a.userId===this.userId&&(G(a.batchId>=r),s=_r(this.serializer,a)),u.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return On(e).J({index:"userMutationsIndex",range:t,reverse:!0},(i,s,o)=>{r=s.batchId,o.done()}).next(()=>r)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return On(e).U("userMutationsIndex",t).next(r=>r.map(i=>_r(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(e,t){let r=Fl(this.userId,t.path),i=IDBKeyRange.lowerBound(r),s=[];return bi(e).J({range:i},(o,a,u)=>{let[c,d,m]=o,p=Kt(d);if(c===this.userId&&t.path.isEqual(p))return On(e).get(m).next(y=>{if(!y)throw B();G(y.userId===this.userId),s.push(_r(this.serializer,y))});u.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new me($),i=[];return t.forEach(s=>{let o=Fl(this.userId,s.path),a=IDBKeyRange.lowerBound(o),u=bi(e).J({range:a},(c,d,m)=>{let[p,y,A]=c,x=Kt(y);p===this.userId&&s.path.isEqual(x)?r=r.add(A):m.done()});i.push(u)}),b.waitFor(i).next(()=>this.xn(e,r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=Fl(this.userId,r),o=IDBKeyRange.lowerBound(s),a=new me($);return bi(e).J({range:o},(u,c,d)=>{let[m,p,y]=u,A=Kt(p);m===this.userId&&r.isPrefixOf(A)?A.length===i&&(a=a.add(y)):d.done()}).next(()=>this.xn(e,a))}xn(e,t){let r=[],i=[];return t.forEach(s=>{i.push(On(e).get(s).next(o=>{if(o===null)throw B();G(o.userId===this.userId),r.push(_r(this.serializer,o))}))}),b.waitFor(i).next(()=>r)}removeMutationBatch(e,t){return KE(e._e,this.userId,t).next(r=>(e.addOnCommittedListener(()=>{this.On(t.batchId)}),b.forEach(r,i=>this.referenceDelegate.markPotentiallyOrphaned(e,i))))}On(e){delete this.Fn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return b.resolve();let r=IDBKeyRange.lowerBound(function(o){return[o]}(this.userId)),i=[];return bi(e).J({range:r},(s,o,a)=>{if(s[0]===this.userId){let u=Kt(s[1]);i.push(u)}else a.done()}).next(()=>{G(i.length===0)})})}containsKey(e,t){return zE(e,this.userId,t)}Nn(e){return WE(e).get(this.userId).next(t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function zE(n,e,t){let r=Fl(e,t.path),i=r[1],s=IDBKeyRange.lowerBound(r),o=!1;return bi(n).J({range:s,H:!0},(a,u,c)=>{let[d,m,p]=a;d===e&&m===i&&(o=!0),c.done()}).next(()=>o)}function On(n){return Le(n,"mutations")}function bi(n){return Le(n,"documentMutations")}function WE(n){return Le(n,"mutationQueues")}var Bi=class n{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new n(0)}static kn(){return new n(-1)}};var Of=class{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.qn(e).next(t=>{let r=new Bi(t.highestTargetId);return t.highestTargetId=r.next(),this.Qn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.qn(e).next(t=>z.fromTimestamp(new Te(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.qn(e).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,t,r){return this.qn(e).next(i=>(i.highestListenSequenceNumber=t,r&&(i.lastRemoteSnapshotVersion=r.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),this.Qn(e,i)))}addTargetData(e,t){return this.Kn(e,t).next(()=>this.qn(e).next(r=>(r.targetCount+=1,this.$n(t,r),this.Qn(e,r))))}updateTargetData(e,t){return this.Kn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>Ii(e).delete(t.targetId)).next(()=>this.qn(e)).next(r=>(G(r.targetCount>0),r.targetCount-=1,this.Qn(e,r)))}removeTargets(e,t,r){let i=0,s=[];return Ii(e).J((o,a)=>{let u=Ao(a);u.sequenceNumber<=t&&r.get(u.targetId)===null&&(i++,s.push(this.removeTargetData(e,u)))}).next(()=>b.waitFor(s)).next(()=>i)}forEachTarget(e,t){return Ii(e).J((r,i)=>{let s=Ao(i);t(s)})}qn(e){return Sw(e).get("targetGlobalKey").next(t=>(G(t!==null),t))}Qn(e,t){return Sw(e).put("targetGlobalKey",t)}Kn(e,t){return Ii(e).put(qE(this.serializer,t))}$n(e,t){let r=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,r=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,r=!0),r}getTargetCount(e){return this.qn(e).next(t=>t.targetCount)}getTargetData(e,t){let r=Ar(t),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),s=null;return Ii(e).J({range:i,index:"queryTargetsIndex"},(o,a,u)=>{let c=Ao(a);ta(t,c.target)&&(s=c,u.done())}).next(()=>s)}addMatchingKeys(e,t,r){let i=[],s=Fn(e);return t.forEach(o=>{let a=it(o.path);i.push(s.put({targetId:r,path:a})),i.push(this.referenceDelegate.addReference(e,r,o))}),b.waitFor(i)}removeMatchingKeys(e,t,r){let i=Fn(e);return b.forEach(t,s=>{let o=it(s.path);return b.waitFor([i.delete([r,o]),this.referenceDelegate.removeReference(e,r,s)])})}removeMatchingKeysForTargetId(e,t){let r=Fn(e),i=IDBKeyRange.bound([t],[t+1],!1,!0);return r.delete(i)}getMatchingKeysForTargetId(e,t){let r=IDBKeyRange.bound([t],[t+1],!1,!0),i=Fn(e),s=X();return i.J({range:r,H:!0},(o,a,u)=>{let c=Kt(o[1]),d=new U(c);s=s.add(d)}).next(()=>s)}containsKey(e,t){let r=it(t.path),i=IDBKeyRange.bound([r],[zw(r)],!1,!0),s=0;return Fn(e).J({index:"documentTargetsIndex",H:!0,range:i},([o,a],u,c)=>{o!==0&&(s++,c.done())}).next(()=>s>0)}ot(e,t){return Ii(e).get(t).next(r=>r?Ao(r):null)}};function Ii(n){return Le(n,"targets")}function Sw(n){return Le(n,"targetGlobal")}function Fn(n){return Le(n,"targetDocuments")}function Aw([n,e],[t,r]){let i=$(n,t);return i===0?$(e,r):i}var Ff=class{constructor(e){this.Un=e,this.buffer=new me(Aw),this.Wn=0}Gn(){return++this.Wn}zn(e){let t=[e,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(t);else{let r=this.buffer.last();Aw(t,r)<0&&(this.buffer=this.buffer.delete(r).add(t))}}get maxValue(){return this.buffer.last()[0]}},Mf=class{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.jn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return this.jn!==null}Hn(e){V("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,()=>D(this,null,function*(){this.jn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(t){Jn(t)?V("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):yield Yn(t)}yield this.Hn(3e5)}))}},Lf=class{constructor(e,t){this.Jn=e,this.params=t}calculateTargetCount(e,t){return this.Jn.Yn(e).next(r=>Math.floor(t/100*r))}nthSequenceNumber(e,t){if(t===0)return b.resolve(pt.oe);let r=new Ff(t);return this.Jn.forEachTarget(e,i=>r.zn(i.sequenceNumber)).next(()=>this.Jn.Zn(e,i=>r.zn(i))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.Jn.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.Jn.removeOrphanedDocuments(e,t)}collect(e,t){return this.params.cacheSizeCollectionThreshold===-1?(V("LruGarbageCollector","Garbage collection skipped; disabled"),b.resolve(Tw)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(V("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Tw):this.Xn(e,t))}getCacheSize(e){return this.Jn.getCacheSize(e)}Xn(e,t){let r,i,s,o,a,u,c,d=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(m=>(m>this.params.maximumSequenceNumbersToCollect?(V("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${m}`),i=this.params.maximumSequenceNumbersToCollect):i=m,o=Date.now(),this.nthSequenceNumber(e,i))).next(m=>(r=m,a=Date.now(),this.removeTargets(e,r,t))).next(m=>(s=m,u=Date.now(),this.removeOrphanedDocuments(e,r))).next(m=>(c=Date.now(),Ti()<=vt.DEBUG&&V("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-d}ms
	Determined least recently used ${i} in `+(a-o)+`ms
	Removed ${s} targets in `+(u-a)+`ms
	Removed ${m} documents in `+(c-u)+`ms
Total Duration: ${c-d}ms`),b.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:m})))}};function tb(n,e){return new Lf(n,e)}var Uf=class{constructor(e,t){this.db=e,this.garbageCollector=tb(this,t)}Yn(e){let t=this.er(e);return this.db.getTargetCache().getTargetCount(e).next(r=>t.next(i=>r+i))}er(e){let t=0;return this.Zn(e,r=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Zn(e,t){return this.tr(e,(r,i)=>t(i))}addReference(e,t,r){return kl(e,r)}removeReference(e,t,r){return kl(e,r)}removeTargets(e,t,r){return this.db.getTargetCache().removeTargets(e,t,r)}markPotentiallyOrphaned(e,t){return kl(e,t)}nr(e,t){return function(i,s){let o=!1;return WE(i).Y(a=>zE(i,a,s).next(u=>(u&&(o=!0),b.resolve(!u)))).next(()=>o)}(e,t)}removeOrphanedDocuments(e,t){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.tr(e,(o,a)=>{if(a<=t){let u=this.nr(e,o).next(c=>{if(!c)return s++,r.getEntry(e,o).next(()=>(r.removeEntry(o,z.min()),Fn(e).delete(function(m){return[0,it(m.path)]}(o))))});i.push(u)}}).next(()=>b.waitFor(i)).next(()=>r.apply(e)).next(()=>s)}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,r)}updateLimboDocument(e,t){return kl(e,t)}tr(e,t){let r=Fn(e),i,s=pt.oe;return r.J({index:"documentTargetsIndex"},([o,a],{path:u,sequenceNumber:c})=>{o===0?(s!==pt.oe&&t(new U(Kt(i)),s),s=c,i=u):s=pt.oe}).next(()=>{s!==pt.oe&&t(new U(Kt(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}};function kl(n,e){return Fn(n).put(function(r,i){return{targetId:0,path:it(r.path),sequenceNumber:i}}(e,n.currentSequenceNumber))}var cu=class{constructor(){this.changes=new Jt(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Fe.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let r=this.changes.get(t);return r!==void 0?b.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}};var Bf=class{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,r){return mr(e).put(r)}removeEntry(e,t,r){return mr(e).delete(function(s,o){let a=s.path.toArray();return[a.slice(0,a.length-2),a[a.length-2],iu(o),a[a.length-1]]}(t,r))}updateMetadata(e,t){return this.getMetadata(e).next(r=>(r.byteSize+=t,this.rr(e,r)))}getEntry(e,t){let r=Fe.newInvalidDocument(t);return mr(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Io(t))},(i,s)=>{r=this.ir(t,s)}).next(()=>r)}sr(e,t){let r={size:0,document:Fe.newInvalidDocument(t)};return mr(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Io(t))},(i,s)=>{r={document:this.ir(t,s),size:lu(s)}}).next(()=>r)}getEntries(e,t){let r=lt();return this._r(e,t,(i,s)=>{let o=this.ir(i,s);r=r.insert(i,o)}).next(()=>r)}ar(e,t){let r=lt(),i=new ye(U.comparator);return this._r(e,t,(s,o)=>{let a=this.ir(s,o);r=r.insert(s,a),i=i.insert(s,lu(o))}).next(()=>({documents:r,ur:i}))}_r(e,t,r){if(t.isEmpty())return b.resolve();let i=new me(Rw);t.forEach(u=>i=i.add(u));let s=IDBKeyRange.bound(Io(i.first()),Io(i.last())),o=i.getIterator(),a=o.getNext();return mr(e).J({index:"documentKeyIndex",range:s},(u,c,d)=>{let m=U.fromSegments([...c.prefixPath,c.collectionGroup,c.documentId]);for(;a&&Rw(a,m)<0;)r(a,null),a=o.getNext();a&&a.isEqual(m)&&(r(a,c),a=o.hasNext()?o.getNext():null),a?d.$(Io(a)):d.done()}).next(()=>{for(;a;)r(a,null),a=o.hasNext()?o.getNext():null})}getDocumentsMatchingQuery(e,t,r,i,s){let o=t.path,a=[o.popLast().toArray(),o.lastSegment(),iu(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],u=[o.popLast().toArray(),o.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return mr(e).U(IDBKeyRange.bound(a,u,!0)).next(c=>{s?.incrementDocumentReadCount(c.length);let d=lt();for(let m of c){let p=this.ir(U.fromSegments(m.prefixPath.concat(m.collectionGroup,m.documentId)),m);p.isFoundDocument()&&(ra(t,p)||i.has(p.key))&&(d=d.insert(p.key,p))}return d})}getAllFromCollectionGroup(e,t,r,i){let s=lt(),o=bw(t,r),a=bw(t,At.max());return mr(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(o,a,!0)},(u,c,d)=>{let m=this.ir(U.fromSegments(c.prefixPath.concat(c.collectionGroup,c.documentId)),c);s=s.insert(m.key,m),s.size===i&&d.done()}).next(()=>s)}newChangeBuffer(e){return new qf(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(t=>t.byteSize)}getMetadata(e){return Cw(e).get("remoteDocumentGlobalKey").next(t=>(G(!!t),t))}rr(e,t){return Cw(e).put("remoteDocumentGlobalKey",t)}ir(e,t){if(t){let r=XC(this.serializer,t);if(!(r.isNoDocument()&&r.version.isEqual(z.min())))return r}return Fe.newInvalidDocument(e)}};function QE(n){return new Bf(n)}var qf=class extends cu{constructor(e,t){super(),this.cr=e,this.trackRemovals=t,this.lr=new Jt(r=>r.toString(),(r,i)=>r.isEqual(i))}applyChanges(e){let t=[],r=0,i=new me((s,o)=>$(s.canonicalString(),o.canonicalString()));return this.changes.forEach((s,o)=>{let a=this.lr.get(s);if(t.push(this.cr.removeEntry(e,s,a.readTime)),o.isValidDocument()){let u=fw(this.cr.serializer,o);i=i.add(s.path.popLast());let c=lu(u);r+=c-a.size,t.push(this.cr.addEntry(e,s,u))}else if(r-=a.size,this.trackRemovals){let u=fw(this.cr.serializer,o.convertToNoDocument(z.min()));t.push(this.cr.addEntry(e,s,u))}}),i.forEach(s=>{t.push(this.cr.indexManager.addToCollectionParentIndex(e,s))}),t.push(this.cr.updateMetadata(e,r)),b.waitFor(t)}getFromCache(e,t){return this.cr.sr(e,t).next(r=>(this.lr.set(t,{size:r.size,readTime:r.document.readTime}),r.document))}getAllFromCache(e,t){return this.cr.ar(e,t).next(({documents:r,ur:i})=>(i.forEach((s,o)=>{this.lr.set(s,{size:o,readTime:r.get(s).readTime})}),r))}};function Cw(n){return Le(n,"remoteDocumentGlobal")}function mr(n){return Le(n,"remoteDocumentsV14")}function Io(n){let e=n.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function bw(n,e){let t=e.documentKey.path.toArray();return[n,iu(e.readTime),t.slice(0,t.length-2),t.length>0?t[t.length-1]:""]}function Rw(n,e){let t=n.path.toArray(),r=e.path.toArray(),i=0;for(let s=0;s<t.length-2&&s<r.length-2;++s)if(i=$(t[s],r[s]),i)return i;return i=$(t.length,r.length),i||(i=$(t[t.length-2],r[r.length-2]),i||$(t[t.length-1],r[r.length-1]))}var jf=class{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}};var hu=class{constructor(e,t,r,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=i}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(i=>(r=i,this.remoteDocumentCache.getEntry(e,t))).next(i=>(r!==null&&Ro(r.mutation,i,gt.empty(),Te.now()),i))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.getLocalViewOfDocuments(e,r,X()).next(()=>r))}getLocalViewOfDocuments(e,t,r=X()){let i=zt();return this.populateOverlays(e,i,t).next(()=>this.computeViews(e,t,i,r).next(s=>{let o=So();return s.forEach((a,u)=>{o=o.insert(a,u.overlayedDocument)}),o}))}getOverlayedDocuments(e,t){let r=zt();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,X()))}populateOverlays(e,t,r){let i=[];return r.forEach(s=>{t.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(e,i).next(s=>{s.forEach((o,a)=>{t.set(o,a)})})}computeViews(e,t,r,i){let s=lt(),o=bo(),a=function(){return bo()}();return t.forEach((u,c)=>{let d=r.get(c.key);i.has(c.key)&&(d===void 0||d.mutation instanceof Nt)?s=s.insert(c.key,c):d!==void 0?(o.set(c.key,d.mutation.getFieldMask()),Ro(d.mutation,c,d.mutation.getFieldMask(),Te.now())):o.set(c.key,gt.empty())}),this.recalculateAndSaveOverlays(e,s).next(u=>(u.forEach((c,d)=>o.set(c,d)),t.forEach((c,d)=>{var m;return a.set(c,new jf(d,(m=o.get(c))!==null&&m!==void 0?m:null))}),a))}recalculateAndSaveOverlays(e,t){let r=bo(),i=new ye((o,a)=>o-a),s=X();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(o=>{for(let a of o)a.keys().forEach(u=>{let c=t.get(u);if(c===null)return;let d=r.get(u)||gt.empty();d=a.applyToLocalView(c,d),r.set(u,d);let m=(i.get(a.batchId)||X()).add(u);i=i.insert(a.batchId,m)})}).next(()=>{let o=[],a=i.getReverseIterator();for(;a.hasNext();){let u=a.getNext(),c=u.key,d=u.value,m=_E();d.forEach(p=>{if(!s.has(p)){let y=SE(t.get(p),r.get(p));y!==null&&m.set(p,y),s=s.add(p)}}),o.push(this.documentOverlayCache.saveOverlays(e,c,m))}return b.waitFor(o)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.recalculateAndSaveOverlays(e,r))}getDocumentsMatchingQuery(e,t,r,i){return function(o){return U.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Hm(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,i):this.getDocumentsMatchingCollectionQuery(e,t,r,i)}getNextDocuments(e,t,r,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,i).next(s=>{let o=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,i-s.size):b.resolve(zt()),a=-1,u=s;return o.next(c=>b.forEach(c,(d,m)=>(a<m.largestBatchId&&(a=m.largestBatchId),s.get(d)?b.resolve():this.remoteDocumentCache.getEntry(e,d).next(p=>{u=u.insert(d,p)}))).next(()=>this.populateOverlays(e,c,s)).next(()=>this.computeViews(e,u,c,X())).next(d=>({batchId:a,changes:gE(d)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new U(t)).next(r=>{let i=So();return r.isFoundDocument()&&(i=i.insert(r.key,r)),i})}getDocumentsMatchingCollectionGroupQuery(e,t,r,i){let s=t.collectionGroup,o=So();return this.indexManager.getCollectionParents(e,s).next(a=>b.forEach(a,u=>{let c=function(m,p){return new xt(p,null,m.explicitOrderBy.slice(),m.filters.slice(),m.limit,m.limitType,m.startAt,m.endAt)}(t,u.child(s));return this.getDocumentsMatchingCollectionQuery(e,c,r,i).next(d=>{d.forEach((m,p)=>{o=o.insert(m,p)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(e,t,r,i){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(o=>(s=o,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,s,i))).next(o=>{s.forEach((u,c)=>{let d=c.getKey();o.get(d)===null&&(o=o.insert(d,Fe.newInvalidDocument(d)))});let a=So();return o.forEach((u,c)=>{let d=s.get(u);d!==void 0&&Ro(d.mutation,c,gt.empty(),Te.now()),ra(t,c)&&(a=a.insert(u,c))}),a})}};var Gf=class{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return b.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,function(i){return{id:i.id,version:i.version,createTime:Pe(i.createTime)}}(t)),b.resolve()}getNamedQuery(e,t){return b.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,function(i){return{name:i.name,query:Zm(i.bundledQuery),readTime:Pe(i.readTime)}}(t)),b.resolve()}};var Kf=class{constructor(){this.overlays=new ye(U.comparator),this.Ir=new Map}getOverlay(e,t){return b.resolve(this.overlays.get(t))}getOverlays(e,t){let r=zt();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((i,s)=>{this.ht(e,t,s)}),b.resolve()}removeOverlaysForBatchId(e,t,r){let i=this.Ir.get(r);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.Ir.delete(r)),b.resolve()}getOverlaysForCollection(e,t,r){let i=zt(),s=t.length+1,o=new U(t.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){let u=a.getNext().value,c=u.getKey();if(!t.isPrefixOf(c.path))break;c.path.length===s&&u.largestBatchId>r&&i.set(u.getKey(),u)}return b.resolve(i)}getOverlaysForCollectionGroup(e,t,r,i){let s=new ye((c,d)=>c-d),o=this.overlays.getIterator();for(;o.hasNext();){let c=o.getNext().value;if(c.getKey().getCollectionGroup()===t&&c.largestBatchId>r){let d=s.get(c.largestBatchId);d===null&&(d=zt(),s=s.insert(c.largestBatchId,d)),d.set(c.getKey(),c)}}let a=zt(),u=s.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach((c,d)=>a.set(c,d)),!(a.size()>=i)););return b.resolve(a)}ht(e,t,r){let i=this.overlays.get(r.key);if(i!==null){let o=this.Ir.get(i.largestBatchId).delete(r.key);this.Ir.set(i.largestBatchId,o)}this.overlays=this.overlays.insert(r.key,new Uo(t,r));let s=this.Ir.get(t);s===void 0&&(s=X(),this.Ir.set(t,s)),this.Ir.set(t,s.add(r.key))}};var zf=class{constructor(){this.sessionToken=xe.EMPTY_BYTE_STRING}getSessionToken(e){return b.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,b.resolve()}};var zo=class{constructor(){this.Tr=new me(ke.Er),this.dr=new me(ke.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){let r=new ke(e,t);this.Tr=this.Tr.add(r),this.dr=this.dr.add(r)}Rr(e,t){e.forEach(r=>this.addReference(r,t))}removeReference(e,t){this.Vr(new ke(e,t))}mr(e,t){e.forEach(r=>this.removeReference(r,t))}gr(e){let t=new U(new se([])),r=new ke(t,e),i=new ke(t,e+1),s=[];return this.dr.forEachInRange([r,i],o=>{this.Vr(o),s.push(o.key)}),s}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){let t=new U(new se([])),r=new ke(t,e),i=new ke(t,e+1),s=X();return this.dr.forEachInRange([r,i],o=>{s=s.add(o.key)}),s}containsKey(e){let t=new ke(e,0),r=this.Tr.firstAfterOrEqual(t);return r!==null&&e.isEqual(r.key)}},ke=class{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return U.comparator(e.key,t.key)||$(e.wr,t.wr)}static Ar(e,t){return $(e.wr,t.wr)||U.comparator(e.key,t.key)}};var Wf=class{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new me(ke.Er)}checkEmpty(e){return b.resolve(this.mutationQueue.length===0)}addMutationBatch(e,t,r,i){let s=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let o=new Lo(s,t,r,i);this.mutationQueue.push(o);for(let a of i)this.br=this.br.add(new ke(a.key,s)),this.indexManager.addToCollectionParentIndex(e,a.key.path.popLast());return b.resolve(o)}lookupMutationBatch(e,t){return b.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=this.vr(r),s=i<0?0:i;return b.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return b.resolve(this.mutationQueue.length===0?-1:this.Sr-1)}getAllMutationBatches(e){return b.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let r=new ke(t,0),i=new ke(t,Number.POSITIVE_INFINITY),s=[];return this.br.forEachInRange([r,i],o=>{let a=this.Dr(o.wr);s.push(a)}),b.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new me($);return t.forEach(i=>{let s=new ke(i,0),o=new ke(i,Number.POSITIVE_INFINITY);this.br.forEachInRange([s,o],a=>{r=r.add(a.wr)})}),b.resolve(this.Cr(r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=r;U.isDocumentKey(s)||(s=s.child(""));let o=new ke(new U(s),0),a=new me($);return this.br.forEachWhile(u=>{let c=u.key.path;return!!r.isPrefixOf(c)&&(c.length===i&&(a=a.add(u.wr)),!0)},o),b.resolve(this.Cr(a))}Cr(e){let t=[];return e.forEach(r=>{let i=this.Dr(r);i!==null&&t.push(i)}),t}removeMutationBatch(e,t){G(this.Fr(t.batchId,"removed")===0),this.mutationQueue.shift();let r=this.br;return b.forEach(t.mutations,i=>{let s=new ke(i.key,t.batchId);return r=r.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)}).next(()=>{this.br=r})}On(e){}containsKey(e,t){let r=new ke(t,0),i=this.br.firstAfterOrEqual(r);return b.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return this.mutationQueue.length,b.resolve()}Fr(e,t){return this.vr(e)}vr(e){return this.mutationQueue.length===0?0:e-this.mutationQueue[0].batchId}Dr(e){let t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}};var Qf=class{constructor(e){this.Mr=e,this.docs=function(){return new ye(U.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let r=t.key,i=this.docs.get(r),s=i?i.size:0,o=this.Mr(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:o}),this.size+=o-s,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let r=this.docs.get(t);return b.resolve(r?r.document.mutableCopy():Fe.newInvalidDocument(t))}getEntries(e,t){let r=lt();return t.forEach(i=>{let s=this.docs.get(i);r=r.insert(i,s?s.document.mutableCopy():Fe.newInvalidDocument(i))}),b.resolve(r)}getDocumentsMatchingQuery(e,t,r,i){let s=lt(),o=t.path,a=new U(o.child("")),u=this.docs.getIteratorFrom(a);for(;u.hasNext();){let{key:c,value:{document:d}}=u.getNext();if(!o.isPrefixOf(c.path))break;c.path.length>o.length+1||Km(Qw(d),r)<=0||(i.has(d.key)||ra(t,d))&&(s=s.insert(d.key,d.mutableCopy()))}return b.resolve(s)}getAllFromCollectionGroup(e,t,r,i){B()}Or(e,t){return b.forEach(this.docs,r=>t(r))}newChangeBuffer(e){return new $f(this)}getSize(e){return b.resolve(this.size)}},$f=class extends cu{constructor(e){super(),this.cr=e}applyChanges(e){let t=[];return this.changes.forEach((r,i)=>{i.isValidDocument()?t.push(this.cr.addEntry(e,i)):this.cr.removeEntry(r)}),b.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}};var Hf=class{constructor(e){this.persistence=e,this.Nr=new Jt(t=>Ar(t),ta),this.lastRemoteSnapshotVersion=z.min(),this.highestTargetId=0,this.Lr=0,this.Br=new zo,this.targetCount=0,this.kr=Bi.Bn()}forEachTarget(e,t){return this.Nr.forEach((r,i)=>t(i)),b.resolve()}getLastRemoteSnapshotVersion(e){return b.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return b.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),b.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.Lr&&(this.Lr=t),b.resolve()}Kn(e){this.Nr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.kr=new Bi(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,b.resolve()}updateTargetData(e,t){return this.Kn(t),b.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,b.resolve()}removeTargets(e,t,r){let i=0,s=[];return this.Nr.forEach((o,a)=>{a.sequenceNumber<=t&&r.get(a.targetId)===null&&(this.Nr.delete(o),s.push(this.removeMatchingKeysForTargetId(e,a.targetId)),i++)}),b.waitFor(s).next(()=>i)}getTargetCount(e){return b.resolve(this.targetCount)}getTargetData(e,t){let r=this.Nr.get(t)||null;return b.resolve(r)}addMatchingKeys(e,t,r){return this.Br.Rr(t,r),b.resolve()}removeMatchingKeys(e,t,r){this.Br.mr(t,r);let i=this.persistence.referenceDelegate,s=[];return i&&t.forEach(o=>{s.push(i.markPotentiallyOrphaned(e,o))}),b.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),b.resolve()}getMatchingKeysForTargetId(e,t){let r=this.Br.yr(t);return b.resolve(r)}containsKey(e,t){return b.resolve(this.Br.containsKey(t))}};var du=class{constructor(e,t){this.qr={},this.overlays={},this.Qr=new pt(0),this.Kr=!1,this.Kr=!0,this.$r=new zf,this.referenceDelegate=e(this),this.Ur=new Hf(this),this.indexManager=new kf,this.remoteDocumentCache=function(i){return new Qf(i)}(r=>this.referenceDelegate.Wr(r)),this.serializer=new ru(t),this.Gr=new Gf(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Kf,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.qr[e.toKey()];return r||(r=new Wf(t,this.referenceDelegate),this.qr[e.toKey()]=r),r}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,r){V("MemoryPersistence","Starting transaction:",e);let i=new Yf(this.Qr.next());return this.referenceDelegate.zr(),r(i).next(s=>this.referenceDelegate.jr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Hr(e,t){return b.or(Object.values(this.qr).map(r=>()=>r.containsKey(e,t)))}},Yf=class extends zl{constructor(e){super(),this.currentSequenceNumber=e}},fu=class n{constructor(e){this.persistence=e,this.Jr=new zo,this.Yr=null}static Zr(e){return new n(e)}get Xr(){if(this.Yr)return this.Yr;throw B()}addReference(e,t,r){return this.Jr.addReference(r,t),this.Xr.delete(r.toString()),b.resolve()}removeReference(e,t,r){return this.Jr.removeReference(r,t),this.Xr.add(r.toString()),b.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),b.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach(i=>this.Xr.add(i.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(i=>{i.forEach(s=>this.Xr.add(s.toString()))}).next(()=>r.removeTargetData(e,t))}zr(){this.Yr=new Set}jr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return b.forEach(this.Xr,r=>{let i=U.fromPath(r);return this.ei(e,i).next(s=>{s||t.removeEntry(i,z.min())})}).next(()=>(this.Yr=null,t.apply(e)))}updateLimboDocument(e,t){return this.ei(e,t).next(r=>{r?this.Xr.delete(t.toString()):this.Xr.add(t.toString())})}Wr(e){return 0}ei(e,t){return b.or([()=>b.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}};var Jf=class{constructor(e){this.serializer=e}O(e,t,r,i){let s=new Wl("createOrUpgrade",t);r<1&&i>=1&&(function(u){u.createObjectStore("owner")}(e),function(u){u.createObjectStore("mutationQueues",{keyPath:"userId"}),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Kv,{unique:!0}),u.createObjectStore("documentMutations")}(e),Pw(e),function(u){u.createObjectStore("remoteDocuments")}(e));let o=b.resolve();return r<3&&i>=3&&(r!==0&&(function(u){u.deleteObjectStore("targetDocuments"),u.deleteObjectStore("targets"),u.deleteObjectStore("targetGlobal")}(e),Pw(e)),o=o.next(()=>function(u){let c=u.store("targetGlobal"),d={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:z.min().toTimestamp(),targetCount:0};return c.put("targetGlobalKey",d)}(s))),r<4&&i>=4&&(r!==0&&(o=o.next(()=>function(u,c){return c.store("mutations").U().next(d=>{u.deleteObjectStore("mutations"),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Kv,{unique:!0});let m=c.store("mutations"),p=d.map(y=>m.put(y));return b.waitFor(p)})}(e,s))),o=o.next(()=>{(function(u){u.createObjectStore("clientMetadata",{keyPath:"clientId"})})(e)})),r<5&&i>=5&&(o=o.next(()=>this.ni(s))),r<6&&i>=6&&(o=o.next(()=>(function(u){u.createObjectStore("remoteDocumentGlobal")}(e),this.ri(s)))),r<7&&i>=7&&(o=o.next(()=>this.ii(s))),r<8&&i>=8&&(o=o.next(()=>this.si(e,s))),r<9&&i>=9&&(o=o.next(()=>{(function(u){u.objectStoreNames.contains("remoteDocumentChanges")&&u.deleteObjectStore("remoteDocumentChanges")})(e)})),r<10&&i>=10&&(o=o.next(()=>this.oi(s))),r<11&&i>=11&&(o=o.next(()=>{(function(u){u.createObjectStore("bundles",{keyPath:"bundleId"})})(e),function(u){u.createObjectStore("namedQueries",{keyPath:"name"})}(e)})),r<12&&i>=12&&(o=o.next(()=>{(function(u){let c=u.createObjectStore("documentOverlays",{keyPath:yC});c.createIndex("collectionPathOverlayIndex",vC,{unique:!1}),c.createIndex("collectionGroupOverlayIndex",wC,{unique:!1})})(e)})),r<13&&i>=13&&(o=o.next(()=>function(u){let c=u.createObjectStore("remoteDocumentsV14",{keyPath:aC});c.createIndex("documentKeyIndex",lC),c.createIndex("collectionGroupIndex",uC)}(e)).next(()=>this._i(e,s)).next(()=>e.deleteObjectStore("remoteDocuments"))),r<14&&i>=14&&(o=o.next(()=>this.ai(e,s))),r<15&&i>=15&&(o=o.next(()=>function(u){u.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),u.createObjectStore("indexState",{keyPath:mC}).createIndex("sequenceNumberIndex",pC,{unique:!1}),u.createObjectStore("indexEntries",{keyPath:gC}).createIndex("documentKeyIndex",_C,{unique:!1})}(e))),r<16&&i>=16&&(o=o.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),r<17&&i>=17&&(o=o.next(()=>{(function(u){u.createObjectStore("globals",{keyPath:"name"})})(e)})),o}ri(e){let t=0;return e.store("remoteDocuments").J((r,i)=>{t+=lu(i)}).next(()=>{let r={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",r)})}ni(e){let t=e.store("mutationQueues"),r=e.store("mutations");return t.U().next(i=>b.forEach(i,s=>{let o=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return r.U("userMutationsIndex",o).next(a=>b.forEach(a,u=>{G(u.userId===s.userId);let c=_r(this.serializer,u);return KE(e,s.userId,c).next(()=>{})}))}))}ii(e){let t=e.store("targetDocuments"),r=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return r.J((o,a)=>{let u=new se(o),c=function(m){return[0,it(m)]}(u);s.push(t.get(c).next(d=>d?b.resolve():(m=>t.put({targetId:0,path:it(m),sequenceNumber:i.highestListenSequenceNumber}))(u)))}).next(()=>b.waitFor(s))})}si(e,t){e.createObjectStore("collectionParents",{keyPath:fC});let r=t.store("collectionParents"),i=new Ko,s=o=>{if(i.add(o)){let a=o.lastSegment(),u=o.popLast();return r.put({collectionId:a,parent:it(u)})}};return t.store("remoteDocuments").J({H:!0},(o,a)=>{let u=new se(o);return s(u.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([o,a,u],c)=>{let d=Kt(a);return s(d.popLast())}))}oi(e){let t=e.store("targets");return t.J((r,i)=>{let s=Ao(i),o=qE(this.serializer,s);return t.put(o)})}_i(e,t){let r=t.store("remoteDocuments"),i=[];return r.J((s,o)=>{let a=t.store("remoteDocumentsV14"),u=function(m){return m.document?new U(se.fromString(m.document.name).popFirst(5)):m.noDocument?U.fromSegments(m.noDocument.path):m.unknownDocument?U.fromSegments(m.unknownDocument.path):B()}(o).path.toArray(),c={prefixPath:u.slice(0,u.length-2),collectionGroup:u[u.length-2],documentId:u[u.length-1],readTime:o.readTime||[0,0],unknownDocument:o.unknownDocument,noDocument:o.noDocument,document:o.document,hasCommittedMutations:!!o.hasCommittedMutations};i.push(a.put(c))}).next(()=>b.waitFor(i))}ai(e,t){let r=t.store("mutations"),i=QE(this.serializer),s=new du(fu.Zr,this.serializer.ct);return r.U().next(o=>{let a=new Map;return o.forEach(u=>{var c;let d=(c=a.get(u.userId))!==null&&c!==void 0?c:X();_r(this.serializer,u).keys().forEach(m=>d=d.add(m)),a.set(u.userId,d)}),b.forEach(a,(u,c)=>{let d=new Ve(c),m=su.lt(this.serializer,d),p=s.getIndexManager(d),y=uu.lt(d,this.serializer,p,s.referenceDelegate);return new hu(i,y,m,p).recalculateAndSaveOverlaysForDocumentKeys(new ko(t,pt.oe),u).next()})})}};function Pw(n){n.createObjectStore("targetDocuments",{keyPath:hC}).createIndex("documentTargetsIndex",dC,{unique:!0}),n.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",cC,{unique:!0}),n.createObjectStore("targetGlobal")}var Ud="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Xf=class n{constructor(e,t,r,i,s,o,a,u,c,d,m=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=r,this.ui=s,this.window=o,this.document=a,this.ci=c,this.li=d,this.hi=m,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=p=>Promise.resolve(),!n.D())throw new k(R.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Uf(this,i),this.Ai=t+"main",this.serializer=new ru(u),this.Ri=new qn(this.Ai,this.hi,new Jf(this.serializer)),this.$r=new Cf,this.Ur=new Of(this.referenceDelegate,this.serializer),this.remoteDocumentCache=QE(this.serializer),this.Gr=new Af,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,d===!1&&be("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new k(R.FAILED_PRECONDITION,Ud);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ur.getHighestSequenceNumber(e))}).then(e=>{this.Qr=new pt(e,this.ci)}).then(()=>{this.Kr=!0}).catch(e=>(this.Ri&&this.Ri.close(),Promise.reject(e)))}yi(e){return this.di=t=>D(this,null,function*(){if(this.started)return e(t)}),e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ri.L(t=>D(this,null,function*(){t.newVersion===null&&(yield e())}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ui.enqueueAndForget(()=>D(this,null,function*(){this.started&&(yield this.mi())})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>Vl(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(e).next(t=>{t||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(e)).next(t=>this.isPrimary&&!t?this.bi(e).next(()=>!1):!!t&&this.Di(e).next(()=>!0))).catch(e=>{if(Jn(e))return V("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return V("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ui.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}wi(e){return To(e).get("owner").next(t=>b.resolve(this.vi(t)))}Ci(e){return Vl(e).delete(this.clientId)}Fi(){return D(this,null,function*(){if(this.isPrimary&&!this.Mi(this.Ei,18e5)){this.Ei=Date.now();let e=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{let r=Le(t,"clientMetadata");return r.U().next(i=>{let s=this.xi(i,18e5),o=i.filter(a=>s.indexOf(a)===-1);return b.forEach(o,a=>r.delete(a.clientId)).next(()=>o)})}).catch(()=>[]);if(this.Vi)for(let t of e)this.Vi.removeItem(this.Oi(t.clientId))}})}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(e){return!!e&&e.ownerId===this.clientId}Si(e){return this.li?b.resolve(!0):To(e).get("owner").next(t=>{if(t!==null&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)){if(this.vi(t)&&this.networkEnabled)return!0;if(!this.vi(t)){if(!t.allowTabSynchronization)throw new k(R.FAILED_PRECONDITION,Ud);return!1}}return!(!this.networkEnabled||!this.inForeground)||Vl(e).U().next(r=>this.xi(r,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,o=!this.inForeground&&i.inForeground,a=this.networkEnabled===i.networkEnabled;if(s||o&&a)return!0}return!1})===void 0)}).next(t=>(this.isPrimary!==t&&V("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}shutdown(){return D(this,null,function*(){this.Kr=!1,this.Li(),this.Ti&&(this.Ti.cancel(),this.Ti=null),this.Bi(),this.ki(),yield this.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{let t=new ko(e,pt.oe);return this.bi(t).next(()=>this.Ci(t))}),this.Ri.close(),this.qi()})}xi(e,t){return e.filter(r=>this.Mi(r.updateTimeMs,t)&&!this.Ni(r.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",e=>Vl(e).U().next(t=>this.xi(t,18e5).map(r=>r.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(e,t){return uu.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Vf(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return su.lt(this.serializer,e)}getBundleCache(){return this.Gr}runTransaction(e,t,r){V("IndexedDbPersistence","Starting transaction:",e);let i=t==="readonly"?"readonly":"readwrite",s=function(u){return u===17?TC:u===16?IC:u===15?Wm:u===14?eE:u===13?Zw:u===12?EC:u===11?Xw:void B()}(this.hi),o;return this.Ri.runTransaction(e,i,s,a=>(o=new ko(a,this.Qr?this.Qr.next():pt.oe),t==="readwrite-primary"?this.wi(o).next(u=>!!u||this.Si(o)).next(u=>{if(!u)throw be(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new k(R.FAILED_PRECONDITION,$w);return r(o)}).next(u=>this.Di(o).next(()=>u)):this.Ki(o).next(()=>r(o)))).then(a=>(o.raiseOnCommittedEvent(),a))}Ki(e){return To(e).get("owner").next(t=>{if(t!==null&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)&&!this.vi(t)&&!(this.li||this.allowTabSynchronization&&t.allowTabSynchronization))throw new k(R.FAILED_PRECONDITION,Ud)})}Di(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return To(e).put("owner",t)}static D(){return qn.D()}bi(e){let t=To(e);return t.get("owner").next(r=>this.vi(r)?(V("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):b.resolve())}Mi(e,t){let r=Date.now();return!(e<r-t)&&(!(e>r)||(be(`Detected an update time that is in the future: ${e} > ${r}`),!1))}fi(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground=this.document.visibilityState==="visible")}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var e;typeof((e=this.window)===null||e===void 0?void 0:e.addEventListener)=="function"&&(this.Pi=()=>{this.Li();let t=/(?:Version|Mobile)\/1[456]/;xc()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(e){var t;try{let r=((t=this.Vi)===null||t===void 0?void 0:t.getItem(this.Oi(e)))!==null;return V("IndexedDbPersistence",`Client '${e}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(r){return be("IndexedDbPersistence","Failed to get zombied client id.",r),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(e){be("Failed to set zombie client id.",e)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch{}}Oi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}};function To(n){return Le(n,"owner")}function Vl(n){return Le(n,"clientMetadata")}function tp(n,e){let t=n.projectId;return n.isDefaultDatabase||(t+="."+n.database),"firestore/"+e+"/"+t+"/"}var Zf=class n{constructor(e,t,r,i){this.targetId=e,this.fromCache=t,this.$i=r,this.Ui=i}static Wi(e,t){let r=X(),i=X();for(let s of t.docChanges)switch(s.type){case 0:r=r.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new n(e,t.fromCache,r,i)}};var em=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}};var mu=class{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=function(){return xc()?8:Hw(Rs())>0?6:4}()}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,r,i){let s={result:null};return this.Yi(e,t).next(o=>{s.result=o}).next(()=>{if(!s.result)return this.Zi(e,t,i,r).next(o=>{s.result=o})}).next(()=>{if(s.result)return;let o=new em;return this.Xi(e,t,o).next(a=>{if(s.result=a,this.zi)return this.es(e,t,o,a.size)})}).next(()=>s.result)}es(e,t,r,i){return r.documentReadCount<this.ji?(Ti()<=vt.DEBUG&&V("QueryEngine","SDK will not create cache indexes for query:",Si(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),b.resolve()):(Ti()<=vt.DEBUG&&V("QueryEngine","Query:",Si(t),"scans",r.documentReadCount,"local documents and returns",i,"documents as results."),r.documentReadCount>this.Hi*i?(Ti()<=vt.DEBUG&&V("QueryEngine","The SDK decides to create cache indexes for query:",Si(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,st(t))):b.resolve())}Yi(e,t){if(nw(t))return b.resolve(null);let r=st(t);return this.indexManager.getIndexType(e,r).next(i=>i===0?null:(t.limit!==null&&i===1&&(t=Zl(t,null,"F"),r=st(t)),this.indexManager.getDocumentsMatchingTarget(e,r).next(s=>{let o=X(...s);return this.Ji.getDocuments(e,o).next(a=>this.indexManager.getMinOffset(e,r).next(u=>{let c=this.ts(t,a);return this.ns(t,c,o,u.readTime)?this.Yi(e,Zl(t,null,"F")):this.rs(e,c,t,u)}))})))}Zi(e,t,r,i){return nw(t)||i.isEqual(z.min())?b.resolve(null):this.Ji.getDocuments(e,r).next(s=>{let o=this.ts(t,s);return this.ns(t,o,r,i)?b.resolve(null):(Ti()<=vt.DEBUG&&V("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Si(t)),this.rs(e,o,t,Ww(i,-1)).next(a=>a))})}ts(e,t){let r=new me(mE(e));return t.forEach((i,s)=>{ra(e,s)&&(r=r.add(s))}),r}ns(e,t,r,i){if(e.limit===null)return!1;if(r.size!==t.size)return!0;let s=e.limitType==="F"?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Xi(e,t,r){return Ti()<=vt.DEBUG&&V("QueryEngine","Using full collection scan to execute query:",Si(t)),this.Ji.getDocumentsMatchingQuery(e,t,At.min(),r)}rs(e,t,r,i){return this.Ji.getDocumentsMatchingQuery(e,r,i).next(s=>(t.forEach(o=>{s=s.insert(o.key,o)}),s))}};var tm=class{constructor(e,t,r,i){this.persistence=e,this.ss=t,this.serializer=i,this.os=new ye($),this._s=new Jt(s=>Ar(s),ta),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(r)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new hu(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.os))}};function $E(n,e,t,r){return new tm(n,e,t,r)}function HE(n,e){return D(this,null,function*(){let t=L(n);return yield t.persistence.runTransaction("Handle user change","readonly",r=>{let i;return t.mutationQueue.getAllMutationBatches(r).next(s=>(i=s,t.ls(e),t.mutationQueue.getAllMutationBatches(r))).next(s=>{let o=[],a=[],u=X();for(let c of i){o.push(c.batchId);for(let d of c.mutations)u=u.add(d.key)}for(let c of s){a.push(c.batchId);for(let d of c.mutations)u=u.add(d.key)}return t.localDocuments.getDocuments(r,u).next(c=>({hs:c,removedBatchIds:o,addedBatchIds:a}))})})})}function nb(n,e){let t=L(n);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",r=>{let i=e.batch.keys(),s=t.cs.newChangeBuffer({trackRemovals:!0});return function(a,u,c,d){let m=c.batch,p=m.keys(),y=b.resolve();return p.forEach(A=>{y=y.next(()=>d.getEntry(u,A)).next(x=>{let N=c.docVersions.get(A);G(N!==null),x.version.compareTo(N)<0&&(m.applyToRemoteDocument(x,c),x.isValidDocument()&&(x.setReadTime(c.commitVersion),d.addEntry(x)))})}),y.next(()=>a.mutationQueue.removeMutationBatch(u,m))}(t,r,e,s).next(()=>s.apply(r)).next(()=>t.mutationQueue.performConsistencyCheck(r)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(r,i,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(r,function(a){let u=X();for(let c=0;c<a.mutationResults.length;++c)a.mutationResults[c].transformResults.length>0&&(u=u.add(a.batch.mutations[c].key));return u}(e))).next(()=>t.localDocuments.getDocuments(r,i))})}function YE(n){let e=L(n);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Ur.getLastRemoteSnapshotVersion(t))}function rb(n,e){let t=L(n),r=e.snapshotVersion,i=t.os;return t.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let o=t.cs.newChangeBuffer({trackRemovals:!0});i=t.os;let a=[];e.targetChanges.forEach((d,m)=>{let p=i.get(m);if(!p)return;a.push(t.Ur.removeMatchingKeys(s,d.removedDocuments,m).next(()=>t.Ur.addMatchingKeys(s,d.addedDocuments,m)));let y=p.withSequenceNumber(s.currentSequenceNumber);e.targetMismatches.get(m)!==null?y=y.withResumeToken(xe.EMPTY_BYTE_STRING,z.min()).withLastLimboFreeSnapshotVersion(z.min()):d.resumeToken.approximateByteSize()>0&&(y=y.withResumeToken(d.resumeToken,r)),i=i.insert(m,y),function(x,N,q){return x.resumeToken.approximateByteSize()===0||N.snapshotVersion.toMicroseconds()-x.snapshotVersion.toMicroseconds()>=3e8?!0:q.addedDocuments.size+q.modifiedDocuments.size+q.removedDocuments.size>0}(p,y,d)&&a.push(t.Ur.updateTargetData(s,y))});let u=lt(),c=X();if(e.documentUpdates.forEach(d=>{e.resolvedLimboDocuments.has(d)&&a.push(t.persistence.referenceDelegate.updateLimboDocument(s,d))}),a.push(JE(s,o,e.documentUpdates).next(d=>{u=d.Ps,c=d.Is})),!r.isEqual(z.min())){let d=t.Ur.getLastRemoteSnapshotVersion(s).next(m=>t.Ur.setTargetsMetadata(s,s.currentSequenceNumber,r));a.push(d)}return b.waitFor(a).next(()=>o.apply(s)).next(()=>t.localDocuments.getLocalViewOfDocuments(s,u,c)).next(()=>u)}).then(s=>(t.os=i,s))}function JE(n,e,t){let r=X(),i=X();return t.forEach(s=>r=r.add(s)),e.getEntries(n,r).next(s=>{let o=lt();return t.forEach((a,u)=>{let c=s.get(a);u.isFoundDocument()!==c.isFoundDocument()&&(i=i.add(a)),u.isNoDocument()&&u.version.isEqual(z.min())?(e.removeEntry(a,u.readTime),o=o.insert(a,u)):!c.isValidDocument()||u.version.compareTo(c.version)>0||u.version.compareTo(c.version)===0&&c.hasPendingWrites?(e.addEntry(u),o=o.insert(a,u)):V("LocalStore","Ignoring outdated watch update for ",a,". Current version:",c.version," Watch version:",u.version)}),{Ps:o,Is:i}})}function ib(n,e){let t=L(n);return t.persistence.runTransaction("Get next mutation batch","readonly",r=>(e===void 0&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(r,e)))}function qi(n,e){let t=L(n);return t.persistence.runTransaction("Allocate target","readwrite",r=>{let i;return t.Ur.getTargetData(r,e).next(s=>s?(i=s,b.resolve(i)):t.Ur.allocateTargetId(r).next(o=>(i=new Ui(e,o,"TargetPurposeListen",r.currentSequenceNumber),t.Ur.addTargetData(r,i).next(()=>i))))}).then(r=>{let i=t.os.get(r.targetId);return(i===null||r.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(t.os=t.os.insert(r.targetId,r),t._s.set(e,r.targetId)),r})}function ji(n,e,t){return D(this,null,function*(){let r=L(n),i=r.os.get(e),s=t?"readwrite":"readwrite-primary";try{t||(yield r.persistence.runTransaction("Release target",s,o=>r.persistence.referenceDelegate.removeTarget(o,i)))}catch(o){if(!Jn(o))throw o;V("LocalStore",`Failed to update sequence numbers for target ${e}: ${o}`)}r.os=r.os.remove(e),r._s.delete(i.target)})}function pu(n,e,t){let r=L(n),i=z.min(),s=X();return r.persistence.runTransaction("Execute query","readwrite",o=>function(u,c,d){let m=L(u),p=m._s.get(d);return p!==void 0?b.resolve(m.os.get(p)):m.Ur.getTargetData(c,d)}(r,o,st(e)).next(a=>{if(a)return i=a.lastLimboFreeSnapshotVersion,r.Ur.getMatchingKeysForTargetId(o,a.targetId).next(u=>{s=u})}).next(()=>r.ss.getDocumentsMatchingQuery(o,e,t?i:z.min(),t?s:X())).next(a=>(eI(r,fE(e),a),{documents:a,Ts:s})))}function XE(n,e){let t=L(n),r=L(t.Ur),i=t.os.get(e);return i?Promise.resolve(i.target):t.persistence.runTransaction("Get target data","readonly",s=>r.ot(s,e).next(o=>o?o.target:null))}function ZE(n,e){let t=L(n),r=t.us.get(e)||z.min();return t.persistence.runTransaction("Get new document changes","readonly",i=>t.cs.getAllFromCollectionGroup(i,e,Ww(r,-1),Number.MAX_SAFE_INTEGER)).then(i=>(eI(t,e,i),i))}function eI(n,e,t){let r=n.us.get(e)||z.min();t.forEach((i,s)=>{s.readTime.compareTo(r)>0&&(r=s.readTime)}),n.us.set(e,r)}function sb(n,e,t,r){return D(this,null,function*(){let i=L(n),s=X(),o=lt();for(let c of t){let d=e.Es(c.metadata.name);c.document&&(s=s.add(d));let m=e.ds(c);m.setReadTime(e.As(c.metadata.readTime)),o=o.insert(d,m)}let a=i.cs.newChangeBuffer({trackRemovals:!0}),u=yield qi(i,function(d){return st(Yi(se.fromString(`__bundle__/docs/${d}`)))}(r));return i.persistence.runTransaction("Apply bundle documents","readwrite",c=>JE(c,a,o).next(d=>(a.apply(c),d)).next(d=>i.Ur.removeMatchingKeysForTargetId(c,u.targetId).next(()=>i.Ur.addMatchingKeys(c,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(c,d.Ps,d.Is)).next(()=>d.Ps)))})}function ob(r,i){return D(this,arguments,function*(n,e,t=X()){let s=yield qi(n,st(Zm(e.bundledQuery))),o=L(n);return o.persistence.runTransaction("Save named query","readwrite",a=>{let u=Pe(e.readTime);if(s.snapshotVersion.compareTo(u)>=0)return o.Gr.saveNamedQuery(a,e);let c=s.withResumeToken(xe.EMPTY_BYTE_STRING,u);return o.os=o.os.insert(c.targetId,c),o.Ur.updateTargetData(a,c).next(()=>o.Ur.removeMatchingKeysForTargetId(a,s.targetId)).next(()=>o.Ur.addMatchingKeys(a,t,s.targetId)).next(()=>o.Gr.saveNamedQuery(a,e))})})}function xw(n,e){return`firestore_clients_${n}_${e}`}function Nw(n,e,t){let r=`firestore_mutations_${n}_${t}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function Bd(n,e){return`firestore_targets_${n}_${e}`}var gu=class n{constructor(e,t,r,i){this.user=e,this.batchId=t,this.state=r,this.error=i}static Rs(e,t,r){let i=JSON.parse(r),s,o=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return o&&i.error&&(o=typeof i.error.message=="string"&&typeof i.error.code=="string",o&&(s=new k(i.error.code,i.error.message))),o?new n(e,t,i.state,s):(be("SharedClientState",`Failed to parse mutation state for ID '${t}': ${r}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},Po=class n{constructor(e,t,r){this.targetId=e,this.state=t,this.error=r}static Rs(e,t){let r=JSON.parse(t),i,s=typeof r=="object"&&["not-current","current","rejected"].indexOf(r.state)!==-1&&(r.error===void 0||typeof r.error=="object");return s&&r.error&&(s=typeof r.error.message=="string"&&typeof r.error.code=="string",s&&(i=new k(r.error.code,r.error.message))),s?new n(e,r.state,i):(be("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},_u=class n{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Rs(e,t){let r=JSON.parse(t),i=typeof r=="object"&&r.activeTargetIds instanceof Array,s=Ym();for(let o=0;i&&o<r.activeTargetIds.length;++o)i=Yw(r.activeTargetIds[o]),s=s.add(r.activeTargetIds[o]);return i?new n(e,s):(be("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}},nm=class n{constructor(e,t){this.clientId=e,this.onlineState=t}static Rs(e){let t=JSON.parse(e);return typeof t=="object"&&["Unknown","Online","Offline"].indexOf(t.onlineState)!==-1&&typeof t.clientId=="string"?new n(t.clientId,t.onlineState):(be("SharedClientState",`Failed to parse online state: ${e}`),null)}},Wo=class{constructor(){this.activeTargetIds=Ym()}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){let e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}},xo=class{constructor(e,t,r,i,s){this.window=e,this.ui=t,this.persistenceKey=r,this.ps=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new ye($),this.started=!1,this.bs=[];let o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ds=xw(this.persistenceKey,this.ps),this.vs=function(u){return`firestore_sequence_number_${u}`}(this.persistenceKey),this.Ss=this.Ss.insert(this.ps,new Wo),this.Cs=new RegExp(`^firestore_clients_${o}_([^_]*)$`),this.Fs=new RegExp(`^firestore_mutations_${o}_(\\d+)(?:_(.*))?$`),this.Ms=new RegExp(`^firestore_targets_${o}_(\\d+)$`),this.xs=function(u){return`firestore_online_state_${u}`}(this.persistenceKey),this.Os=function(u){return`firestore_bundle_loaded_v2_${u}`}(this.persistenceKey),this.window.addEventListener("storage",this.ys)}static D(e){return!(!e||!e.localStorage)}start(){return D(this,null,function*(){let e=yield this.syncEngine.Qi();for(let r of e){if(r===this.ps)continue;let i=this.getItem(xw(this.persistenceKey,r));if(i){let s=_u.Rs(r,i);s&&(this.Ss=this.Ss.insert(s.clientId,s))}}this.Ns();let t=this.storage.getItem(this.xs);if(t){let r=this.Ls(t);r&&this.Bs(r)}for(let r of this.bs)this.ws(r);this.bs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(e){this.setItem(this.vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(e){let t=!1;return this.Ss.forEach((r,i)=>{i.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.qs(e,"pending")}updateMutationState(e,t,r){this.qs(e,t,r),this.Qs(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){let r=this.storage.getItem(Bd(this.persistenceKey,e));if(r){let i=Po.Rs(e,r);i&&(t=i.state)}}return this.Ks.fs(e),this.Ns(),t}removeLocalQueryTarget(e){this.Ks.gs(e),this.Ns()}isLocalQueryTarget(e){return this.Ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Bd(this.persistenceKey,e))}updateQueryState(e,t,r){this.$s(e,t,r)}handleUserChange(e,t,r){t.forEach(i=>{this.Qs(i)}),this.currentUser=e,r.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(e){this.Us(e)}notifyBundleLoaded(e){this.Ws(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return V("SharedClientState","READ",e,t),t}setItem(e,t){V("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){V("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ws(e){let t=e;if(t.storageArea===this.storage){if(V("SharedClientState","EVENT",t.key,t.newValue),t.key===this.Ds)return void be("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable(()=>D(this,null,function*(){if(this.started){if(t.key!==null){if(this.Cs.test(t.key)){if(t.newValue==null){let r=this.Gs(t.key);return this.zs(r,null)}{let r=this.js(t.key,t.newValue);if(r)return this.zs(r.clientId,r)}}else if(this.Fs.test(t.key)){if(t.newValue!==null){let r=this.Hs(t.key,t.newValue);if(r)return this.Js(r)}}else if(this.Ms.test(t.key)){if(t.newValue!==null){let r=this.Ys(t.key,t.newValue);if(r)return this.Zs(r)}}else if(t.key===this.xs){if(t.newValue!==null){let r=this.Ls(t.newValue);if(r)return this.Bs(r)}}else if(t.key===this.vs){let r=function(s){let o=pt.oe;if(s!=null)try{let a=JSON.parse(s);G(typeof a=="number"),o=a}catch(a){be("SharedClientState","Failed to read sequence number from WebStorage",a)}return o}(t.newValue);r!==pt.oe&&this.sequenceNumberHandler(r)}else if(t.key===this.Os){let r=this.Xs(t.newValue);yield Promise.all(r.map(i=>this.syncEngine.eo(i)))}}}else this.bs.push(t)}))}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(e,t,r){let i=new gu(this.currentUser,e,t,r),s=Nw(this.persistenceKey,this.currentUser,e);this.setItem(s,i.Vs())}Qs(e){let t=Nw(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Us(e){let t={clientId:this.ps,onlineState:e};this.storage.setItem(this.xs,JSON.stringify(t))}$s(e,t,r){let i=Bd(this.persistenceKey,e),s=new Po(e,t,r);this.setItem(i,s.Vs())}Ws(e){let t=JSON.stringify(Array.from(e));this.setItem(this.Os,t)}Gs(e){let t=this.Cs.exec(e);return t?t[1]:null}js(e,t){let r=this.Gs(e);return _u.Rs(r,t)}Hs(e,t){let r=this.Fs.exec(e),i=Number(r[1]),s=r[2]!==void 0?r[2]:null;return gu.Rs(new Ve(s),i,t)}Ys(e,t){let r=this.Ms.exec(e),i=Number(r[1]);return Po.Rs(i,t)}Ls(e){return nm.Rs(e)}Xs(e){return JSON.parse(e)}Js(e){return D(this,null,function*(){if(e.user.uid===this.currentUser.uid)return this.syncEngine.no(e.batchId,e.state,e.error);V("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)})}Zs(e){return this.syncEngine.ro(e.targetId,e.state,e.error)}zs(e,t){let r=t?this.Ss.insert(e,t):this.Ss.remove(e),i=this.ks(this.Ss),s=this.ks(r),o=[],a=[];return s.forEach(u=>{i.has(u)||o.push(u)}),i.forEach(u=>{s.has(u)||a.push(u)}),this.syncEngine.io(o,a).then(()=>{this.Ss=r})}Bs(e){this.Ss.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ks(e){let t=Ym();return e.forEach((r,i)=>{t=t.unionWith(i.activeTargetIds)}),t}},yu=class{constructor(){this.so=new Wo,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e){return this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,r){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new Wo,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}};var rm=class{_o(e){}shutdown(){}};var vu=class{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){V("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let e of this.ho)e(0)}lo(){V("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let e of this.ho)e(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var Ol=null;function qd(){return Ol===null?Ol=function(){return 268435456+Math.round(2147483648*Math.random())}():Ol++,"0x"+Ol.toString(16)}var ab={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var im=class{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}};var He="WebChannelConnection",sm=class extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;let r=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.Do=r+"://"+t.host,this.vo=`projects/${i}/databases/${s}`,this.Co=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get Fo(){return!1}Mo(t,r,i,s,o){let a=qd(),u=this.xo(t,r.toUriEncodedString());V("RestConnection",`Sending RPC '${t}' ${a}:`,u,i);let c={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(c,s,o),this.No(t,u,c,i).then(d=>(V("RestConnection",`Received RPC '${t}' ${a}: `,d),d),d=>{throw St("RestConnection",`RPC '${t}' ${a} failed with error: `,d,"url: ",u,"request:",i),d})}Lo(t,r,i,s,o,a){return this.Mo(t,r,i,s,o)}Oo(t,r,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Hi}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),r&&r.headers.forEach((s,o)=>t[o]=s),i&&i.headers.forEach((s,o)=>t[o]=s)}xo(t,r){let i=ab[t];return`${this.Do}/v1/${r}:${i}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,r,i){let s=qd();return new Promise((o,a)=>{let u=new Dd;u.setWithCredentials(!0),u.listenOnce(Vd.COMPLETE,()=>{try{switch(u.getLastErrorCode()){case vo.NO_ERROR:let d=u.getResponseJson();V(He,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(d)),o(d);break;case vo.TIMEOUT:V(He,`RPC '${e}' ${s} timed out`),a(new k(R.DEADLINE_EXCEEDED,"Request time out"));break;case vo.HTTP_ERROR:let m=u.getStatus();if(V(He,`RPC '${e}' ${s} failed with status:`,m,"response text:",u.getResponseText()),m>0){let p=u.getResponseJson();Array.isArray(p)&&(p=p[0]);let y=p?.error;if(y&&y.status&&y.message){let A=function(N){let q=N.toLowerCase().replace(/_/g,"-");return Object.values(R).indexOf(q)>=0?q:R.UNKNOWN}(y.status);a(new k(A,y.message))}else a(new k(R.UNKNOWN,"Server responded with status "+u.getStatus()))}else a(new k(R.UNAVAILABLE,"Connection failed."));break;default:B()}}finally{V(He,`RPC '${e}' ${s} completed.`)}});let c=JSON.stringify(i);V(He,`RPC '${e}' ${s} sending request:`,i),u.send(t,"POST",c,r,15)})}Bo(e,t,r){let i=qd(),s=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],o=Md(),a=Fd(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;c!==void 0&&(u.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(u.xmlHttpFactory=new kd({})),this.Oo(u.initMessageHeaders,t,r),u.encodeInitMessageHeaders=!0;let d=s.join("");V(He,`Creating RPC '${e}' stream ${i}: ${d}`,u);let m=o.createWebChannel(d,u),p=!1,y=!1,A=new im({Io:N=>{y?V(He,`Not sending because RPC '${e}' stream ${i} is closed:`,N):(p||(V(He,`Opening RPC '${e}' stream ${i} transport.`),m.open(),p=!0),V(He,`RPC '${e}' stream ${i} sending:`,N),m.send(N))},To:()=>m.close()}),x=(N,q,j)=>{N.listen(q,F=>{try{j(F)}catch(W){setTimeout(()=>{throw W},0)}})};return x(m,yi.EventType.OPEN,()=>{y||(V(He,`RPC '${e}' stream ${i} transport opened.`),A.yo())}),x(m,yi.EventType.CLOSE,()=>{y||(y=!0,V(He,`RPC '${e}' stream ${i} transport closed`),A.So())}),x(m,yi.EventType.ERROR,N=>{y||(y=!0,St(He,`RPC '${e}' stream ${i} transport errored:`,N),A.So(new k(R.UNAVAILABLE,"The operation could not be completed")))}),x(m,yi.EventType.MESSAGE,N=>{var q;if(!y){let j=N.data[0];G(!!j);let F=j,W=F.error||((q=F[0])===null||q===void 0?void 0:q.error);if(W){V(He,`RPC '${e}' stream ${i} received error:`,W);let H=W.status,Y=function(w){let I=De[w];if(I!==void 0)return bE(I)}(H),E=W.message;Y===void 0&&(Y=R.INTERNAL,E="Unknown error status: "+H+" with message "+W.message),y=!0,A.So(new k(Y,E)),m.close()}else V(He,`RPC '${e}' stream ${i} received:`,j),A.bo(j)}}),x(a,Od.STAT_EVENT,N=>{N.stat===Nl.PROXY?V(He,`RPC '${e}' stream ${i} detected buffering proxy`):N.stat===Nl.NOPROXY&&V(He,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{A.wo()},0),A}};function tI(){return typeof window<"u"?window:null}function Bl(){return typeof document<"u"?document:null}function ia(n){return new wf(n,!0)}var Qo=class{constructor(e,t,r=1e3,i=1.5,s=6e4){this.ui=e,this.timerId=t,this.ko=r,this.qo=i,this.Qo=s,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();let t=Math.floor(this.Ko+this.zo()),r=Math.max(0,Date.now()-this.Uo),i=Math.max(0,t-r);i>0&&V("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,i,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){this.$o!==null&&(this.$o.skipDelay(),this.$o=null)}cancel(){this.$o!==null&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}};var wu=class{constructor(e,t,r,i,s,o,a,u){this.ui=e,this.Ho=r,this.Jo=i,this.connection=s,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=u,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new Qo(e,t)}n_(){return this.state===1||this.state===5||this.r_()}r_(){return this.state===2||this.state===3}start(){this.e_=0,this.state!==4?this.auth():this.i_()}stop(){return D(this,null,function*(){this.n_()&&(yield this.close(0))})}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&this.Zo===null&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}__(){return D(this,null,function*(){if(this.r_())return this.close(0)})}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}close(e,t){return D(this,null,function*(){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,e!==4?this.t_.reset():t&&t.code===R.RESOURCE_EXHAUSTED?(be(t.toString()),be("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):t&&t.code===R.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.l_(),this.stream.close(),this.stream=null),this.state=e,yield this.listener.mo(t)})}l_(){}auth(){this.state=1;let e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([r,i])=>{this.Yo===t&&this.P_(r,i)},r=>{e(()=>{let i=new k(R.UNKNOWN,"Fetching auth token failed: "+r.message);return this.I_(i)})})}P_(e,t){let r=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo(()=>{r(()=>this.listener.Eo())}),this.stream.Ro(()=>{r(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(i=>{r(()=>this.I_(i))}),this.stream.onMessage(i=>{r(()=>++this.e_==1?this.E_(i):this.onNext(i))})}i_(){this.state=5,this.t_.Go(()=>D(this,null,function*(){this.state=0,this.start()}))}I_(e){return V("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget(()=>this.Yo===e?t():(V("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},om=class extends wu{constructor(e,t,r,i,s,o){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}T_(e,t){return this.connection.Bo("Listen",e,t)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();let t=zC(this.serializer,e),r=function(s){if(!("targetChange"in s))return z.min();let o=s.targetChange;return o.targetIds&&o.targetIds.length?z.min():o.readTime?Pe(o.readTime):z.min()}(e);return this.listener.d_(t,r)}A_(e){let t={};t.database=Tf(this.serializer),t.addTarget=function(s,o){let a,u=o.target;if(a=Jl(u)?{documents:OE(s,u)}:{query:FE(s,u)._t},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=PE(s,o.resumeToken);let c=Ef(s,o.expectedCount);c!==null&&(a.expectedCount=c)}else if(o.snapshotVersion.compareTo(z.min())>0){a.readTime=Li(s,o.snapshotVersion.toTimestamp());let c=Ef(s,o.expectedCount);c!==null&&(a.expectedCount=c)}return a}(this.serializer,e);let r=QC(this.serializer,e);r&&(t.labels=r),this.a_(t)}R_(e){let t={};t.database=Tf(this.serializer),t.removeTarget=e,this.a_(t)}},am=class extends wu{constructor(e,t,r,i,s,o){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return G(!!e.streamToken),this.lastStreamToken=e.streamToken,G(!e.writeResults||e.writeResults.length===0),this.listener.f_()}onNext(e){G(!!e.streamToken),this.lastStreamToken=e.streamToken,this.t_.reset();let t=WC(e.writeResults,e.commitTime),r=Pe(e.commitTime);return this.listener.g_(r,t)}p_(){let e={};e.database=Tf(this.serializer),this.a_(e)}m_(e){let t={streamToken:this.lastStreamToken,writes:e.map(r=>Go(this.serializer,r))};this.a_(t)}};var lm=class extends class{}{constructor(e,t,r,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=i,this.y_=!1}w_(){if(this.y_)throw new k(R.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,r,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,o])=>this.connection.Mo(e,If(t,r),i,s,o)).catch(s=>{throw s.name==="FirebaseError"?(s.code===R.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new k(R.UNKNOWN,s.toString())})}Lo(e,t,r,i,s){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Lo(e,If(t,r),i,o,a,s)).catch(o=>{throw o.name==="FirebaseError"?(o.code===R.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new k(R.UNKNOWN,o.toString())})}terminate(){this.y_=!0,this.connection.terminate()}},um=class{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){this.S_===0&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){this.state==="Online"?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,e==="Online"&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(be(t),this.D_=!1):V("OnlineStateTracker",t)}x_(){this.b_!==null&&(this.b_.cancel(),this.b_=null)}};var cm=class{constructor(e,t,r,i,s){this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=s,this.k_._o(o=>{r.enqueueAndForget(()=>D(this,null,function*(){Xn(this)&&(V("RemoteStore","Restarting streams for network reachability change."),yield function(u){return D(this,null,function*(){let c=L(u);c.L_.add(4),yield Ji(c),c.q_.set("Unknown"),c.L_.delete(4),yield sa(c)})}(this))}))}),this.q_=new um(r,i)}};function sa(n){return D(this,null,function*(){if(Xn(n))for(let e of n.B_)yield e(!0)})}function Ji(n){return D(this,null,function*(){for(let e of n.B_)yield e(!1)})}function Bu(n,e){let t=L(n);t.N_.has(e.targetId)||(t.N_.set(e.targetId,e),ip(t)?rp(t):Zi(t).r_()&&np(t,e))}function Gi(n,e){let t=L(n),r=Zi(t);t.N_.delete(e),r.r_()&&nI(t,e),t.N_.size===0&&(r.r_()?r.o_():Xn(t)&&t.q_.set("Unknown"))}function np(n,e){if(n.Q_.xe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(z.min())>0){let t=n.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}Zi(n).A_(e)}function nI(n,e){n.Q_.xe(e),Zi(n).R_(e)}function rp(n){n.Q_=new vf({getRemoteKeysForTarget:e=>n.remoteSyncer.getRemoteKeysForTarget(e),ot:e=>n.N_.get(e)||null,tt:()=>n.datastore.serializer.databaseId}),Zi(n).start(),n.q_.v_()}function ip(n){return Xn(n)&&!Zi(n).n_()&&n.N_.size>0}function Xn(n){return L(n).L_.size===0}function rI(n){n.Q_=void 0}function lb(n){return D(this,null,function*(){n.q_.set("Online")})}function ub(n){return D(this,null,function*(){n.N_.forEach((e,t)=>{np(n,e)})})}function cb(n,e){return D(this,null,function*(){rI(n),ip(n)?(n.q_.M_(e),rp(n)):n.q_.set("Unknown")})}function hb(n,e,t){return D(this,null,function*(){if(n.q_.set("Online"),e instanceof tu&&e.state===2&&e.cause)try{yield function(i,s){return D(this,null,function*(){let o=s.cause;for(let a of s.targetIds)i.N_.has(a)&&(yield i.remoteSyncer.rejectListen(a,o),i.N_.delete(a),i.Q_.removeTarget(a))})}(n,e)}catch(r){V("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),r),yield Eu(n,r)}else if(e instanceof Ni?n.Q_.Ke(e):e instanceof eu?n.Q_.He(e):n.Q_.We(e),!t.isEqual(z.min()))try{let r=yield YE(n.localStore);t.compareTo(r)>=0&&(yield function(s,o){let a=s.Q_.rt(o);return a.targetChanges.forEach((u,c)=>{if(u.resumeToken.approximateByteSize()>0){let d=s.N_.get(c);d&&s.N_.set(c,d.withResumeToken(u.resumeToken,o))}}),a.targetMismatches.forEach((u,c)=>{let d=s.N_.get(u);if(!d)return;s.N_.set(u,d.withResumeToken(xe.EMPTY_BYTE_STRING,d.snapshotVersion)),nI(s,u);let m=new Ui(d.target,u,c,d.sequenceNumber);np(s,m)}),s.remoteSyncer.applyRemoteEvent(a)}(n,t))}catch(r){V("RemoteStore","Failed to raise snapshot:",r),yield Eu(n,r)}})}function Eu(n,e,t){return D(this,null,function*(){if(!Jn(e))throw e;n.L_.add(1),yield Ji(n),n.q_.set("Offline"),t||(t=()=>YE(n.localStore)),n.asyncQueue.enqueueRetryable(()=>D(this,null,function*(){V("RemoteStore","Retrying IndexedDB access"),yield t(),n.L_.delete(1),yield sa(n)}))})}function iI(n,e){return e().catch(t=>Eu(n,t,e))}function Xi(n){return D(this,null,function*(){let e=L(n),t=Hn(e),r=e.O_.length>0?e.O_[e.O_.length-1].batchId:-1;for(;db(e);)try{let i=yield ib(e.localStore,r);if(i===null){e.O_.length===0&&t.o_();break}r=i.batchId,fb(e,i)}catch(i){yield Eu(e,i)}sI(e)&&oI(e)})}function db(n){return Xn(n)&&n.O_.length<10}function fb(n,e){n.O_.push(e);let t=Hn(n);t.r_()&&t.V_&&t.m_(e.mutations)}function sI(n){return Xn(n)&&!Hn(n).n_()&&n.O_.length>0}function oI(n){Hn(n).start()}function mb(n){return D(this,null,function*(){Hn(n).p_()})}function pb(n){return D(this,null,function*(){let e=Hn(n);for(let t of n.O_)e.m_(t.mutations)})}function gb(n,e,t){return D(this,null,function*(){let r=n.O_.shift(),i=gf.from(r,e,t);yield iI(n,()=>n.remoteSyncer.applySuccessfulWrite(i)),yield Xi(n)})}function _b(n,e){return D(this,null,function*(){e&&Hn(n).V_&&(yield function(r,i){return D(this,null,function*(){if(function(o){return CE(o)&&o!==R.ABORTED}(i.code)){let s=r.O_.shift();Hn(r).s_(),yield iI(r,()=>r.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield Xi(r)}})}(n,e)),sI(n)&&oI(n)})}function Dw(n,e){return D(this,null,function*(){let t=L(n);t.asyncQueue.verifyOperationInProgress(),V("RemoteStore","RemoteStore received new credentials");let r=Xn(t);t.L_.add(3),yield Ji(t),r&&t.q_.set("Unknown"),yield t.remoteSyncer.handleCredentialChange(e),t.L_.delete(3),yield sa(t)})}function hm(n,e){return D(this,null,function*(){let t=L(n);e?(t.L_.delete(2),yield sa(t)):e||(t.L_.add(2),yield Ji(t),t.q_.set("Unknown"))})}function Zi(n){return n.K_||(n.K_=function(t,r,i){let s=L(t);return s.w_(),new om(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Eo:lb.bind(null,n),Ro:ub.bind(null,n),mo:cb.bind(null,n),d_:hb.bind(null,n)}),n.B_.push(e=>D(this,null,function*(){e?(n.K_.s_(),ip(n)?rp(n):n.q_.set("Unknown")):(yield n.K_.stop(),rI(n))}))),n.K_}function Hn(n){return n.U_||(n.U_=function(t,r,i){let s=L(t);return s.w_(),new am(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Eo:()=>Promise.resolve(),Ro:mb.bind(null,n),mo:_b.bind(null,n),f_:pb.bind(null,n),g_:gb.bind(null,n)}),n.B_.push(e=>D(this,null,function*(){e?(n.U_.s_(),yield Xi(n)):(yield n.U_.stop(),n.O_.length>0&&(V("RemoteStore",`Stopping write stream with ${n.O_.length} pending writes`),n.O_=[]))}))),n.U_}var dm=class n{constructor(e,t,r,i,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=i,this.removalCallback=s,this.deferred=new Oe,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,i,s){let o=Date.now()+r,a=new n(e,t,o,i,s);return a.start(r),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new k(R.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function es(n,e){if(be("AsyncQueue",`${e}: ${n}`),Jn(n))return new k(R.UNAVAILABLE,`${e}: ${n}`);throw n}var Iu=class n{constructor(e){this.comparator=e?(t,r)=>e(t,r)||U.comparator(t.key,r.key):(t,r)=>U.comparator(t.key,r.key),this.keyedMap=So(),this.sortedSet=new ye(this.comparator)}static emptySet(e){return new n(e.comparator)}has(e){return this.keyedMap.get(e)!=null}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),e.length===0?"DocumentSet ()":`DocumentSet (
  `+e.join(`  
`)+`
)`}copy(e,t){let r=new n;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}};var Tu=class{constructor(){this.W_=new ye(U.comparator)}track(e){let t=e.doc.key,r=this.W_.get(t);r?e.type!==0&&r.type===3?this.W_=this.W_.insert(t,e):e.type===3&&r.type!==1?this.W_=this.W_.insert(t,{type:r.type,doc:e.doc}):e.type===2&&r.type===2?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):e.type===2&&r.type===0?this.W_=this.W_.insert(t,{type:0,doc:e.doc}):e.type===1&&r.type===0?this.W_=this.W_.remove(t):e.type===1&&r.type===2?this.W_=this.W_.insert(t,{type:1,doc:r.doc}):e.type===0&&r.type===1?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):B():this.W_=this.W_.insert(t,e)}G_(){let e=[];return this.W_.inorderTraversal((t,r)=>{e.push(r)}),e}},Ki=class n{constructor(e,t,r,i,s,o,a,u,c){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=s,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=u,this.hasCachedResults=c}static fromInitialDocuments(e,t,r,i,s){let o=[];return t.forEach(a=>{o.push({type:0,doc:a})}),new n(e,t,Iu.emptySet(t),o,r,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&na(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==r[i].type||!t[i].doc.isEqual(r[i].doc))return!1;return!0}};var fm=class{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(e=>e.J_())}},mm=class{constructor(){this.queries=kw(),this.onlineState="Unknown",this.Y_=new Set}terminate(){(function(t,r){let i=L(t),s=i.queries;i.queries=kw(),s.forEach((o,a)=>{for(let u of a.j_)u.onError(r)})})(this,new k(R.ABORTED,"Firestore shutting down"))}};function kw(){return new Jt(n=>dE(n),na)}function sp(n,e){return D(this,null,function*(){let t=L(n),r=3,i=e.query,s=t.queries.get(i);s?!s.H_()&&e.J_()&&(r=2):(s=new fm,r=e.J_()?0:1);try{switch(r){case 0:s.z_=yield t.onListen(i,!0);break;case 1:s.z_=yield t.onListen(i,!1);break;case 2:yield t.onFirstRemoteStoreListen(i)}}catch(o){let a=es(o,`Initialization of query '${Si(e.query)}' failed`);return void e.onError(a)}t.queries.set(i,s),s.j_.push(e),e.Z_(t.onlineState),s.z_&&e.X_(s.z_)&&ap(t)})}function op(n,e){return D(this,null,function*(){let t=L(n),r=e.query,i=3,s=t.queries.get(r);if(s){let o=s.j_.indexOf(e);o>=0&&(s.j_.splice(o,1),s.j_.length===0?i=e.J_()?0:1:!s.H_()&&e.J_()&&(i=2))}switch(i){case 0:return t.queries.delete(r),t.onUnlisten(r,!0);case 1:return t.queries.delete(r),t.onUnlisten(r,!1);case 2:return t.onLastRemoteStoreUnlisten(r);default:return}})}function yb(n,e){let t=L(n),r=!1;for(let i of e){let s=i.query,o=t.queries.get(s);if(o){for(let a of o.j_)a.X_(i)&&(r=!0);o.z_=i}}r&&ap(t)}function vb(n,e,t){let r=L(n),i=r.queries.get(e);if(i)for(let s of i.j_)s.onError(t);r.queries.delete(e)}function ap(n){n.Y_.forEach(e=>{e.next()})}var pm,Vw;(Vw=pm||(pm={})).ea="default",Vw.Cache="cache";var $o=class{constructor(e,t,r){this.query=e,this.ta=t,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=r||{}}X_(e){if(!this.options.includeMetadataChanges){let r=[];for(let i of e.docChanges)i.type!==3&&r.push(i);e=new Ki(e.query,e.docs,e.oldDocs,r,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.na?this.ia(e)&&(this.ta.next(e),t=!0):this.sa(e,this.onlineState)&&(this.oa(e),t=!0),this.ra=e,t}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let t=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),t=!0),t}sa(e,t){if(!e.fromCache||!this.J_())return!0;let r=t!=="Offline";return(!this.options._a||!r)&&(!e.docs.isEmpty()||e.hasCachedResults||t==="Offline")}ia(e){if(e.docChanges.length>0)return!0;let t=this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&this.options.includeMetadataChanges===!0}oa(e){e=Ki.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==pm.Cache}};var gm=class{constructor(e,t){this.aa=e,this.byteLength=t}ua(){return"metadata"in this.aa}};var Su=class{constructor(e){this.serializer=e}Es(e){return Qt(this.serializer,e)}ds(e){return e.metadata.exists?VE(this.serializer,e.document,!1):Fe.newNoDocument(this.Es(e.metadata.name),this.As(e.metadata.readTime))}As(e){return Pe(e)}},_m=class{constructor(e,t,r){this.ca=e,this.localStore=t,this.serializer=r,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=aI(e)}la(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.aa.namedQuery)this.queries.push(e.aa.namedQuery);else if(e.aa.documentMetadata){this.documents.push({metadata:e.aa.documentMetadata}),e.aa.documentMetadata.exists||++t;let r=se.fromString(e.aa.documentMetadata.name);this.collectionGroups.add(r.get(r.length-2))}else e.aa.document&&(this.documents[this.documents.length-1].document=e.aa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ha(e){let t=new Map,r=new Su(this.serializer);for(let i of e)if(i.metadata.queries){let s=r.Es(i.metadata.name);for(let o of i.metadata.queries){let a=(t.get(o)||X()).add(s);t.set(o,a)}}return t}complete(){return D(this,null,function*(){let e=yield sb(this.localStore,new Su(this.serializer),this.documents,this.ca.id),t=this.ha(this.documents);for(let r of this.queries)yield ob(this.localStore,r,t.get(r.name));return this.progress.taskState="Success",{progress:this.progress,Pa:this.collectionGroups,Ia:e}})}};function aI(n){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:n.totalDocuments,totalBytes:n.totalBytes}}var Au=class{constructor(e){this.key=e}},Cu=class{constructor(e){this.key=e}},bu=class{constructor(e,t){this.query=e,this.Ta=t,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=X(),this.mutatedKeys=X(),this.Aa=mE(e),this.Ra=new Iu(this.Aa)}get Va(){return this.Ta}ma(e,t){let r=t?t.fa:new Tu,i=t?t.Ra:this.Ra,s=t?t.mutatedKeys:this.mutatedKeys,o=i,a=!1,u=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,c=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((d,m)=>{let p=i.get(d),y=ra(this.query,m)?m:null,A=!!p&&this.mutatedKeys.has(p.key),x=!!y&&(y.hasLocalMutations||this.mutatedKeys.has(y.key)&&y.hasCommittedMutations),N=!1;p&&y?p.data.isEqual(y.data)?A!==x&&(r.track({type:3,doc:y}),N=!0):this.ga(p,y)||(r.track({type:2,doc:y}),N=!0,(u&&this.Aa(y,u)>0||c&&this.Aa(y,c)<0)&&(a=!0)):!p&&y?(r.track({type:0,doc:y}),N=!0):p&&!y&&(r.track({type:1,doc:p}),N=!0,(u||c)&&(a=!0)),N&&(y?(o=o.add(y),s=x?s.add(d):s.delete(d)):(o=o.delete(d),s=s.delete(d)))}),this.query.limit!==null)for(;o.size>this.query.limit;){let d=this.query.limitType==="F"?o.last():o.first();o=o.delete(d.key),s=s.delete(d.key),r.track({type:1,doc:d})}return{Ra:o,fa:r,ns:a,mutatedKeys:s}}ga(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,i){let s=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;let o=e.fa.G_();o.sort((d,m)=>function(y,A){let x=N=>{switch(N){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return B()}};return x(y)-x(A)}(d.type,m.type)||this.Aa(d.doc,m.doc)),this.pa(r),i=i!=null&&i;let a=t&&!i?this.ya():[],u=this.da.size===0&&this.current&&!i?1:0,c=u!==this.Ea;return this.Ea=u,o.length!==0||c?{snapshot:new Ki(this.query,e.Ra,s,o,e.mutatedKeys,u===0,c,!1,!!r&&r.resumeToken.approximateByteSize()>0),wa:a}:{wa:a}}Z_(e){return this.current&&e==="Offline"?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new Tu,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach(t=>this.Ta=this.Ta.add(t)),e.modifiedDocuments.forEach(t=>{}),e.removedDocuments.forEach(t=>this.Ta=this.Ta.delete(t)),this.current=e.current)}ya(){if(!this.current)return[];let e=this.da;this.da=X(),this.Ra.forEach(r=>{this.Sa(r.key)&&(this.da=this.da.add(r.key))});let t=[];return e.forEach(r=>{this.da.has(r)||t.push(new Cu(r))}),this.da.forEach(r=>{e.has(r)||t.push(new Au(r))}),t}ba(e){this.Ta=e.Ts,this.da=X();let t=this.ma(e.documents);return this.applyChanges(t,!0)}Da(){return Ki.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,this.Ea===0,this.hasCachedResults)}},ym=class{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}},vm=class{constructor(e){this.key=e,this.va=!1}},wm=class{constructor(e,t,r,i,s,o){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=o,this.Ca={},this.Fa=new Jt(a=>dE(a),na),this.Ma=new Map,this.xa=new Set,this.Oa=new ye(U.comparator),this.Na=new Map,this.La=new zo,this.Ba={},this.ka=new Map,this.qa=Bi.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return this.Qa===!0}};function wb(n,e,t=!0){return D(this,null,function*(){let r=qu(n),i,s=r.Fa.get(e);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.Da()):i=yield lI(r,e,t,!0),i})}function Eb(n,e){return D(this,null,function*(){let t=qu(n);yield lI(t,e,!0,!1)})}function lI(n,e,t,r){return D(this,null,function*(){let i=yield qi(n.localStore,st(e)),s=i.targetId,o=t?n.sharedClientState.addLocalQueryTarget(s):"not-current",a;return r&&(a=yield lp(n,e,s,o==="current",i.resumeToken)),n.isPrimaryClient&&t&&Bu(n.remoteStore,i),a})}function lp(n,e,t,r,i){return D(this,null,function*(){n.Ka=(m,p,y)=>function(x,N,q,j){return D(this,null,function*(){let F=N.view.ma(q);F.ns&&(F=yield pu(x.localStore,N.query,!1).then(({documents:E})=>N.view.ma(E,F)));let W=j&&j.targetChanges.get(N.targetId),H=j&&j.targetMismatches.get(N.targetId)!=null,Y=N.view.applyChanges(F,x.isPrimaryClient,W,H);return Em(x,N.targetId,Y.wa),Y.snapshot})}(n,m,p,y);let s=yield pu(n.localStore,e,!0),o=new bu(e,s.Ts),a=o.ma(s.documents),u=qo.createSynthesizedTargetChangeForCurrentChange(t,r&&n.onlineState!=="Offline",i),c=o.applyChanges(a,n.isPrimaryClient,u);Em(n,t,c.wa);let d=new ym(e,t,o);return n.Fa.set(e,d),n.Ma.has(t)?n.Ma.get(t).push(e):n.Ma.set(t,[e]),c.snapshot})}function Ib(n,e,t){return D(this,null,function*(){let r=L(n),i=r.Fa.get(e),s=r.Ma.get(i.targetId);if(s.length>1)return r.Ma.set(i.targetId,s.filter(o=>!na(o,e))),void r.Fa.delete(e);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||(yield ji(r.localStore,i.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(i.targetId),t&&Gi(r.remoteStore,i.targetId),zi(r,i.targetId)}).catch(Yn))):(zi(r,i.targetId),yield ji(r.localStore,i.targetId,!0))})}function Tb(n,e){return D(this,null,function*(){let t=L(n),r=t.Fa.get(e),i=t.Ma.get(r.targetId);t.isPrimaryClient&&i.length===1&&(t.sharedClientState.removeLocalQueryTarget(r.targetId),Gi(t.remoteStore,r.targetId))})}function Sb(n,e,t){return D(this,null,function*(){let r=dp(n);try{let i=yield function(o,a){let u=L(o),c=Te.now(),d=a.reduce((y,A)=>y.add(A.key),X()),m,p;return u.persistence.runTransaction("Locally write mutations","readwrite",y=>{let A=lt(),x=X();return u.cs.getEntries(y,d).next(N=>{A=N,A.forEach((q,j)=>{j.isValidDocument()||(x=x.add(q))})}).next(()=>u.localDocuments.getOverlayedDocuments(y,A)).next(N=>{m=N;let q=[];for(let j of a){let F=LC(j,m.get(j.key).overlayedDocument);F!=null&&q.push(new Nt(j.key,F,sE(F.value.mapValue),Ae.exists(!0)))}return u.mutationQueue.addMutationBatch(y,c,q,a)}).next(N=>{p=N;let q=N.applyToLocalDocumentSet(m,x);return u.documentOverlayCache.saveOverlays(y,N.batchId,q)})}).then(()=>({batchId:p.batchId,changes:gE(m)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(i.batchId),function(o,a,u){let c=o.Ba[o.currentUser.toKey()];c||(c=new ye($)),c=c.insert(a,u),o.Ba[o.currentUser.toKey()]=c}(r,i.batchId,t),yield gn(r,i.changes),yield Xi(r.remoteStore)}catch(i){let s=es(i,"Failed to persist write");t.reject(s)}})}function uI(n,e){return D(this,null,function*(){let t=L(n);try{let r=yield rb(t.localStore,e);e.targetChanges.forEach((i,s)=>{let o=t.Na.get(s);o&&(G(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?o.va=!0:i.modifiedDocuments.size>0?G(o.va):i.removedDocuments.size>0&&(G(o.va),o.va=!1))}),yield gn(t,r,e)}catch(r){yield Yn(r)}})}function Ow(n,e,t){let r=L(n);if(r.isPrimaryClient&&t===0||!r.isPrimaryClient&&t===1){let i=[];r.Fa.forEach((s,o)=>{let a=o.view.Z_(e);a.snapshot&&i.push(a.snapshot)}),function(o,a){let u=L(o);u.onlineState=a;let c=!1;u.queries.forEach((d,m)=>{for(let p of m.j_)p.Z_(a)&&(c=!0)}),c&&ap(u)}(r.eventManager,e),i.length&&r.Ca.d_(i),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}function Ab(n,e,t){return D(this,null,function*(){let r=L(n);r.sharedClientState.updateQueryState(e,"rejected",t);let i=r.Na.get(e),s=i&&i.key;if(s){let o=new ye(U.comparator);o=o.insert(s,Fe.newNoDocument(s,z.min()));let a=X().add(s),u=new Bo(z.min(),new Map,new ye($),o,a);yield uI(r,u),r.Oa=r.Oa.remove(s),r.Na.delete(e),hp(r)}else yield ji(r.localStore,e,!1).then(()=>zi(r,e,t)).catch(Yn)})}function Cb(n,e){return D(this,null,function*(){let t=L(n),r=e.batch.batchId;try{let i=yield nb(t.localStore,e);cp(t,r,null),up(t,r),t.sharedClientState.updateMutationState(r,"acknowledged"),yield gn(t,i)}catch(i){yield Yn(i)}})}function bb(n,e,t){return D(this,null,function*(){let r=L(n);try{let i=yield function(o,a){let u=L(o);return u.persistence.runTransaction("Reject batch","readwrite-primary",c=>{let d;return u.mutationQueue.lookupMutationBatch(c,a).next(m=>(G(m!==null),d=m.keys(),u.mutationQueue.removeMutationBatch(c,m))).next(()=>u.mutationQueue.performConsistencyCheck(c)).next(()=>u.documentOverlayCache.removeOverlaysForBatchId(c,d,a)).next(()=>u.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(c,d)).next(()=>u.localDocuments.getDocuments(c,d))})}(r.localStore,e);cp(r,e,t),up(r,e),r.sharedClientState.updateMutationState(e,"rejected",t),yield gn(r,i)}catch(i){yield Yn(i)}})}function Rb(n,e){return D(this,null,function*(){let t=L(n);Xn(t.remoteStore)||V("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=yield function(o){let a=L(o);return a.persistence.runTransaction("Get highest unacknowledged batch id","readonly",u=>a.mutationQueue.getHighestUnacknowledgedBatchId(u))}(t.localStore);if(r===-1)return void e.resolve();let i=t.ka.get(r)||[];i.push(e),t.ka.set(r,i)}catch(r){let i=es(r,"Initialization of waitForPendingWrites() operation failed");e.reject(i)}})}function up(n,e){(n.ka.get(e)||[]).forEach(t=>{t.resolve()}),n.ka.delete(e)}function cp(n,e,t){let r=L(n),i=r.Ba[r.currentUser.toKey()];if(i){let s=i.get(e);s&&(t?s.reject(t):s.resolve(),i=i.remove(e)),r.Ba[r.currentUser.toKey()]=i}}function zi(n,e,t=null){n.sharedClientState.removeLocalQueryTarget(e);for(let r of n.Ma.get(e))n.Fa.delete(r),t&&n.Ca.$a(r,t);n.Ma.delete(e),n.isPrimaryClient&&n.La.gr(e).forEach(r=>{n.La.containsKey(r)||cI(n,r)})}function cI(n,e){n.xa.delete(e.path.canonicalString());let t=n.Oa.get(e);t!==null&&(Gi(n.remoteStore,t),n.Oa=n.Oa.remove(e),n.Na.delete(t),hp(n))}function Em(n,e,t){for(let r of t)r instanceof Au?(n.La.addReference(r.key,e),Pb(n,r)):r instanceof Cu?(V("SyncEngine","Document no longer in limbo: "+r.key),n.La.removeReference(r.key,e),n.La.containsKey(r.key)||cI(n,r.key)):B()}function Pb(n,e){let t=e.key,r=t.path.canonicalString();n.Oa.get(t)||n.xa.has(r)||(V("SyncEngine","New document in limbo: "+t),n.xa.add(r),hp(n))}function hp(n){for(;n.xa.size>0&&n.Oa.size<n.maxConcurrentLimboResolutions;){let e=n.xa.values().next().value;n.xa.delete(e);let t=new U(se.fromString(e)),r=n.qa.next();n.Na.set(r,new vm(t)),n.Oa=n.Oa.insert(t,r),Bu(n.remoteStore,new Ui(st(Yi(t.path)),r,"TargetPurposeLimboResolution",pt.oe))}}function gn(n,e,t){return D(this,null,function*(){let r=L(n),i=[],s=[],o=[];r.Fa.isEmpty()||(r.Fa.forEach((a,u)=>{o.push(r.Ka(u,e,t).then(c=>{var d;if((c||t)&&r.isPrimaryClient){let m=c?!c.fromCache:(d=t?.targetChanges.get(u.targetId))===null||d===void 0?void 0:d.current;r.sharedClientState.updateQueryState(u.targetId,m?"current":"not-current")}if(c){i.push(c);let m=Zf.Wi(u.targetId,c);s.push(m)}}))}),yield Promise.all(o),r.Ca.d_(i),yield function(u,c){return D(this,null,function*(){let d=L(u);try{yield d.persistence.runTransaction("notifyLocalViewChanges","readwrite",m=>b.forEach(c,p=>b.forEach(p.$i,y=>d.persistence.referenceDelegate.addReference(m,p.targetId,y)).next(()=>b.forEach(p.Ui,y=>d.persistence.referenceDelegate.removeReference(m,p.targetId,y)))))}catch(m){if(!Jn(m))throw m;V("LocalStore","Failed to update sequence numbers: "+m)}for(let m of c){let p=m.targetId;if(!m.fromCache){let y=d.os.get(p),A=y.snapshotVersion,x=y.withLastLimboFreeSnapshotVersion(A);d.os=d.os.insert(p,x)}}})}(r.localStore,s))})}function xb(n,e){return D(this,null,function*(){let t=L(n);if(!t.currentUser.isEqual(e)){V("SyncEngine","User change. New user:",e.toKey());let r=yield HE(t.localStore,e);t.currentUser=e,function(s,o){s.ka.forEach(a=>{a.forEach(u=>{u.reject(new k(R.CANCELLED,o))})}),s.ka.clear()}(t,"'waitForPendingWrites' promise is rejected due to a user change."),t.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),yield gn(t,r.hs)}})}function Nb(n,e){let t=L(n),r=t.Na.get(e);if(r&&r.va)return X().add(r.key);{let i=X(),s=t.Ma.get(e);if(!s)return i;for(let o of s){let a=t.Fa.get(o);i=i.unionWith(a.view.Va)}return i}}function Db(n,e){return D(this,null,function*(){let t=L(n),r=yield pu(t.localStore,e.query,!0),i=e.view.ba(r);return t.isPrimaryClient&&Em(t,e.targetId,i.wa),i})}function kb(n,e){return D(this,null,function*(){let t=L(n);return ZE(t.localStore,e).then(r=>gn(t,r))})}function Vb(n,e,t,r){return D(this,null,function*(){let i=L(n),s=yield function(a,u){let c=L(a),d=L(c.mutationQueue);return c.persistence.runTransaction("Lookup mutation documents","readonly",m=>d.Mn(m,u).next(p=>p?c.localDocuments.getDocuments(m,p):b.resolve(null)))}(i.localStore,e);s!==null?(t==="pending"?yield Xi(i.remoteStore):t==="acknowledged"||t==="rejected"?(cp(i,e,r||null),up(i,e),function(a,u){L(L(a).mutationQueue).On(u)}(i.localStore,e)):B(),yield gn(i,s)):V("SyncEngine","Cannot apply mutation batch with id: "+e)})}function Ob(n,e){return D(this,null,function*(){let t=L(n);if(qu(t),dp(t),e===!0&&t.Qa!==!0){let r=t.sharedClientState.getAllActiveQueryTargets(),i=yield Fw(t,r.toArray());t.Qa=!0,yield hm(t.remoteStore,!0);for(let s of i)Bu(t.remoteStore,s)}else if(e===!1&&t.Qa!==!1){let r=[],i=Promise.resolve();t.Ma.forEach((s,o)=>{t.sharedClientState.isLocalQueryTarget(o)?r.push(o):i=i.then(()=>(zi(t,o),ji(t.localStore,o,!0))),Gi(t.remoteStore,o)}),yield i,yield Fw(t,r),function(o){let a=L(o);a.Na.forEach((u,c)=>{Gi(a.remoteStore,c)}),a.La.pr(),a.Na=new Map,a.Oa=new ye(U.comparator)}(t),t.Qa=!1,yield hm(t.remoteStore,!1)}})}function Fw(n,e,t){return D(this,null,function*(){let r=L(n),i=[],s=[];for(let o of e){let a,u=r.Ma.get(o);if(u&&u.length!==0){a=yield qi(r.localStore,st(u[0]));for(let c of u){let d=r.Fa.get(c),m=yield Db(r,d);m.snapshot&&s.push(m.snapshot)}}else{let c=yield XE(r.localStore,o);a=yield qi(r.localStore,c),yield lp(r,hI(c),o,!1,a.resumeToken)}i.push(a)}return r.Ca.d_(s),i})}function hI(n){return hE(n.path,n.collectionGroup,n.orderBy,n.filters,n.limit,"F",n.startAt,n.endAt)}function Fb(n){return function(t){return L(L(t).persistence).Qi()}(L(n).localStore)}function Mb(n,e,t,r){return D(this,null,function*(){let i=L(n);if(i.Qa)return void V("SyncEngine","Ignoring unexpected query state notification.");let s=i.Ma.get(e);if(s&&s.length>0)switch(t){case"current":case"not-current":{let o=yield ZE(i.localStore,fE(s[0])),a=Bo.createSynthesizedRemoteEventForCurrentChange(e,t==="current",xe.EMPTY_BYTE_STRING);yield gn(i,o,a);break}case"rejected":yield ji(i.localStore,e,!0),zi(i,e,r);break;default:B()}})}function Lb(n,e,t){return D(this,null,function*(){let r=qu(n);if(r.Qa){for(let i of e){if(r.Ma.has(i)&&r.sharedClientState.isActiveQueryTarget(i)){V("SyncEngine","Adding an already active target "+i);continue}let s=yield XE(r.localStore,i),o=yield qi(r.localStore,s);yield lp(r,hI(s),o.targetId,!1,o.resumeToken),Bu(r.remoteStore,o)}for(let i of t)r.Ma.has(i)&&(yield ji(r.localStore,i,!1).then(()=>{Gi(r.remoteStore,i),zi(r,i)}).catch(Yn))}})}function qu(n){let e=L(n);return e.remoteStore.remoteSyncer.applyRemoteEvent=uI.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Nb.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Ab.bind(null,e),e.Ca.d_=yb.bind(null,e.eventManager),e.Ca.$a=vb.bind(null,e.eventManager),e}function dp(n){let e=L(n);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Cb.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=bb.bind(null,e),e}function Ub(n,e,t){let r=L(n);(function(s,o,a){return D(this,null,function*(){try{let u=yield o.getMetadata();if(yield function(y,A){let x=L(y),N=Pe(A.createTime);return x.persistence.runTransaction("hasNewerBundle","readonly",q=>x.Gr.getBundleMetadata(q,A.id)).then(q=>!!q&&q.createTime.compareTo(N)>=0)}(s.localStore,u))return yield o.close(),a._completeWith(function(y){return{taskState:"Success",documentsLoaded:y.totalDocuments,bytesLoaded:y.totalBytes,totalDocuments:y.totalDocuments,totalBytes:y.totalBytes}}(u)),Promise.resolve(new Set);a._updateProgress(aI(u));let c=new _m(u,s.localStore,o.serializer),d=yield o.Ua();for(;d;){let p=yield c.la(d);p&&a._updateProgress(p),d=yield o.Ua()}let m=yield c.complete();return yield gn(s,m.Ia,void 0),yield function(y,A){let x=L(y);return x.persistence.runTransaction("Save bundle","readwrite",N=>x.Gr.saveBundleMetadata(N,A))}(s.localStore,u),a._completeWith(m.progress),Promise.resolve(m.Pa)}catch(u){return St("SyncEngine",`Loading bundle failed with ${u}`),a._failWith(u),Promise.resolve(new Set)}})})(r,e,t).then(i=>{r.sharedClientState.notifyBundleLoaded(i)})}var Ho=class{constructor(){this.synchronizeTabs=!1}initialize(e){return D(this,null,function*(){this.serializer=ia(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),yield this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)})}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return $E(this.persistence,new mu,e.initialUser,this.serializer)}createPersistence(e){return new du(fu.Zr,this.serializer)}createSharedClientState(e){return new yu}terminate(){return D(this,null,function*(){var e,t;(e=this.gcScheduler)===null||e===void 0||e.stop(),(t=this.indexBackfillerScheduler)===null||t===void 0||t.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}};var Ru=class n extends Ho{constructor(e,t,r){super(),this.Wa=e,this.cacheSizeBytes=t,this.forceOwnership=r,this.synchronizeTabs=!1}initialize(e){return D(this,null,function*(){yield Ac(n.prototype,this,"initialize").call(this,e),yield this.Wa.initialize(this,e),yield dp(this.Wa.syncEngine),yield Xi(this.Wa.remoteStore),yield this.persistence.yi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}createLocalStore(e){return $E(this.persistence,new mu,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){let r=this.persistence.referenceDelegate.garbageCollector;return new Mf(r,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){let r=new Zd(t,this.persistence);return new Xd(e.asyncQueue,r)}createPersistence(e){let t=tp(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),r=this.cacheSizeBytes!==void 0?Tt.withCacheSize(this.cacheSizeBytes):Tt.DEFAULT;return new Xf(this.synchronizeTabs,t,e.clientId,r,e.asyncQueue,tI(),Bl(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new yu}},Im=class n extends Ru{constructor(e,t){super(e,t,!1),this.Wa=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}initialize(e){return D(this,null,function*(){yield Ac(n.prototype,this,"initialize").call(this,e);let t=this.Wa.syncEngine;this.sharedClientState instanceof xo&&(this.sharedClientState.syncEngine={no:Vb.bind(null,t),ro:Mb.bind(null,t),io:Lb.bind(null,t),Qi:Fb.bind(null,t),eo:kb.bind(null,t)},yield this.sharedClientState.start()),yield this.persistence.yi(r=>D(this,null,function*(){yield Ob(this.Wa.syncEngine,r),this.gcScheduler&&(r&&!this.gcScheduler.started?this.gcScheduler.start():r||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(r&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():r||this.indexBackfillerScheduler.stop())}))})}createSharedClientState(e){let t=tI();if(!xo.D(t))throw new k(R.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let r=tp(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new xo(t,e.asyncQueue,r,e.clientId,e.initialUser)}},Yo=class{initialize(e,t){return D(this,null,function*(){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=r=>Ow(this.syncEngine,r,1),this.remoteStore.remoteSyncer.handleCredentialChange=xb.bind(null,this.syncEngine),yield hm(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(e){return function(){return new mm}()}createDatastore(e){let t=ia(e.databaseInfo.databaseId),r=function(s){return new sm(s)}(e.databaseInfo);return function(s,o,a,u){return new lm(s,o,a,u)}(e.authCredentials,e.appCheckCredentials,r,t)}createRemoteStore(e){return function(r,i,s,o,a){return new cm(r,i,s,o,a)}(this.localStore,this.datastore,e.asyncQueue,t=>Ow(this.syncEngine,t,0),function(){return vu.D()?new vu:new rm}())}createSyncEngine(e,t){return function(i,s,o,a,u,c,d){let m=new wm(i,s,o,a,u,c);return d&&(m.Qa=!0),m}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return D(this,null,function*(){var e,t;yield function(i){return D(this,null,function*(){let s=L(i);V("RemoteStore","RemoteStore shutting down."),s.L_.add(5),yield Ji(s),s.k_.shutdown(),s.q_.set("Unknown")})}(this.remoteStore),(e=this.datastore)===null||e===void 0||e.terminate(),(t=this.eventManager)===null||t===void 0||t.terminate()})}};function Mw(n,e=10240){let t=0;return{read(){return D(this,null,function*(){if(t<n.byteLength){let i={value:n.slice(t,t+e),done:!1};return t+=e,i}return{done:!0}})},cancel(){return D(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var Wi=class{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ga(this.observer.next,e)}error(e){this.observer.error?this.Ga(this.observer.error,e):be("Uncaught Error in snapshot listener:",e.toString())}za(){this.muted=!0}Ga(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}};var Tm=class{constructor(e,t){this.ja=e,this.serializer=t,this.metadata=new Oe,this.buffer=new Uint8Array,this.Ha=function(){return new TextDecoder("utf-8")}(),this.Ja().then(r=>{r&&r.ua()?this.metadata.resolve(r.aa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(r?.aa)}`))},r=>this.metadata.reject(r))}close(){return this.ja.cancel()}getMetadata(){return D(this,null,function*(){return this.metadata.promise})}Ua(){return D(this,null,function*(){return yield this.getMetadata(),this.Ja()})}Ja(){return D(this,null,function*(){let e=yield this.Ya();if(e===null)return null;let t=this.Ha.decode(e),r=Number(t);isNaN(r)&&this.Za(`length string (${t}) is not valid number`);let i=yield this.Xa(r);return new gm(JSON.parse(i),e.length+r)})}eu(){return this.buffer.findIndex(e=>e===123)}Ya(){return D(this,null,function*(){for(;this.eu()<0&&!(yield this.tu()););if(this.buffer.length===0)return null;let e=this.eu();e<0&&this.Za("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t})}Xa(e){return D(this,null,function*(){for(;this.buffer.length<e;)(yield this.tu())&&this.Za("Reached the end of bundle when more is expected.");let t=this.Ha.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t})}Za(e){throw this.ja.cancel(),new Error(`Invalid bundle format: ${e}`)}tu(){return D(this,null,function*(){let e=yield this.ja.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done})}};var Sm=class{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(e){return D(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new k(R.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=yield function(i,s){return D(this,null,function*(){let o=L(i),a={documents:s.map(m=>jo(o.serializer,m))},u=yield o.Lo("BatchGetDocuments",o.serializer.databaseId,se.emptyPath(),a,s.length),c=new Map;u.forEach(m=>{let p=KC(o.serializer,m);c.set(p.key.toString(),p)});let d=[];return s.forEach(m=>{let p=c.get(m.toString());G(!!p),d.push(p)}),d})}(this.datastore,e);return t.forEach(r=>this.recordVersion(r)),t})}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(r){this.lastTransactionError=r}this.writtenDocs.add(e.toString())}delete(e){this.write(new $n(e,this.precondition(e))),this.writtenDocs.add(e.toString())}commit(){return D(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((t,r)=>{let i=U.fromPath(r);this.mutations.push(new Mo(i,this.precondition(i)))}),yield function(r,i){return D(this,null,function*(){let s=L(r),o={writes:i.map(a=>Go(s.serializer,a))};yield s.Mo("Commit",s.serializer.databaseId,se.emptyPath(),o)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw B();t=z.min()}let r=this.readVersions.get(e.key.toString());if(r){if(!t.isEqual(r))throw new k(R.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(z.min())?Ae.exists(!1):Ae.updateTime(t):Ae.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(z.min()))throw new k(R.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Ae.updateTime(t)}return Ae.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}};var Am=class{constructor(e,t,r,i,s){this.asyncQueue=e,this.datastore=t,this.options=r,this.updateFunction=i,this.deferred=s,this.nu=r.maxAttempts,this.t_=new Qo(this.asyncQueue,"transaction_retry")}ru(){this.nu-=1,this.iu()}iu(){this.t_.Go(()=>D(this,null,function*(){let e=new Sm(this.datastore),t=this.su(e);t&&t.then(r=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(r)}).catch(i=>{this.ou(i)}))}).catch(r=>{this.ou(r)})}))}su(e){try{let t=this.updateFunction(e);return!ea(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}ou(e){this.nu>0&&this._u(e)?(this.nu-=1,this.asyncQueue.enqueueAndForget(()=>(this.iu(),Promise.resolve()))):this.deferred.reject(e)}_u(e){if(e.name==="FirebaseError"){let t=e.code;return t==="aborted"||t==="failed-precondition"||t==="already-exists"||!CE(t)}return!1}};var Cm=class{constructor(e,t,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=i,this.user=Ve.UNAUTHENTICATED,this.clientId=Gl.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(r,s=>D(this,null,function*(){V("FirestoreClient","Received user=",s.uid),yield this.authCredentialListener(s),this.user=s})),this.appCheckCredentials.start(r,s=>(V("FirestoreClient","Received new app check token=",s),this.appCheckCredentialListener(s,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new k(R.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();let e=new Oe;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>D(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){let r=es(t,"Failed to shutdown persistence");e.reject(r)}})),e.promise}};function ql(n,e){return D(this,null,function*(){n.asyncQueue.verifyOperationInProgress(),V("FirestoreClient","Initializing OfflineComponentProvider");let t=n.configuration;yield e.initialize(t);let r=t.initialUser;n.setCredentialChangeListener(i=>D(this,null,function*(){r.isEqual(i)||(yield HE(e.localStore,i),r=i)})),e.persistence.setDatabaseDeletedListener(()=>n.terminate()),n._offlineComponents=e})}function bm(n,e){return D(this,null,function*(){n.asyncQueue.verifyOperationInProgress();let t=yield fp(n);V("FirestoreClient","Initializing OnlineComponentProvider"),yield e.initialize(t,n.configuration),n.setCredentialChangeListener(r=>Dw(e.remoteStore,r)),n.setAppCheckTokenChangeListener((r,i)=>Dw(e.remoteStore,i)),n._onlineComponents=e})}function dI(n){return n.name==="FirebaseError"?n.code===R.FAILED_PRECONDITION||n.code===R.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}function fp(n){return D(this,null,function*(){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){V("FirestoreClient","Using user provided OfflineComponentProvider");try{yield ql(n,n._uninitializedComponentsProvider._offline)}catch(e){let t=e;if(!dI(t))throw t;St("Error using user provided cache. Falling back to memory cache: "+t),yield ql(n,new Ho)}}else V("FirestoreClient","Using default OfflineComponentProvider"),yield ql(n,new Ho);return n._offlineComponents})}function ju(n){return D(this,null,function*(){return n._onlineComponents||(n._uninitializedComponentsProvider?(V("FirestoreClient","Using user provided OnlineComponentProvider"),yield bm(n,n._uninitializedComponentsProvider._online)):(V("FirestoreClient","Using default OnlineComponentProvider"),yield bm(n,new Yo))),n._onlineComponents})}function fI(n){return fp(n).then(e=>e.persistence)}function mp(n){return fp(n).then(e=>e.localStore)}function mI(n){return ju(n).then(e=>e.remoteStore)}function pp(n){return ju(n).then(e=>e.syncEngine)}function Bb(n){return ju(n).then(e=>e.datastore)}function Qi(n){return D(this,null,function*(){let e=yield ju(n),t=e.eventManager;return t.onListen=wb.bind(null,e.syncEngine),t.onUnlisten=Ib.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=Eb.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=Tb.bind(null,e.syncEngine),t})}function qb(n){return n.asyncQueue.enqueue(()=>D(this,null,function*(){let e=yield fI(n),t=yield mI(n);return e.setNetworkEnabled(!0),function(i){let s=L(i);return s.L_.delete(0),sa(s)}(t)}))}function jb(n){return n.asyncQueue.enqueue(()=>D(this,null,function*(){let e=yield fI(n),t=yield mI(n);return e.setNetworkEnabled(!1),function(i){return D(this,null,function*(){let s=L(i);s.L_.add(0),yield Ji(s),s.q_.set("Offline")})}(t)}))}function Gb(n,e){let t=new Oe;return n.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return function(i,s,o){return D(this,null,function*(){try{let a=yield function(c,d){let m=L(c);return m.persistence.runTransaction("read document","readonly",p=>m.localDocuments.getDocument(p,d))}(i,s);a.isFoundDocument()?o.resolve(a):a.isNoDocument()?o.resolve(null):o.reject(new k(R.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(a){let u=es(a,`Failed to get document '${s} from cache`);o.reject(u)}})}(yield mp(n),e,t)})),t.promise}function pI(n,e,t={}){let r=new Oe;return n.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return function(s,o,a,u,c){let d=new Wi({next:p=>{o.enqueueAndForget(()=>op(s,m));let y=p.docs.has(a);!y&&p.fromCache?c.reject(new k(R.UNAVAILABLE,"Failed to get document because the client is offline.")):y&&p.fromCache&&u&&u.source==="server"?c.reject(new k(R.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):c.resolve(p)},error:p=>c.reject(p)}),m=new $o(Yi(a.path),d,{includeMetadataChanges:!0,_a:!0});return sp(s,m)}(yield Qi(n),n.asyncQueue,e,t,r)})),r.promise}function Kb(n,e){let t=new Oe;return n.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return function(i,s,o){return D(this,null,function*(){try{let a=yield pu(i,s,!0),u=new bu(s,a.Ts),c=u.ma(a.documents),d=u.applyChanges(c,!1);o.resolve(d.snapshot)}catch(a){let u=es(a,`Failed to execute query '${s} against cache`);o.reject(u)}})}(yield mp(n),e,t)})),t.promise}function gI(n,e,t={}){let r=new Oe;return n.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return function(s,o,a,u,c){let d=new Wi({next:p=>{o.enqueueAndForget(()=>op(s,m)),p.fromCache&&u.source==="server"?c.reject(new k(R.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):c.resolve(p)},error:p=>c.reject(p)}),m=new $o(a,d,{includeMetadataChanges:!0,_a:!0});return sp(s,m)}(yield Qi(n),n.asyncQueue,e,t,r)})),r.promise}function zb(n,e){let t=new Wi(e);return n.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return function(i,s){L(i).Y_.add(s),s.next()}(yield Qi(n),t)})),()=>{t.za(),n.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return function(i,s){L(i).Y_.delete(s)}(yield Qi(n),t)}))}}function Wb(n,e,t,r){let i=function(o,a){let u;return u=typeof o=="string"?RE().encode(o):o,function(d,m){return new Tm(d,m)}(function(d,m){if(d instanceof Uint8Array)return Mw(d,m);if(d instanceof ArrayBuffer)return Mw(new Uint8Array(d),m);if(d instanceof ReadableStream)return d.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(u),a)}(t,ia(e));n.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){Ub(yield pp(n),i,r)}))}function Qb(n,e){return n.asyncQueue.enqueue(()=>D(this,null,function*(){return function(r,i){let s=L(r);return s.persistence.runTransaction("Get named query","readonly",o=>s.Gr.getNamedQuery(o,i))}(yield mp(n),e)}))}function _I(n){let e={};return n.timeoutSeconds!==void 0&&(e.timeoutSeconds=n.timeoutSeconds),e}var Lw=new Map;function gp(n,e,t){if(!t)throw new k(R.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${e}.`)}function _p(n,e,t,r){if(e===!0&&r===!0)throw new k(R.INVALID_ARGUMENT,`${n} and ${t} cannot be used together.`)}function Uw(n){if(!U.isDocumentKey(n))throw new k(R.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function Bw(n){if(U.isDocumentKey(n))throw new k(R.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${n} has ${n.length}.`)}function Gu(n){if(n===void 0)return"undefined";if(n===null)return"null";if(typeof n=="string")return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if(typeof n=="number"||typeof n=="boolean")return""+n;if(typeof n=="object"){if(n instanceof Array)return"an array";{let e=function(r){return r.constructor?r.constructor.name:null}(n);return e?`a custom ${e} object`:"an object"}}return typeof n=="function"?"a function":B()}function oe(n,e){if("_delegate"in n&&(n=n._delegate),!(n instanceof e)){if(e.name===n.constructor.name)throw new k(R.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let t=Gu(n);throw new k(R.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return n}function yI(n,e){if(e<=0)throw new k(R.INVALID_ARGUMENT,`Function ${n}() requires a positive number, but it was: ${e}.`)}var Pu=class{constructor(e){var t,r;if(e.host===void 0){if(e.ssl!==void 0)throw new k(R.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=(t=e.ssl)===null||t===void 0||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,e.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(e.cacheSizeBytes!==-1&&e.cacheSizeBytes<1048576)throw new k(R.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}_p("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:e.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=_I((r=e.experimentalLongPollingOptions)!==null&&r!==void 0?r:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new k(R.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new k(R.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new k(R.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(r,i){return r.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}},Pr=class{constructor(e,t,r,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Pu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new k(R.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!==void 0}_setSettings(e){if(this._settingsFrozen)throw new k(R.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Pu(e),e.credentials!==void 0&&(this._authCredentials=function(r){if(!r)return new jd;switch(r.type){case"firstParty":return new Wd(r.sessionIndex||"0",r.iamToken||null,r.authTokenFactory||null);case"provider":return r.client;default:throw new k(R.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){let r=Lw.get(t);r&&(V("ComponentProvider","Removing Datastore"),Lw.delete(t),r.terminate())}(this),Promise.resolve()}};function yp(n,e,t,r={}){var i;let s=(n=oe(n,Pr))._getSettings(),o=`${e}:${t}`;if(s.host!=="firestore.googleapis.com"&&s.host!==o&&St("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let a,u;if(typeof r.mockUserToken=="string")a=r.mockUserToken,u=Ve.MOCK_USER;else{a=Da(r.mockUserToken,(i=n._app)===null||i===void 0?void 0:i.options.projectId);let c=r.mockUserToken.sub||r.mockUserToken.user_id;if(!c)throw new k(R.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");u=new Ve(c)}n._authCredentials=new Gd(new jl(a,u))}}var Ge=class n{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new n(this.firestore,e,this._query)}},ge=class n{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new $t(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new n(this.firestore,e,this._key)}},$t=class n extends Ge{constructor(e,t,r){super(e,t,Yi(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new ge(this.firestore,null,new U(e))}withConverter(e){return new n(this.firestore,e,this._path)}};function vp(n,e,...t){if(n=ne(n),gp("collection","path",e),n instanceof Pr){let r=se.fromString(e,...t);return Bw(r),new $t(n,null,r)}{if(!(n instanceof ge||n instanceof $t))throw new k(R.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(se.fromString(e,...t));return Bw(r),new $t(n.firestore,null,r)}}function vI(n,e){if(n=oe(n,Pr),gp("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new k(R.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ge(n,null,function(r){return new xt(se.emptyPath(),r)}(e))}function oa(n,e,...t){if(n=ne(n),arguments.length===1&&(e=Gl.newId()),gp("doc","path",e),n instanceof Pr){let r=se.fromString(e,...t);return Uw(r),new ge(n,null,new U(r))}{if(!(n instanceof ge||n instanceof $t))throw new k(R.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(se.fromString(e,...t));return Uw(r),new ge(n.firestore,n instanceof $t?n.converter:null,new U(r))}}function wp(n,e){return n=ne(n),e=ne(e),(n instanceof ge||n instanceof $t)&&(e instanceof ge||e instanceof $t)&&n.firestore===e.firestore&&n.path===e.path&&n.converter===e.converter}function Ep(n,e){return n=ne(n),e=ne(e),n instanceof Ge&&e instanceof Ge&&n.firestore===e.firestore&&na(n._query,e._query)&&n.converter===e.converter}var Rm=class{constructor(){this.au=Promise.resolve(),this.uu=[],this.cu=!1,this.lu=[],this.hu=null,this.Pu=!1,this.Iu=!1,this.Tu=[],this.t_=new Qo(this,"async_queue_retry"),this.Eu=()=>{let t=Bl();t&&V("AsyncQueue","Visibility state changed to "+t.visibilityState),this.t_.jo()};let e=Bl();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.Eu)}get isShuttingDown(){return this.cu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.du(),this.Au(e)}enterRestrictedMode(e){if(!this.cu){this.cu=!0,this.Iu=e||!1;let t=Bl();t&&typeof t.removeEventListener=="function"&&t.removeEventListener("visibilitychange",this.Eu)}}enqueue(e){if(this.du(),this.cu)return new Promise(()=>{});let t=new Oe;return this.Au(()=>this.cu&&this.Iu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.uu.push(e),this.Ru()))}Ru(){return D(this,null,function*(){if(this.uu.length!==0){try{yield this.uu[0](),this.uu.shift(),this.t_.reset()}catch(e){if(!Jn(e))throw e;V("AsyncQueue","Operation failed with retryable error: "+e)}this.uu.length>0&&this.t_.Go(()=>this.Ru())}})}Au(e){let t=this.au.then(()=>(this.Pu=!0,e().catch(r=>{this.hu=r,this.Pu=!1;let i=function(o){let a=o.message||"";return o.stack&&(a=o.stack.includes(o.message)?o.stack:o.message+`
`+o.stack),a}(r);throw be("INTERNAL UNHANDLED ERROR: ",i),r}).then(r=>(this.Pu=!1,r))));return this.au=t,t}enqueueAfterDelay(e,t,r){this.du(),this.Tu.indexOf(e)>-1&&(t=0);let i=dm.createAndSchedule(this,e,t,r,s=>this.Vu(s));return this.lu.push(i),i}du(){this.hu&&B()}verifyOperationInProgress(){}mu(){return D(this,null,function*(){let e;do e=this.au,yield e;while(e!==this.au)})}fu(e){for(let t of this.lu)if(t.timerId===e)return!0;return!1}gu(e){return this.mu().then(()=>{this.lu.sort((t,r)=>t.targetTimeMs-r.targetTimeMs);for(let t of this.lu)if(t.skipDelay(),e!=="all"&&t.timerId===e)break;return this.mu()})}pu(e){this.Tu.push(e)}Vu(e){let t=this.lu.indexOf(e);this.lu.splice(t,1)}};function Pm(n){return function(t,r){if(typeof t!="object"||t===null)return!1;let i=t;for(let s of r)if(s in i&&typeof i[s]=="function")return!0;return!1}(n,["next","error","complete"])}var xm=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new Oe,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,r){this._progressObserver={next:e,error:t,complete:r}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}};var wI=-1,Ee=class extends Pr{constructor(e,t,r,i){super(e,t,r,i),this.type="firestore",this._queue=function(){return new Rm}(),this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return this._firestoreClient||EI(this),this._firestoreClient.terminate()}};function gP(n,e){let t=typeof n=="object"?n:Oc(),r=typeof n=="string"?n:e||"(default)",i=Vc(t,"firestore").getImmediate({identifier:r});if(!i._initialized){let s=Rc("firestore");s&&yp(i,...s)}return i}function Ue(n){return n._firestoreClient||EI(n),n._firestoreClient.verifyNotTerminated(),n._firestoreClient}function EI(n){var e,t,r;let i=n._freezeSettings(),s=function(a,u,c,d){return new ef(a,u,c,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,_I(d.experimentalLongPollingOptions),d.useFetchStreams)}(n._databaseId,((e=n._app)===null||e===void 0?void 0:e.options.appId)||"",n._persistenceKey,i);n._firestoreClient=new Cm(n._authCredentials,n._appCheckCredentials,n._queue,s),!((t=i.localCache)===null||t===void 0)&&t._offlineComponentProvider&&(!((r=i.localCache)===null||r===void 0)&&r._onlineComponentProvider)&&(n._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function II(n,e){NI(n=oe(n,Ee));let t=Ue(n);if(t._uninitializedComponentsProvider)throw new k(R.FAILED_PRECONDITION,"SDK cache is already specified.");St("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let r=n._freezeSettings(),i=new Yo;return SI(t,i,new Ru(i,r.cacheSizeBytes,e?.forceOwnership))}function TI(n){NI(n=oe(n,Ee));let e=Ue(n);if(e._uninitializedComponentsProvider)throw new k(R.FAILED_PRECONDITION,"SDK cache is already specified.");St("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=n._freezeSettings(),r=new Yo;return SI(e,r,new Im(r,t.cacheSizeBytes))}function SI(n,e,t){let r=new Oe;return n.asyncQueue.enqueue(()=>D(this,null,function*(){try{yield ql(n,t),yield bm(n,e),r.resolve()}catch(i){let s=i;if(!dI(s))throw s;St("Error enabling indexeddb cache. Falling back to memory cache: "+s),r.reject(s)}})).then(()=>r.promise)}function AI(n){if(n._initialized&&!n._terminated)throw new k(R.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let e=new Oe;return n._queue.enqueueAndForgetEvenWhileRestricted(()=>D(this,null,function*(){try{yield function(r){return D(this,null,function*(){if(!qn.D())return Promise.resolve();let i=r+"main";yield qn.delete(i)})}(tp(n._databaseId,n._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function CI(n){return function(t){let r=new Oe;return t.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return Rb(yield pp(t),r)})),r.promise}(Ue(n=oe(n,Ee)))}function bI(n){return qb(Ue(n=oe(n,Ee)))}function RI(n){return jb(Ue(n=oe(n,Ee)))}function PI(n,e){let t=Ue(n=oe(n,Ee)),r=new xm;return Wb(t,n._databaseId,e,r),r}function xI(n,e){return Qb(Ue(n=oe(n,Ee)),e).then(t=>t?new Ge(n,null,t.query):null)}function NI(n){if(n._initialized||n._terminated)throw new k(R.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var Xt=class n{constructor(e){this._byteString=e}static fromBase64String(e){try{return new n(xe.fromBase64String(e))}catch(t){throw new k(R.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new n(xe.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}};var Dt=class{constructor(...e){for(let t=0;t<e.length;++t)if(e[t].length===0)throw new k(R.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Re(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}};var mn=class{constructor(e){this._methodName=e}};var xr=class{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new k(R.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new k(R.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return $(this._lat,e._lat)||$(this._long,e._long)}};var Jo=class{constructor(e){this._values=(e||[]).map(t=>t)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(r,i){if(r.length!==i.length)return!1;for(let s=0;s<r.length;++s)if(r[s]!==i[s])return!1;return!0}(this._values,e._values)}};var $b=/^__.*__$/,Nm=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return this.fieldMask!==null?new Nt(e,this.data,this.fieldMask,t,this.fieldTransforms):new Qn(e,this.data,t,this.fieldTransforms)}},xu=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return new Nt(e,this.data,this.fieldMask,t,this.fieldTransforms)}};function DI(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw B()}}var Nu=class n{constructor(e,t,r,i,s,o){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=i,s===void 0&&this.yu(),this.fieldTransforms=s||[],this.fieldMask=o||[]}get path(){return this.settings.path}get wu(){return this.settings.wu}Su(e){return new n(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}bu(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.Su({path:r,Du:!1});return i.vu(e),i}Cu(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.Su({path:r,Du:!1});return i.yu(),i}Fu(e){return this.Su({path:void 0,Du:!0})}Mu(e){return Du(e,this.settings.methodName,this.settings.xu||!1,this.path,this.settings.Ou)}contains(e){return this.fieldMask.find(t=>e.isPrefixOf(t))!==void 0||this.fieldTransforms.find(t=>e.isPrefixOf(t.field))!==void 0}yu(){if(this.path)for(let e=0;e<this.path.length;e++)this.vu(this.path.get(e))}vu(e){if(e.length===0)throw this.Mu("Document fields must not be empty");if(DI(this.wu)&&$b.test(e))throw this.Mu('Document fields cannot begin and end with "__"')}},Dm=class{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||ia(e)}Nu(e,t,r,i=!1){return new Nu({wu:e,methodName:t,Ou:r,path:Re.emptyPath(),Du:!1,xu:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function Vr(n){let e=n._freezeSettings(),t=ia(n._databaseId);return new Dm(n._databaseId,!!e.ignoreUndefinedProperties,t)}function Ku(n,e,t,r,i,s={}){let o=n.Nu(s.merge||s.mergeFields?2:0,e,t,i);Sp("Data must be an object, but it was:",o,r);let a=OI(r,o),u,c;if(s.merge)u=new gt(o.fieldMask),c=o.fieldTransforms;else if(s.mergeFields){let d=[];for(let m of s.mergeFields){let p=Mm(e,m,t);if(!o.contains(p))throw new k(R.INVALID_ARGUMENT,`Field '${p}' is specified in your field mask but missing from your input data.`);MI(d,p)||d.push(p)}u=new gt(d),c=o.fieldTransforms.filter(m=>u.covers(m.field))}else u=null,c=o.fieldTransforms;return new Nm(new Ye(a),u,c)}var Xo=class n extends mn{_toFieldTransform(e){if(e.wu!==2)throw e.wu===1?e.Mu(`${this._methodName}() can only appear at the top level of your update data`):e.Mu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof n}};function kI(n,e,t){return new Nu({wu:3,Ou:e.settings.Ou,methodName:n._methodName,Du:t},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}var km=class n extends mn{_toFieldTransform(e){return new Cr(e.path,new zn)}isEqual(e){return e instanceof n}},Vm=class n extends mn{constructor(e,t){super(e),this.Lu=t}_toFieldTransform(e){let t=kI(this,e,!0),r=this.Lu.map(s=>Or(s,t)),i=new dn(r);return new Cr(e.path,i)}isEqual(e){return e instanceof n&&Nc(this.Lu,e.Lu)}},Om=class n extends mn{constructor(e,t){super(e),this.Lu=t}_toFieldTransform(e){let t=kI(this,e,!0),r=this.Lu.map(s=>Or(s,t)),i=new fn(r);return new Cr(e.path,i)}isEqual(e){return e instanceof n&&Nc(this.Lu,e.Lu)}},Fm=class n extends mn{constructor(e,t){super(e),this.Bu=t}_toFieldTransform(e){let t=new Wn(e.serializer,vE(e.serializer,this.Bu));return new Cr(e.path,t)}isEqual(e){return e instanceof n&&this.Bu===e.Bu}};function Ip(n,e,t,r){let i=n.Nu(1,e,t);Sp("Data must be an object, but it was:",i,r);let s=[],o=Ye.empty();kr(r,(u,c)=>{let d=Ap(e,u,t);c=ne(c);let m=i.Cu(d);if(c instanceof Xo)s.push(d);else{let p=Or(c,m);p!=null&&(s.push(d),o.set(d,p))}});let a=new gt(s);return new xu(o,a,i.fieldTransforms)}function Tp(n,e,t,r,i,s){let o=n.Nu(1,e,t),a=[Mm(e,r,t)],u=[i];if(s.length%2!=0)throw new k(R.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let p=0;p<s.length;p+=2)a.push(Mm(e,s[p])),u.push(s[p+1]);let c=[],d=Ye.empty();for(let p=a.length-1;p>=0;--p)if(!MI(c,a[p])){let y=a[p],A=u[p];A=ne(A);let x=o.Cu(y);if(A instanceof Xo)c.push(y);else{let N=Or(A,x);N!=null&&(c.push(y),d.set(y,N))}}let m=new gt(c);return new xu(d,m,o.fieldTransforms)}function VI(n,e,t,r=!1){return Or(t,n.Nu(r?4:3,e))}function Or(n,e){if(FI(n=ne(n)))return Sp("Unsupported field value:",e,n),OI(n,e);if(n instanceof mn)return function(r,i){if(!DI(i.wu))throw i.Mu(`${r._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Mu(`${r._methodName}() is not currently supported inside arrays`);let s=r._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(n,e),null;if(n===void 0&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),n instanceof Array){if(e.settings.Du&&e.wu!==4)throw e.Mu("Nested arrays are not supported");return function(r,i){let s=[],o=0;for(let a of r){let u=Or(a,i.Fu(o));u==null&&(u={nullValue:"NULL_VALUE"}),s.push(u),o++}return{arrayValue:{values:s}}}(n,e)}return function(r,i){if((r=ne(r))===null)return{nullValue:"NULL_VALUE"};if(typeof r=="number")return vE(i.serializer,r);if(typeof r=="boolean")return{booleanValue:r};if(typeof r=="string")return{stringValue:r};if(r instanceof Date){let s=Te.fromDate(r);return{timestampValue:Li(i.serializer,s)}}if(r instanceof Te){let s=new Te(r.seconds,1e3*Math.floor(r.nanoseconds/1e3));return{timestampValue:Li(i.serializer,s)}}if(r instanceof xr)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof Xt)return{bytesValue:PE(i.serializer,r._byteString)};if(r instanceof ge){let s=i.databaseId,o=r.firestore._databaseId;if(!o.isEqual(s))throw i.Mu(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:Xm(r.firestore._databaseId||i.databaseId,r._key.path)}}if(r instanceof Jo)return function(o,a){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:o.toArray().map(u=>{if(typeof u!="number")throw a.Mu("VectorValues must only contain numeric values.");return Jm(a.serializer,u)})}}}}}}(r,i);throw i.Mu(`Unsupported field value: ${Gu(r)}`)}(n,e)}function OI(n,e){let t={};return tE(n)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):kr(n,(r,i)=>{let s=Or(i,e.bu(r));s!=null&&(t[r]=s)}),{mapValue:{fields:t}}}function FI(n){return!(typeof n!="object"||n===null||n instanceof Array||n instanceof Date||n instanceof Te||n instanceof xr||n instanceof Xt||n instanceof ge||n instanceof mn||n instanceof Jo)}function Sp(n,e,t){if(!FI(t)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(t)){let r=Gu(t);throw r==="an object"?e.Mu(n+" a custom object"):e.Mu(n+" "+r)}}function Mm(n,e,t){if((e=ne(e))instanceof Dt)return e._internalPath;if(typeof e=="string")return Ap(n,e);throw Du("Field path arguments must be of type string or ",n,!1,void 0,t)}var Hb=new RegExp("[~\\*/\\[\\]]");function Ap(n,e,t){if(e.search(Hb)>=0)throw Du(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,t);try{return new Dt(...e.split("."))._internalPath}catch{throw Du(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,t)}}function Du(n,e,t,r,i){let s=r&&!r.isEmpty(),o=i!==void 0,a=`Function ${e}() called with invalid data`;t&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(s||o)&&(u+=" (found",s&&(u+=` in field ${r}`),o&&(u+=` in document ${i}`),u+=")"),new k(R.INVALID_ARGUMENT,a+n+u)}function MI(n,e){return n.some(t=>t.isEqual(e))}var Nr=class{constructor(e,t,r,i,s){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new ge(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let e=new Lm(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(zu("DocumentSnapshot.get",e));if(t!==null)return this._userDataWriter.convertValue(t)}}},Lm=class extends Nr{data(){return super.data()}};function zu(n,e){return typeof e=="string"?Ap(n,e):e instanceof Dt?e._internalPath:e._delegate._internalPath}function LI(n){if(n.limitType==="L"&&n.explicitOrderBy.length===0)throw new k(R.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var Zo=class{},Dr=class extends Zo{};function _n(n,e,...t){let r=[];e instanceof Zo&&r.push(e),r=r.concat(t),function(s){let o=s.filter(u=>u instanceof Um).length,a=s.filter(u=>u instanceof ku).length;if(o>1||o>0&&a>0)throw new k(R.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(let i of r)n=i._apply(n);return n}var ku=class n extends Dr{constructor(e,t,r){super(),this._field=e,this._op=t,this._value=r,this.type="where"}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=this._parse(e);return $I(e._query,t),new Ge(e.firestore,e.converter,mf(e._query,t))}_parse(e){let t=Vr(e.firestore);return function(s,o,a,u,c,d,m){let p;if(c.isKeyField()){if(d==="array-contains"||d==="array-contains-any")throw new k(R.INVALID_ARGUMENT,`Invalid Query. You can't perform '${d}' queries on documentId().`);if(d==="in"||d==="not-in"){jw(m,d);let y=[];for(let A of m)y.push(qw(u,s,A));p={arrayValue:{values:y}}}else p=qw(u,s,m)}else d!=="in"&&d!=="not-in"&&d!=="array-contains-any"||jw(m,d),p=VI(a,o,m,d==="in"||d==="not-in");return re.create(c,d,p)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}};function UI(n,e,t){let r=e,i=zu("where",n);return ku._create(i,r,t)}var Um=class n extends Zo{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new n(e,t)}_parse(e){let t=this._queryConstraints.map(r=>r._parse(e)).filter(r=>r.getFilters().length>0);return t.length===1?t[0]:ce.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return t.getFilters().length===0?e:(function(i,s){let o=i,a=s.getFlattenedFilters();for(let u of a)$I(o,u),o=mf(o,u)}(e._query,t),new Ge(e.firestore,e.converter,mf(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var Bm=class n extends Dr{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new n(e,t)}_apply(e){let t=function(i,s,o){if(i.startAt!==null)throw new k(R.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new k(R.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Sr(s,o)}(e._query,this._field,this._direction);return new Ge(e.firestore,e.converter,function(i,s){let o=i.explicitOrderBy.concat([s]);return new xt(i.path,i.collectionGroup,o,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(e._query,t))}};function BI(n,e="asc"){let t=e,r=zu("orderBy",n);return Bm._create(r,t)}var Vu=class n extends Dr{constructor(e,t,r){super(),this.type=e,this._limit=t,this._limitType=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){return new Ge(e.firestore,e.converter,Zl(e._query,this._limit,this._limitType))}};function qI(n){return yI("limit",n),Vu._create("limit",n,"F")}function jI(n){return yI("limitToLast",n),Vu._create("limitToLast",n,"L")}var Ou=class n extends Dr{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=QI(e,this.type,this._docOrFields,this._inclusive);return new Ge(e.firestore,e.converter,function(i,s){return new xt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(e._query,t))}};function GI(...n){return Ou._create("startAt",n,!0)}function KI(...n){return Ou._create("startAfter",n,!1)}var Fu=class n extends Dr{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=QI(e,this.type,this._docOrFields,this._inclusive);return new Ge(e.firestore,e.converter,function(i,s){return new xt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(e._query,t))}};function zI(...n){return Fu._create("endBefore",n,!1)}function WI(...n){return Fu._create("endAt",n,!0)}function QI(n,e,t,r){if(t[0]=ne(t[0]),t[0]instanceof Nr)return function(s,o,a,u,c){if(!u)throw new k(R.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);let d=[];for(let m of xi(s))if(m.field.isKeyField())d.push(Tr(o,u.key));else{let p=u.data.field(m.field);if(Lu(p))throw new k(R.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+m.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(p===null){let y=m.field.canonicalString();throw new k(R.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${y}' (used as the orderBy) does not exist.`)}d.push(p)}return new Yt(d,c)}(n._query,n.firestore._databaseId,e,t[0]._document,r);{let i=Vr(n.firestore);return function(o,a,u,c,d,m){let p=o.explicitOrderBy;if(d.length>p.length)throw new k(R.INVALID_ARGUMENT,`Too many arguments provided to ${c}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let y=[];for(let A=0;A<d.length;A++){let x=d[A];if(p[A].field.isKeyField()){if(typeof x!="string")throw new k(R.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${c}(), but got a ${typeof x}`);if(!Hm(o)&&x.indexOf("/")!==-1)throw new k(R.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${c}() must be a plain document ID, but '${x}' contains a slash.`);let N=o.path.child(se.fromString(x));if(!U.isDocumentKey(N))throw new k(R.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${c}() must result in a valid document path, but '${N}' is not because it contains an odd number of segments.`);let q=new U(N);y.push(Tr(a,q))}else{let N=VI(u,c,x);y.push(N)}}return new Yt(y,m)}(n._query,n.firestore._databaseId,i,e,t,r)}}function qw(n,e,t){if(typeof(t=ne(t))=="string"){if(t==="")throw new k(R.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Hm(e)&&t.indexOf("/")!==-1)throw new k(R.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${t}' contains a '/' character.`);let r=e.path.child(se.fromString(t));if(!U.isDocumentKey(r))throw new k(R.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Tr(n,new U(r))}if(t instanceof ge)return Tr(n,t._key);throw new k(R.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Gu(t)}.`)}function jw(n,e){if(!Array.isArray(n)||n.length===0)throw new k(R.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function $I(n,e){let t=function(i,s){for(let o of i)for(let a of o.getFlattenedFilters())if(s.indexOf(a.op)>=0)return a.op;return null}(n.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(t!==null)throw t===e.op?new k(R.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new k(R.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${t.toString()}' filters.`)}var $i=class{convertValue(e,t="none"){switch(Ir(e)){case 0:return null;case 1:return e.booleanValue;case 2:return we(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(jn(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw B()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let r={};return kr(e,(i,s)=>{r[i]=this.convertValue(s,t)}),r}convertVectorValue(e){var t,r,i;let s=(i=(r=(t=e.fields)===null||t===void 0?void 0:t.value.arrayValue)===null||r===void 0?void 0:r.values)===null||i===void 0?void 0:i.map(o=>we(o.doubleValue));return new Jo(s)}convertGeoPoint(e){return new xr(we(e.latitude),we(e.longitude))}convertArray(e,t){return(e.values||[]).map(r=>this.convertValue(r,t))}convertServerTimestamp(e,t){switch(t){case"previous":let r=Qm(e);return r==null?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(Vo(e));default:return null}}convertTimestamp(e){let t=hn(e);return new Te(t.seconds,t.nanos)}convertDocumentKey(e,t){let r=se.fromString(e);G(BE(r));let i=new Gn(r.get(1),r.get(3)),s=new U(r.popFirst(5));return i.isEqual(t)||be(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}};function Wu(n,e,t){let r;return r=n?t&&(t.merge||t.mergeFields)?n.toFirestore(e,t):n.toFirestore(e):e,r}var qm=class extends $i{constructor(e){super(),this.firestore=e}convertBytes(e){return new Xt(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new ge(this.firestore,null,t)}};var cn=class{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}},Ct=class extends Nr{constructor(e,t,r,i,s,o){super(e,t,r,i,o),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new Un(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let r=this._document.data.field(zu("DocumentSnapshot.get",e));if(r!==null)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}},Un=class extends Ct{data(e={}){return super.data(e)}},kt=class{constructor(e,t,r,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new cn(i.hasPendingWrites,i.fromCache),this.query=r}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(e,t){this._snapshot.docs.forEach(r=>{e.call(t,new Un(this._firestore,this._userDataWriter,r.key,r,new cn(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new k(R.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let o=0;return i._snapshot.docChanges.map(a=>{let u=new Un(i._firestore,i._userDataWriter,a.doc.key,a.doc,new cn(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter);return a.doc,{type:"added",doc:u,oldIndex:-1,newIndex:o++}})}{let o=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(a=>s||a.type!==3).map(a=>{let u=new Un(i._firestore,i._userDataWriter,a.doc.key,a.doc,new cn(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter),c=-1,d=-1;return a.type!==0&&(c=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),d=o.indexOf(a.doc.key)),{type:Yb(a.type),doc:u,oldIndex:c,newIndex:d}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}};function Yb(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return B()}}function Cp(n,e){return n instanceof Ct&&e instanceof Ct?n._firestore===e._firestore&&n._key.isEqual(e._key)&&(n._document===null?e._document===null:n._document.isEqual(e._document))&&n._converter===e._converter:n instanceof kt&&e instanceof kt&&n._firestore===e._firestore&&Ep(n.query,e.query)&&n.metadata.isEqual(e.metadata)&&n._snapshot.isEqual(e._snapshot)}function HI(n){n=oe(n,ge);let e=oe(n.firestore,Ee);return pI(Ue(e),n._key).then(t=>xp(e,n,t))}var pn=class extends $i{constructor(e){super(),this.firestore=e}convertBytes(e){return new Xt(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new ge(this.firestore,null,t)}};function YI(n){n=oe(n,ge);let e=oe(n.firestore,Ee),t=Ue(e),r=new pn(e);return Gb(t,n._key).then(i=>new Ct(e,r,n._key,i,new cn(i!==null&&i.hasLocalMutations,!0),n.converter))}function JI(n){n=oe(n,ge);let e=oe(n.firestore,Ee);return pI(Ue(e),n._key,{source:"server"}).then(t=>xp(e,n,t))}function XI(n){n=oe(n,Ge);let e=oe(n.firestore,Ee),t=Ue(e),r=new pn(e);return LI(n._query),gI(t,n._query).then(i=>new kt(e,r,n,i))}function ZI(n){n=oe(n,Ge);let e=oe(n.firestore,Ee),t=Ue(e),r=new pn(e);return Kb(t,n._query).then(i=>new kt(e,r,n,i))}function eT(n){n=oe(n,Ge);let e=oe(n.firestore,Ee),t=Ue(e),r=new pn(e);return gI(t,n._query,{source:"server"}).then(i=>new kt(e,r,n,i))}function bp(n,e,t){n=oe(n,ge);let r=oe(n.firestore,Ee),i=Wu(n.converter,e,t);return ts(r,[Ku(Vr(r),"setDoc",n._key,i,n.converter!==null,t).toMutation(n._key,Ae.none())])}function Rp(n,e,t,...r){n=oe(n,ge);let i=oe(n.firestore,Ee),s=Vr(i),o;return o=typeof(e=ne(e))=="string"||e instanceof Dt?Tp(s,"updateDoc",n._key,e,t,r):Ip(s,"updateDoc",n._key,e),ts(i,[o.toMutation(n._key,Ae.exists(!0))])}function tT(n){return ts(oe(n.firestore,Ee),[new $n(n._key,Ae.none())])}function nT(n,e){let t=oe(n.firestore,Ee),r=oa(n),i=Wu(n.converter,e);return ts(t,[Ku(Vr(n.firestore),"addDoc",r._key,i,n.converter!==null,{}).toMutation(r._key,Ae.exists(!1))]).then(()=>r)}function Pp(n,...e){var t,r,i;n=ne(n);let s={includeMetadataChanges:!1,source:"default"},o=0;typeof e[o]!="object"||Pm(e[o])||(s=e[o],o++);let a={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(Pm(e[o])){let m=e[o];e[o]=(t=m.next)===null||t===void 0?void 0:t.bind(m),e[o+1]=(r=m.error)===null||r===void 0?void 0:r.bind(m),e[o+2]=(i=m.complete)===null||i===void 0?void 0:i.bind(m)}let u,c,d;if(n instanceof ge)c=oe(n.firestore,Ee),d=Yi(n._key.path),u={next:m=>{e[o]&&e[o](xp(c,n,m))},error:e[o+1],complete:e[o+2]};else{let m=oe(n,Ge);c=oe(m.firestore,Ee),d=m._query;let p=new pn(c);u={next:y=>{e[o]&&e[o](new kt(c,p,m,y))},error:e[o+1],complete:e[o+2]},LI(n._query)}return function(p,y,A,x){let N=new Wi(x),q=new $o(y,N,A);return p.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return sp(yield Qi(p),q)})),()=>{N.za(),p.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return op(yield Qi(p),q)}))}}(Ue(c),d,a,u)}function rT(n,e){return zb(Ue(n=oe(n,Ee)),Pm(e)?e:{next:e})}function ts(n,e){return function(r,i){let s=new Oe;return r.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){return Sb(yield pp(r),i,s)})),s.promise}(Ue(n),e)}function xp(n,e,t){let r=t.docs.get(e._key),i=new pn(n);return new Ct(n,i,e._key,r,new cn(t.hasPendingWrites,t.fromCache),e.converter)}var Jb={maxAttempts:5};var Mu=class{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Vr(e)}set(e,t,r){this._verifyNotCommitted();let i=Mn(e,this._firestore),s=Wu(i.converter,t,r),o=Ku(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,r);return this._mutations.push(o.toMutation(i._key,Ae.none())),this}update(e,t,r,...i){this._verifyNotCommitted();let s=Mn(e,this._firestore),o;return o=typeof(t=ne(t))=="string"||t instanceof Dt?Tp(this._dataReader,"WriteBatch.update",s._key,t,r,i):Ip(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(o.toMutation(s._key,Ae.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=Mn(e,this._firestore);return this._mutations=this._mutations.concat(new $n(t._key,Ae.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new k(R.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function Mn(n,e){if((n=ne(n)).firestore!==e)throw new k(R.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return n}var jm=class extends class{constructor(t,r){this._firestore=t,this._transaction=r,this._dataReader=Vr(t)}get(t){let r=Mn(t,this._firestore),i=new qm(this._firestore);return this._transaction.lookup([r._key]).then(s=>{if(!s||s.length!==1)return B();let o=s[0];if(o.isFoundDocument())return new Nr(this._firestore,i,o.key,o,r.converter);if(o.isNoDocument())return new Nr(this._firestore,i,r._key,null,r.converter);throw B()})}set(t,r,i){let s=Mn(t,this._firestore),o=Wu(s.converter,r,i),a=Ku(this._dataReader,"Transaction.set",s._key,o,s.converter!==null,i);return this._transaction.set(s._key,a),this}update(t,r,i,...s){let o=Mn(t,this._firestore),a;return a=typeof(r=ne(r))=="string"||r instanceof Dt?Tp(this._dataReader,"Transaction.update",o._key,r,i,s):Ip(this._dataReader,"Transaction.update",o._key,r),this._transaction.update(o._key,a),this}delete(t){let r=Mn(t,this._firestore);return this._transaction.delete(r._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=Mn(e,this._firestore),r=new pn(this._firestore);return super.get(e).then(i=>new Ct(this._firestore,r,t._key,i._document,new cn(!1,!1),t.converter))}};function iT(n,e,t){n=oe(n,Ee);let r=Object.assign(Object.assign({},Jb),t);return function(s){if(s.maxAttempts<1)throw new k(R.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(s,o,a){let u=new Oe;return s.asyncQueue.enqueueAndForget(()=>D(this,null,function*(){let c=yield Bb(s);new Am(s.asyncQueue,c,a,o,u).ru()})),u.promise}(Ue(n),i=>e(new jm(n,i)),r)}function sT(){return new Xo("deleteField")}function oT(){return new km("serverTimestamp")}function aT(...n){return new Vm("arrayUnion",n)}function lT(...n){return new Om("arrayRemove",n)}function uT(n){return new Fm("increment",n)}(function(e,t=!0){(function(i){Hi=i})(Ma),Fa(new Mt("firestore",(r,{instanceIdentifier:i,options:s})=>{let o=r.getProvider("app").getImmediate(),a=new Ee(new Kd(r.getProvider("auth-internal")),new $d(r.getProvider("app-check-internal")),function(c,d){if(!Object.prototype.hasOwnProperty.apply(c.options,["projectId"]))throw new k(R.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Gn(c.options.projectId,d)}(o,i),o);return s=Object.assign({useFetchStreams:t},s),a._setSettings(s),a},"PUBLIC").setMultipleInstances(!0)),Qr(qv,"4.7.0",e),Qr(qv,"4.7.0","esm2017")})();var Xb="@firebase/firestore-compat",Zb="0.3.35";function Fp(n,e){if(e===void 0)return{merge:!1};if(e.mergeFields!==void 0&&e.merge!==void 0)throw new k("invalid-argument",`Invalid options passed to function ${n}(): You cannot specify both "merge" and "mergeFields".`);return e}function cT(){if(typeof Uint8Array>"u")throw new k("unimplemented","Uint8Arrays are not available in this environment.")}function hT(){if(!nE())throw new k("unimplemented","Blobs are unavailable in Firestore in this environment.")}var Qu=class n{constructor(e){this._delegate=e}static fromBase64String(e){return hT(),new n(Xt.fromBase64String(e))}static fromUint8Array(e){return cT(),new n(Xt.fromUint8Array(e))}toBase64(){return hT(),this._delegate.toBase64()}toUint8Array(){return cT(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function Np(n){return eR(n,["next","error","complete"])}function eR(n,e){if(typeof n!="object"||n===null)return!1;let t=n;for(let r of e)if(r in t&&typeof t[r]=="function")return!0;return!1}var Dp=class{enableIndexedDbPersistence(e,t){return II(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return TI(e._delegate)}clearIndexedDbPersistence(e){return AI(e._delegate)}},$u=class{constructor(e,t,r){this._delegate=t,this._persistenceProvider=r,this.INTERNAL={delete:()=>this.terminate()},e instanceof Gn||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){let t=this._delegate._getSettings();!e.merge&&t.host!==e.host&&St("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&(e=Object.assign(Object.assign({},t),e),delete e.merge),this._delegate._setSettings(e)}useEmulator(e,t,r={}){yp(this._delegate,e,t,r)}enableNetwork(){return bI(this._delegate)}disableNetwork(){return RI(this._delegate)}enablePersistence(e){let t=!1,r=!1;return e&&(t=!!e.synchronizeTabs,r=!!e.experimentalForceOwningTab,_p("synchronizeTabs",t,"experimentalForceOwningTab",r)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,r)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return CI(this._delegate)}onSnapshotsInSync(e){return rT(this._delegate,e)}get app(){if(!this._appCompat)throw new k("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new is(this,vp(this._delegate,e))}catch(t){throw ot(t,"collection()","Firestore.collection()")}}doc(e){try{return new Zt(this,oa(this._delegate,e))}catch(t){throw ot(t,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Ur(this,vI(this._delegate,e))}catch(t){throw ot(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return iT(this._delegate,t=>e(new Hu(this,t)))}batch(){return Ue(this._delegate),new Yu(new Mu(this._delegate,e=>ts(this._delegate,e)))}loadBundle(e){return PI(this._delegate,e)}namedQuery(e){return xI(this._delegate,e).then(t=>t?new Ur(this,t):null)}},ns=class extends $i{constructor(e){super(),this.firestore=e}convertBytes(e){return new Qu(new Xt(e))}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return Zt.forKey(t,this.firestore,null)}};function tR(n){Gw(n)}var Hu=class{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new ns(e)}get(e){let t=Fr(e);return this._delegate.get(t).then(r=>new Mr(this._firestore,new Ct(this._firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,t.converter)))}set(e,t,r){let i=Fr(e);return r?(Fp("Transaction.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Fr(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Fr(e);return this._delegate.delete(t),this}},Yu=class{constructor(e){this._delegate=e}set(e,t,r){let i=Fr(e);return r?(Fp("WriteBatch.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Fr(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Fr(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}},rs=class n{constructor(e,t,r){this._firestore=e,this._userDataWriter=t,this._delegate=r}fromFirestore(e,t){let r=new Un(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new Lr(this._firestore,r),t??{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){let r=n.INSTANCES,i=r.get(e);i||(i=new WeakMap,r.set(e,i));let s=i.get(t);return s||(s=new n(e,new ns(e),t),i.set(t,s)),s}};rs.INSTANCES=new WeakMap;var Zt=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new ns(e)}static forPath(e,t,r){if(e.length%2!==0)throw new k("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new n(t,new ge(t._delegate,r,new U(e)))}static forKey(e,t,r){return new n(t,new ge(t._delegate,r,e))}get id(){return this._delegate.id}get parent(){return new is(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new is(this.firestore,vp(this._delegate,e))}catch(t){throw ot(t,"collection()","DocumentReference.collection()")}}isEqual(e){return e=ne(e),e instanceof ge?wp(this._delegate,e):!1}set(e,t){t=Fp("DocumentReference.set",t);try{return t?bp(this._delegate,e,t):bp(this._delegate,e)}catch(r){throw ot(r,"setDoc()","DocumentReference.set()")}}update(e,t,...r){try{return arguments.length===1?Rp(this._delegate,e):Rp(this._delegate,e,t,...r)}catch(i){throw ot(i,"updateDoc()","DocumentReference.update()")}}delete(){return tT(this._delegate)}onSnapshot(...e){let t=dT(e),r=fT(e,i=>new Mr(this.firestore,new Ct(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return Pp(this._delegate,t,r)}get(e){let t;return e?.source==="cache"?t=YI(this._delegate):e?.source==="server"?t=JI(this._delegate):t=HI(this._delegate),t.then(r=>new Mr(this.firestore,new Ct(this.firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,this._delegate.converter)))}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(rs.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function ot(n,e,t){return n.message=n.message.replace(e,t),n}function dT(n){for(let e of n)if(typeof e=="object"&&!Np(e))return e;return{}}function fT(n,e){var t,r;let i;return Np(n[0])?i=n[0]:Np(n[1])?i=n[1]:typeof n[0]=="function"?i={next:n[0],error:n[1],complete:n[2]}:i={next:n[1],error:n[2],complete:n[3]},{next:s=>{i.next&&i.next(e(s))},error:(t=i.error)===null||t===void 0?void 0:t.bind(i),complete:(r=i.complete)===null||r===void 0?void 0:r.bind(i)}}var Mr=class{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Zt(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Cp(this._delegate,e._delegate)}},Lr=class extends Mr{data(e){let t=this._delegate.data(e);return this._delegate._converter||Kw(t!==void 0,"Document in a QueryDocumentSnapshot should exist"),t}},Ur=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new ns(e)}where(e,t,r){try{return new n(this.firestore,_n(this._delegate,UI(e,t,r)))}catch(i){throw ot(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(e,t){try{return new n(this.firestore,_n(this._delegate,BI(e,t)))}catch(r){throw ot(r,/(orderBy|where)\(\)/,"Query.$1()")}}limit(e){try{return new n(this.firestore,_n(this._delegate,qI(e)))}catch(t){throw ot(t,"limit()","Query.limit()")}}limitToLast(e){try{return new n(this.firestore,_n(this._delegate,jI(e)))}catch(t){throw ot(t,"limitToLast()","Query.limitToLast()")}}startAt(...e){try{return new n(this.firestore,_n(this._delegate,GI(...e)))}catch(t){throw ot(t,"startAt()","Query.startAt()")}}startAfter(...e){try{return new n(this.firestore,_n(this._delegate,KI(...e)))}catch(t){throw ot(t,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new n(this.firestore,_n(this._delegate,zI(...e)))}catch(t){throw ot(t,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new n(this.firestore,_n(this._delegate,WI(...e)))}catch(t){throw ot(t,"endAt()","Query.endAt()")}}isEqual(e){return Ep(this._delegate,e._delegate)}get(e){let t;return e?.source==="cache"?t=ZI(this._delegate):e?.source==="server"?t=eT(this._delegate):t=XI(this._delegate),t.then(r=>new aa(this.firestore,new kt(this.firestore._delegate,this._userDataWriter,this._delegate,r._snapshot)))}onSnapshot(...e){let t=dT(e),r=fT(e,i=>new aa(this.firestore,new kt(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return Pp(this._delegate,t,r)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(rs.getInstance(this.firestore,e)):this._delegate.withConverter(null))}},kp=class{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new Lr(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},aa=class{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Ur(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new Lr(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(t=>new kp(this._firestore,t))}forEach(e,t){this._delegate.forEach(r=>{e.call(t,new Lr(this._firestore,r))})}isEqual(e){return Cp(this._delegate,e._delegate)}},is=class n extends Ur{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let e=this._delegate.parent;return e?new Zt(this.firestore,e):null}doc(e){try{return e===void 0?new Zt(this.firestore,oa(this._delegate)):new Zt(this.firestore,oa(this._delegate,e))}catch(t){throw ot(t,"doc()","CollectionReference.doc()")}}add(e){return nT(this._delegate,e).then(t=>new Zt(this.firestore,t))}isEqual(e){return wp(this._delegate,e._delegate)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(rs.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function Fr(n){return oe(n,ge)}var Vp=class n{constructor(...e){this._delegate=new Dt(...e)}static documentId(){return new n(Re.keyField().canonicalString())}isEqual(e){return e=ne(e),e instanceof Dt?this._delegate._internalPath.isEqual(e._internalPath):!1}};var Op=class n{constructor(e){this._delegate=e}static serverTimestamp(){let e=oT();return e._methodName="FieldValue.serverTimestamp",new n(e)}static delete(){let e=sT();return e._methodName="FieldValue.delete",new n(e)}static arrayUnion(...e){let t=aT(...e);return t._methodName="FieldValue.arrayUnion",new n(t)}static arrayRemove(...e){let t=lT(...e);return t._methodName="FieldValue.arrayRemove",new n(t)}static increment(e){let t=uT(e);return t._methodName="FieldValue.increment",new n(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}};var nR={Firestore:$u,GeoPoint:xr,Timestamp:Te,Blob:Qu,Transaction:Hu,WriteBatch:Yu,DocumentReference:Zt,DocumentSnapshot:Mr,Query:Ur,QueryDocumentSnapshot:Lr,QuerySnapshot:aa,CollectionReference:is,FieldPath:Vp,FieldValue:Op,setLogLevel:tR,CACHE_SIZE_UNLIMITED:wI};function rR(n,e){n.INTERNAL.registerComponent(new Mt("firestore-compat",t=>{let r=t.getProvider("app-compat").getImmediate(),i=t.getProvider("firestore").getImmediate();return e(r,i)},"PUBLIC").setServiceProps(Object.assign({},nR)))}function iR(n){rR(n,(e,t)=>new $u(e,t,new Dp)),n.registerVersion(Xb,Zb)}iR(Lt);var mT=(()=>{let e=class e{constructor(r,i){this.document=r,this.platformId=i,this.documentIsAccessible=$g(this.platformId)}static getCookieRegExp(r){let i=r.replace(/([\[\]{}()|=;+?,.*^$])/gi,"\\$1");return new RegExp("(?:^"+i+"|;\\s*"+i+")=(.*?)(?:;|$)","g")}static safeDecodeURIComponent(r){try{return decodeURIComponent(r)}catch{return r}}check(r){return this.documentIsAccessible?(r=encodeURIComponent(r),e.getCookieRegExp(r).test(this.document.cookie)):!1}get(r){if(this.documentIsAccessible&&this.check(r)){r=encodeURIComponent(r);let s=e.getCookieRegExp(r).exec(this.document.cookie);return s[1]?e.safeDecodeURIComponent(s[1]):""}else return""}getAll(){if(!this.documentIsAccessible)return{};let r={},i=this.document;return i.cookie&&i.cookie!==""&&i.cookie.split(";").forEach(s=>{let[o,a]=s.split("=");r[e.safeDecodeURIComponent(o.replace(/^ /,""))]=e.safeDecodeURIComponent(a)}),r}set(r,i,s,o,a,u,c,d){if(!this.documentIsAccessible)return;if(typeof s=="number"||s instanceof Date||o||a||u||c){let y={expires:s,path:o,domain:a,secure:u,sameSite:c||"Lax",partitioned:d};this.set(r,i,y);return}let m=encodeURIComponent(r)+"="+encodeURIComponent(i)+";",p=s||{};if(p.expires)if(typeof p.expires=="number"){let y=new Date(new Date().getTime()+p.expires*1e3*60*60*24);m+="expires="+y.toUTCString()+";"}else m+="expires="+p.expires.toUTCString()+";";p.path&&(m+="path="+p.path+";"),p.domain&&(m+="domain="+p.domain+";"),p.secure===!1&&p.sameSite==="None"&&(p.secure=!0,console.warn(`[ngx-cookie-service] Cookie ${r} was forced with secure flag because sameSite=None.More details : https://github.com/stevermeister/ngx-cookie-service/issues/86#issuecomment-597720130`)),p.secure&&(m+="secure;"),p.sameSite||(p.sameSite="Lax"),m+="sameSite="+p.sameSite+";",p.partitioned&&(m+="Partitioned;"),this.document.cookie=m}delete(r,i,s,o,a="Lax"){if(!this.documentIsAccessible)return;let u=new Date("Thu, 01 Jan 1970 00:00:01 GMT");this.set(r,"",{expires:u,path:i,domain:s,secure:o,sameSite:a})}deleteAll(r,i,s,o="Lax"){if(!this.documentIsAccessible)return;let a=this.getAll();for(let u in a)a.hasOwnProperty(u)&&this.delete(u,r,i,s,o)}};e.\u0275fac=function(i){return new(i||e)(K(Qg),K(In))},e.\u0275prov=_t({token:e,factory:e.\u0275fac,providedIn:"root"});let n=e;return n})();function sR(n,e=Aa){return new rr(t=>{let r;return e!=null?e.schedule(()=>{r=n.onSnapshot({includeMetadataChanges:!0},t)}):r=n.onSnapshot({includeMetadataChanges:!0},t),()=>{r?.()}})}function pT(n,e){return sR(n,e)}function oR(n,e){return pT(n,e).pipe(Pa(void 0),Ra(),he(t=>{let[r,i]=t;return i.exists?r?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function Up(n,e){return pT(n,e).pipe(he(t=>({payload:t,type:"query"})))}var Ju=class{ref;afs;constructor(e,t){this.ref=e,this.afs=t}set(e,t){return this.ref.set(e,t)}update(e){return this.ref.update(e)}delete(){return this.ref.delete()}collection(e,t){let r=this.ref.collection(e),{ref:i,query:s}=yT(r,t);return new Zu(i,s,this.afs)}snapshotChanges(){return oR(this.ref,this.afs.schedulers.outsideAngular).pipe(Ce)}valueChanges(e={}){return this.snapshotChanges().pipe(he(({payload:t})=>e.idField?Ss(Vt({},t.data()),{[e.idField]:t.id}):t.data()))}get(e){return ct(this.ref.get(e)).pipe(Ce)}};function Xu(n,e){return Up(n,e).pipe(Pa(void 0),Ra(),he(t=>{let[r,i]=t,s=i.payload.docChanges(),o=s.map(a=>({type:a.type,payload:a}));return r&&JSON.stringify(r.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((a,u)=>{let c=s.find(m=>m.doc.ref.isEqual(a.ref)),d=r?.payload.docs.find(m=>m.ref.isEqual(a.ref));c&&JSON.stringify(c.doc.metadata)===JSON.stringify(a.metadata)||!c&&d&&JSON.stringify(d.metadata)===JSON.stringify(a.metadata)||o.push({type:"modified",payload:{oldIndex:u,newIndex:u,type:"modified",doc:a}})}),o}))}function gT(n,e,t){return Xu(n,t).pipe(ir((r,i)=>aR(r,i.map(s=>s.payload),e),[]),ba(),he(r=>r.map(i=>({type:i.type,payload:i}))))}function aR(n,e,t){return e.forEach(r=>{t.indexOf(r.type)>-1&&(n=lR(n,r))}),n}function Mp(n,e,t,...r){let i=n.slice();return i.splice(e,t,...r),i}function lR(n,e){switch(e.type){case"added":if(!(n[e.newIndex]&&n[e.newIndex].doc.ref.isEqual(e.doc.ref)))return Mp(n,e.newIndex,0,e);break;case"modified":if(n[e.oldIndex]==null||n[e.oldIndex].doc.ref.isEqual(e.doc.ref))if(e.oldIndex!==e.newIndex){let t=n.slice();return t.splice(e.oldIndex,1),t.splice(e.newIndex,0,e),t}else return Mp(n,e.newIndex,1,e);break;case"removed":if(n[e.oldIndex]&&n[e.oldIndex].doc.ref.isEqual(e.doc.ref))return Mp(n,e.oldIndex,1);break}return n}function _T(n){return(!n||n.length===0)&&(n=["added","removed","modified"]),n}var Zu=class{ref;query;afs;constructor(e,t,r){this.ref=e,this.query=t,this.afs=r}stateChanges(e){let t=Xu(this.query,this.afs.schedulers.outsideAngular);return e&&e.length>0&&(t=t.pipe(he(r=>r.filter(i=>e.indexOf(i.type)>-1)))),t.pipe(Pa(void 0),Ra(),bs(([r,i])=>i.length>0||!r),he(([,r])=>r),Ce)}auditTrail(e){return this.stateChanges(e).pipe(ir((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=_T(e);return gT(this.query,t,this.afs.schedulers.outsideAngular).pipe(Ce)}valueChanges(e={}){return Up(this.query,this.afs.schedulers.outsideAngular).pipe(he(t=>t.payload.docs.map(r=>e.idField?Ss(Vt({},r.data()),{[e.idField]:r.id}):r.data())),Ce)}get(e){return ct(this.query.get(e)).pipe(Ce)}add(e){return this.ref.add(e)}doc(e){return new Ju(this.ref.doc(e),this.afs)}},Lp=class{query;afs;constructor(e,t){this.query=e,this.afs=t}stateChanges(e){return!e||e.length===0?Xu(this.query,this.afs.schedulers.outsideAngular).pipe(Ce):Xu(this.query,this.afs.schedulers.outsideAngular).pipe(he(t=>t.filter(r=>e.indexOf(r.type)>-1)),bs(t=>t.length>0),Ce)}auditTrail(e){return this.stateChanges(e).pipe(ir((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=_T(e);return gT(this.query,t,this.afs.schedulers.outsideAngular).pipe(Ce)}valueChanges(e={}){return Up(this.query,this.afs.schedulers.outsideAngular).pipe(he(r=>r.payload.docs.map(i=>e.idField?Vt({[e.idField]:i.id},i.data()):i.data())),Ce)}get(e){return ct(this.query.get(e)).pipe(Ce)}},uR=new Ze("angularfire2.enableFirestorePersistence"),cR=new Ze("angularfire2.firestore.persistenceSettings"),hR=new Ze("angularfire2.firestore.settings"),dR=new Ze("angularfire2.firestore.use-emulator");function yT(n,e=t=>t){return{query:e(n),ref:n}}var vT=(()=>{class n{schedulers;firestore;persistenceEnabled$;constructor(t,r,i,s,o,a,u,c,d,m,p,y,A,x,N,q,j){this.schedulers=u;let F=Xr(t,a,r),W=d;m&&Ls(F,a,p,A,x,N,y,q),[this.firestore,this.persistenceEnabled$]=Zr(`${F.name}.firestore`,"AngularFirestore",F.name,()=>{let H=a.runOutsideAngular(()=>F.firestore());if(s&&H.settings(s),W&&H.useEmulator(...W),i&&!xa(o)){let Y=()=>{try{return ct(H.enablePersistence(c||void 0).then(()=>!0,()=>!1))}catch(E){return typeof console<"u"&&console.warn(E),Ot(!1)}};return[H,a.runOutsideAngular(Y)]}else return[H,Ot(!1)]},[s,W,i])}collection(t,r){let i;typeof t=="string"?i=this.firestore.collection(t):i=t;let{ref:s,query:o}=yT(i,r),a=this.schedulers.ngZone.run(()=>s);return new Zu(a,o,this)}collectionGroup(t,r){let i=r||(o=>o),s=this.firestore.collectionGroup(t);return new Lp(i(s),this)}doc(t){let r;typeof t=="string"?r=this.firestore.doc(t):r=t;let i=this.schedulers.ngZone.run(()=>r);return new Ju(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(r){return new(r||n)(K(Yr),K(Jr,8),K(uR,8),K(hR,8),K(In),K(Kr),K(Hr),K(cR,8),K(dR,8),K(ei,8),K(Ds,8),K(ks,8),K(Vs,8),K(Os,8),K(Fs,8),K(Ms,8),K($r,8))};static \u0275prov=_t({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})();var rx=(()=>{let e=class e{get userSnapsot(){return this.userSubject.getValue()}get emailVerfiedSnapshot(){return this.emailVerfiedSubject$.getValue()}set emailVerified(r){this.emailVerfiedSubject$.next(r)}get userSnapshot(){return this.userSubject.getValue()}set user(r){this.userSubject.next(r)}get userRoleSnapshot(){return this.userRoleSubject.getValue()}set userRole(r){this.userRoleSubject.next(r)}constructor(r,i,s,o,a){this.afAuth=r,this.router=i,this.firestore=s,this.applicationService=o,this.crudService=a,this.cookieService=Wg(mT),this.userSubject=new rn(null),this.$user=this.userSubject.asObservable(),this.userRoleSubject=new rn(null),this.$userRole=this.userRoleSubject.asObservable(),this.emailVerfiedSubject$=new rn(!1),this.emailVerfied$=this.emailVerfiedSubject$.asObservable()}createUser(r,i){return ct(this.afAuth.createUserWithEmailAndPassword(r,i).then(s=>{}))}loginWithGoogle(){return ct(this.afAuth.signInWithPopup(new Lt.auth.GoogleAuthProvider))}loginWithFacebook(){return ct(this.afAuth.signInWithPopup(new Lt.auth.FacebookAuthProvider))}login(r,i){return ct(this.afAuth.signInWithEmailAndPassword(r,i))}saveSession(r,i){let s=!1,o=new Date((Yg(r).exp||0)*1e3);try{r&&(this.cookieService.set("session_token",r,i?void 0:o,"/",void 0,!0,"Strict",!1),s=!0)}catch(a){console.error("Error saving session to cookies:",a),s=!1}return s}logout(){this.afAuth.signOut().then(r=>{localStorage.removeItem("remind-me"),this.cookieService.delete("session_token"),window.location.reload()})}SendVerificationMail(){return this.afAuth.currentUser.then(r=>r.sendEmailVerification()).then(()=>{this.applicationService.showSwalDialog("Un e-mail de v\xE9rification a \xE9t\xE9 envoy\xE9 \xE0 votre adresse e-mail.","success","#cce5cc")})}isLoggedIn(){return this.afAuth.authState.pipe(he(r=>!!r))}getCurrentUser(){return this.afAuth.authState.subscribe(i=>{if(i)try{this.crudService.getItemBy_(i.uid,"uid",Na.USERS).subscribe(s=>{this.user=s[0],this.getUserRole(this.userSnapshot?.role)})}catch(s){}}),this.afAuth.authState}getIdToken(){return this.afAuth.idToken}getUserRole(r){"-O7uyBMY9Z99xkVpTM9G";this.crudService.getItem(Na.ROLES,r||"").subscribe(i=>{i&&(this.userRole=i)})}getUserInfo(r){return this.firestore.collection(Na.USERS).doc(r).valueChanges()}sendPasswordReset(r){return this.afAuth.sendPasswordResetEmail(r)}resetTimeout(){clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.logout()},15*60*1e3)}};e.\u0275fac=function(i){return new(i||e)(K(ei),K(Hg),K(vT),K(Jg),K(Lv))},e.\u0275prov=_t({token:e,factory:e.\u0275fac,providedIn:"root"});let n=e;return n})();export{gP as a,mT as b,ei as c,Mv as d,Lv as e,rx as f};
